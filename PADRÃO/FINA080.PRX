
STATIC lFa080Bco
/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ FINA080	  ³ Autor ³ Wagner Xavier       ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Programa de Baixa de Titulos a Pagar						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FINA080()												  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Gen‚rico							 						  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FINA080(xAutoCab,nOpc,lNoMBrowse,nOpbaixa,lExibeLanc,lOnline)
#include "FINA080.CH"
#INCLUDE "PROTHEUS.CH"
#INCLUDE "SET.CH"

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define Variaveis 											 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Local lDigita,lAglut
Local bBlock

Private lF080Auto :=(xAutoCab <> NIL)
Private aAutoCab := {}
nOpc := If(nOpc==NIL,3,nOPC)

lF415Auto := IIf(Type("lF415Auto")=="U",.F.,lF415Auto)		// Sergio Fuzinaka - 05.06.02
DEFAULT lNoMBrowse := .F.
Default nOpBaixa := 1

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Restringe o uso do programa ao Financeiro e Sigaloja		 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !(AmIIn(6,12,17))		// S¢ Fin e Loja e EIC
	Return
Endif

PRIVATE aRotina := MenuDef()
PRIVATE cLoteFin 		:= Space(04)
PRIVATE cBanco 		:= CriaVar("E1_PORTADO")
PRIVATE cAgencia		:= CriaVar("E1_AGEDEP")
PRIVATE cConta			:= CriaVar("E1_CONTA")
PRIVATE cCheque 		:= CriaVar("E1_NUMBCO")
PRIVATE cPortado 		:= "   "
PRIVATE cNumBor 		:= Space(6)
PRIVATE cMarca 		:= Get080Mark()
PRIVATE nValPadrao	:= 0
PRIVATE nValEstrang	:= 0
PRIVATE cBenef
PRIVATE cBancoV
PRIVATE cAgenciaV
PRIVATE cContrato
PRIVATE cPrefV
PRIVATE cNumV
PRIVATE cParcV
PRIVATE cTipV
PRIVATE cNaturV
PRIVATE cFornecV
PRIVATE nValAcres
PRIVATE nTxAcresV
PRIVATE nValtitV
PRIVATE dDataVencV
PRIVATE cCtbaixa := GETMV("MV_CTBAIXA")
Private cFil080
PRIVATE oVlEstrang,oCM
PRIVATE lGerouSef := .F.
PRIVATE nAcresc      := 0
PRIVATE nDecresc     := 0
PRIVATE lIntegracao := IF(GetMV("MV_EASY")=="S",.T.,.F.)
PRIVATE oDifCambio

NUMCHEQUE 	:= ""		//para contabilizar o numero do cheque

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Carrega fun‡ao Pergunte										 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

SetKey (VK_F12,{|a,b| AcessaPerg("FIN080",.T.)})

If FunName() <> "FINA415"
	Pergunte("FIN080",.F.)
EndIf	

//Tratamento para evitar conflito do pergunte FIN080
//com o TMA250 ao gerar contrato de carreteiro - TMS
If lExibeLanc <> NIL .And. ValType(lExibeLanc) == "L"
	mv_par01 := Iif(lExibeLanc,1,2) //Exibe Lancamentos Contabeis
EndIf

//Tratamento para evitar conflito do pergunte FIN080
//com o TMA250 ao gerar contrato de carreteiro - TMS
If lOnline <> NIL .And. ValType(lOnline) == "L"
	mv_par03 := Iif(lOnline,1,2) //Contabiliza On-Line
EndIf

lDigita:=IIf(mv_par01==1,.T.,.F.)
lAglut :=IIf(mv_par02==1,.T.,.F.)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ VerIfica o numero do Lote 									 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE cLote
LoteCont( "FIN" )

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Define o cabe‡alho da tela de baixas						 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE cCadastro := OemToAnsi(STR0006 )  //"Baixa de Titulos"

If lNoMBrowse
	Do Case
		Case nOpc == 3
			INCLUI := .T.
			ALTERA := .F.
		Case nOpc == 4
			INCLUI := .F.
			ALTERA := .T.
		OtherWise	
			INCLUI := .F.
			ALTERA := .F.
	EndCase		
	dbSelectArea("SE2")
	If ( nOpc <> 0 )
		bBlock := &( "{ |a,b,c,d,e| " + aRotina[ nOpc,2 ] + "(a,b,c,d,e) }" )
		Eval( bBlock, Alias(), (Alias())->(Recno()),nOpc)
	EndIf
Else			
	If ! lF080Auto
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Ponto de entrada para pre-validar os dados a serem  ³
		//³ exibidos.                                           ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF ExistBlock("F080BROW")
			ExecBlock("F080BROW",.f.,.f.)
		Endif
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Endere‡a a Fun‡„o de BROWSE									 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		mBrowse( 6, 1,22,75,"SE2",,,,,, Fa040Legenda("SE2"),,,,,,,,IIF(ExistBlock("F080FILB"),ExecBlock("F080FILB",.f.,.f.),NIL))
	Else
	   dbSelectArea('SE2')
	   aAutoCab := SE2->(MSArrayXDB(xAutoCab,nil,4))
	   If Len(aAutoCab) == 0
	      Return
	   EndIf
	   if nOpc == 3
           fA080Tit("SE2",Recno(),4)
	   ElseIf nOpc == 5
	       fA080Can("SE2",Recno(),5,,nOpbaixa)	
	   Endif
	
	Endif
Endif
	
dbSelectArea("SE2")
SET FILTER TO
dbSetOrder(1)

Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fA080Tit ³ Autor ³ Wagner Xavier 		  ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fun‡„o utilizada para Baixa de Titulos a Pagar			     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Tit()												              ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 												              ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Tit(cAlias,nReg,nOpcx,aM,lAut)

LOCAL oBtnTx
LOCAL nLinSom  := If(cPaisLoc<>"BRA",14,15)
LOCAL nOpt
LOCAL lDigita	:=IIf(mv_par01==1,.T.,.F.)
LOCAL lAglut	:=IIf(mv_par02==1,.T.,.F.)
LOCAL nHdlPrv	:=0
LOCAL nTotal	:=0
LOCAL lPadraoBx
LOCAL cArquivo
LOCAL lRet:=.T.
LOCAL nSalvRec:=0
LOCAL cParcela
LOCAL cNum
LOCAL cFornece
LOCAL cMoeda
LOCAL nOrdem
LOCAL nErro :=0
LOCAL lPadraoVd
LOCAL cContabiliza := GETMV("MV_CTBAIXA")
LOCAL lContabiliza
Local lContabMnat
LOCAL lFina080 := Existblock("FINA080")
Local cLanca	:= Iif(mv_par03==1,"S","N")
Local aCmc7:={}
Local lFa080tit:= Existblock("FA080TIT")
Local aMotBx := ReadMotBx()
Local cPadrao
Local aOldValores
LOCAL oDlg,oCbx
LOCAL aDescMotbx := {}
Local cMoedaTx, nA := 0
LOCAL oImpSubst
Local nAcrescF := 0
Local nDecrescF:= 0
Local lSPB := VerCpoSPB() // Bank of America
Local cClearing := Space(3) // Bank of America
Local cTipoPgto := Space(2) // Bank of America
Local cStored := Space(4) // Bank of America
Local cHora := Substr(Time(),1,5) // Bank of America
Local cCodBar	:= Space(44) // Bank of America
Local nEventoSPB := 0 // Bank of America
Local lSpbInUse := SpbInUse()
LOCAL aModalSPB	:=  {"1=TED","2=CIP","3=COMP"}
LOCAL oModSpb
Local nTxMoeda
Local nUltLin
Local nTamTitOri := TamParcela("E2_PARCELA",19,20,21)
Local oMultNat
Local lMultNat := .F.
Local lOk := .F. //Controla se foi confirmada a distribuicao 
Local aColsSEV := {}
Local oTxMoeda
Local nTolerCp := SuperGetMv("MV_TOLERCP",.F.,0)
Local nI
Local cNatPis	:= GetMv("MV_PISNAT",.F.,"PIS")
Local cNatCof	:= GetMv("MV_COFINS",.F.,"COF")
Local cNatCsl	:= GetMv("MV_CSLL",.F.,"CSL")
Local lMensagem := .T.   
Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )
Local nLinha := 0

Local nOldVlPis := 0
Local nOldVlCof := 0
Local nOldVlCsl := 0
Local nCentMd1	:= MsDecimais(1)
Local nOldVlIrf := 0
Local lIrfMp232 := .F.

Local aArea := SE2->(GetArea())
Local	cPrefixo := SE2->E2_PREFIXO
Local cTipoPai := SE2->E2_TIPO
Local lAchou := .F.

Local cMsg	 := ""
Local nBusca := 0
Local lAD	 := .F.
Local lAcessImp:= .T.
Local oNumTit
Local oNomeFor
Local aButtons  := {}
Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)

Local nOldVlIss := 0                                       

Local nOldRetPis := 0
Local nOldRetCof := 0
Local nOldRetCsl := 0               
Local lContrRet  := !Empty( SE2->( FieldPos( "E2_VRETPIS" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE2->( FieldPos( "E2_VRETCSL" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETPIS" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_PRETCOF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETCSL" ) ) )

Local lBordero   := If (lContrRet,(SE2->E2_PRETPIS = '4' .OR. SE2->E2_PRETCOF = '4' .OR. SE2->E2_PRETCSL = '4') .And.;
				 				!Empty(SE2->E2_NUMBOR),.F.)

Local lBxEstTotal := .F.

Local lAcessMul	:= .T.
Local lAcessJur	:= .T.
Local lAcessDes	:= .T.
Local aCposDes		:= {}
Local nT 			:= 0
Local oJuros
Local oDescont
Local oMulta



PRIVATE oCheque,oAgencia,oBanco,oConta
PRIVATE cHist070 := CriaVar("E5_HISTOR")
PRIVATE dBaixa	  := CriaVar("E2_BAIXA")
PRIVATE dDebito	  := CriaVar("E2_BAIXA")
PRIVATE nValPgto := 0
PRIVATE nCM 	  := 0
PRIVATE nDescont := 0
PRIVATE nJuros   := 0
PRIVATE nMulta   := 0
PRIVATE nOtrga       := 0
PRIVATE nDifCambio   := 0
PRIVATE nImpSubst    := 0
PRIVATE aTxMoedas	  := {}
Private noldvalor := 0
Private aDadosSPB := {}
PRIVATE lUsaCmc7 := .F.
PRIVATE cModSpb		:= "1"
PRIVATE nValBrut		:= 0
PRIVATE nPis 		:= 0
PRIVATE nCofins   := 0
PRIVATE nCsll		:= 0
PRIVATE aDadosRef := Array(7)
PRIVATE aDadosRet := Array(7)
PRIVATE nOldValPgto := 0
PRIVATE dBxDt_Venc
PRIVATE dOldData := CToD("")
PRIVATE nOldDescont := 0
PRIVATE nOldMulta := 0
PRIVATE nOldJuros := 0
PRIVATE nOldIRRF := 0
PRIVATE nOldPIS := 0
PRIVATE nOldCofins := 0
PRIVATE nOldCSLL := 0
PRIVATE nValComp := 0
PRIVATE nVlImpPCC:= 0

aFill(aDadosRef,0)
aFill(aDadosRet,0)
If (ExistBlock( "FA080CMC" ) )
	lUsaCmc7:=ExecBlock("FA080CMC",.F.,.F.)
Endif

IF ExistBlock("F080MNAT")
	lMultNat := ExecBlock("F080MNAT",.F.,.F.)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se existe Adiantamento ou Devolucao ³
//³ para o Fornecedor do título a ser baixado.   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If GetNewPar("MV_VLTITAD",.F.) .And. !(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG)
	nBusca := F090BuscAD( "SE2", SE2->E2_FORNECE, SE2->E2_LOJA )
	If nBusca <> 0
		lAD := .T.
		cMsg := STR0144 //"O Fornecedor deste titulo possui "
		Do Case 
			Case nBusca = 1 // Adiantamento
				cMsg += STR0145 //"Adiantamento."
			Case nBusca = 2 // Devolucao
				cMsg += STR0146 //"Devolucao."
		End Case
		cMsg += chr(13)+chr(10)
		cMsg += STR0147 //"Deseja mesmo assim baixa-lo ?"
		If !MsgYesNo( cMsg )
			Return .F.
		Endif
	Endif
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Paises Localizados:                                  ³
//³Nao deixa baixar o titulo se no cadastro de Moeda SM2³
//³a taxa estiver com valor Zero                        ³
//³Validacao somente para titulo com Moeda > 1          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( cPaisLoc <> "BRA" ) .And. ( SE2->E2_MOEDA > 1 )
	If !(RecMoeda(dBaixa,SE2->E2_MOEDA) > 0 )
 		Help(" ",1,"A080TXZERO")	
 		Return .F.
    Endif
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³VerIfica se pode baixar titulo inserido em um bordero 					³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If mv_par04 == 2	// Nao permite baixa se o titulo estiver num bordero.
	If !Empty( SE2->E2_NUMBOR )
		Help(" " , 1 , "FA080NAOBAIXA")
		Return .F.
	Endif
Endif
// inclusao para a rotina de workflow (maria cristina)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se pode baixar sem aprova‡Æo                               ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If (Type('lF080Auto') =='U' .or. ! lF080Auto)
	If (!Empty(GetMv("MV_APRPAG")) .and. Empty(SE2->E2_DATALIB)).or.;
	   !( SE2->E2_TIPO $ MVPAGANT ) .And. ;
	   (GetMv("MV_CTLIPAG").and.Empty(SE2->E2_DATALIB).and.(SE2->E2_SALDO+SE2->E2_SDACRES-SE2->E2_SDDECRE)>GetMV("MV_VLMINPG"))
		Help(" " , 1 , "FA080NAOLIB") // NÆo permite baixar t¡tulos nÆo liberados
		Return .F.
	Endif
Endif	
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Caso tenha sido gerado pelo SigaEic e do tipo PR nao podera se baixado se nao for pela rotina automatica ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( Type('lF080Auto') =='U' .or. ! lF080Auto) .and. lIntegracao .and.  SE2->E2_TIPO = "PR "  .and. UPPER(SE2->E2_ORIGEM) = "SIGAEIC"
	HELP(" ",1,"FAORIEIC")
	Return
Endif  

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Caso tenha sido gerado pelo SigaEic e do tipo INV e do BRASIL nao podera se baixado se nao for pela rotina automatica ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ( Type('lF080Auto') =='U' .or. ! lF080Auto) .and. lIntegracao .and. cPaisloc = "BRA" .and.  SE2->E2_TIPO = "INV"  .and. UPPER(SE2->E2_Origem) = "SIGAEIC"
	HELP(" ",1,"FAORIEIC")
	Return
Endif  

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Caso esteja ligado o controle de solicitacao de notas de credito e exista alguma ³
//³ pendencia para este titulo                                                       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

If cPaisLoc <> "BRA"
	SCU->(DbSetOrder(2))
Endif
If ( Type('lF080Auto') =='U' .or. ! lF080Auto) .And. cPaisLoc <> "BRA" .And. SuperGetMv('MV_SOLNCP') .And.  SE2->E2_TIPO == MVNOTAFIS ;
		.And. SCU->(MsSeek(xFilial()+SE2->E2_FORNECE+SE2->E2_LOJA+SE2->E2_NUM+SE2->E2_PREFIXO)).And. Empty(SCU->CU_NCRED)
	HELP(" ",1,"SOLNCPAB")
	Return
Endif  


//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ PONTO DE ENTRADA 																	³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If (ExistBlock( "FA080CHK" ) )
	If !(ExecBlock("FA080CHK",.F.,.F.))
		Return .F.
	EndIf
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Monta Hist¢rico da Baixa para digita‡„o pelo usuario						³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cHist070 := Criavar("E5_HISTOR")		//Inicilizador padrao

If Empty(cHist070)
	cHist070 := OemToAnsi(STR0011)+Space(Len(cHist070)-20) 	//"Valor pago s/ Titulo"
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Variavel auxiliar  … analise se o titulo veio de um cheque pre datado ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
PRIVATE lChqPre:= .f.
PRIVATE cMotBx := CriaVar("E5_MOTBX")
PRIVATE cBenef	:= CriaVar("E5_BENEF")
lAut 		:= If( lAut=NIL,.F.,lAut)

dbSelectArea("SE2")
nOrdem	:= IndexOrd()
dbSetOrder(1)

If cPaisLoc <> "BRA"
	Aadd(aTxMoedas,{"",1,PesqPict("SM2","M2_MOEDA1")})
	For nA	:=	2	To MoedFin()
		cMoedaTx	:=	Str(nA,IIf(nA <= 9,1,2))
		If !Empty(GetMv("MV_MOEDA"+cMoedaTx))
			Aadd(aTxMoedas,{GetMv("MV_MOEDA"+cMoedaTx),RecMoeda(dDataBase,nA),PesqPict("SM2","M2_MOEDA"+cMoedaTx) })
		Else
			Exit
		Endif	
	Next
EndIf
*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Analisa se o titulo foi gerado a partir de um cheque pre datado.		³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lChqPre := .f.
dbSelectArea("SE5")
dbSetOrder(2)
If SE5->(dbSeek( xFilial("SE5") + "CD" + SE2->E2_PREFIXO + ;
		SE2->E2_NUM + SE2->E2_PARCELA + SE2->E2_TIPO + dToS(SE2->E2_EMISSAO )+;
		SE2->E2_FORNECE + SE2->E2_LOJA ))

	lChqPre := .T.
	cBanco   := SE5->E5_BANCO
	cAgencia := SE5->E5_AGENCIA
	cConta   := SE5->E5_CONTA
	cCheque  := SE5->E5_NUMCHEQ
	cBenef   := SE5->E5_BENEF
	cHist070 := SE5->E5_HISTOR	
EndIf

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Mostra dados cadastrais do titulo												 	³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SA2")
dbSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA)

lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )


*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Carrega Beneficiario com Nome do Fornecedor 								   ³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If Empty(cBenef)
	dbSelectArea("SA2")
	SA2->(dbSeek(cFilial+SE2->E2_FORNECE+SE2->E2_LOJA))
	dbSelectArea("SE2")
	cBenef   := SA2->A2_NOME
Endif

IF !lChqPre
	cCheque  := CriaVar("EF_NUM",.F.)
Endif

dBaixa	 := CriaVar("E2_BAIXA")
If cPaisLoc == "BRA"
	nTxMoeda	 := If(SE2->E2_MOEDA > 1,If(SE2->E2_TXMOEDA > 0 .and. Empty(SE2->E2_DTVARIA), SE2->E2_TXMOEDA,RecMoeda(dBaixa,SE2->E2_MOEDA)),0)
Else
	nTxMoeda	 := RecMoeda(dBaixa,SE2->E2_MOEDA)
Endif	
cPortado	 := SE2->E2_PORTADO

If !SoftLock( "SE2" )
	Return
EndIf

If (ExistBlock( "F080MENS" ) )
	lMensagem:=ExecBlock("F080MENS",.F.,.F.)
Endif

//Ponto de entrada para desabilitar campos de Multa, Juros ou Descontos
If ExistBlock("F080DCNB")
	aCposDes:=ExecBlock("F080DCNB",.F.,.F.)
	If Len(aCposDes) > 0
		IF (nT := ascan(aCposDes,'MULTA')) > 0	
			lAcessMul := .F.
		Endif
		IF (nT := ascan(aCposDes,'DESCONTO')) > 0	
			lAcessDes := .F.
		Endif
		IF (nT := ascan(aCposDes,'JUROS')) > 0	
			lAcessJur := .F.
		Endif		
	Endif
Endif

//Aviso ao baixar titulo de Imposto gerado por bordero e baixa do principal ainda nao
//foi efetuada.
If lMensagem .and. cPaisLoc == "BRA" .and. ( Type('lF080Auto') =='U' .or. ! lF080Auto) .and. ;
	("FINA240" $ SE2->E2_ORIGEM) .and. lPccBaixa .and. ;
	SE2->E2_TIPO $ MVTAXA .and. ((cNatPis $ E2_NATUREZ).or. ;
		(cNatCof $ E2_NATUREZ ).or. (cNatCsl $ E2_NATUREZ))

	Do Case 
	Case Alltrim(E2_NATUREZ) $ AllTrim(GetMv("MV_PISNAT"))
		cValorPai := "SE2->E2_PIS"
		cParcPai := "E2_PARCPIS"
	Case Alltrim(E2_NATUREZ) $ AllTrim(GetMv("MV_COFINS"))
		cValorPai := "SE2->E2_COFINS"
		cParcPai := "E2_PARCCOF"
	Case Alltrim(E2_NATUREZ) $ AllTrim(GetMv("MV_CSLL"))
		cValorPai := "SE2->E2_CSLL"
		cParcPai := "E2_PARCSLL"
	OtherWise
		cValorPai := "SE2->E2_IRRF"
		cParcPai := "E2_PARCIR"
	EndCase	

	dbSelectArea("SE2")
	dbSetOrder(1)
	nRegSE2:= Recno()
	aArea := SE2->(GetArea())
	cPrefixo := SE2->E2_PREFIXO
	cNum := SE2->E2_NUM 
	cParcela := SE2->E2_PARCELA
	cTipoPai := SE2->E2_TIPO
	lAchou := .F.
	If dbSeek(xFilial("SE2")+cPrefixo+cNum)
		While !Eof() .and. SE2->(E2_FILIAL+E2_PREFIXO+E2_NUM) == cFilial+cPrefixo+cNum
			If &(cParcPai) == cParcela .and. IIF(cTipoPai $ MVTXA,SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,.T.)
				If &(cValorPai) != 0 .and. SE2->E2_SALDO > 0
					lAchou := .T.
					Exit
				EndIf
			EndIf
			DbSkip()
		Enddo
	EndIf

	If lAchou
		IF !MSGYESNO(STR0139+; // "Tentativa de efetuar baixa de titulo de imposto sem que o titulo "
							STR0140,"BXIMPBOR") // "principal tenha sido baixado. Continuar o processo de baixa ?"
			RestArea(aArea)				
			Return .F.
		Endif
	Endif
	RestArea(aArea)	
Endif

While .T.
	nTotAGer  := 0 // Variaveis para acumulo dos valores
	nTotADesp := 0 // na baixa
	nTotADesc := 0
	nTotAMul	 := 0
	nTotAJur	 := 0

	nValPgto := 0
	nCM 	  	:= 0
	nDescont := 0
	nJuros   := 0
	nMulta   := 0

	nAcrescF 	:= SE2->E2_SDACRES
	nDecrescF	:= SE2->E2_SDDECRE
	nAcresc		:= Round(Noround(xMoeda(SE2->E2_SDACRES,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
	nDecresc		:= Round(Noround(xMoeda(SE2->E2_SDDECRE,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)

	nPis		:= 0
	nCofins	:= 0
	nCsll		:= 0
	nVlRetPis	:= 0
	nVlRetCof	:= 0
	nVlRetCsl	:= 0
	nDiferImp	:= 0
	cNumBor		:= SE2->E2_NUMBOR

	nIrrf := 0
	nVlRetIrf := 0
	nIss		:= 0

	IF Empty(cBanco)
		cBanco	:= CriaVar( "E5_BANCO" )
		cAgencia := CriaVar( "E5_AGENCIA")
		cConta	:= CriaVar( "E5_CONTA" )
	Endif

	dbSelectArea("SE2")
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Verifica se o Titulo ja foi Baixado Totalmente 							   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF SE2->E2_SALDO + SE2->E2_SDACRES == 0
		Help(" ",1,"TITBAIXADO")
		MsUnlock()
		Exit
	EndIF

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Verifica se ‚ um registro Principal											 	³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF SE2->E2_TIPO $ MVABATIM
		Help(" ",1,"NAOPRINCIP")
		MsUnlock()
		Exit
	EndIF

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Verifica se ‚ um titulo provisorio 												  ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF SE2->E2_TIPO $ MVPROVIS
		Help(" ",1,"TITULOPROV")
		MsUnlock()
		Exit
	EndIF

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³ Identifica se contab. deve ocorrer na baixa ou gera‡„o de cheques e se  ³
	*³ o tipo do titulo for PA e existir cheque deve ser contabilizado  		   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SEF")
	dbSetOrder(3)
	If SE2->E2_TIPO $ MVPAGANT .and. SEF->(dbseek(xFilial("SEF")+SE2->E2_PREFIXO+SE2->E2_NUM+;
			SE2->E2_PARCELA+SE2->E2_TIPO))
		lContabiliza := .T.
	Else
		lContabiliza := IIf(cContabiliza = "B" .Or. cContabiliza = "A", .T., .F.)
	EndIf
	dbSelectArea("SE2")
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Carrega as variaveis utilizadas para receber os dados do titulo				³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nSalvRec 	:= SE2->(RecNO())
	cNum	  		:= SE2->E2_NUM
	cPrefixo 	:= SE2->E2_PREFIXO
	cParcela 	:= SE2->E2_PARCELA
	cFornece 	:= SE2->E2_FORNECE
	cLoja	  		:= SE2->E2_LOJA
	nTotAbat 	:= 0
	nValPadrao 	:= 0
	dAnter 		:= dBaixa	
	cMoeda 		:= IIF(Empty(SE2->E2_MOEDA),"1",AllTrim(Str(SE2->E2_MOEDA,2)))
	cDescMoeda  := SubStr(GetMV("MV_SIMB"+cMoeda),1,3)

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Soma Titulos Abatimentos															   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nTotAbat:=SumAbatPag( cPrefixo, cNum, cParcela, cFornece, SE2->E2_MOEDA, "S", dBaixa, cLoja )
	SE2->( dbGoTo( nSalvRec ) )
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Recebe os dados do titulo a ser baixado										   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	lCont := .F.
	aOldValores:={nDescont,nMulta,nJuros}

	nValTot		:= SE2->E2_VLCRUZ
	nValEstrang := nValOrig 	 := SE2->E2_SALDO-nTotAbat
	nValMoeda   := Round(Noround(xMoeda(nValOrig				,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nValMoeda1  := Round(NoRound(xMoeda(SE2->E2_VALOR-nTotAbat	,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	If nAcresc  > nValMoeda
		nAcresc:= nValMoeda
	EndIf
	nValPgto	:= nValMoeda+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
	nOldValPgto	:= nValPgto

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³ Retorna o Array aDescMotBx contendo apenas a descricao do  	 ³
	*³ motivo das Baixas.									 					 ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	if len(aDescMotbx) == 0
		For nI := 1 to len( aMotBx )
			If substr(aMotBx[nI],34,01) == "A" .or. substr(aMotBx[nI],34,01) =="P"
				AADD( aDescMotbx,substr(aMotBx[nI],07,10))
			EndIf
		Next
	EndIf         
	
	// Carrega varivael cmotbx para sua verifcacao na funcao fa080totmes()
	cMotBx		:= aDescMotBx[1] 	//NORMAL

	//Calcula ISS na Baixa
	F080IssBx()

	//Calcula Impostos pela Baixa
	If lPccBaixa
		fa080Data()		
		f080TotMes(dBaixa,.T.)
	Endif

	//Guardo o valor dos impostos calculados para diferenciar quando os mesmos
	//forem digitados manualmente pelo usuario
	nVlImpPCC := nPis+nCoFins+nCsll
	
	IF (nMulta+nJuros+nDescont+nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,,,nTxMoeda),2 ) > 0.01
		nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
	EndIF
	nValLiq	  := nValPgto-nMulta-nJuros+nDescont-nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss
	If SE2->E2_MOEDA == 1
		nCm:=0
	Endif
	SA2->( dbseek( xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))
	cNomeFor := SE2->E2_FORNECE + " " + SA2->A2_NOME
	cTitulo := SE2->E2_PREFIXO + " " + SE2->E2_NUM+ " " + SE2->E2_PARCELA
	nPagtoParcial := SE2->E2_VALOR-SE2->E2_SALDO
	cTexto := OemToAnsi(STR0101)+ SubStr(GetMV("MV_SIMB"+cMoeda),1,3)  //"Valor Original "
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³PONTO DE ENTRADA FA080POS	³
	//³                           ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Permite a altera‡„o de vari veis apos carga de dados do t¡tulo a ser ³
	//³ baixado, antes das informa‡äes serem mostradas na Tela.              ³
	//³ Vari veis dispon¡veis para serem alteradas :                         ³
	//³                                                                      ³
	//³ cBanco , cAgencia, cConta, cCheque                                   ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ExistBlock("FA080POS")
		ExecBlock("FA080POS",.F.,.F.)
		SE2->(dbGoTo(nSalvRec))
	Endif

	If cPaisLoc <> "BRA" .And. !lF415Auto
		nTxMoeda   := RecMoeda(dBaixa,SE2->E2_MOEDA)
		nDifCambio := ( Round( (SE2->E2_VALOR * nTxMoeda), nCentMd1) - SE2->E2_VLCRUZ )
	EndIf
   
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³PONTO DE ENTRADA FA080ACES ³
	//³ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Permite ou nao que o usuario altere os valores dos impostos da lei 10925 ³
	//³ calculados automaticamente pelo sistema.                                 ³
	//³ Vari veis dispon¡veis para serem alteradas :                             ³
	//³                                                                          ³
	//³ lAcessImp ( .T. - PERMITE  /  .F. - NAO PERMITE )								  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If ExistBlock("FA080ACES")
		lAcessImp := ExecBlock("FA080ACES",.F.,.F.)
	Endif
   
   If Type('lF080Auto') =='U' .or. ! lF080Auto
		*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		*³Recebe os dados do t¡tulo a ser baixado 									³
		*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nOpc1 := 0
		// Carrega as variaveis bancarias
		Fa080BDev(.F.)
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Pr‚-inicializa a modalidade de SPB                                 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lSpbInUse
			If !Empty(SE2->E2_MODSPB)
				cModSpb := SE2->E2_MODSPB
			Else
			   cModSpb := "1"
			Endif		
		Endif
	
		DEFINE MSDIALOG oDlg FROM	31,15 TO 577,574 TITLE OemToAnsi(STR0007)  PIXEL OF oMainWnd //"Baixas a Pagar"
		@ 37+nLinSom , 001 TO 247+nLinSom, 137 LABEL OemToAnsi(STR0013) OF oDlg  PIXEL //"Dados Gerais"
		@ 38+nLinSom , 143 TO 247+nLinSom, 278 LABEL OemToAnsi(STR0014) OF oDlg  PIXEL //"Valores da Baixa"
		@ 01+nLinSom , 002 TO 035+nLinSom, 278 LABEL OemToAnsi(STR0015) OF oDlg  PIXEL //"Principal"

		If lUsaCmc7
			aCmc7:=LjLeCmc7(1)
			If Len(aCmc7) > 0
				cBanco  :=aCmc7[1]
				cAgencia:=aCmc7[2]
				cConta  :=aCmc7[3]
				cCheque :=aCmc7[4]
			Endif
		Endif
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\¿
		//³Ponto de Entrada para o escolher se a data exibida é a E2_VENCREA ou a E2_VENCTO³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\Ù
		If Type("dBxDt_Venc") == "U"
			dBxDt_Venc := SE2->E2_VENCREA
		EndIf

		@ 010+nLinSom, 010 SAY OemToAnsi(STR0016)	SIZE 18,07 OF oDlg PIXEL // "T¡tulo"
		@ 008+nLinSom, 030 MSGET oNumTit VAR cTitulo	F3 "SE2RDO"	SIZE 57,10 OF oDlg PIXEL HASBUTTON //READONLY
		oNumTit:lReadOnly := .T.
		@ 010+nLinSom, 095 SAY OemToAnsi(STR0017)	SIZE 31,07 OF oDlg PIXEL //"Emiss„o"
		@ 008+nLinSom, 127 MSGET SE2->E2_EMISSAO 	SIZE 39,10 OF oDlg PIXEL HASBUTTON When .F.
		@ 010+nLinSom, 169 SAY OemToAnsi(STR0018)	SIZE 39,07 OF oDlg PIXEL //"Vencto.Atual"
		@ 008+nLinSom, 202 MSGET dBxDt_Venc		 	SIZE 39,10 OF oDlg PIXEL HASBUTTON When .F.
		@ 022+nLinSom, 005 SAY OemToAnsi(STR0019)	SIZE 22,07 OF oDlg PIXEL //"Fornec."
		@ 020+nLinSom, 030 MSGET oNomeFor VAR cNomeFor	F3 "SA2" SIZE 211,9 OF oDlg PIXEL HASBUTTON //READONLY
		oNomeFor:lReadOnly := .T.
		@ 046+nLinSom    , 007 SAY OemToAnsi(STR0020)	SIZE 38,07 OF oDlg PIXEL //"Hist.Emiss„o"
		@ 043+nLinSom    , 050 MSGET SE2->E2_HIST 		SIZE 79,10 OF oDlg PIXEL HASBUTTON When .F.
		@ 057+nLinSom    , 007 SAY OemToAnsi(STR0021)	SIZE 39,07 OF oDlg PIXEL //"Portador"
		@ 056+nLinSom    , 050 MSGET cPortado			SIZE 66,10 OF oDlg PIXEL HASBUTTON When .F.
		@ 069+nLinSom    , 007 SAY OemToAnsi(STR0029)	SIZE 37,07 OF oDlg PIXEL //"Mot.Baixa"
		@ 068+nLinSom    , 050 MSCOMBOBOX oCbx VAR cMotBx ITEMS aDescMotbx SIZE 56,47 OF oDlg PIXEL ;
		ON CHANGE (fa080ChkVdr(),oBanco:lReadOnly := !fa080digit()) Valid fa080BDev() .and.;
		F080SPB(@lSPB,@cClearing,@cTipoPgto,@cStored,@cHora) .and. F080TotMes(dBaixa,.F.)
		@ 081+nLinSom    , 007 SAY OemToAnsi(STR0022)	SIZE 40,07 OF oDlg PIXEL //"Banco"
		@ 080+nLinSom    , 050 MSGET oBanco VAR cBanco 	SIZE 22,10 OF oDlg PIXEL HASBUTTON F3 "SA6" ;
			Valid (!MovBcobx(cMotBx, .T.) .and. Empty(cBanco)) .or. ;
						(CarregaSA6(@cBanco,,,.T.) .and. fa080BcoCx() .And. ;
						FaPrNumChq(cBanco,cAgencia,cConta,@oCheque,@cCheque) )
		oBanco:lReadOnly := !fa080digit()
		
		@ 093+nLinSom    , 007 SAY OemToAnsi(STR0023)	SIZE 39,07 OF oDlg PIXEL //"Agˆncia"
		@ 092+nLinSom    , 050 MSGET oAgencia VAR cAgencia	SIZE 35,09 OF oDlg PIXEL HASBUTTON When fa080digit() Valid ;
																  CarregaSA6(@cBanco,@cAgencia,,.T.) .And. FaPrNumChq(cBanco,cAgencia,cConta,@oCheque,@cCheque)
		@ 106+nLinSom    , 007 SAY OemToAnsi(STR0024)	SIZE 41,07 OF oDlg PIXEL //"Conta"
		@ 104+nLinSom    , 050 MSGET oConta VAR cConta 	SIZE 66,10 OF oDlg PIXEL HASBUTTON When fa080digit() Valid ;
																	If(CarregaSA6(@cBanco,@cAgencia,@cConta,.T.,,.T.),FaPrNumChq(cBanco,cAgencia,cConta,@oCheque,@cCheque),oBanco:SetFocus())
		@ 118+nLinSom    , 007 SAY OemToAnsi(STR0027)	SIZE 40,07 OF oDlg PIXEL //"Cheque No."
		@ 116+nLinSom    , 050 MSGET oCheque VAR cCheque	SIZE 38,10 OF oDlg PIXEL HASBUTTON When (fa080digit() .and. faDigiChq()) Valid fa080Cheq()
		@ 130+nLinSom    , 007 SAY OemToAnsi(STR0025)	SIZE 38,07 OF oDlg PIXEL //"Data Pagto."
		@ 128+nLinSom    , 050 MSGET dBaixa 			SIZE 50,09 OF oDlg PIXEL HASBUTTON Valid Iif(dOldData # dBaixa, fa080Data(@nTxMoeda), .T.) .and. DtMovFin(dBaixa) .and. f080TotMes(dBaixa,.T.)
		dOldData := dBaixa
		@ 142+nLinSom    , 007 SAY OemToAnsi(STR0149)	SIZE 38,07 OF oDlg PIXEL //"Data Debito"
		@ 140+nLinSom    , 050 MSGET dDebito 			SIZE 50,09 OF oDlg PIXEL HASBUTTON Valid (dDebito >= dBaixa  .and. DtMovFin(dDebito))
		@ 154+nLinSom    , 007 SAY OemToAnsi(STR0026)	SIZE 39,07 OF oDlg PIXEL //"Hist.Baixa"
		@ 152+nLinSom    , 050 MSGET cHist070			SIZE 83,10 OF oDlg PIXEL HASBUTTON Picture "@!" VALID CheckSX3("E5_HISTOR") When VisualSX3("E5_HISTOR")
		@ 166+nLinSom    , 007 SAY OemToAnsi(STR0028)	SIZE 36,07 OF oDlg PIXEL //"Beneficiário"
		@ 164+nLinSom    , 050 MSGET cBenef 			SIZE 83,10 OF  oDlg PIXEL HASBUTTON Picture "@!" When cNivel >= NivelSx3("E5_BENEF") .and. fa080digit()
		nUltLin := 166
		If cPaisLoc == "BRA" .And. SE2->E2_MOEDA > 1
			@ 178+nLinSom,007 SAY STR0129 	SIZE 53, 07 OF oDlg PIXEL //"Taxa contratada"
			@ 176+nLinSom,050 MSGET oTxMoeda VAR nTxMoeda SIZE 66, 10 OF oDlg PIXEL HASBUTTON Picture PesqPict( "SM2","M2_MOEDA"+AllTrim(Str(SE2->E2_MOEDA))) ;
							 Valid Fa080Val(0,nTxMoeda)
			nUltLin := 178
		Endif	                   
		If lSpbInUse
			@ nUltLin+14+nLinSom,007 SAY STR0128 SIZE 32, 07 OF oDlg PIXEL  //"Modalidade SPB"
			@ nUltLin+12+nLinSom,050 COMBOBOX oModSPB VAR cModSpb ITEMS aModalSpb SIZE 56, 47 OF oDlg PIXEL ;
								When MovBcoBx(cMotBx,.T.) 
			nUltLin += 14		
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Somente exibe a opcao Rateio Multiplas Naturezas se parametro MV_MULNATP = .T.  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ       
		If MV_MULNATP
			@ nUltLin+14+nLinSom,007 SAY STR0132 SIZE 100, 07 OF oDlg PIXEL	 //"Rateio Mult.Naturezas"
			@ nUltLin+12+nLinSom,090 CHECKBOX oMultNat VAR lMultNat PROMPT "" SIZE 11,11 OF oDLG PIXEL
		Endif
	
	    If cPaisLoc <> "CHI"
			@ 046+nLinSom, 151 SAY cTexto 				SIZE 53,07 OF oDlg PIXEL //"Valor Original"
			@ 043+nLinSom, 208 MSGET SE2->E2_VALOR		SIZE 66,10 OF oDlg PIXEL HASBUTTON When .F. Picture PesqPict("SE2","E2_VALOR")
			@ 057+nLinSom, 151 SAY OemToAnsi(STR0035)	SIZE 53,07 OF oDlg PIXEL //"- Abatimentos"
			@ 056+nLinSom, 208 MSGET nTotAbat			SIZE 66,10 OF oDlg PIXEL HASBUTTON When .F. Picture PesqPict("SE2","E2_VALOR")	
		Else
			@ 046+nLinSom, 151 SAY OemToAnsi(STR0034) 	SIZE 53,07 OF oDlg PIXEL //"Valor Original"
			@ 043+nLinSom, 208 MSGET SE2->E2_VLCRUZ		SIZE 66,10 OF oDlg PIXEL HASBUTTON When .F. Picture PesqPict("SE2","E2_VLCRUZ")
			@ 057+nLinSom, 151 SAY OemToAnsi(STR0118)	SIZE 53,07 OF oDlg PIXEL //"+ Imposto Subst."
			@ 056+nLinSom, 208 MSGET oImpSubst VAR nImpSubst	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_IMPSUBS") Valid Fa080Val(nImpSubst,nTxMoeda)
		EndIf
		@ 069+nLinSom, 151 SAY OemToAnsi(STR0036)  		SIZE 53,07 OF oDlg PIXEL //"- Pagtos.Parciais"
		@ 068+nLinSom, 208 MSGET nPagtoParcial			SIZE 66,10 OF oDlg PIXEL HASBUTTON When .F. Picture PesqPict("SE2","E2_VALOR")
		@ 081+nLinSom, 151 SAY OemToAnsi(STR0120)    	SIZE 53,07 OF oDlg PIXEL //"+ Acrescimo"
		@ 080+nLinSom, 208 MSGET nAcrescF				SIZE 66,10 OF oDlg PIXEL HASBUTTON When .f. Picture PesqPict("SE2","E2_SDACRES")
		@ 093+nLinSom, 151 SAY OemToAnsi(STR0121)		SIZE 53,07 OF oDlg PIXEL //"- Decrescimo"
		@ 092+nLinSom, 208 MSGET nDecrescF				SIZE 66,10 OF oDlg PIXEL HASBUTTON When .f. Picture PesqPict("SE2","E2_SDDECRE")

		@ 106+nLinSom, 151 SAY OemToAnsi(STR0037)	   	SIZE 53,07 OF oDlg PIXEL //"- Descontos"
		@ 104+nLinSom, 208 MSGET oDescont VAR nDescont	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_DESCONT") Valid Iif(nOldDescont # nDescont, Fa080Val(nDescont,nTxMoeda,.T.), .T.) .and. nDescont<=xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dBAIXA,,nTxMoeda) .and. if((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .And. nDescont!=aOldValores[1],Help(" ",1,"JACHQSTIT")!=NIL,.t.)
		oDescont:SetEnable( lAcessDes )
		nOldDescont := nDescont

		@ 118+nLinSom, 151 SAY OemToAnsi(STR0038)		SIZE 53,07 OF oDlg PIXEL //"+ Multa"
		@ 116+nLinSom, 208 MSGET oMulta VAR nMulta 				SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_MULTA") Valid Iif(nOldMulta # nMulta, Fa080Val(nMulta,nTxMoeda,.T.), .T.) .and. if((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .and. nMulta!=aOldValores[2],Help(" ",1,"JACHQSTIT")!=NIL,.t.)
		oMulta:SetEnable( lAcessMul )
		nOldMulta := nMulta

	   If cPaisLoc <> "CHI"
			@ 130+nLinSom, 151 SAY OemToAnsi(STR0039)  	SIZE 53,7 OF oDlg PIXEL //"+ Tx.Permanenc."
			@ 128+nLinSom, 208 MSGET oJuros VAR nJuros 			SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_JUROS") Valid Iif(nOldJuros # nJuros, Fa080Val(nJuros,nTxMoeda,.T.), .T.) .and. if((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .and. nJuros!=aOldValores[3],Help(" ",1,"JACHQSTIT")!=NIL,.t.)
			oJuros:SetEnable( lAcessJur )
			nOldJuros := nJuros
		Else
			@ 130+nLinSom, 151 SAY OemToAnsi(STR0117)  	SIZE 53,7 OF oDlg PIXEL //"+ Outros Gastos"
			@ 128+nLinSom, 208 MSGET nOtrga 			SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_OTRGA") Valid Iif(nOldJuros # nOtrga, Fa080Val(nOtrga,nTxMoeda), .T.)
			nOldJuros := nOtrga
		EndIf
		nLinha := 130
		//Get do ISS na baixa
		If lCalcIssBx .and. cPaisLoc == "BRA"
			@ 12+nLinha+nLinSom, 151 SAY "- Iss"	SIZE 53,07 OF oDlg PIXEL
			@ 10+nLinha+nLinSom, 208 MSGET oIss VAR nIss	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
			Valid (Fa080Val(nIss,,.T.))
			nLinha +=12
		Endif

		If lPccBaixa .and. cPaisLoc == "BRA"
			If lIrfMp232
				@ 12+nLinha+nLinSom, 151 SAY "- Irrf"	SIZE 53,07 OF oDlg PIXEL
				@ 10+nLinha+nLinSom, 208 MSGET oIrrf VAR nIrrf	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
				Valid ( Iif(nOldIRRF # nIrrf, Fa080Val(nIrrf,,,.T.), .T.))
				nOldIRRF := nIrrf
				nLinha +=12
			Endif
			@ 12+nLinha+nLinSom, 151 SAY "- Pis"	SIZE 53,07 OF oDlg PIXEL
			@ 10+nLinha+nLinSom, 208 MSGET oPis VAR nPis	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
			Valid ( Iif(nOldPIS # nPis, Fa080Val(nPis,,,.T.), .T.))
			oPis:SetEnable( lAcessImp )
			nOldPIS := nPis
			nLinha +=12
			@ 12+nLinha+nLinSom, 151 SAY "- Cofins" 	SIZE 53,07 OF oDlg PIXEL
			@ 10+nLinha+nLinSom, 208 MSGET oCofins VAR nCofins SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ") ;
			Valid ( Iif(nOldCofins # nCofins, Fa080Val(nCofins,,,.T.), .T.))
			oCofins:SetEnable( lAcessImp )
			nOldCofins := nCofins
			nLinha +=12
			@ 12+nLinha+nLinSom, 151 SAY "- Csll"	SIZE 53,07 OF oDlg PIXEL
			@ 10+nLinha+nLinSom, 208 MSGET oCsll VAR nCsll	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ") ;
			Valid ( Iif(nOldCSLL # nCsll, Fa080Val(nCsll,,,.T.), .T.))
			oCsll:SetEnable( lAcessImp )
			nOldCSLL := nCsll
			nLinha +=12
		Endif

		nValTot	     := SE2->E2_VLCRUZ
		nValEstrang  := nValOrig	  := SE2->E2_SALDO-nTotAbat
		nEstOriginal := nValEstrang-(xMoeda(nJuros+nMulta-nDescont+nOtrga+nImpSubst,1,SE2->E2_MOEDA,,,,nTxMoeda))
		nValMoeda    := Round(Noround(xMoeda(nValOrig				,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
		nValMoeda1   := Round(NoRound(xMoeda(SE2->E2_VALOR-nTotAbat,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
		nValPgto	    := nValMoeda+nMulta+nJuros-nDescont+nOtrga+nImpSubst+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
		nOldValPgto	 := nValPgto
		IF (nMulta+nJuros+nDescont+nOtrga+nImpSubst+nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,,,nTxMoeda),2 ) > 0.01
			nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
		EndIF
		nValLiq	  := nValPgto-nMulta-nJuros+nDescont-nOtrga-nImpSubst-nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss
		FA080CORR(nEstOriginal,nTxMoeda)
		If cPaisLoc <> "CHI"
			@ 12+nLinha+nLinSom, 151 SAY OemToAnsi(STR0041)	 	SIZE 53,07 OF oDlg PIXEL //"= Valor Pago"
			@ 10+nLinha+nLinSom, 208 MSGET oValPgto VAR nValPgto	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
	                   Valid ( oValPgto:Refresh(), FA080REFRE(1), Fa080ValVR(nTxMoeda,nTolerCp))            
			nLinha+=12
		Else
			@ 12+nLinha+nLinSom, 151 SAY OemToAnsi(STR0041)	 	SIZE 53,07 OF oDlg PIXEL //"= Valor Pago"
			@ 12+nLinha+nLinSom, 208 MSGET oValPgto VAR nValPgto	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
	                   Valid ( oValPgto:Refresh(), Fa080ValVR(nTxMoeda), FA080REFRE() )
			nLinha+=12
		EndIf
		If SE2->E2_MOEDA > 1
			@ 12+nLinha+nLinSom, 151 SAY OemToAnsi(STR0042)  + SubStr(GetMV("MV_SIMB"+cMoeda),1,3)    SIZE 53,07 OF oDlg PIXEL //"Valor "
			@ 10+nLinha+nLinSom, 208	MSGET oVlEstrang VAR nValEstrang		SIZE 66,10 OF oDlg PIXEL HASBUTTON ;
						  	Picture PesqPict("SE2","E2_VALOR") Valid	FA080Estrang(nTxMoeda,nTolerCP) .And.;
						  														  	FA080REFRE() .And.;
						  														  	Fa080ValEstrang(	nValEstrang,@nTxMoeda,@nValPgto,dBaixa,oValPgto,oTxMoeda,;
																											nJuros,nMulta,nDescont,nOtrga,nImpSubst,nEstOriginal)
			nLinha += 12
			If cPaisloc <> "CHI"

			   @ 12+nLinha+nLinSom, 151 SAY OemToAnsi(STR0040) 		SIZE 53,07 OF oDlg PIXEL //"+ Corr.Monet ria"
			   @ 10+nLinha+nLinSom, 208 MSGET oCM VAR nCM				SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_CORREC") ;
					When SE2->E2_MOEDA > 1 .and. (IIf(GetMv("MV_CALCCM") == "S",.T.,.F.))
			Else
		      @ 12+nLinha+nLinSom, 151 SAY OemToAnsi(STR0119)				SIZE 53,07 OF oDlg PIXEL //"+/- Dif. Cambio"	   
		      @ 10+nLinha+nLinSom, 208 MSGET oDifCambio VAR nDifCambio	SIZE 66,10 OF oDlg PIXEL HASBUTTON Picture PesqPict("SE2","E2_CAMBIO");
		      When .F.	   
		   EndIf
		Endif
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Atualiza o valor caso seja necessario calcular juros no titulo          ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ		
		If ( cPaisLoc <> "BRA" )
			fa080Data(nTxMoeda)
		Else
			If !lPccBaixa
				fa080Data()
			Endif
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Verifica os botoes de usuarios.³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ExistBlock("FA080BTN")
			aButtons:= ExecBlock("FA080BTN",.F.,.F.,{aButtons})
		EndIf
		
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Verifica os botoes de usuarios no Template.³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If ExistTemplate("FA080BTN")
			aButtons := ExecTemplate("FA080BTN",.F.,.F.,{aButtons})
		EndIf

		If ( cPaisLoc <> "BRA" )
	    	DEFINE SBUTTON oBtnTx FROM 34, 246 TYPE 18 ENABLE OF oDlg ACTION ( nTxMoeda:=Fa080SetMd(), fA080Val(0,nTxMoeda),Fa080ValVR(nTxMoeda), FA080REFRE(1) )
	    	oBtnTx:cToolTip := OemToAnsi(STR0138)
		Endif

		ACTIVATE MSDIALOG oDlg ON INIT EnchoiceBar(oDlg,{||iIf( iIf( !MovBcoBx(cMotBx, .T.),Fa080BDev(),Fa080Cont().and.DtMovFin(dBaixa) .and.fa080Data(@nTxMoeda,.T.,.T.) .and. fa080Cheq(.F.)) ;
		                                                             ,(nOpc1 := 1,oDlg:End()),NIL) ;
                                                        },{||nOpc1 := 0,oDlg:End()},,aButtons) CENTERED

	Else 
		// rotina automatica
	  	lCont := .F.
		aOldValores:={nDescont,nMulta,nJuros,nOTRGA}

		aValidGet:= {}
	   	IF (nT := ascan(aAutoCab,{|x| x[1]='AUTMOTBX'})) > 0
			cMotBx	:=	aAutoCab[nT,2]		// Sergio Fuzinaka - 28.05.02
	 		Aadd(aValidGet,{'cMotBx' ,aAutoCab[nT,2],"fa080BDev()",.t.})
	 	EndIf	
		If MovBcobx(cMotBx, .T.)	// Sergio Fuzinaka - 28.05.02
			IF (nT := ascan(aAutoCab,{|x| x[1]='AUTBANCO'})) > 0
				Aadd(aValidGet,{'cBanco' ,aAutoCab[nT,2],"CarregaSa6(@cBanco,,,.T.)",.t.})		
			Endif	
		    IF (nT := ascan(aAutoCab,{|x| x[1]='AUTAGENCIA'}) ) > 0
				Aadd(aValidGet,{'cAgencia' ,aAutoCab[nT,2],"CarregaSa6(@cBanco,@cAgencia,,.T.)",.t.})		
			EndIf	
		   	IF (nT := ascan(aAutoCab,{|x| x[1]='AUTCONTA'}) ) > 0
				Aadd(aValidGet,{'cConta' ,aAutoCab[nT,2],"CarregaSa6(@cBanco,@cAgencia,@cConta,.T.,,.T.)",.t.})		
			EndIf	
		EndIf	
   	IF (nT := ascan(aAutoCab,{|x| x[1]='AUTDTBAIXA'}) ) > 0
			dBaixa :=	aAutoCab[nT,2]
			Aadd(aValidGet,{'dBaixa' ,aAutoCab[nT,2],"fA080Data()",.t.})		
		EndIf	

		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTDTDEB'}) ) > 0
			dDebito :=	aAutoCab[nT,2]
			Aadd(aValidGet,{'dDebito' ,aAutoCab[nT,2],"(dDebito >= dBaixa  .and. DtMovFin(dDebito))",.t.})		
		EndIf	

		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTCHEQUE'}) ) > 0
			Aadd(aValidGet,{'cCheque' ,aAutoCab[nT,2],"fA080Cheq()",.t.})		
		EndIf	
		IF VisualSX3("E5_HISTOR") .AND. (nT := ascan(aAutoCab,{|x| x[1]='AUTHIST'}) ) > 0
			Aadd(aValidGet,{'cHist070' ,aAutoCab[nT,2],"CheckSX3('E5_HISTOR')",.t.})		
		EndIf	
     
		nOldValor := aOldValores[1]
		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTDESCONT'}) ) > 0
			Aadd(aValidGet,{'nDescont' ,aAutoCab[nT,2],'Fa080Val(nDescont,,.f.) .and. IIF(cPaisLoc<>"CHI",nDescont<=Moeda(SE2->E2_SALDO,1,"P",dBaixa),iF(SE2->E2_MOEDA==1,nDescont<=moeda(SE2->E2_SALDO,1,"P",dBaixa),.T.))  .and. if((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .and. nDescont!=nOldValor,Help(" ",1,"JACHQSTIT")!=NIL,.t.)',.t.})
		EndIf	
            
		nOldValor := aOldValores[2]
		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTMULTA'}) ) > 0
			Aadd(aValidGet,{'nMulta' ,aAutoCab[nT,2],'Fa080Val(nMulta,,.f.) .and. if((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .and. nMulta!=nOldValor,Help(" ",1,"JACHQSTIT")!=NIL,.t.)',.t.})
		EndIf	
			
		nOldValor := aOldValores[3]
		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTJUROS'}) ) > 0
			Aadd(aValidGet,{'nJuros' ,aAutoCab[nT,2],'Fa080Val(nJuros,,.f.) .and. if((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .and. nJuros!=nOldValor,Help(" ",1,"JACHQSTIT")!=NIL,.t.)',.t.})
		EndIf	                    
			
		nOldValor := aOldValores[4]                
		If cPaisLoc == "CHI"
			IF (nT := ascan(aAutoCab,{|x| x[1]='AUTOUTGAS'}) ) > 0
				Aadd(aValidGet,{'nOTRGA' ,aAutoCab[nT,2],'Fa080Val(nOTRGA) .and. if(!fa080Digit() .and. nOTRGA!=nOldValor,Help(" ",1,"JACHQSTIT")!=NIL,.t.)',.t.})		
			EndIf	                             			
		EndIf			               
		
		IF SE2->E2_MOEDA > 1               
			If cPaisLoc == "BRA"
				IF (nT := ascan(aAutoCab,{|x| x[1]='AUTTXMOEDA'}) ) > 0
					nTxMoeda	:=	aAutoCab[nT,2]
					Aadd(aValidGet,{'nTxMoeda' ,aAutoCab[nT,2],"Fa080Val(0,"+STR(nTxMoeda,17,TamSx3("E2_TXMOEDA")[2])+")",.t.})		
				EndIf	                            
			Endif
			IF (nT := ascan(aAutoCab,{|x| x[1]='AUTVLRME'}) ) > 0
				nValEstrang	:=	aAutoCab[nT,2]
				Aadd(aValidGet,{'nValEstrang' ,aAutoCab[nT,2],"Fa080Estrang() .And. Fa080ValEstrang(nValEstrang,"+STR(nTxMoeda,17,TamSx3("E2_TXMOEDA")[2])+",@nValPgto,dBaixa,,,nJuros,nMulta,nDescont,nOtrga,nImpSubst,nEstOriginal)",.T.})
			Else
				nValEstrang := SE2->E2_SALDO-nTotAbat
				lBxEstTotal := .T.				
			EndIf	                            
		ENDIF			
		
		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTBENEF'}) ) > 0
			cBenef :=	aAutoCab[nT,2]
			Aadd(aValidGet,{'cBenef' ,aAutoCab[nT,2],'.t.',.t.})		
		EndIf	                    

		nValTot	  := SE2->E2_VLCRUZ			
		nValOrig	:= SE2->E2_SALDO-nTotAbat
		nEstOriginal := nValEstrang-(xMoeda(nJuros+nMulta-nDescont+nOTRGA,1,SE2->E2_MOEDA))
	
		FA080CORR(nEstOriginal,nTxMoeda)
	
		If !lBxEstTotal
			nValMoeda := Round(Noround(xMoeda(nValOrig,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
			nValPgto	 := nValMoeda+nMulta+nJuros-nDescont+nOtrga+nImpSubst+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
		Else
			nValPgto  := nValEstrang   		
		EndIf
   	
		If cPaisLoc =="CHI" .And. SE2->E2_MOEDA <> 1
			nValPgto	  := nValTot+nMulta+nJuros-nDescont+nOTRGA
		Endif

		IF (nMulta+nJuros+nDescont+nOTRGA) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa),2 ) > 0.01
			nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3),3),2)
		EndIF

		nValLiq	  := nValPgto-nMulta-nJuros+nDescont-nOtrga-nImpSubst-nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss
                        
		IF (nT := ascan(aAutoCab,{|x| x[1]='AUTVLRPG'}) ) > 0
			If aAutoCab[nT,2] != SE2->E2_SALDO
				nPis := nCofins := nCsll := 0
				Aadd(aValidGet,{'nValPgto' ,aAutoCab[nT,2],"Fa080ValVR("+STR(nTxMoeda,17,TamSx3("E2_TXMOEDA")[2])+")",.t.})		
			Endif
		EndIf	                            
		
	 	If ! SE2->(MsVldGAuto(aValidGet)) // consiste os gets
		  	Return .f.
	   EndIf
		nOpc1 := 1
	Endif	
	If nOpc1 == 0
		nErro ++
	EndIf

	If nErro > 2
		nErro :=0
		If Abandona()
			MsUnlock()
			Exit
		Endif
	Endif

	NUMCHEQUE := cCheque	//para contabilizar o numero do cheque

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³ Verifica onde ocorrer  a contabiliza‡„o 										  	³
	*³ Se for informado num. do cheque, deve contabilizar pela baixa			  	³
	*³ Se n„o informou num. do cheque ou num. cheque come‡ar com "*" na gera‡„o³
	*³ Contabiliza tamb‚m caso seja CAIXA.                           		 	   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If (!Empty( cCheque ) .and. SubStr( cCheque, 1, 1 ) != "*" .and. SE2->E2_IMPCHEQ != "S") .or. ;
			cContabiliza = "B" .Or. cContabiliza = "A" .or. ;
			Substr(cBanco,1,2)=="CX" .or. cBanco$GetMV("MV_CARTEIR")
		lContabiliza := .T.
	Endif

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Caso motivo seja VENDOR, dever   ser contabilizado na baixa. 			   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If Empty(cMotBx)
		cMotBx		:= aDescMotBx[1] 	//NORMAL
	Endif

	If TrazCodMot(cMotBx) $ "VEN/DEB"
		lContabiliza := .T.
	EndIF

	If MovBcoBx(cMotBx, .T.) .and. !ChqMotBx(cMotBx)
		lContabiliza := .T.
	EndIF
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Verifica se valor da baixa ‚ maior que valor maximo a pagar 			  ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If nOpc1 == 1 .and. SE2->E2_MOEDA == 1
		IF nOpc1 == 1 .And. Str(nValPgto,17,2) > STR(SE2->E2_SALDO+nJuros+nMulta-nDescont-nTotAbat+nOtrga+nImpSubst+nAcresc-nDecresc+nTolerCp-nPis-nCoFins-nCsll-nIrrf-nIss,17,2)
			Help(" ",1,"ValorMaior")
			If Type('lF080Auto') =='U' .or. ! lF080Auto
				Loop
			Else
				nopc1 := 0
			Endif	
		Endif
	EndIf
         
	If nOpc1 == 1 
		If !Fa080ValCh()
			If Type('lF080Auto') =='U' .or. ! lF080Auto
				Loop
			Else
				nopc1 := 0
			Endif	
		Endif
	EndIf

   //Baixa de titulo em moeda forte com a cotacao da moeda igual a zero !!
	If nOpc1 == 1 .and. SE2->E2_MOEDA > 1 .and. RECMOEDA(dBaixa,cMoeda) == 0 .and. nTxMoeda == 0 .and. ;
			nValPgto == 0 .and. nValEstrang == 0
		Help(" ",1,"TX_MOEDA",, STR0130,1,0)	//"Nao sera possivel baixar este titulo pois a cotacao da moeda do titulo na data da baixa é igual a zero."
		// Se nao for baixa por rotina automatica, volta para o usuario corrigir os
		// dados, senao abandona a baixa.
		If Type('lF080Auto') =='U' .or. ! lF080Auto
			loop
		Else
			nOpc1 := 0
		Endif
	Endif

	If	SE5->(FieldPos("E5_VLACRES")) >0  .and. SE5->(FieldPos("E5_VLDECRE")) >0 .And. nAcresc > nValPgto
		nValPadrao 	:= 0
		nAcresc		:= nValPgto
	Else
		nValPadrao:=nValPgto-(nJuros+Iif(SE2->E2_MOEDA<=1,nCM,0)+nMulta-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss)
	EndIf
	nOpt := IIF(Str(nValPadrao,14,2)=Str(Moeda(SE2->E2_SALDO,1,"P",dBaixa),14,2),1,2)

	If nOpc1 <> 1
		lRet := .F.
		MsUnlock()
		Exit
	Endif

	IF nOpc1 == 1
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Ponto de Entrada - para confirmacao da baixa					³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lFa080Tit
			lRet	:= ExecBlock("FA080TIT",.F.,.F.)
		Endif

		//.....
		//    Conforme situacao do parametro abaixo, integra com o SIGAGSP
		//    MV_SIGAGSP - 0-Nao / 1-Integra
		//    Lancamento de Orcamentacao das Baixas
		//    .......
		If lRet .And. GetNewPar("MV_SIGAGSP","0") == "1" 
			lRet := GSPF050()
		EndIf

		If !lRet
			Return lRet
		EndIf	

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Verifica se modalidade do SPB é valida.									    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lSpbInUse .and. (Type('lF080Auto') =='U' .or. !lF080Auto)
			cModSpb := Substr(cModSpb,1,1)
			IF !(SpbTipo("SE2",cModSpb,SE2->E2_TIPO))
				Loop
			Endif
		Endif

		*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		*³Verifica se n„o h  campos em branco												³
		*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF Empty(cMotBx)
			Help(" ",1,"FA080MOT")
			DbSelectArea("SE2")
			If Type('lF080Auto') =='U' .or. ! lF080Auto
				Loop
			Else
				Exit
			Endif	
		EndIF
		IF SE2->E2_IMPCHEQ != "S"
			IF ((MovBcoBx(cMotBx, .T.) .and. (Empty(dBaixa) .Or. Empty(cBanco) .Or. Empty(cConta))) .Or. ;
					( nValPgto < 0 ))
				Help(" ",1,"FA080VAZ")
				DbSelectArea ("SE2")
				If Type('lF080Auto') =='U' .or. ! lF080Auto
					Loop
				Else
					Exit
				Endif	
			Endif
		Endif

		IF (nTotAbat = 0 .and. nDescont = 0 .and. nDecresc = 0 .and. nPis = 0 .and. ;
			nCofins = 0 .and. nCsll = 0 .and. nIrrf = 0 .and. nIss = 0.and. nValPgto = 0) .or. ;
				(nValPgto=0.and.(nTotAbat+nDescont+nDecresc+nPis+nCofins+nCsll+nIrrf+nIss)!=xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dBaixa,,nTxMoeda))
			Help(" ",1,"FA070INV")
			dbSelectArea("SE2")
			If Type('lF080Auto') =='U' .or. ! lF080Auto
				Loop
			Else
				Exit
			Endif	
		Endif

	 	 If !F080VldRec()
			DbSelectArea("SE2")
			If Type('lF080Auto') =='U' .or. ! lF080Auto
				Loop
			Else
				Exit
			Endif	
		Endif
       
		IF nValPgto != nValLiq .And. TrazCodMot(cMotBx) == "VEN"
			Help(" ",1,"FA080BXPARC")
			dbSelectArea("SE2")
			If Type('lF080Auto') =='U' .or. ! lF080Auto
				Loop
			Else
				Exit
			Endif	
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Rotina de validacao e execucao da baixao via SPB         	³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lSPB 
			IF !F080BxSPB(cClearing,cTipoPgto,cStored,cHora,@cCodBar,@nEventoSpb)
				Loop
			Endif
		Endif				
		*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		*³Soma nos totalizadores														³
		*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		nTotAGer += nValPgto
		nTotADesc+= nDescont+nDecresc
		nTotAMul += nMulta
		nTotAJur += nJuros+nAcresc
		nTotADesp+=Iif(SE2->E2_MOEDA<=1,nCM,0)
		VALOR := nValPgto				
		cPadrao:="530"
		*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		*³Contabiliza se existir o lan‡amento e:									  ³
		*³ - a contabiliza‡„o for feita na baixa (parƒmetro mv_ctBaixa) ou  ³
		*³ - se digitou numero de cheque ou se a contabiliza‡„o for on-line ³
		*³ Verifica existencia do lan‡amento padr„o da baixa e/ou do gera‡„o³
		*³ do t¡tulo referente ao Vendor.											  ³
		*³ Lan‡amento Padr„o referente a baixa   := "530"                   ³
		*³ Lan‡amento Padr„o referente ao Vendor := "518"                   ³
		*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		lPadraoBx := VerPadrao(cPadrao) .And. lContabiliza
		lPadraoVd := VerPadrao( "518" ) .And. lContabiliza

	  	IF Type('lF080Auto') =='U' .or. ! lF080Auto
			// Verifica se esta utilizando multiplas naturezas
			// E chama a rotina para distribuir o valor entre as naturezas
			If MV_MULNATP .and. lMultNat
				MultNatB("SE2",.F.,STR(mv_par05,1),@lOk,@aColsSEV,@lMultNat)
			Endif
		Endif		

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Inicializa a gravacao dos lancamentos do SIGAPCO    ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	    PcoIniLan("000005")

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Inicio da prote‡„o via TTS								  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		Begin Transaction
			lBaixou := fa080Grv(lPadraoBx,lPadraoVd,,cLanca,,nTxMoeda,dDebito)

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Rotina de Gravacao dos dados do SPB								³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If lSPB 
				RecLock("SE2")
				SE2->E2_OKSPB		:= "A"		// Em Aberto, aguardando confirmacao
				SE2->E2_CLEARIN	:= cClearing
				SE2->E2_TPPGTO		:= cTipoPgto
				SE2->E2_HORASPB	:= cHora
				SE2->E2_CODBAR		:= cCodBar
				SE2->E2_EVTSPB		:= nEventoSPB				
				MsUnlock()
			Endif				
			nTotAbat := Round(NoRound(xMoeda(nTotAbat,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
			ABATIMENTO := nTotAbat

			//Reposiciono o arquivo de fornecedores para a contabilizacao
			SA2->(dbSetOrder(1))
			SA2->(MsSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))

			//Reposiciono o arquivo de BANCOS para a contabilizacao
			SA6->(DbSetOrder(1))
	    	SA6->(dbSeek(xFilial("SA6")+cBanco+cAgencia+cConta))

			IF !lAut
            If lPccBaixa
					nOldVlPis := SE2->E2_PIS
					nOldVlCof := SE2->E2_COFINS
					nOldVlCsl := SE2->E2_CSLL
					nOldVlIrf := SE2->E2_IRRF
					nOldVlIss := SE2->E2_ISS         
					
					//Armazeno os valores retidos de impostos, se os mesmos foram gerados por um bordero
					If lBordero
						nOldRetPis := SE2->E2_VRETPIS
						nOldRetCof := SE2->E2_VRETCOF
						nOldRetCsl := SE2->E2_VRETCSL
					EndIf
					
					Reclock("SE2")
					SE2->E2_PIS := nPis
					SE2->E2_COFINS := nCofins
					SE2->E2_CSLL := nCsll
					If lIrfMp232
						SE2->E2_IRRF := nIrrf
					Endif

					If lCalcIssBx
						SE2->E2_ISS := nIss
					Endif
	
					//Gravo valores retidos para o titulo permitindo a contabilizacao
					If lPccBaixa
						SE2->E2_VRETPIS := nPis
						SE2->E2_VRETCOF := nCofins
						SE2->E2_VRETCSL := nCsll
						If SE2->(FieldPos("E2_VRETIRF")) > 0
							SE2->E2_VRETIRF := nIrrf
						Endif
					Endif
					MsUnlock()
				Endif
					
				If MV_MULNATP .and. lMultNat .and. lOk
					lContabMNat := lContabiliza .and. mv_par03 == 1
					MultNatC("SE2",@nHdlPrv,@nTotal,@cArquivo,lContabMNat,.F.,STR(mv_par05,1),,lOk,aColsSEV,lBaixou)
				Endif

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Ponto de entrada antes da contabilizacao.			  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If ExistBlock("F080ACONT")
					ExecBlock("F080ACONT",.F.,.F.)
				EndIf				
	
				IF ( lPadraoBx .or. lPadraoVd ) .and. cLanca == "S" .and. !lMultNat
					nHdlPrv:=HeadProva(cLote,"FINA080",Substr(cUsuario,7,6),@cArquivo)
				Endif
				IF lPadraoBx .and. cLanca == "S"  .and. !lMultNat
					nTotal+=DetProva(nHdlPrv,cPadrao,"FINA080",cLote)
				Endif
				IF lPadraoVd .and. cLanca == "S" .and. TrazCodMot(cMotBx) == "VEN"  .and. !lMultNat
					dbSelectArea( "SE2" )
					IF (dbSeek( cFilial +  Left(SE2-> E2_TITORIG,nTamTitOri)) )
						nTotal+=DetProva(nHdlPrv,"518","FINA080",cLote)
					Endif
				Endif        
						
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Grava os lancamentos nas contas orcamentarias SIGAPCO    ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				PcoDetLan("000005","01","FINA080")

				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Finaliza a gravacao dos lancamentos do SIGAPCO ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				PcoFinLan("000005")
				
				IF ( lPadraoBx .or. lPadraoVd ) .and. cLanca=="S"
					RodaProva(nHdlPrv,nTotal)
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³ Envia para Lancamento Contabil							  ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					lDigita:=IIF(mv_par01==1,.T.,.F.)
					lAglut :=IIF(mv_par02==1,.T.,.F.)
					If lFina080
						Execblock("FINA080",.F.,.F.)
					Endif
					cA100Incl(cArquivo,nHdlPrv,3,cLote,lDigita,lAglut)
					If !Empty( cCheque ) .and. left(cCheque,1) != "*" .and. lGerouSef .and. !SEF->(Eof())
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Atualiza SEF apos contabiliza‡„o			  ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						Reclock("SEF")
						SEF->EF_LA := "S"
						MsUnlock()
					Endif
				Endif
				If lPccBaixa
					Reclock("SE2")
					SE2->E2_PIS := nOldVlPis
					SE2->E2_COFINS := nOldVlCof
					SE2->E2_CSLL := nOldVlCsl
					SE2->E2_IRRF := nOldVlIrf

					//Restauro os valores retidos de impostos, se os mesmos foram gerados por um bordero
					If lBordero
						SE2->E2_VRETPIS := nOldRetPis
						SE2->E2_VRETCOF := nOldRetCof
						SE2->E2_VRETCSL := nOldRetCsl
					EndIf
							
					MsUnlock()
				Endif
	
				If lCalcIssBx
					Reclock("SE2")
					SE2->E2_ISS := nOldVlIss
					MsUnlock()
				Endif
			Endif
		   //Conforme situacao do parametro abaixo, integra com o SIGAGSP, solicitado em 05/10/2004 por Fernando Mazzarolo.
		   //MV_SIGAGSP - 0-Nao / 1-Integra
		   //Integração após a gravação da Baixa
		   If GetNewPar("MV_SIGAGSP","0") == "1" 
		      GSPF350()
		   EndIf
		
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Final  da protecao via TTS								  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		End Transaction
                                           
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Pontos de Entrada 									³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (ExistTemplate( "FA080PE" ) )
			ExecTemplate("FA080PE",.F.,.F.)
		Endif

		If (ExistBlock( "FA080PE" ) )
			ExecBlock("FA080PE",.F.,.F.)
		Endif
	EndIF
	Exit
Enddo
dbSelectArea(cAlias)
If nSalvRec > 0
	dbGoTo(nSalvRec)
EndIf	
dbSetOrder(nOrdem)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fA080Lot ³ Autor ³ Wagner Xavier 		  ³ Data ³ 03/08/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Seleciona titulos a serem baixados								  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Lot()																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FA080Lot(cAlias,nReg,nOpcx)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Salva a integridade dos dados 													 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
LOCAL oDlg
LOCAL oDebConta

LOCAL nSalvRec
LOCAL lGrava:=.F.
LOCAL nOrdem
LOCAL cIndex := ""
Local cLanca := Iif(mv_par03==1,"S","N")
Local cSetFilter := SE2->(DBFILTER()) // Salva o filtro
Local oVencDe
Local oVencAte
Local oLoteFin
Local oBcoLot
Local cMoedaTx, nA := 0
Local aSize := {}
Local oPanel
Local aButton := { { "PESQUISA", { || Fa070Pesq(oMark, "SE2")  }, "Pesquisar..(CTRL-P)","Pesquisar" } }
Local bSet16 := SetKey(16,{||Fa070Pesq(oMark,"SE2")})

PRIVATE cBanco		:=CriaVar("E1_PORTADO")
PRIVATE cAgencia	:=CriaVar("E1_AGEDEP")
PRIVATE cConta		:=CriaVar("E1_CONTA")
PRIVATE nNroTit	:=0
PRIVATE nTotDesp	:=0
PRIVATE nTotJur	:=0
PRIVATE nTotMul	:=0
PRIVATE nDebConta	:=0
PRIVATE nTotDesc	:=0
PRIVATE nTotGer	:=0
PRIVATE nValor		:=0
PRIVATE nQtdtit	:=0
PRIVATE dVencDe	:=Ctod(Space(8))
PRIVATE cNatDe		:=CriaVar("E2_NATUREZ")
PRIVATE dVencATe	:=Ctod(Space(8))
PRIVATE cNatAte	:=CriaVar("E2_NATUREZ")
PRIVATE lInverte 	:= .F.
PRIVATE nOtrga    := 0
PRIVATE nImpSubst := 0
PRIVATE nDifCambio:= 0    
PRIVATE aTxMoedas	  := {}

SX3->(dbSetOrder(1))  // Queiroz Galvao


If cPaisLoc <> "BRA"
	Aadd(aTxMoedas,{"",1,PesqPict("SM2","M2_MOEDA1")})
	For nA	:=	2	To MoedFin()
		cMoedaTx	:=	Str(nA,IIf(nA <= 9,1,2))
	  If !Empty(GetMv("MV_MOEDA"+cMoedaTx))
		 Aadd(aTxMoedas,{GetMv("MV_MOEDA"+cMoedaTx),RecMoeda(dDataBase,nA),PesqPict("SM2","M2_MOEDA"+cMoedaTx) })
		Else
			Exit
		Endif	
	Next
EndIf

While .T.
	nTotAGer  := 0 // Variaveis para acumulo dos valores
	nTotADesp := 0 // na baixa
	nTotADesc := 0
	nTotAMul	 := 0
	nTotAJur	 := 0

	cMarca := Get080Mark()	
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Salva ordem atual 																  ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea( cAlias )
	nOrdem 	:= IndexOrd()
	nSalvRec := Recno()
	nOpc1 	:= 0	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Desenha tela padrao do browse											³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nValor := 0
	nQtdtit:= 0
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Verifica se data do movimento n„o ‚ menor que data limite de ³
	//³ movimentacao no financeiro    										  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !DtMovFin()
		Exit
	Endif

	DEFINE MSDIALOG oDlg FROM	102,5 TO 301,607 TITLE OemToAnsi(STR0058)	PIXEL //"Baixa a Pagar em Lote"

	@ 02, 004 TO 98, 83  LABEL OemToAnsi(STR0059) 	 		OF oDlg  PIXEL //"Dados Banc rios"
	@ 02, 086 TO 98, 204 LABEL OemToAnsi(STR0060) 			OF oDlg	PIXEL //"Valores"
	@ 02, 207 TO 73, 299 LABEL OemToAnsi(STR0061)			OF oDlg  PIXEL //"Filtragem"
	@ 15, 09 SAY OemToAnsi(STR0022)				SIZE 30, 7 	OF oDlg PIXEL //"Banco"
	@ 12, 35 MSGET oBcoLot VAR cBanco			SIZE 20, 10 OF oDlg PIXEL Picture "@!" F3 "SA6" Valid ;
		CarregaSa6(@cBanco,@cAgencia,@cConta,.T.) .And. fa080BcoCx()
	@ 29, 09 SAY OemToAnsi(STR0023)			  	SIZE 30, 7  OF oDlg PIXEL //"Agˆncia"
	@ 26, 35 MSGET cAgencia 						SIZE 25, 10 OF oDlg PIXEL Picture "@!" Valid ;
		CarregaSa6(@cBanco,@cAgencia,@cConta,.T.)
	@ 42, 09 SAY OemToAnsi(STR0024)				SIZE 29, 7  OF oDlg PIXEL //"Conta"
	@ 40, 35 MSGET cConta							SIZE 38, 10 OF oDlg PIXEL Picture "@!" Valid ;
		IF(CarregaSa6(@cBanco,@cAgencia,@cConta,.T.,,.T.),.T.,oBcoLot:SetFocus())
	@ 56, 09 SAY OemToAnsi(STR0062)				SIZE 30, 7	OF oDlg PIXEL //"N.Titulos"
	@ 54, 35 MSGET nNroTit							SIZE 13, 10 OF oDlg PIXEL Picture "999" Valid nNroTit > 0
	@ 70, 09 SAY OemToAnsi(STR0063)				SIZE 29, 7  OF oDlg PIXEL //"Lote"
	@ 69, 35 MSGET oLoteFin VAR cLoteFin 		SIZE 19, 10 OF oDlg PIXEL ;
		When UltiLote() ;		
		Valid CheckLote("P") Picture "@!"
	@ 14, 093 SAY OemToAnsi(STR0064)	  		SIZE 53, 7  OF oDlg PIXEL //"Valor T¡tulos"
	@ 11, 142 MSGET nTotGer							SIZE 50, 10 OF oDlg PIXEL Picture  PesqPict("SE2","E2_VALOR") Valid MontaTot(oDebConta)
	@ 27, 093 SAY OemToAnsi(STR0065)	 		SIZE 53, 7  OF oDlg PIXEL //"Total Despesas"
	@ 25, 142 MSGET nTotDesp						SIZE 50, 10 OF oDlg PIXEL Picture PesqPict("SE2","E2_VALOR") Valid MontaTot(oDebConta)
	@ 42, 093 SAY OemToAnsi(STR0066) 			SIZE 53, 7  OF oDlg PIXEL //"Total Descontos"
	@ 39, 142 MSGET nTotDesc						SIZE 50, 10 OF oDlg PIXEL Picture PesqPict("SE2","E2_DESCONT") Valid MontaTot(oDebConta)
	@ 56, 093 SAY OemToAnsi(STR0067)			SIZE 53, 7	OF oDlg PIXEL //"Total Multas"
	@ 54, 142 MSGET nTotMul 						SIZE 50, 10 OF oDlg PIXEL Picture PesqPict("SE2","E2_MULTA") Valid MontaTot(oDebConta)
	@ 70, 093 SAY OemToAnsi(STR0068)			SIZE 53, 7	OF oDlg PIXEL //"Total Juros"
	@ 69, 142 MSGET nTotJur 						SIZE 50, 10 OF oDlg PIXEL Picture PesqPict("SE2","E2_JUROS") Valid MontaTot(oDebConta)
	@ 85, 093 SAY OemToAnsi(STR0069)	  		SIZE 53, 7  OF oDlg PIXEL //"D‚bito em C/C"
	@ 83, 142 MSGET oDebConta VAR nDebConta	SIZE 50, 10 OF oDlg PIXEL Picture PesqPict("SE2","E2_VALOR")

	@ 16, 211 SAY OemToAnsi(STR0070) 			SIZE 44, 7	OF oDlg PIXEL //"Do Vencto."
	@ 14, 251 MSGET oVencDe VAR dVencDe			SIZE 37, 10 OF oDlg PIXEL Valid ! Empty(dVencDe)
	oVencDe:cReadVar := "DVENCINI"  // Help
	@ 30, 211 SAY OemToAnsi(STR0071) 			SIZE 42, 7	OF oDlg PIXEL //"Até o Vencto."
	@ 28, 251 MSGET oVencAte VAR dVencAte		SIZE 37, 10 OF oDlg PIXEL Valid dVencAte >= dVencDe
	oVencAte:cReadVar := "DVENCFIM" // Help
	@ 45, 211 SAY OemToAnsi(STR0072) 	  		SIZE 39, 7  OF oDlg PIXEL //"Da Natureza"
	@ 42, 251 MSGET cNatDe							SIZE 37, 10 OF oDlg PIXEL Picture "@!" F3 "SED"
	@ 59, 211 SAY OemToAnsi(STR0073)   		SIZE 45, 7  OF oDlg PIXEL //"At‚ a Natureza"
	@ 57, 251 MSGET cNatAte 						SIZE 37, 10 OF oDlg PIXEL Picture "@!" Valid cNatAte >= cNatDe F3 "SED"

	DEFINE SBUTTON FROM 80, 224 TYPE 1 ENABLE OF oDlg ACTION (nOpc1 := 1,IIF(Empty(cLoteFin),(oLoteFin:SetFocus(),nOpc1 := 0),oDlg:End()))
	DEFINE SBUTTON FROM 80, 254 TYPE 2 ENABLE OF oDlg ACTION (nOpc1 := 0,oDlg:End())

	ACTIVATE MSDIALOG oDlg VALID (iif(nOpc1==1,Fa080Cont().and. ValidaTot(cLoteFin),.t.)) CENTERED

	If nOpc1 != 1
		Exit
	Endif

	dbSelectArea( cAlias )

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Execblock a ser executado antes da Indregua                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF ExistBlock("F080FIL")
		cFil080 := ExecBlock("F080FIL",.f.,.f.)
	Else
		cFil080 := ""
	Endif

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Filtra o arquivo para titulos em abertos							  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	cIndex := CriaTrab(nil,.f.)
	cChave	:= IndexKey()
	IndRegua("SE2",cIndex,cChave,,FA080ChecF(),OemToAnsi(STR0074) ) //"Selecionando Registros..."
	nIndex := RetIndex("SE2")
	dbSelectArea("SE2")
	#IFNDEF TOP
		dbSetIndex(cIndex+ordBagExt())
	#ENDIF
	dbSetOrder(nIndex+1)
	DbGoTop()
	IF BOF() .and. EOF()
		Help(" ",1,"RECNO")
		Exit
	EndIF

	nValor	:= 0		// valor total dos T¡tulos,mostrado no rodape do browse
	nQtdtit	:= 0		// quantidade de T¡tulos,mostrado no rodape do browse
	nOpca		:= 0

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Faz o calculo automatico de dimensoes de objetos     ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aSize := MSADVSIZE()	

	DEFINE MSDIALOG oDlg1 TITLE STR0075 From aSize[7],0 To aSize[6],aSize[5] OF oMainWnd PIXEL //"Baixa em Lote"
	oDlg1:lMaximized := .T.

	Dbeval( { |a| FA080Dbeva() } )

	oPanel := TPanel():New(0,0,'',oDlg1,, .T., .T.,, ,15,15,.T.,.T. )
	oPanel:Align := CONTROL_ALIGN_TOP

	@3,5 Say STR0076 PIXEL Of oPanel // "Valor Total:"
	@3,60 Say oValor VAR nValor Picture PesqPict("SE2","E2_VALOR") PIXEL Of oPanel
	@3,120 Say STR0077 PIXEL Of oPanel// "Quantidade:"
	@3,150 Say oQtda VAR nQtdTit Picture "@E 99999" SIZE 50,10 PIXEL of oPanel

	oMark := MsSelect():New(cAlias,"E2_OK","!E2_SALDO",,@lInverte,@cMarca,{35,oDlg1:nLeft,oDlg1:nBottom,oDlg1:nRight})
	oMark:bMark := {| | finaDisplay(cMarca,lInverte,oValor,oQtda,"P")}
	oMark:oBrowse:lhasMark = .t.
	oMark:oBrowse:lCanAllmark := .t.
	oMark:oBrowse:bAllMark := { || FA080Inverte(cMarca,oValor,oQtda) }
	oMark:oBrowse:Align := CONTROL_ALIGN_ALLCLIENT

	ACTIVATE MSDIALOG oDlg1 ON INIT EnchoiceBar(oDlg1,{|| nOpca := 1,oDlg1:End()},{|| nOpca := 2,oDlg1:End()},,aButton) CENTERED
	SetKey(16,bSet16)																

	IF nOpcA == 1
		lGrava :=fA080Grava(cLanca)
	Endif
	Exit

EndDO
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Restaura os indices 												 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SE2")
RetIndex("SE2")
#IFNDEF TOP
	IF cIndex != ""
		FErase (cIndex+OrdBagExt())
	EndIF
#ENDIF

dbSetOrder(nOrdem)
If nSalvRec > 0
	dbGoTo(nSalvRec)
EndIf	
cLoteFin := SPACE(4)
// Restaura o filtro, para que o usuario que utilizar filtro atraves do PE F080BROW
// nao perca este filtro.
Set Filter to &cSetFilter.
Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fa080Can ³ Autor ³ Wagner Xavier 		  ³ Data ³ 06/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Rotina de Cancelamento de Baixa a pagar						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fa080can(ExpC1,ExpN1,ExpN1)										  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080Can(cAlias,nReg,nOpcx,aEncho,nOpBaixa)
LOCAL oDlg
LOCAL lOk := .F.
LOCAL lDigita := IIF(mv_par01==1,.T.,.F.)
LOCAL nHdlPrv := 0
LOCAL nTotal := 0
LOCAL lPadraoBx
LOCAL nOrdem
LOCAL lPadraoVd
LOCAL cArquivo
LOCAL nSalvRec := 0
LOCAL cParcela
LOCAL cNum
LOCAL cPrefixo
LOCAL dBaixa 
Local dDebito
LOCAL cAgencia	:= CriaVar("E1_AGEDEP")
LOCAL cCheque	:= CriaVar("EF_NUM")
LOCAL cFornece
LOCAL cMoeda
LOCAL cTitAnt
LOCAL cDescrMo	:= " "
LOCAL aBaixa 	:= {}
LOCAL cTipo
LOCAL nJuros 	:= 0
LOCAL nMulta 	:= 0
LOCAL nCorrec 	:= 0
LOCAL nDescont := 0
LOCAL nAcresc   := 0
LOCAL nDecresc  := 0
LOCAL dDataAnt
LOCAL lBaixaAbat	:= .F.
LOCAL cSequencia 	:= "  "
LOCAL cParcCanc   := ""
LOCAL nRegB
LOCAL lVend 		:= .F.
LOCAL nRegV
LOCAL lCheque 		:= .F.
LOCAL cBenef 		:= ""
LOCAL lContabilizou
LOCAL cNumCheq		:= CRIAVAR("EF_NUM")
LOCAL lEstorna
LOCAL nTotAdto 	:= 0
LOCAL cSeqSe5 		:= "  "
LOCAL nTxMoeda := 0
LOCAL cTipoDoc := ""
LOCAL aAux := {}
LOCAL nI := 0
LOCAL nRecDelSef := 0
LOCAL nRecSe5    := 0
Local lRet := .T.
Local lFa080Own := ExistBlock("FA080OWN")
Local aMotBx:= ReadMotBx()
Local cPadrao
Local cTitOriV := CRIAVAR("E2_TITORIG")
Local lBaixaOk	:= .T.
Local nOrdSa6, nRecSa6
Local nDifCambio := 0
Local nImpSubst   := 0
Local nOtrga     := 0
Local nAtraso := 0
Local lSPB := VerCpoSPB()  // Bank of America
Local lLanca	:= Iif(mv_par03==1,.T.,.F.)
Local lCnab 	:= .F.
Local cModSPB := "1"	// Modalidade de SPB
Local aModalSpb := {"TED","CIP","COMP"}
Local cDescSpb := "TED"
Local lSpbInUse := SpbInUse()
Local nTamTitOri := TamParcela("E2_PARCELA",19,20,21)
Local lSetDeleted := SET(_SET_DELETED)
Local	cSefOrigem := ""
Local	lDeleted		:= .F.
Local cEfImpress	:= ""
Local lBxCEC 		:= .F.  //Verificador de existencia de baixa por compensacao entre carteiras

Local lAcreDecre := .F.
Local nMoedaBco  := 1
Local nMoedaTit  := SE2->E2_MOEDA
Local nTxModBco  := 0
Local nTxModTit  := 0
//Controla o Pis Cofins e Csll na baixa
Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )

Local lContrRet := !Empty( SE2->( FieldPos( "E2_VRETPIS" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE2->( FieldPos( "E2_VRETCSL" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETPIS" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_PRETCOF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETCSL" ) ) )

Local nPis := 0
Local nCofins := 0 
Local nCsll := 0

//Variaveis utilizadas na contabilizacao do estorno
Local nPisOld	:= 0
Local nCofOld	:= 0
Local nCslOld	:= 0
Local nVRPisOld := 0
Local nVRCofOld := 0
Local nVRCslold := 0


Local aImp := {}
Local nLinha := 0
Local nX := 0
Local lNotBax 	:= .F.
Local lAglImp  := .F. 
LOCAL aHelpPor 	:= {}
LOCAL aHelpEng 	:= {}
LOCAL aHelpSpa 	:= {}
Local nCentMd1	:= MsDecimais(1)

LOCAL nTotImpost 	:= 0  //Valores de baixas de por geracao de impostos

Local lIrfMp232 := .F.

Local nIrrf := 0

Local lRetSoIrf := .F.  //Baixa reteve apenas IRRF

Local cParcPis := ""
Local cParcCof := ""
Local cParcCsl := ""
Local lAchouRel := .F.
Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)

Local nIss := 0                                    
Local lBxConc  := GetNewPar("MV_BXCONC","2") == "1"                            

Default nOpBaixa := 1
                             
nPagtoParcial	:=	0
PRIVATE aBaixaSE5 := {}

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Procura pelas baixas deste titulo                                     ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aBaixa := Sel080Baixa("VL /BA /CP /",SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,@nTotAdto,@lBaixaAbat,SE2->E2_FORNECE,SE2->E2_LOJA,@lBxCec,.T.,@lNotBax,@nTotImpost,@lAglImp)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se o Titulo nao sofreu nenhuma baixa 								 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF Empty(SE2->E2_BAIXA) .And. ( Len(aBaixa)<=0 )
	Help(" ",1,"TITNAOXADO")
	Return
EndIF


//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se o Titulo teve cheque sobre titulo						 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF !Empty(SE2->E2_IMPCHEQ) 
	Help(" " , 1 , "FA080TEMCH")
	Return
EndIF

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se data do movimento n„o ‚ menor que data limite de ³
//³ movimentacao no financeiro    										  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !DtMovFin()
	Return
Endif

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Verifica se ‚ um registro Principal												³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF SE2->E2_TIPO $ MVABATIM
	Help(" ",1,"NAOPRINCIP")
	Return
Endif

//verifica se existem os campos de valores de acrescimo e decrescimo no SE5
If SE5->(FieldPos("E5_VLACRES")) > 0 .and. SE5->(FieldPos("E5_VLDECRE")) > 0
	lAcreDecre := .T.
Endif           

dbSelectArea("SE2")
nOrdem:=IndexOrd()
dbSetOrder(1)

cMoeda := IIF(Empty(SE2->E2_MOEDA),"1",AllTrim(Str(SE2->E2_MOEDA,2)))
nSalvRec := SE2->( RecNO() )
cNum		:= SE2->E2_NUM
cPrefixo := SE2->E2_PREFIXO
cParcela := SE2->E2_PARCELA
cFornece := SE2->E2_FORNECE
cTipo 	:= SE2->E2_TIPO
cLoja 	:= SE2->E2_LOJA
nTotAbat := 0
nValPgto := SE2->E2_VALLIQ
dBaixa	:= SE2->E2_BAIXA
nTotAbat := SumAbatPag( cPrefixo, cNum, cParcela, cFornece, SE2->E2_MOEDA,"V",dBaixa,cLoja )
If cPaisLoc == "CHI"
	nOtrga     := IIf (SE2->(FieldPos("E2_OTRGA"))> 0,SE2->E2_OTRGA,0)              		
	nDifCambio := IIf (SE2->(FieldPos("E2_CAMBIO"))> 0,SE2->E2_CAMBIO,0)              		
	nImpSubst  := IIf (SE2->(FieldPos("E2_IMPSUBS"))> 0,SE2->E2_IMPSUBS,0)              		
EndIf
nAcresc  := SE2->E2_ACRESC
nDecresc := SE2->E2_DECRESC
SE2->( dbGoTo( nSalvRec ) )
SA2->(dbSetOrder(1))
SA2->(MSSEEK(xFilial("SA2")+SE2->(E2_FORNECE+SE2->E2_LOJA)))
lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Escolhe Baixa a ser cancelada												  ³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If Type('lF080Auto') =='U' .or. ! lF080Auto
	If Len(aBaixa) > 1
		cListBox := aBaixa[1]
		nOpbaixa := 1
		DEFINE MSDIALOG oDlg FROM 5, 5 TO 14, 50 TITLE OemToAnsi(STR0080) //"Escolha A Baixa"
	
		@	.5, 2 LISTBOX nOpBaixa ITEMS aBaixa SIZE 150 , 40 Font oDlg:oFont
		DEFINE SBUTTON FROM 055,112	TYPE 1 ACTION (lOk := .T.,oDlg:End()) ENABLE OF oDlg
		DEFINE SBUTTON FROM 055,139.1 TYPE 2 ACTION (lOk := .F.,oDlg:End()) ENABLE OF oDlg
	
		ACTIVATE MSDIALOG oDlg CENTERED
		If !lOk
			Return Nil
		Endif   
	Else
	   nOpbaixa := 1
	EndIF		
Else
	If nOpBaixa > Len(aBaixa)
		nOpBaixa := 1
	Endif	
Endif	
If Len(aBaixa) == 0
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Procura pelas compensa‡”es															³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lBxCEC  //Compensacao entre carteiras
		Help(" ",1,"BX_CEC")
	ElseIf  SE5->(dbSeek(xFilial("SE5")+"CP"+cPrefixo+cNum+cParcela+cTipo))
		Help(" ",1,"TITULOADT")
	ElseIf SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG .and. !lBaixaAbat
		Help(" ",1,"TITULOADT")
	ElseIf lNotBax	  
		//ÚÄÄÄÄÄÄ¿
		//³HELP'S³
		//ÀÄÄÄÄÄÄÙ
	 	// Espanhol
 		Aadd(aHelpSpa,"No se encontro ninguna baja que pueda"   )
 		Aadd(aHelpSpa,"ser anulada por esta rutina."            )
	 	// Portugues
 		Aadd(aHelpPor,"Nao foi encontrada nenhuma baixa que"    )
 		Aadd(aHelpPor,"possa ser cancelada por esta rotina."    )
	 	// Ingles
 		Aadd(aHelpEng,"No post. was found that can be canceled" )
 		Aadd(aHelpEng,"by this process."                        )
		PutHelp("PA080ORDREC",aHelpPor,aHelpEng,aHelpSpa,.F.)
 		Help(" ",1,"A080ORDREC")
	ElseIf nTotImpost > 0 .and. !Empty(SE2->E2_NUMBOR)
		Help(" ",1,"BXBORD",,STR0151 +CHR(13)+CHR(10)+CHR(13)+CHR(10)+ STR0152,1,1) // "Baixa realizada por geração de impostos (Pis, Cofins ou Csll) via borderô. Para o cancelamento desta, utilize a rotina de Cancelamento do borderô."
	ElseIf lAglImp
		Help(" ",1,"BXAGLUT",,STR0154+CHR(13)+CHR(10)+CHR(13)+CHR(10)+STR0155,1,1) //"O titulo de imposto selecionado sofreu aglutinação. Para o cancelamento" ## "desta baixa, utilize a rotina de Aglutinação de Impostos (FINA378)." 
	Elseif Empty( SE2 -> E2_FATURA )
		Help(" ",1,"BAIXTITINC")
	Else
		Help(" ",1,"TITFATURAD")
	EndIF
	Return
EndIF


//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Pega os Valores da Baixa Escolhida 											 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dBaixa		:= aBaixaSE5[nOpBaixa,07]
dDebito     :=aBaixaSE5[nOpBaixa,14]
cSequencia 	:= aBaixaSE5[nOpBaixa,09]
cChave      := SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO+Dtos(dBaixa)+cFornece+cLoja+cSequencia
cParcCanc 	:= aBaixaSE5[nOpBaixa,03]

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica se data do cancelamento ‚ menor que a data da baixa ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If dBaixa > dDataBase
	Help(" ",1,"DTBAIXA")
	Return
Endif

dbSelectArea("SE5")
SE5->(dbSetOrder(2))
cTipoDoc := "CM/CX/DC/MT/JR/BA/VL/"
IIf(cPaisloc == "CHI",cTipoDoc += "IS/",.T.)
For nI := 1 to len( cTipoDoc) Step 3
	IF SE5->( dbSeek(xFilial("SE5")+substr(cTipoDoc,nI,2)+cChave) )
		If ( cPaisloc <> "BRA" )
			nMoedaBco  := Max( Val(SE5->E5_MOEDA), 1)
			nMoedaTit  := SE2->E2_MOEDA
			nTxModBco  := If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA, RecMoeda(SE5->E5_DATA,nMoedaBco) )
			nTxModTit  := RecMoeda(SE5->E5_DATA,nMoedaTit)
		Endif
		If substr(cTipoDoc,nI,2 ) $ "CM/CX"
			If ( cPaisLoc <> "BRA" )
				If ( cPaisloc <> "CHI" )
					nCorrec		:= xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
				Else
					nDifcambio	:= xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
				Endif
			Else
				nCorrec := SE5->E5_VALOR
			Endif
		ElseIf substr(cTipoDoc,nI,2 ) $ "DC"
			If ( cPaisLoc <> "BRA" )
				nDescont:= xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
			Else
				nDescont:= SE5->E5_VALOR
			Endif
		ElseIf substr(cTipoDoc,nI,2 ) $ "MT"
			If ( cPaisLoc <> "BRA" )
				nMulta	:= xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
			Else
				nMulta	:= SE5->E5_VALOR
			Endif
		ElseIf substr(cTipoDoc,nI,2 ) $ "JR"
			If ( cPaisLoc <> "BRA" )
				If ( cPaisloc <> "CHI" )
					nJuros := xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
				Else
					nOtrga := xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
				Endif
			Else
				nJuros := SE5->E5_VALOR
			Endif
		ElseIf substr(cTipoDoc,nI,2 ) $ "BA/VL"
			If cPaisLoc <> "BRA" .And. !Empty(SE5->E5_BANCO)
				SA6->(DbSetOrder(1))
				SA6->(MsSeek(xFilial()+SE5->E5_BANCO+SE5->E5_AGENCIA+SE5->E5_CONTA))
				If( Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1) )== 1
			  	  	nValPgto := SE5->E5_VALOR
			   	nValestrang := SE5->E5_VLMOED2
			   Else
			   	nValestrang := SE5->E5_VALOR
			  		nValPgto := SE5->E5_VLMOED2
				Endif
			Else
				nValPgto := SE5->E5_VALOR
				nValestrang := SE5->E5_VLMOED2
			Endif
			cHist070 := SE5->E5_HISTOR
			cMotBx   := SE5->E5_MOTBX
			cNumBor  := SubStr(SE5->E5_DOCUMEN,1,6)
			cLoteFin := SE5->E5_LOTE
			nRecSe5  := SE5->(RecNo())
			
			cHistCan070 := PADR(IIF(Empty(SE5->E5_LOTE),STR0114,STR0113+SE5->E5_LOTE),TamSx3("E5_HISTOR")[1]) // Cancelamento de baixa###"Canc Baixa Lote "
			cMultNat	:= SE5->E5_MULTNAT
			cSeqSE5	:= SE5->E5_SEQ
			nPis := nCofins := nCsll := nIrrf := nIss := 0 
			If lPccBaixa
				If Empty(SE5->E5_PRETPIS)
					nPis := SE5->E5_VRETPIS
				Endif
				If Empty(SE5->E5_PRETCOF)
					nCofins := SE5->E5_VRETCOF
				Endif
				If Empty(SE5->E5_PRETCSL)
					nCsll := SE5->E5_VRETCSL
				Endif
				If lIrfMp232
					If Empty(SE5->E5_PRETIRF)
						nIrrf := SE5->E5_VRETIRF
					Endif
				Endif
			Endif

			If lCalcIssBx
				nIss := SE5->E5_VRETISS
			Endif

		ElseIf substr(cTipoDoc,nI,2 ) $ "IS" 	//Localizacao Chile
			If ( cPaisLoc <> "BRA" )
				nImpsubst := xMoeda( SE5->E5_VALOR, nMoedaBco, 1, SE5->E5_DATA,, nTxModBco )
			Else
				nImpsubst := SE5->E5_VALOR
			Endif
		EndIF
	EndIF
Next

lEstorna 	 := Iif(Empty(cNumBor),.F.,.T.)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se foi utilizada taxa contratada para moeda > 1          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbGoTo(nRecSe5)		//volta para o registro principal

//Nao permito cancelamento de baixa se a mesma foi conciliada e se
//o parametro MV_BXCONC estiver como 2(Padrao) - Nao permite
If !Empty(SE5->E5_RECONC) .And. !lBxConc
	Help(" ",1,"BXCONCIL")
	dbSelectArea("SE1")
	Return
Endif

If cPaisLoc <>"BRA"
	SA6->( DbSetOrder(1) )
	SA6->( MsSeek(xFilial("SA6")+SE5->(E5_BANCO+E5_AGENCIA+E5_CONTA) ) )
	If Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1) == 1
		
		If SE2->E2_MOEDA > 1 .and. Round(NoRound(xMoeda(nValpgto,1,SE2->E2_MOEDA,dBaixa,3),3),2) != SE5->E5_VLMOED2
			nTxMoeda := Noround((SE5->E5_VALOR / SE5->E5_VLMOED2),5)
		Else
			nTxMoeda := RecMoeda(dBaixa,SE2->E2_MOEDA)
		Endif
	Else
		If SE2->E2_MOEDA > 1 .and. Round(NoRound(xMoeda(nValpgto,1,SE2->E2_MOEDA,dBaixa,3),3),2) != SE5->E5_VALOR
			nTxMoeda := Noround((SE5->E5_VLMOED2/SE5->E5_VALOR),5)
		Else
			nTxMoeda := RecMoeda(dBaixa,SE2->E2_MOEDA)
		Endif        
	
		
	EndIf
Else	
	If SE2->E2_MOEDA > 1 .and. Round(NoRound(xMoeda(nValpgto,1,SE2->E2_MOEDA,dBaixa,3),3),2) != SE5->E5_VLMOED2
		nTxMoeda := Noround((SE5->E5_VALOR / SE5->E5_VLMOED2),5)
	Else
		nTxMoeda := RecMoeda(dBaixa,SE2->E2_MOEDA)
	Endif 
EndIf
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Caso moeda ==1 a funcao RecMoeda iguala nTxMoeda = 0. Iguala-se    ³
//³nTxMoeda = 1 p/ evitar problema c/ calculos de abatimento e outros.³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nTxMoeda := IIF(nTxMoeda == 0 , 1 , nTxMoeda)

// Se nao for titulo de imposto, verifica se um dos titulos de impostos já foi baixado e nao permite a exclusao
If !SE2->E2_TIPO $ MVISS+"/"+MVTAXA+"/"+MVTXA+"/"+MVINSS+"/"+"SES"
	If !Fa050Filho(.T.)
		Help(" ",1,"NODELETA",,STR0153, 4, 0) // "Este titulo possui impostos e"+chr(13)+"um desses impostos sofreu baixa."
		Return .F. 
	Endif	
Endif

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Verifica se foi ja foi gerado cheque para esta baixa; se o cheque ³
*³ ja foi gerado nao permite o cancelamento								  ³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SEF")
dbSetOrder(3)
If !(SE5->E5_TIPO $ MVPAGANT)
		// Devido a verificacao do "MV_CTBAIXA" $ "BA" 
	// nao conseguiamos contabilizar o LP 531 quando o cheque era gerado
	// no momento da baixa do titulo, a contabilizacao efetuada pelo LP 530 e o
	// MV_CTBAIXA fosse igual a C. Para cancelar a baixa, o usuario precisa cancelar o
	// cheque primeiro. Entao pesquisamos com Set Deleted Off para verificar
	// se o cheque gerado para a baixa e permitir a contabilizacao do LP 531.
	SET(_SET_DELETED, .F.)	// Habilita pesquisa nos cheques deletados, para verificar
									// se a contabilizacao deva ocorrer pelo 531
	If SEF->(dbSeek(xFilial()+SE5->E5_PREFIXO+SE5->E5_NUMERO+SE5->E5_PARCELA+SE5->E5_TIPO))
		cSeqSe5 := SE5->E5_SEQ

		While SEF->( !Eof()) .and. EF_FILIAL == xFilial() 		.and. ;
				EF_TITULO == SE5->E5_NUMERO	.and. ;
				EF_PARCELA== SE5->E5_PARCELA .and. ;
				EF_PREFIXO== SE5->E5_PREFIXO .and. ;
				EF_TIPO   == SE5->E5_TIPO		

			If Str(SE5->E5_VALOR,17,2)	 == Str(SEF->EF_VALOR,17,2)	.And.;
				SEF->EF_SEQUENC == cSeqSe5			.And.;
				SE5->E5_CLIFOR  == SEF->EF_FORNECE
				
				nRecDelSef	:= SEF->( RecNo() )
				lEstorna 	:= .F.  //achou cheque para esta baixa
				cEfImpress	:= SEF->EF_IMPRESS
				cSefOrigem	:= SEF->EF_ORIGEM
				lDeleted		:= SEF->(Deleted())
				lCheque		:= .F.

				// Permite a baixa se houver cheque cancelado.
				IF SEF->EF_IMPRESS # "C"
					lCheque		:= .T.
					cNumCheq		:= SEF->EF_NUM
					cBenef		:= SEF->EF_BENEF 
				Endif
				// Como o SET DELETED esta desligado, verifica se o registro eh valido
				// para sair do LOOP, pois o que vale sao os dados do utlimo cheque
				// gravado no SEF, quando existirem registros identicos mas, um ou mais
				// registros estiverem deletados.
				If SEF->(!Deleted())
					Exit
				Endif	
			Endif
			SEF->( dbSkip() )
		Enddo
	Endif
EndIf
dbSelectArea("SEF")
dbSetOrder(1)

lContabilizou:= Iif(SE5->E5_LA="S",.T.,.F.)

nValPadrao	:= nValPgto-(nJuros+nMulta-nDescont-nPis-nCoFins-nCsll-nIrrf-nIss)
nSalDup		:= SE2->E2_SALDO-nValPadrao

cBanco := aBaixaSE5[nOpbaixa,11]
cAgencia := aBaixaSE5[nOpBaixa,12]
cConta := aBaixaSE5[nOpBaixa,13]

dbSelectArea("SEF")
dbSetOrder(1)
If (lCheque .and. !Empty(cNumcheq)) .Or. (!Empty(SE2->E2_NUMBCO) .and. !Empty(cEfImpress) .and. !SE2->E2_TIPO $ MVPAGANT )
	If !lDeleted // Achou um cheque e este nao esta deletado, avisa e nao permite o 
					 // cancelamento da baixa
		SET(_SET_DELETED,lSetDeleted) // Restaura ambiente
		Help(" " , 1 , "FA080TEMCH")
		dbSelectArea("SE2")
		Return
	Endif	
Endif

If !GetMv("MV_CTBAIXA") $ "BA" .And. !TrazCodMot(cMotBx) $ "VEN/DEB"
	lContabilizou := .F.
EndIf

SET(_SET_DELETED,lSetDeleted) // Restaura ambiente
dbSelectArea("SE5")
dbGoTo(nRecSe5)		//volta para o registro principal

nI :=  Ascan(aMotBx, {|x| Substr(x,1,3) == Upper(cMotbx) })
cDescrMo := if( nI > 0,Substr(aMotBx[nI],07,10),"" )

SA2->( dbseek( xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))
dbSelectArea("SE2")
RecLock("SE2")
cNomeFor      := SE2->E2_FORNECE + " " + SA2->A2_NOME
cTitulo := SE2->E2_PREFIXO + " " + SE2->E2_NUM+ " " + SE2->E2_PARCELA
	nPagtoParcial := SE2->E2_VALOR-SE2->E2_SALDO
cTexto	     := OemToAnsi(STR0084) + SubStr(GetMV("MV_SIMB"+cMoeda),1,3)  //"Valor Original "

If lSpbInUse
	cModSpb	:= IIF(!Empty(SE5->E5_MODSPB),SE5->E5_MODSPB,"1")
	cDescSpb := aModalSpb[Val(cModSpb)]
Endif

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Recebe os dados do t¡tulo a ser baixado 										³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nOpc1 := 0
If Type('lF080Auto') =='U' .or. ! lF080Auto

	DEFINE MSDIALOG oDlg FROM	31,15 TO 527,574 TITLE OemToAnsi(STR0085)  PIXEL OF oMainWnd //  "Cancelamento de Baixas a Pagar"
	@ 37, 001 TO 247, 137 LABEL OemToAnsi(STR0086) OF oDlg  PIXEL //"Dados Gerais"
	@ 38, 143 TO 247, 278 LABEL OemToAnsi(STR0087) OF oDlg  PIXEL //"Valores da Baixa"
	@ 01, 002 TO 035, 278 LABEL OemToAnsi(STR0088) OF oDlg  PIXEL //"Principal"

	@ 010, 010 SAY OemToAnsi(STR0016)			SIZE 18,07 OF oDlg PIXEL //"T¡tulo"
	@ 008, 030 MSGET cTitulo						F3 "SE2RDO" SIZE 57,10 OF oDlg PIXEL READONLY
	@ 010, 095 SAY OemToAnsi(STR0017)			SIZE 39,07 OF oDlg PIXEL //"Emiss„o"
	@ 008, 127 MSGET SE2->E2_EMISSAO				SIZE 35,10 OF oDlg PIXEL When .F.
	@ 010, 169 SAY OemToAnsi(STR0018)	 		SIZE 39,07 OF oDlg PIXEL //"Vencto.Atual"
	@ 008, 202 MSGET SE2->E2_VENCREA 			SIZE 39,10 OF oDlg PIXEL When .F.
	@ 022, 005 SAY OemToAnsi(STR0019)			SIZE 22,07 OF oDlg PIXEL //"Fornec."
	@ 020, 030 MSGET cNomeFor						F3 "SA2"	SIZE 211,9 OF oDlg PIXEL READONLY
	@ 046, 007 SAY OemToAnsi(STR0020)	 		SIZE 38,07 OF oDlg PIXEL //"Hist.Emiss„o"
	@ 043, 050 MSGET SE2->E2_HIST 				SIZE 79,10 OF oDlg PIXEL When .F.
	@ 057, 007 SAY OemToAnsi(STR0021)		  	SIZE 39,07 OF oDlg PIXEL //"Portador"
	@ 056, 050 MSGET SE2->E2_PORTADO				SIZE 66,10 OF oDlg PIXEL When .F.
	@ 069, 007 SAY OemToAnsi(STR0022)			SIZE 40,07 OF oDlg PIXEL //"Banco"
	@ 068, 050 MSGET aBaixaSE5[nOpBaixa,11]	F3 "SA6" SIZE 22,10 OF oDlg PIXEL READONLY
	@ 081, 007 SAY OemToAnsi(STR0023)		  	SIZE 39,07 OF oDlg PIXEL //"Agˆncia"
	@ 080, 050 MSGET aBaixaSE5[nOpBaixa,12]	SIZE 35,10 OF oDlg PIXEL When .F.
	@ 093, 007 SAY OemToAnsi(STR0024)			SIZE 41,07 OF oDlg PIXEL //"Conta"	
	@ 092, 050 MSGET aBaixaSE5[nOpBaixa,13]	SIZE 66,10 OF oDlg PIXEL When .F.
	@ 106, 007 SAY OemToAnsi(STR0089) 			SIZE 38,07 OF oDlg PIXEL //"Data Receb."
	@ 104, 050 MSGET dBaixa 					SIZE 39,10 OF oDlg PIXEL When .F.
	@ 118, 007 SAY OemToAnsi(STR0149) 	SIZE 39,07 OF oDlg PIXEL //"Data Debito"
	@ 117, 050 MSGET dDebito					SIZE 39,07 OF oDlg PIXEL When .F.
	
	@ 130, 007 SAY OemToAnsi(STR0026)	  		SIZE 39,07 OF oDlg PIXEL //"Hist.Baixa"
	@ 128, 050 MSGET cHist070						SIZE 83,10 OF oDlg PIXEL When .F.
	@ 142, 007 SAY OemToAnsi(STR0027)	  		SIZE 40,07 OF oDlg PIXEL //"Cheque No."
	@ 140, 050 MSGET cNumCheq		 				SIZE 38,10 OF oDlg PIXEL When .F.
	@ 155, 007 SAY OemToAnsi(STR0028)			SIZE 36,07 OF oDlg PIXEL //"Beneficiário"
	@ 153, 050 MSGET cBenef 						SIZE 84,10 OF oDlg PIXEL When .F.
	@ 168, 007 SAY OemToAnsi(STR0029)			SIZE 37,07 OF oDlg PIXEL //"Mot.Baixa"
	@ 166, 050 MSGET cDescrMo 						SIZE 83,10 OF oDlg PIXEL When .F.
	@ 181, 007 SAY STR0131 SIZE 32, 07 OF oDlg PIXEL // //"Hist.Cancel."
	@ 179, 050 MSGET cHistCan070					SIZE 83, 10 OF oDlg PIXEL 
	
	If lSpbInUse
		@ 194,007 SAY STR0128 SIZE 32, 07 OF oDlg PIXEL  //"Modalidade SPB"
		@ 192,050 MSGET cDescSpb SIZE 56, 10 OF oDlg PIXEL When .F.
	Endif
	
	If cPaisLoc <> "CHI"
		@ 047, 151 SAY cTexto  	SIZE 53,07 OF oDlg PIXEL //"Valor Original"
		@ 044, 208 MSGET SE2->E2_VALOR			SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
		@ 058, 151 SAY OemToAnsi(STR0035)		SIZE 53,07 OF oDlg PIXEL //"- Abatimentos"
		@ 056, 208 MSGET nTotAbat					SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
	Else
		@ 047, 151 SAY OemToAnsi(STR0034)  	SIZE 53,07 OF oDlg PIXEL //"Valor Original"
		@ 044, 208 MSGET SE2->E2_VLCRUZ  		SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_VLCRUZ")
	   @ 058, 151 SAY OemToAnsi(STR0118)			SIZE 53,07 OF oDlg PIXEL //"+ Otros Gastos"
	   @ 056, 208 MSGET nImpSubst 					SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_IMPSUBS")
	EndIf
	@ 070, 151 SAY OemToAnsi(STR0036)  		SIZE 53,07 OF oDlg PIXEL //"- Pagtos.Parciais"
	@ 069, 208 MSGET nPagtoParcial				SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
	@ 082, 151 SAY OemToAnsi(STR0037)	 		SIZE 53,07 OF oDlg PIXEL //"- Descontos"
	@ 081, 208 MSGET nDescont						SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_DESCONT")
	@ 095, 151 SAY OemToAnsi(STR0038)		  	SIZE 53,07 OF oDlg PIXEL //"+ Multa"
	@ 093, 208 MSGET nMulta 						SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_MULTA")
	If cPaisLoc <> "CHI"
		@ 107, 151 SAY OemToAnsi(STR0039) 		SIZE 53,07 OF oDlg PIXEL //"+ Tx.Permanenc."
		@ 105, 208 MSGET nJuros 					SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_JUROS")
	Else
	   @ 107, 151 SAY OemToAnsi(STR0117) 			SIZE 53,7 OF oDlg PIXEL //"+ Impuesto Subst."
	   @ 105, 208 MSGET nOtrga					    SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_OTRGA")
	EndIf

	nLinha := 107

	//Get do ISS na baixa
	If lCalcIssBx .and. cPaisLoc == "BRA"
		@ 12+nLinha, 151 SAY "- Iss"	SIZE 53,07 OF oDlg PIXEL
		@ 10+nLinha, 208 MSGET nIss	SIZE 66,10 OF oDlg PIXEL  When .F. Picture PesqPict("SE2","E2_ISS")  
		nLinha +=12
	Endif

	If lPccBaixa .and. cPaisLoc == "BRA"
		If lIrfMp232
			@ 12+nLinha, 151 SAY "- Irrf"	SIZE 53,07 OF oDlg PIXEL
			@ 10+nLinha, 208 MSGET nIrrf	SIZE 66,10 OF oDlg PIXEL  When .F. Picture PesqPict("SE2","E2_IRRF")  ;
			Valid ( Fa080Val(nIrrf))
			nLinha +=12
		Endif

		@ 12+nLinha, 151 SAY "- Pis"	SIZE 53,07 OF oDlg PIXEL
		@ 10+nLinha, 208 MSGET nPis	SIZE 66,10 OF oDlg PIXEL When .F.  Picture PesqPict("SE2","E2_PIS")
		nLinha +=12
		@ 12+nLinha, 151 SAY "- Cofins" 	SIZE 53,07 OF oDlg PIXEL
		@ 10+nLinha, 208 MSGET nCofins	SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_COFINS") 
		nLinha +=12
		@ 12+nLinha, 151 SAY "- Csll"	SIZE 53,07 OF oDlg PIXEL
		@ 10+nLinha, 208 MSGET nCsll	SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_CSLL")
		nLinha +=12
	Endif

	@ 12+nLinha, 151 SAY OemToAnsi(STR0041)  		SIZE 53,07 OF oDlg PIXEL //"= Valor Pago"
	@ 10+nLinha, 208 MSGET nValPgto						SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_VALLIQ")
	
	IF SE2->E2_MOEDA > 1
		nLinha+=12	
		@ 12+nLinha, 151 SAY OemToAnsi(STR0042)  + SubStr(GetMV("MV_SIMB"+cMoeda),1,3)    SIZE 53,07 OF oDlg PIXEL //"Valor "
		@ 10+nLinha, 208 MSGET nValEstrang				SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
		nLinha+=12
		If cPaisLoc <> "CHI"
			@ 12+nLinha, 151 SAY OemToAnsi(STR0040)  SIZE 53,07 OF oDlg PIXEL //"+ Corr.Monet ria"
			@ 10+nLinha, 208 MSGET nCorrec				SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_CORREC")
		Else
			@ 12+nLinha, 151 SAY OemToAnsi(STR0119)  SIZE 53,07 OF oDlg PIXEL //"+/- Dif. Cambio"
			@ 10+nLinha, 208 MSGET nDifCambio		   SIZE 66,10 OF oDlg PIXEL When .F. Picture PesqPict("SE2","E2_CAMBIO")
		EndIf
	ENDIF
	
	DEFINE SBUTTON FROM 06, 246 TYPE 1 ENABLE OF oDlg ACTION ( nOpc1 := 1,oDlg:End() )
	DEFINE SBUTTON FROM 20, 246 TYPE 2 ENABLE OF oDlg ACTION oDlg:End()
	
	ACTIVATE MSDIALOG oDlg
	
Else 
	// rotina automatica
	nOpc1 = 1
Endif	
msUnlock("SE2")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ PONTO DE ENTRADA P/ PERMISSAO DE CANCELAMENTO DE BAIXA DE TITULO		  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lFa080Own
	lRet :=	ExecBlock('FA080OWN',.F.,.F.)
Endif   

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Consiste MV_DATAFIN antes de cancelar baixa ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lRet	
	If nOpcx == 5 // Estorno da baixa
		lRet := DtMovFin(dDatabase)
	ElseIf nOpcx == 6  ///Exclusão da baixa
		lRet := DtMovFin(dBaixa)
	Endif
Endif

//......
//     Conforme situacao do parametro abaixo, integra com o SIGAGSP
//     MV_SIGAGSP - 0-Nao / 1-Integra
//     Efetua o Estorno do Lancamento de Baixa de Orcamentacao
//.......
If lRet .And. GetNewPar("MV_SIGAGSP","0") == "1" 
	nGSPx := nOpcx
	lRet := GSPF080()
EndIf

If !lRet
	Return
EndIf	

IF nOpc1 == 1
	If lSPB
		If SE2->E2_OKSPB == "B" // Titulo Baixado via SPB com aceite de pagamento
			Help(" " , 1 , "NOCANCBX")
			dbSelectArea("SE2")
			Return
		ElseIf SE2->E2_OKSPB == "A" //Titulo baixado via SPB com aceite de pagto em aberto
			If !ChkPsw(104)
				dbSelectArea("SE2")
				Return
			Endif
		Endif
	Endif
        
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicia a gravacao dos lancamentos - SIGAPCO ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	PcoIniLan("000005")

	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³ Inicio da protecao via TTS													  ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nOrdSa6 := SA6->(INDEXORD())
	nRecSa6 := SA6->(RECNO())
	Begin Transaction
		SED->( dbSeek(cFilial+SE2->E2_NATUREZ) )
		SA6->( DbSetOrder(1) )
		SA6->( DbSeek(xFilial("SA6")+SE5->(E5_BANCO+E5_AGENCIA+E5_CONTA) ) )

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Apaga Titulo de Vendor Gerado					  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		lBaixaOk := .T.
		IF TrazCodMot(cMotBx) == "VEN"
			dbSelectArea("SE2")
			cTitOriV := Left(SE2->E2_TITORIG,nTamTitOri)
			nTamParc := TamSx3("E2_PARCELA")[1]
			If dbSeek(cFilial+Left(SE2->E2_TITORIG,nTamTitOri)) .And. SE2->E2_ORIGEM != "FINA090"
				If SE2->E2_SALDO == SE2->E2_VALOR
					Reclock("SE2",.F.,.T.)
					dbDelete()
				Else
					Help(" ",1,"BXVENDOR",,Subs(cTitOriV,1,3)+" "+Subs(cTitOriV,4,6)+;
						" "+Subs(cTitOriV,10,nTamParc)+" "+Subs(cTitOriV,10+nTamParc,3),5,1)
					lBaixaOk := .F.
				Endif
			ElseIf SE2->(!Eof()) .And. Alltrim(SE2->E2_ORIGEM) == "FINA090" .And. SuperGetMv("MV_BXAUTVE",.F.,.F.)
				Aviso(	STR0143, STR0141 + Chr(13)+; // "Atenção", "Existe um titulo de vendor gerado por esta baixa! Porém, como ele foi gerado pela rotina de baixa automática, seu valor não será alterado."
							STR0142 + Subs(cTitOriV,1,3)+" "+Subs(cTitOriV,4,6)+; // "Prefixo/Numero/Parcela/Tipo do titulo de VENDOR gerado: "
							" "+Subs(cTitOriV,10,nTamParc)+" "+Subs(cTitOriV,10+nTamParc,3),{"Ok"})
			Endif
			If lBaixaOk
				dbGoto(nReg)
				RecLock("SE2",.F.)
				Replace SE2->E2_TITORIG With TamSx3("E2_TITORIG")[1]
			Endif
		Endif
		If lBaixaOk
			*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			*³Gravar valores no SE2															  ³
			*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			Reclock( "SE2" )
			SE2->E2_VALLIQ := nValPgto
			If cPaisloc <> "CHI"
				SE2->E2_JUROS	:= nJuros
				SE2->E2_CORREC := nCorrec
			Else
				SE2->E2_JUROS	:= nOtrga + nImpsubst
				SE2->E2_CORREC := nDifCambio
			   IIf(SE2->(FieldPos("E2_OTRGA"))  > 0,SE2->E2_OTRGA  :=nOtrga,.T.)              		
			   IIf(SE2->(FieldPos("E2_CAMBIO")) > 0,SE2->E2_CAMBIO :=nDifCambio,.T.)              		
			   IIf(SE2->(FieldPos("E2_IMPSUBS"))> 0,SE2->E2_IMPSUBS:=nImpSubst,.T.)              		   
			EndIf
			SE2->E2_MULTA	:= nMulta
			SE2->E2_DESCONT:= nDescont

			*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			*³Gera lancamento contabil de estorno 										  ³
			*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			cPadrao := "531"    //cancelamento de baixa
			lPadraoBx := (VerPadrao(cPadrao) .and. lContabilizou)

			nRegB := SE2->( Recno() )
			dbSelectArea("SE2")
			IF SE2->( dbSeek(cFilial+Left(SE2->E2_TITORIG,nTamTitOri)) )
				lVend := .T.
				nRegV := SE2->( Recno() )
			Endif
			lPadraoVd := VerPadrao("519") //cancelamento de baixa vendor
			dbSelectArea( "SE2" )
			dbGoto(nRegB)

			IF lVend
				lPadraoBx := VerPadrao( "531" ) //cancelamento
			Endif
			nTotAbat := NoRound((nTotAbat*nTxMoeda),3)
			ABATIMENTO := nTotAbat

			//Guardo valores antigos para contabilizar impostos no cancelamento
			If lPccBaixa
				nPisOld		:= SE2->E2_PIS
				nCofOld		:= SE2->E2_COFINS
				nCslOld		:= SE2->E2_CSLL
				nVRPisOld	:= SE2->E2_VRETPIS
				nVRCofOld	:= SE2->E2_VRETCOF
				nVRCslold	:= SE2->E2_VRETCSL
      		Reclock("SE2")	
				Replace E2_PIS		With nPis
				Replace E2_COFINS	With nCofins
				Replace E2_CSLL	With nCsll
				Replace E2_VRETPIS	With nPis
				Replace E2_VRETCOF	With nCofins
				Replace E2_VRETCSL	With nCsll
				MsUnlock()
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Verifica se contabiliza on-line o estorno da baixa		  ³
			//³Estorno de Vendor deve ser on-line                  	  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If nOpcx == 5 .and. !lVend .and. SE5->E5_TIPODOC  == "VL"
				lLanca := IIF(mv_par03 == 1 , .T.,.F.)
			Else
				lLanca := .T.
			Endif

			If cMultNat == "1"
				DelMNatBx("SE2",@nHdlPrv,@nTotal,@cArquivo,nOpcx != 5,cSeqSE5,lLanca) // Apaga as naturezas geradas para o titulo
			Else	
				IF (lPadraoBx .or. lPadraoVd ) .and. lContabilizou .and. lLanca
					nHdlPrv:=HeadProva(cLote,"FINA080",Substr(cUsuario,7,6),@cArquivo)
				Endif
				IF lPadraoBx .and. lContabilizou .and. lLanca
					ABATIMENTO := nTotAbat
					nTotal+=DetProva(nHdlPrv,cPadrao,"FINA080",cLote)
				Endif
				IF lPadraoVd .and. lContabilizou
					IF lVend
						dbSelectArea( "SE2" )
						SE2->( dbGoto(nRegV) )
						nTotal+=DetProva(nHdlPrv,"519","FINA080",cLote)
					Endif
				Endif
			Endif
			IF (lPadraoBx .Or. lPadraoVd) .and. lContabilizou .and. lLanca
				RodaProva(nHdlPrv,nTotal)
			Endif
			SE2->( dbGoto(nRegB) )
			*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			*³Volta titulo para carteira 													  ³
			*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			Reclock( "SE2" )
			nTotAbat := IIF( SE2->E2_SALDO!=0,0,nTotAbat)
			dDataAnt := Iif(nOpBaixa==Len(aBaixa),Iif(Len(aBaixa)==1,CtoD(""),;
			aBaixaSE5[Len(aBaixa)-1][7]),E2_BAIXA)

			IF SE2->E2_MOEDA == 1
				nValor :=SE2->E2_SALDO+(nValPgto-(nJuros+nOtrga+nImpSubst)-nMulta+nDescont+nTotAbat+nPis+nCoFins+nCsll+nIrrf+nIss)
			Else
				nValor :=SE2->E2_SALDO+((nValPgto-(nJuros+nOtrga+nImpSubst)-nMulta+nDescont+nTotAbat+nPis+nCoFins+nCsll+nIrrf+nIss) / NoRound(nTxMoeda,5))
			Endif
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Volta valor original do titulo se for o cancelamento final das baixas, se nao ³
			//³houverem compensa‡oes e se o titulo, ou parte dele, nao estiver em fatura.    ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			IF Len(aBaixa) == 1 .and. nTotAdto == 0 .and. nTotImpost == 0 .and. ;
					!SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG .And. Empty(SE2->E2_FATURA)
				nValor := SE2->E2_VALOR
			Endif
			SE2->E2_SALDO := 	IIf( nValor < 0 , 0 , nValor )
			
			IF Str(E2_SALDO,17,2) == Str(E2_VALOR,17,2)
				SE2->E2_BAIXA :=	 CtoD("")
			EndIf
			SE2->E2_DESCONT:= 0
			SE2->E2_MULTA	:= 0
			SE2->E2_JUROS	:= 0
			SE2->E2_CORREC	:= 0
			SE2->E2_VALLIQ	:= 0
			SE2->E2_LOTE 	:= Space(Len(SE2->E2_LOTE))
			SE2->E2_NUMBCO	:=	Space(Len(SE2->E2_NUMBCO))
			If cPaisLoc == "CHI"
				IIf (SE2->(FieldPos("E2_OTRGA"))  > 0,SE2->E2_OTRGA    := 0,.T.)   
				IIf (SE2->(FieldPos("E2_CAMBIO")) > 0,SE2->E2_CAMBIO   := 0,.T.)      
				IIf (SE2->(FieldPos("E2_IMPSUBS"))> 0,SE2->E2_IMPSUBS  := 0,.T.)         
				IIf (SE2->(FieldPos("E2_TXMOEDA"))> 0,SE2->E2_TXMOEDA  := 0,.T.)                  
			EndIf
			//Caso exista solicitacao de NCP eh necessario atualizar o campo CU_DTBAIXA... 
			If cPaisLoc <> "BRA"
				A055AtuDtBx("2",SE2->E2_FORNECE,SE2->E2_LOJA,SE2->E2_NUM,SE2->E2_PREFIXO,SE2->E2_BAIXA)
			EndIf
			If lSPB
				SE2->E2_OKSPB		:= " "
				SE2->E2_CLEARIN	:= Space(3)
				SE2->E2_TPPGTO		:= Space(2)
				SE2->E2_HORASPB	:= Space(5)
			Endif
			If (SE2->E2_SALDO == SE2->E2_VALOR .AND. EMPTY(SE2->E2_BAIXA))
				SE2->E2_SDACRES := SE2->E2_ACRESC
				SE2->E2_SDDECRE := SE2->E2_DECRESC
			ElseIf lAcreDecre
				SE2->E2_SDACRES += Round(Noround(xMoeda(SE5->E5_VLACRES,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
				SE2->E2_SDDECRE += Round(Noround(xMoeda(SE5->E5_VLDECRE,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
				IF( Str(E2_SALDO,17,2) == Str(E2_VALOR,17,2) .and. Str(E2_SDACRES,17,2) = Str(E2_ACRESC,17,2) )
					SE2->E2_BAIXA := CtoD("")	
				EndIf
			EndIf

			//Guardo as parcelas de impostos para deleção correta dos mesmos         
			If cPaisLoc == "BRA"
				cParcPis := SE2->E2_PARCPIS
				cParcCof := SE2->E2_PARCCOF
				cParcCsl := SE2->E2_PARCSLL      
			EndIf
			If lPccBaixa .And. cPaisLoc == "BRA"
				//Guardo valores antigos para contabilizar impostos no cancelamento
				SE2->E2_PIS	:= nPisOld
				SE2->E2_COFINS	:= nCofOld
				SE2->E2_CSLL	:= nCslOld
				SE2->E2_VRETPIS := nVRPisOld
				SE2->E2_VRETCOF := nVRCofOld
				SE2->E2_VRETCSL := nVRCslOld

				//Verifica se o titulo em questao ja foi retido em outro titulo
				If AliasIndic("SFQ") 
					aAreaSE2 := SE2->(GetArea())
					dbSelectArea("SFQ")
					dbSetOrder(2)
					lAchouRel := MsSeek(xFilial("SFQ")+cAlias+SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA))
					RestArea(aAreaSE2)
				EndIf            

				//Se o titulo estiver em bordero, permanece os campos de retencao do bordero
				If !Empty (SE2->E2_NUMBOR)
					If SE2->(E2_VRETPIS+E2_VRETCOF+E2_VRETCSL) > 0
						SE2->E2_PRETPIS := "4"
						SE2->E2_PRETCOF := "4"
						SE2->E2_PRETCSL := "4"
					ElseIf lAchouRel
						SE2->E2_PRETPIS := "2"
						SE2->E2_PRETCOF := "2"
						SE2->E2_PRETCSL := "2"                     
					Else 
						SE2->E2_PRETPIS := "1"
						SE2->E2_PRETCOF := "1"
						SE2->E2_PRETCSL := "1"                     
					EndIf
				Elseif !SE2->E2_TIPO $ MVPAGANT //Se for PA (geracao de tx's pela emissao), nao exclui o numero da parcela. 
					SE2->E2_PRETPIS := "1"
					SE2->E2_PRETCOF := "1"
					SE2->E2_PRETCSL := "1"
					SE2->E2_VRETPIS := 0
					SE2->E2_VRETCOF := 0
					SE2->E2_VRETCSL := 0
					SE2->E2_PARCPIS := Space(Len("E2_PARCPIS"))
					SE2->E2_PARCCOF := Space(Len("E2_PARCCOF"))
					SE2->E2_PARCSLL := Space(Len("E2_PARCSLL"))
				EndIf
				If lIrfMP232
					SE2->E2_PRETIRF := "1"
					SE2->E2_VRETIRF := 0
  				Endif
			Endif

			//Altera data de vencimento dos titulos de impostos
			If Empty(SE2->E2_BAIXA) .and. !lPccBaixa
				AltvencImp(SE2->E2_VENCREA)
			Endif

			//Altera valor dos impostos
			If !lPccBaixa
				F080Impost(SE2->(RECNO()),.T.,nJuros,nMulta,nDescont,nValPgto)
			Endif
		
			*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			*³Verifica se h  abatimentos para voltar a carteira					  ³
			*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SE2->(dbSeek(cFilial+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA))
				cTitAnt := (SE2->E2_FILIAL+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA)
				While !SE2->(Eof()) .and. cTitAnt == (SE2->E2_FILIAL+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA)
					IF !SE2->E2_TIPO $ MVABATIM
						SE2->(dbSkip())
						Loop
					EndIF
					IF SE2->E2_FORNECE+SE2->E2_LOJA != cFornece+cLoja
						SE2->(dbSkip())
						Loop
					EndIF
					//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
					//³Volta titulo para carteira 				  ³
					//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
					Reclock("SE2")
					SE2->E2_BAIXA	:= dDataAnt
					SE2->E2_SALDO	:= E2_VALOR
					SE2->E2_DESCONT:= 0
					SE2->E2_JUROS	:= 0
					SE2->E2_MULTA	:= 0
					SE2->E2_CORREC	:= 0
					SE2->E2_VARURV	:= 0
					SE2->E2_LOTE	:= Space(Len(E2_LOTE))
					SE2->E2_VALLIQ	:= 0
					SE2->E2_NUMBCO	:= Space(Len(SE2->E2_NUMBCO))
					If cPaisLoc == "CHI"
			         IIf(SE2->(FieldPos("E2_OTRGA"))  > 0,SE2->E2_OTRGA    := 0,.T.)   
			         IIf(SE2->(FieldPos("E2_CAMBIO")) > 0,SE2->E2_CAMBIO   := 0,.T.)      
			         IIf(SE2->(FieldPos("E2_IMPSUBS"))> 0,SE2->E2_IMPSUBS  := 0,.T.)         
			         IIf(SE2->(FieldPos("E2_TXMOEDA"))> 0,SE2->E2_TXMOEDA  := 0,.T.)
					EndIf	         
					SE2->(dbSkip())
				Enddo
			Endif

			SE2->( dbGoTo( nSalvRec ) )

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ PONTOS DE ENTRADA							        ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If ExistTemplate("FA080CAN")
				ExecTemplate("FA080CAN",.F.,.F.,{nOpcx})
			Endif

			If ExistBlock("FA080CAN")
				ExecBlock("FA080CAN",.F.,.F.,{nOpcx})
			Endif
			 
			If ExistBlock("FA080REC")
				ExecBlock("FA080REC",.F.,.F.,{nJuros,nMulta,dDataAnt})
			EndIf	

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³LOCALiza na movimenta‡„o banc ria, os registros referentes a baixa³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

			//Limpo referencias de apuracao de impostos.
			If lContrRet .and. lPccBaixa
	
				dbSelectArea("SE5")
				dbSetOrder(2)
				dbGoto(nRecSe5)			
	
				If lIrfMP232 .and. SA2->A2_TIPO == "F" .and. Empty(SE5->E5_PRETIRF) .and. ;
					!Empty(SE5->E5_PRETPIS)
					lRetSoIrf := .T.
				Endif				
					 		
				aRecSE5 := FImpDelTit("SE5",SE5->E5_PREFIXO,SE5->E5_NUMERO,SE5->E5_PARCELA,SE5->E5_TIPO,SE5->E5_CLIFOR,SE5->E5_LOJA,SE5->E5_SEQ)
				For nX := 1 to Len(aRecSE5)
					SE5->(MSGoto(aRecSE5[nX]))	
					RecLock("SE5",.F.)
					//Se nao reteve somente IRRF
					If !lRetSoIrf .And. ((!SE5->E5_TIPO $ MVPAGANT) .Or. (SE5->E5_TIPO $ MVPAGANT .And.;
						!Empty(SE5->E5_PRETPIS) .And. !Empty(SE5->E5_PRETCOF) .And. !Empty(SE5->E5_PRETCSL)))					
						SE5->E5_PRETPIS := "1"
						SE5->E5_PRETCOF := "1"
						SE5->E5_PRETCSL := "1"
						If lIrfMP232 .and. SE5->E5_PRETIRF == "2"  
							SE5->E5_PRETIRF := "1"
   					Endif
					Else
						If lIrfMP232
							SE5->E5_PRETIRF := "1"
   					Endif
					Endif
					MsUnlock()
				Next
	
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Exclui os registros de relacionamentos do SFQ                                ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				SE5->(dbGoto(nRecSe5))
				FImpDelSFQ("SE5",SE5->E5_PREFIXO,SE5->E5_NUMERO,SE5->E5_PARCELA,SE5->E5_TIPO,SE5->E5_CLIFOR,SE5->E5_LOJA,SE5->E5_SEQ)
				
				FDelTxBx(SE5->E5_PREFIXO,SE5->E5_NUMERO,SE5->E5_PARCELA,SE5->E5_TIPO,SE5->E5_CLIFOR,SE5->E5_LOJA,SE5->E5_SEQ,cParcPis,cParcCof,cParcCsl)			
	
			Endif         

			IF nIss != 0
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Apaga tambem os registro de impostos-ISS	  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				SE5->(dbGoto(nRecSe5))
				SE2->(dbGoTo(nSalvRec))
				dbSelectArea("SE2")
				If MsSeek(xFilial("SE2")+SE2->(E2_PREFIXO+E2_NUM))
					cChaveImp := SE2->(E2_PREFIXO+E2_NUM)
		
					While !Eof() .And. E2_FILIAL+E2_PREFIXO+E2_NUM == xFilial("SE2")+cChaveImp
						IF E2_TIPO $ MVISS .And. ;
							AllTrim(E2_NATUREZ) = AllTrim(&(GetMv("MV_ISS"))) .And. ;
							STR(SE2->E2_SALDO,17,2) == STR(SE2->E2_VALOR,17,2) .and. ;
							("FINA080" $ SE2->E2_ORIGEM .or. "FINA090" $ SE2->E2_ORIGEM) .and. ;
							SE5->E5_SEQ == SE2->E2_SEQBX
							
							RecLock( "SE2" ,.F.,.T.)
							dbDelete( )
						EndIf
						dbSkip()
					Enddo
				Endif
			EndIf
			
			SE5->(dbGoto(nRecSe5))
			SE2->(dbGoTo(nSalvRec))
	
			dbSelectArea("SE5")
			dbSetOrder(2)

			aAux := { "VL","CM","CX","DC","MT","JR","BA"}
			IIf(cPaisloc == "CHI",AADD(aAux,"IS"),.T.)

			For nI := 1 to len(aAux)

				If SE5->( dbSeek(xFilial("SE5")+aAux[ni]+cChave))

					cBanco	:= SE5->E5_BANCO
					cAgencia := SE5->E5_AGENCIA
					cConta   := SE5->E5_CONTA
					cTitulo	:= SE5->E5_NUMERO
					cCheque	:= SE5->E5_NUMCHEQ
               lCnab		:= IIF(EMPTY(SE5->E5_ARQCNAB),.F.,.T.)
					If lAcreDecre
						nAcresc := SE5->E5_VLACRES
						nDecresc := SE5->E5_VLDECRE
					Endif
					If lContrRet .and. lPccBaixa
						If lIrfMp232
							aImp := {SE5->E5_VRETPIS,SE5->E5_VRETCOF,SE5->E5_VRETCSL,SE5->E5_PRETPIS,SE5->E5_PRETCOF,SE5->E5_PRETCSL,SE5->E5_VRETIRF,SE5->E5_PRETIRF}
						Else
							aImp := {SE5->E5_VRETPIS,SE5->E5_VRETCOF,SE5->E5_VRETCSL,SE5->E5_PRETPIS,SE5->E5_PRETCOF,SE5->E5_PRETCSL}
						Endif
					Endif
					If nOpcx == 5 .or. (nOpcx == 6 .and. (aAux[nI]=="BA" .and. !Empty(cLoteFin).and. lCnab ))
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³Cancela as baixas gerando um lancamento de estorno no SE5         ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If aAux[nI] $ "VL" .or. (aAux[nI]=="BA" .and. !Empty(cLoteFin).and. lCnab )
							Reclock("SE5",.T.)
							SE5->E5_FILIAL    := xFilial("SE5")
							SE5->E5_BANCO     := cBANCO
							SE5->E5_AGENCIA   := cAGENCIA
							SE5->E5_CONTA     := cCONTA
							SE5->E5_DATA      := dDatabase
						If cPaisLoc <>"BRA"
							SA6->(DbSetOrder(1))
							SA6->(MsSeek(xFilial()+SE5->E5_BANCO+SE5->E5_AGENCIA+SE5->E5_CONTA))
							If( Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1) )== 1
								SE5->E5_VALOR     := nValPgto
								SE5->E5_VLMOED2   := nValEstrang
							Else
								SE5->E5_VALOR     := nValEstrang
								SE5->E5_VLMOED2   := nValPgto
							EndIf
						Else
								SE5->E5_VALOR     := nValPgto
								SE5->E5_VLMOED2   := nValEstrang   
						EndIf
							SE5->E5_NATUREZ   := SE2->E2_NATUREZ
							SE5->E5_RECPAG    := Iif(SE2->E2_TIPO$MVPAGANT+"/"+MV_CPNEG,"P","R")
							SE5->E5_TIPO      := cTIPO
							SE5->E5_LA        := Iif((lPadraoBx .OR. lPadraoVd ) .and. lContabilizou .and. lLanca ,"S","N")
							SE5->E5_TIPODOC   := "ES"
							SE5->E5_LOTE      := cLoteFin
							SE5->E5_PREFIXO   := cPREFIXO
							SE5->E5_NUMERO    := cTITULO
							SE5->E5_PARCELA   := cPARCELA
							SE5->E5_FORNECE   := cFORNECE
							SE5->E5_CLIFOR    := cFORNECE
							SE5->E5_LOJA      := cLOJA
							SE5->E5_BENEF     := SE2->E2_NOMFOR
							SE5->E5_DTDIGIT   := dDataBase
							SE5->E5_MOTBX     := TrazCodMot(cMotBx)
							SE5->E5_SEQ       := cSEQUENCIA
							SE5->E5_DTDISPO   := dDataBase
							SE5->E5_NUMCHEQ	:= cCheque
							SE5->E5_DOCUMEN   := cNumBor
							SE5->E5_HISTOR		:= cHistCan070
							SE5->E5_MULTNAT	:= cMultNat
							SE5->E5_VLJUROS	:= nJuros
							SE5->E5_VLDESCO	:= nDescont
							SE5->E5_VLMULTA	:= nMulta
							SE5->E5_VLCORRE	:= nCorrec

							If lAcreDecre
								SE5->E5_VLACRES := nAcresc
								SE5->E5_VLDECRE := nDecresc
							Endif

							If lSpbInUse
								SE5->E5_MODSPB	 := cModSpb
							Endif

							If lContrRet .and. lPccBaixa
   	
								SE5->E5_VRETPIS := aImp[1]
								SE5->E5_VRETCOF := aImp[2]
								SE5->E5_VRETCSL := aImp[3]
		         	                              
								SE5->E5_PRETPIS := aImp[4]
								SE5->E5_PRETCOF := aImp[5]
								SE5->E5_PRETCSL := aImp[6]
   	
								If lIrfMP232
									SE5->E5_VRETIRF := aImp[7]
									SE5->E5_PRETIRF := aImp[8]								
								Endif   	

							Endif

							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ PONTO DE ENTRADA F080EST                            ³
							//³ PE para grava‡äes complementares do cancelamento    ³
							//³ da baixa                                            ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							IF EXISTBLOCK("F080EST")
								ExecBlock("F080EST",.F.,.F.)
							Endif
						Else
							Reclock("SE5")
							SE5->E5_SITUACA := "C"
							MsUnlock()
						EndIf
						
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ PONTO DE ENTRADA F080EST2                           ³
						//³ PE para grava‡oes complementares do cancelamento    ³
						//³ da baixa                                            ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						IF EXISTBLOCK("F080EST2")
							ExecBlock("F080EST2",.F.,.F.)
						Endif

						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Grava os lancamentos das contas orcamentarias - SIGAPCO    ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If SE5->E5_TIPODOC == "ES"
							PcoDetLan("000005","02","FINA080")
						Else	                              
							PcoDetLan("000005","01","FINA080",.T.,"00000601")
						EndIf	
							
					Else
						Reclock("SE5",.F.,.T.)
						dbDelete()
						MsUnlock()
					EndIf
				Endif
			Next

			dbSetOrder(1)
			dbGoTo(nRecSe5)		//volta para o registro principal
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Deleta Cheque gerado pela baixa						 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nRecNo := 0
			nValor := 0
			dbSelectArea("SEF")
			If nRecDelSef > 0
				dbGoto( nRecDelSef )
				If SEF->EF_IMPRESS != "C"
					Reclock("SEF",.F.,.T.)
					nValor := SEF->EF_VALOR
					dbDelete()
					MsUnlock()
				Endif
			Endif
			dbSetOrder(1)
			nRecNo := 0
			nValor := 0

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza o totalizador										 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If SubStr(cCheque,1,1) = "*" .And. nRecNo != 0
				dbGoTo( nRecNo )
				Reclock("SEF")
				SEF->EF_VALOR -= nValor
				IF SEF->EF_VALOR == 0
					Reclock("SEF",.F.,.T.)
					SEF->(dbDelete())
					MsUnlock()
				Endif
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Atualiza o Cadastro de Fornecedores								  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SA2")
			If !Eof()
				RecLock( "SA2" )
				If SE2->E2_MOEDA > 1
					nValPadrao := Round(NoRound(xMoeda(nValPadrao,1,SE2->E2_MOEDA,dBaixa,3),3),2)
					nValPadrao := Round(NoRound(xMoeda(nValPadrao,SE2->E2_MOEDA,1,SE2->E2_EMISSAO,3),3),2)
				Endif
				IF SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG
					SA2->A2_SALDUP		:= A2_SALDUP - nValPadrao
					SA2->A2_SALDUPM	:= A2_SALDUPM-xMoeda(nValPadrao,1,Val(GetMv("MV_MCUSTO")),SE2->E2_EMISSAO)
      		Else
					SA2->A2_SALDUP		:= A2_SALDUP + nValPadrao
					SA2->A2_SALDUPM	:= A2_SALDUPM+xMoeda(nValPadrao,1,Val(GetMv("MV_MCUSTO")),SE2->E2_EMISSAO)
				Endif
				nAtraso:=dBaixa-SE2->E2_VENCTO
				If nAtraso > 1
					IF Dow(SE2->E2_VENCTO) == 1 .Or. Dow(SE2->E2_VENCTO) == 7
						IF Dow(dBaixa) == 2 .and. nAtraso <= 2
							nAtraso := 0
						EndIF
					EndIF
					nAtraso:=IIF(nAtraso<0,0,nAtraso)
					If SA2->A2_MATR < nAtraso
						Replace A2_MATR With nAtraso
					EndIf
				Endif
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³	Atualiza saldos banc rios. 												  ³
			//³	No cancelamento de baixa de adiantamento, o saldo do caixa/banco ³
			//³	deve diminuir, pois o capital saiu do caixa e voltou a quem      ³
			//³	solicitou o PA. 																  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			dbSelectArea("SE2")
			SE2->( dbGoto(nReg) )

			IF SE2->E2_TIPO $ MVPAGANT
				AtuSalBco(aBaixaSE5[nOpBaixa,11],aBaixaSE5[nOpBaixa,12],aBaixaSE5[nOpBaixa,13],dDataBase,nValPgto,"-")
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³	Caixa ou Bordero sem Cheque ou Debto.CC								  ³
			//³	Quando for Debito em C.Corrente tem que estornar o saldo Bancario³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Verifica o modulo para definir o tratamento do Caixa			 	 ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If (lEstorna .and. MovBcoBx(cMotBx, .T.) .and. SE5->E5_TIPODOC <>"BA") .or. ;
				Left(aBaixaSE5[nOpBaixa,11],3) == Left(GetMv("MV_CXFIN"),3) .or. aBaixaSE5[nOpBaixa,11] $ GetMv("MV_CARTEIR")
				AtuSalBco(aBaixaSE5[nOpBaixa,11],aBaixaSE5[nOpBaixa,12],aBaixaSE5[nOpBaixa,13],dDataBase,nValPgto,"+")
			Else
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Atualiza saldo bancario quando motivo de baixa movimenta banco mas ³
				//³ este motivo de baixa nao gera cheque                               ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If	(MovBcoBx(cMotBx) .and. !ChqMotBx(cDescrMo)).and. (!(Left(aBaixaSE5[nOpBaixa,11],3) ==;
					Left(GetMv("MV_CXFIN"),3)) .and. !(aBaixaSE5[nOpBaixa,11] $ GetMv("MV_CARTEIR")))
					AtuSalBco(aBaixaSE5[nOpBaixa,11],aBaixaSE5[nOpBaixa,12],aBaixaSE5[nOpBaixa,13],dDataBase,nValPgto,"+")			
				Endif
			EndIf

			If GetMv("MV_CANBORP") == "S"
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Apaga registro do titulo no SEA retirando-o do bordero		 	 ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				If !Empty(SE2->E2_NUMBOR)
					dbSelectArea("SEA")
					dbSetOrder(1)
					If dbseek(xFilial()+SE2->(E2_NUMBOR+E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA))
						While !Eof() .and. SEA->(EA_NUMBOR+EA_PREFIXO+EA_NUM+EA_PARCELA+EA_TIPO+EA_FORNECE+EA_LOJA) == ;
								SE2->(E2_NUMBOR+E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA)
							If SEA->EA_CART == "P"
								Reclock("SEA",.F.,.T.)
								dbDelete()
								Exit
							Endif
							DbSkip()
						Enddo
					Endif
				Endif
				RecLock("SE2",.F.)
				SE2->E2_NUMBOR := Space(Len(SE2->E2_NUMBOR))
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Gera lan‡amento cont bil de estorno						  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			IF (lPadraoBx .Or. lPadraoVd) .and. lContabilizou .and. lLanca
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
				//³ Envia para Lan‡amento Cont bil							  ³
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
				lDigita:=IIF(mv_par01==1,.T.,.F.)
				cA100Incl(cArquivo,nHdlPrv,3,cLote,lDigita,.F.)
			Endif
		Endif		

		//Conforme situacao do parametro abaixo, integra com o SIGAGSP, solicitado em 05/10/2004 por Fernando Mazzarolo.
		//MV_SIGAGSP - 0-Nao / 1-Integra
		//Integração após a gravação do cancelamento da Baixa
		If GetNewPar("MV_SIGAGSP","0") == "1" 
			If ( "U" == Valtype(nGSPx) ) .or. ( "N" <> Valtype(nGSPx) )
				nGSPx := nOpcx
			Endif
			GSPF360()
		EndIf
 
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Final da prote‡„o via TTS						³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	End Transaction
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Finaliza a gravacao dos lancamentos do SIGAPCO ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	PcoFinLan("000005")
	
	SA6->(DbSetOrder(nOrdSa6), DbGoto(nRecSa6))
Endif

dbSelectArea(cAlias)
If nSalvRec > 0
	dbGoTo(nSalvRec)
EndIf	
dbSetOrder(nOrdem)
Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³FA080Grava³ Autor ³ Wagner Xavier 		  ³ Data ³ 06/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Grava as baixas 														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ FA080Grava(void)														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ Nao Tem																	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Grava(cLanca)
Local nx,cArquivo
Local lDigita:=IIF(mv_par01==1,.T.,.F.),nTotal:=0,nHdlPrv:=0
Local lAglut :=IIF(mv_par02==1,.T.,.F.),lPadraoBx:=.F.,lHdlPrv:= .F.
Local cLoteOrig
LOCAL cPadrao := "530"
Local nTotLtEZ := 0	//Totalizador da Bx Lote Mult Nat CC
Local nRecSeV	:= 0
Local nRecSeZ	:= 0
Local lAcessMul	:= .T.
Local lAcessJur	:= .T.
Local lAcessDes	:= .T.
Local aCposDes		:= {}
Local nT 			:= 0

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Caso o usu rio configure que deseja usar o lote financeiro, o   ³
//³ sistema becapeia o lote cont bil original e depois o restaura.  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cLoteOrig := cLote
If GetMv("MV_LOTEFIN") == "S" .and. !Empty( cLoteFin )
	cLote := cLoteFin
Endif

//Ponto de entrada para desabilitar campos de Multa, Juros ou Descontos
If ExistBlock("F080DCNB")
	aCposDes:=ExecBlock("F080DCNB",.F.,.F.)
	If Len(aCposDes) > 0
		IF (nT := ascan(aCposDes,'MULTA')) > 0	
			lAcessMul := .F.
		Endif
		IF (nT := ascan(aCposDes,'DESCONTO')) > 0	
			lAcessDes := .F.
		Endif
		IF (nT := ascan(aCposDes,'JUROS')) > 0	
			lAcessJur := .F.
		Endif		
	Endif
Endif

dbSelectArea("SE2")
dbGotop()

While ! SE2->(Eof())

	If SE2->E2_FILIAL != cFilial
		dbSkip()
		Loop
	Endif

	SE2->( dbskip() )				
	nX	 := SE2->( Recno() )
	SE2->( dbSkip( -1 )  )

	Fa080TitW(cMarca,@nTotal,@nHdlPrv,@lHdlPrv,@lPadraoBx,@cArquivo,@cPadrao,@nTotLtEZ,lAcessMul,lAcessJur,lAcessDes)

EndDo

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Avisa quando totais nao baterem 						  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF Str(nTotGer,16,2) != Str(nTotAGer,16,2)
   Help(" ",1,"TOTGERAL",, STR0122 +;
                           Space(1) + Trans(nTotGer, "@E 99,999,999,999.99") +;
                           Chr(10)  + STR0123 +;
                           Space(1) + Trans(nTotAGer, "@E 99,999,999,999.99"), 4, 0)
Elseif Str(nTotDesp,16,2) != Str(nTotADesp,16,2)
   Help(" ",1,"TOTDESP",, STR0122 +;
                           Space(1) + Trans(nTotDesp, "@E 99,999,999,999.99") +;
                           Chr(10)  + STR0123 +;
                           Space(1) + Trans(nTotADesp, "@E 99,999,999,999.99"), 4, 0)
Elseif Str(nTotDesc,16,2) != Str(nTotADesc,16,2)
   Help(" ",1,"TOTDESC",, STR0122 +;
                          Space(1) + Trans(nTotDesc, "@E 99,999,999,999.99") +;
                          Chr(10)  + STR0123 +;
                          Space(1) + Trans(nTotADesc, "@E 99,999,999,999.99"), 4, 0)
Elseif Str(nTotMul,16,2) != Str(nTotAMul,16,2)
   Help(" ",1,"TOTMULT",, STR0122 +;
                          Space(1) + Trans(nTotMul, "@E 99,999,999,999.99") +;
                          Chr(10)  + STR0123 +;
                          Space(1) + Trans(nTotAMul, "@E 99,999,999,999.99"), 4, 0)
Elseif Str(nTotJur,16,2) != Str(nTotAJur,16,2)
   Help(" ",1,"TOTJUROS",, STR0122 +;
                           Space(1) + Trans(nTotJur, "@E 99,999,999,999.99") +;
                           Chr(10)  + STR0123 +;
                           Trans(nTotAJur, "@E 99,999,999,999.99"), 4, 1)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Envia para Lancamento Contabil, se gerado arquivo   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF nTotal > 0 .And. nHdlPrv > 0
	dbSelectArea( "SE2" )
	nRecSe2 := RecNo()
	dbGoBottom()
	dbSkip()

	dbSelectArea( "SEV" )
	nRecSeV := RecNo()
	dbGoBottom()
	dbSkip()

	dbSelectArea( "SEZ" )
	nRecSeZ := RecNo()
	dbGoBottom()
	dbSkip()

	If nTotAGer != 0
		//Contabilizar totalizador exceto o rateado por MultNat C.Custo
		VALOR := nTotaGer - nTotLtEZ
		ABATIMENTO := 0
		nTotal+=DetProva(nHdlPrv,cPadrao,"FINA080",cLote)

		//Contabilizar totalizador dos rateios MultNat com C.Custo
		If nTotLtEZ > 0
			VALOR := nTotLtEZ   
			ABATIMENTO := 0
			nTotal+=DetProva(nHdlPrv,"537","FINA080",cLote)
		Endif
	Endif

	RodaProva(nHdlPrv,nTotal)
	cA100Incl(cArquivo,nHdlPrv,3,cLote,lDigita,lAglut)
	dbSelectArea( "SE2" )
	SE2->( dbGoTo( nRecSe2 ) )        

	dbSelectArea("SEV")
	SEV->(dbGoTo(nRecSeV))

	dbSelectArea("SEZ")
	SEZ->(dbGoTo(nRecSeZ))

Endif
cLote := cLoteOrig
Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fa080Cheq  ³ Autor ³ Wagner Xavier			 ³ Data ³ 23/03/93 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Consistencia do numero do cheque 									 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fa080Cheq() 																 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080Cheq(lHelp)
Local cAlias:=Alias(),lRet:=.T.

DEFAULT lHelp := .T.

IF Empty(cCheque) .or. SE2->E2_IMPCHEQ == "S"
	dbSelectArea(cAlias)
	Return(.T.)
Endif
dbSelectArea("SEF")
dbSetOrder(1)
If SEF->( dbSeek(cFilial+cBanco+cAgencia+cConta+cCheque) )
	If Subs(cCheque,1,1) != "*"
		If lHelp
			Help(" ",1,"CHEQEXIST")
		Endif
		lRet:=.F.
	Else
		lRet:=.T.
	Endif
Endif
If lRet
	lRet := VldUser("EF_NUM") // Chama a validacao de usuario
Endif	
dbSelectArea(cAlias)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080ChecF³ Autor ³ Antonio Maniero Jr.   ³ Data ³ 17/03/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Retorna Expresao para Indice Condicional						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³Fa080ChecF() 															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³Generico																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FA080ChecF()
Local cFiltro := ""
cFiltro := 'E2_FILIAL=="'+xFilial("SE2")+'".And.'
cFiltro += '!(E2_TIPO $ "'+MVPROVIS+"/"+MVPAGANT+"/"+MVABATIM+"/"+MV_CPNEG+'").and.'
cFiltro += 'E2_NATUREZ>="'+cNatDe+'".and.E2_NATUREZ<="'+cNatAte+'".and.'
cFiltro += 'DTOS(E2_VENCREA)>="'+DTOS(dVencDe)+'".and.DTOS(E2_VENCREA)<="'+DTOS(dVencAte)+'"'

// Se trabalha com liberacao de pagto., filtra os registros que ultrapassem o valor
// minimo 
If GetMv("MV_CTLIPAG")
	cFiltro += '.And. !(Empty(SE2->E2_DATALIB).And.(SE2->E2_SALDO+SE2->E2_SDACRES-SE2->E2_SDDECRE)>'+Str(GetMV("MV_VLMINPG"),17,2)+')'
Endif	

If !Empty(cFil080)
	cFiltro := '(' +cFiltro+ ').and.(' +cFil080+')'
Endif

#IFNDEF TOP
	cFiltro := "("+cFiltro+").And.(E2_SALDO>0 .Or. E2_OK='xx')"
#ELSE
	If TcSrvType() == "AS/400"
		cFiltro := "("+cFiltro+").And.(E2_SALDO>0 .Or. E2_OK='xx')"
	Else	
		cFiltro += " .And. E2_SALDO >0 "
	Endif
#ENDIF

Return cFiltro

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ FA080Estra ³ Autor ³ Wilson Junior			 ³ Data ³ 20/05/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao utilizada para consistir o valor digitado em M.Forte  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ FA080ESTRANG() 															 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function FA080Estrang(nTxMoeda,nTolerCp)

Local lRet := .f.
Local nValEstAnt := 0
DEFAULT nTxMoeda := 0
DEFAULT nTolerCp := SuperGetMv("MV_TOLERCP",.F.,0)

If ExistBlock("FA080CMI")
	ExecBlock("FA080CMI",.F.,.F.)
Endif

nValEstAnt := Round(nValEstrang- Round(NoRound(xMoeda(nJuros+nMulta-nDescont+nOtrga+nImpSubst+nAcresc-nDecresc+nTolerCp,1,SE2->E2_MOEDA,,3,,nTxMoeda),3),2),2) 
IF nValEstAnt <= SE2->E2_SALDO
	lRet := .T.
ElseIf cPaisLoc == "CHI"
	If Abs( nValEstAnt - SE2->E2_SALDO ) <= ( (1/(10**( MsDecimais(SE2->E2_MOEDA)-1)))/2 )
		lRet := .T.
	Endif
Endif
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080GrVen³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 19/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que grava os dados do VENDOR 							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080GrVen(cTitOrig,lPadraoVd)									  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080GrVen(cTitOrig,lPadraoVd,cLanca,aVendor,cOrigem)

Local cAlias		:= Alias()
Local nRec
Local cBcoVen
Local cLojVen

dbSelectArea( "SA6" )
dbSeek( xFilial("SA6") + SE9->E9_BANCO + SE9->E9_AGENCIA + SE9->E9_CONTA )

cBcoVen := Space(Len(SA2->A2_COD))
cLojVen := Space(Len(SA2->A2_LOJA))

dbSelectArea("SA2")
dbSetOrder(1)
If Empty(cBcoVen)
	cBcoVen := If(Empty(SA6->A6_CODFOR),Pad(SA6->A6_COD,Len(SA2->A2_COD)),SA6->A6_CODFOR)
Endif	
If Empty(cLojVen)
	cLojVen := "01"+Space(Len(SA6->A6_LOJFOR)-2)
Endif	                                          

If ! dbSeek(xFilial("SA2")+cBcoVen+cLojVen)
	RecLock("SA2",.T.)
	SA2->A2_FILIAL	:= xFilial("SA2")
	SA2->A2_COD		:= cBcoVen
	SA2->A2_LOJA	:= cLojVen
	SA2->A2_NOME	:= SA6->A6_NOME
	SA2->A2_END		:= Iif(Empty(SA6->A6_END),"...",SA6->A6_END)
	SA2->A2_MUN		:= Iif(Empty(SA6->A6_MUN),"...",SA6->A6_MUN)
	SA2->A2_EST		:= Iif(Empty(SA6->A6_EST),"SP",SA6->A6_EST)
	SA2->A2_NREDUZ	:= Iif(Empty(SA6->A6_NREDUZ),Subs(SA6->A6_NOME,1,20),SA6->A6_NREDUZ)
Endif

If Valtype(aVendor) == "A"
	cPrefV		:= aVendor[4]
	cNumV			:= aVendor[5]
	cParcV		:= aVendor[6]
	cTipV			:= aVendor[7]
	dDataVencV	:= aVendor[8]
	nTxAcresv	:= aVendor[9]
	cNaturV		:= aVendor[10]
	nValTitV		:= aVendor[11]
Endif	
dbSelectArea("SE2")
nRec := Recno()
RecLock("SE2",.T.)

SE2-> E2_FILIAL 	:= xFilial("SE2")
SE2-> E2_PREFIXO	:= cPrefv
SE2-> E2_NUM 		:= cNumV
SE2-> E2_PARCELA	:= cParcV
SE2-> E2_TIPO		:= cTipv
SE2-> E2_NOMFOR 	:= SA2->A2_NREDUZ
SE2-> E2_EMIS1		:= dDatabase
SE2-> E2_VALOR		:= nValTitV
SE2-> E2_SALDO		:= nValTitV
SE2-> E2_VLCRUZ 	:= nValTitV
SE2-> E2_EMISSAO	:= dDataBase
SE2-> E2_VENCORI	:= dDataVencV
SE2-> E2_RATEIO 	:= "N"
If lPadraoVd .And. cLanca == "S"
	SE2-> E2_LA		:= "S"
Else
	SE2-> E2_LA		:= "N"
EndIf
SE2-> E2_VENCTO 	:= dDataVencV
SE2-> E2_VENCREA	:= DataValida(SE2->E2_VENCTO,.T.)
SE2-> E2_FORNECE	:= SA2 -> A2_COD
SE2-> E2_LOJA		:= cLojVen
SE2-> E2_MOEDA		:= 1
SE2-> E2_NATUREZ	:= cNaturV
SE2-> E2_MOVIMEN	:= dDataBase
Fa080CalcV(nTxAcresv)
SE2-> E2_ACRESC 	:= nValAcres
SE2-> E2_SDACRES	:= nValAcres

If cOrigem != Nil
	SE2->E2_ORIGEM := cOrigem	
Endif

//Ponto de entrada para tratamento complementar a gravação do titulo de VENDOR
If ExistBlock("F080VEND")
	ExecBlock("F080VEND",.F.,.F.)
Endif

dbGoto(nRec)
cTitOrig := cPrefV + cNumV + cParcV + cTipV + SA2->A2_COD
dbSelectArea(cAlias)
Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080CalcV³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que calcula o valor do titulo de VENDOR				  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080CalcV(nTaxa) 													  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080CalcV(nTaxa)
Local cAlias := Alias(), lRet := .T.

If nTaxa == Nil
	nTaxa := 1
Endif
nValAcres := (SE2->E2_VALOR * (1 + (nTaxa / 100))) - SE2->E2_VALOR

dbSelectArea(cAlias)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080VerVd³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que verifica dados obrigatorios do vendor			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fa080VerVd(void)														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080VerVd()

Local lErro := .F.

If Empty(cContrato)
	lErro := .T.
ElseIf Empty(cNumV)
	lErro := .T.
ElseIf Empty(cTipV)
	lErro := .T.
ElseIf Empty(cNaturV)
	lErro := .T.
ElseIf Empty(nTxAcresV)
	lErro := .T.
ElseIf Empty(dDataVencV)
	lErro := .T.
Endif

If lErro
	Help(" " , 1 , "FA080DADVEND")
	Return .f.
Endif
Return .t.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080digit³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que permite ou nao a digitacao dos dados bancarios  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fa080digit(void)														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
function fa080digit()
lRet := .t.
	If !MovBcoBx( cMotBx, .T. ) .or. SE2->E2_IMPCHEQ == "S" .or. lChqPre
		lRet := .f.
Endif
Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³fa080Adiant ³ Autor ³ Vincius S. Barreira	 ³ Data ³ 26/10/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Processa baixa de adiantamento.										 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³fa080Adiant( )																 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080Adiant( lPadrao, cLanca, nTxMoeda )
Local cSequencia := "00"
Local aTipoSeq := {}
Local nLaco
Local nMoedaBco := If( cPaisLoc<>"BRA", MoedaBco(cBanco,cAgencia,cConta), 1 )
Local nMoedaTit := SE2->E2_MOEDA
Local nTxModBco := If( cPaisLoc<>"BRA", aTxMoedas[Max(nMoedaBco		,1)][2]	, 0 )
Local nTxModTit := If( cPaisLoc<>"BRA", aTxMoedas[Max(SE2->E2_MOEDA	,1)][2]	, 0 )
Local nRecBA
If ( nMoedaBco = 0 )
	nMoedaBco := 1
Endif

DEFAULT nTxMoeda := 0

If MovBcoBx(cMotBx, .T.)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Estorna saldo bancario. 															 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	AtuSalBco(cBanco,cAgencia,cConta,dBaixa,nValPgto,"+")
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Para numerar as sequencias o sistema precisa procurar os	³
//³ registros com  tipodoc igual a vl, ba ou cp.					³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
aTipoSeq := { "VL","BA","CP" }
dbSelectArea("SE5")
SE5->(dbSetOrder(2))
For nLaco := 1 to len(aTipoSeq)
	SE5->(dbSeek(xFilial("SE5") + aTipoSeq[nLaco] + SE2->E2_PREFIXO + SE2->E2_NUM + ;
		SE2->E2_PARCELA + SE2->E2_TIPO) )

	While !SE5->(Eof()) .And. ;
			SE5->E5_FILIAL	== xFilial("SE5") .And. ;
			SE5->E5_TIPODOC == aTipoSeq[nLaco] .And. ;
			SE5->E5_PREFIXO == SE2->E2_PREFIXO .And. ;
			SE5->E5_NUMERO	== SE2->E2_NUM .And. ;
			SE5->E5_PARCELA == SE2->E2_PARCELA .And. ;
			SE5->E5_TIPO 	== SE2->E2_TIPO

		If SE5->(E5_CLIFOR+E5_LOJA) == SE2->(E2_FORNECE+E2_LOJA)
			If cSequencia < SE5->E5_SEQ
				cSequencia := SE5->E5_SEQ
			Endif
      Endif
		SE5->(dbSkip())
	Enddo
Next
cSequencia := Soma1(cSequencia,2)
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Gera movimentacao bancaria a pagar - baixa do adiantamento				 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Reclock( "SE5", .T. )
SE5 -> E5_FILIAL := xFilial()
SE5 -> E5_NUMERO := SE2->E2_NUM
SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
SE5 -> E5_RECPAG := "R"
SE5 -> E5_TIPO   := SE2->E2_TIPO
SE5 -> E5_PARCELA:= SE2->E2_PARCELA
SE5 -> E5_TIPODOC:= Iif( MovBcoBx( cMotBx, .T. ),"VL","BA" )
SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
SE5 -> E5_BANCO  := cBanco
SE5 -> E5_AGENCIA:= cAgencia
SE5 -> E5_CONTA  := cConta
SE5 -> E5_DATA   := dBaixa
If cPaisLoc == "BRA" .or. Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1) == 1
	SE5 -> E5_VALOR  := nValPgto
Else
	SE5 -> E5_VALOR  := nValEstrang
EndIf
SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
If lPadrao .And. cLanca == "S"
	SE5 -> E5_LA	:= "S"
Else
	SE5 -> E5_LA	:= "N"
EndIf
SE5->E5_HISTOR := If(!Empty(cHist070),cHist070,OemToAnsi( STR0112 )) //"BAIXA DE ADIANTAMENTO"
SE5->E5_LOTE   := cLoteFin
SE5->E5_FORNECE := SE2->E2_FORNECE
SE5->E5_CLIFOR := SE2->E2_FORNECE
SE5->E5_LOJA   := SE2->E2_LOJA
SE5->E5_BENEF  := SE2->E2_NOMFOR
SE5->E5_DTDIGIT:= dDataBase
SE5->E5_SEQ		:= cSequencia
SE5->E5_DTDISPO:= SE5->E5_DATA
If ( cPaisLoc <> "BRA" )
	If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
	SE5->E5_MOEDA := StrZero(nMoedaBco,2)
Endif
If nValEstrang != 0
	If cPaisLoc == "BRA" .or. Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1) == 1
		SE5->E5_VLMOED2	:= nValEstrang
	Else
		SE5->E5_VLMOED2	:= nValPgto
	EndIf
Else
		SE5->E5_VLMOED2  := xMoeda(nValPgto,1,SE2->E2_MOEDA,,,,nTxMoeda)
Endif
If SpbInUse()
	SE5->E5_MODSPB := cModSpb
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Grava os valores agregados ao titulo no totalizador ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
SE5->E5_VLMULTA := nMulta
SE5->E5_VLDESCO := nDescont
If cPaisloc <> "CHI"
	SE5->E5_VLJUROS := nJuros
	SE5->E5_VLCORRE := nCm
Else
	SE5->E5_VLJUROS := nOtrga + nImpSubst
	SE5->E5_VLCORRE := nDifcambio
EndIf
nRecBA := SE5->(Recno())

If cPaisloc <> "CHI"
	If nJuros > 0
		Reclock( "SE5", .T. )
		SE5 -> E5_FILIAL := cFilial
		SE5 -> E5_NUMERO := SE2->E2_NUM
		SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
		SE5 -> E5_RECPAG := "R"
		SE5 -> E5_TIPO   := SE2->E2_TIPO
		SE5 -> E5_PARCELA:= SE2->E2_PARCELA
		SE5 -> E5_TIPODOC:= "JR"
		SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
		SE5 -> E5_BANCO  := cBanco
		SE5 -> E5_AGENCIA:= cAgencia
		SE5 -> E5_CONTA  := cConta
		SE5 -> E5_DATA   := dBaixa
		SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
		If lPadrao .And. cLanca == "S"
			SE5 -> E5_LA  := "S"
		Else
			SE5 -> E5_LA  := "N"
		EndIf
		SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
		SE5 -> E5_LOTE   := cLoteFin
		SE5 -> E5_FORNECE:= SE2->E2_FORNECE
		SE5 -> E5_CLIFOR := SE2->E2_FORNECE
		SE5 -> E5_LOJA   := SE2->E2_LOJA
		SE5 -> E5_BENEF  := SE2->E2_NOMFOR
		SE5 -> E5_DTDIGIT:= dDataBase
		SE5 -> E5_SEQ	  := cSequencia
		SE5 -> E5_DTDISPO:= SE5->E5_DATA
		If ( cPaisLoc != "BRA" ) 
			SE5 -> E5_VALOR  := xMoeda( nJuros, 1, nMoedaBco,,,, nTxModBco )
			SE5 -> E5_VLMOED2:= xMoeda( nJuros, 1, nMoedaTit,,,, nTxModTit )		
			If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
			SE5->E5_MOEDA := StrZero(nMoedaBco,2)
		Else
			SE5 -> E5_VALOR  := nJuros
			SE5 -> E5_VLMOED2:= xMoeda(nJuros,1,SE2->E2_MOEDA,,,,nTxMoeda)
		Endif
	EndIf
	If nCm != 0
		Reclock( "SE5", .T. )
		SE5 -> E5_FILIAL := cFilial
		SE5 -> E5_NUMERO := SE2->E2_NUM
		SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
		SE5 -> E5_RECPAG := "R"
		SE5 -> E5_TIPO   := SE2->E2_TIPO
		SE5 -> E5_PARCELA:= SE2->E2_PARCELA
		SE5 -> E5_TIPODOC:= "CM"
		SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
		SE5 -> E5_BANCO  := cBanco
		SE5 -> E5_AGENCIA:= cAgencia
		SE5 -> E5_CONTA  := cConta
		SE5 -> E5_DATA   := dBaixa
		SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
		If lPadrao .And. cLanca == "S"
			SE5 -> E5_LA	:= "S"
		Else
			SE5 -> E5_LA	:= "N"
		EndIf
		SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
		SE5 -> E5_LOTE   := cLoteFin
		SE5 -> E5_FORNECE:= SE2->E2_FORNECE
		SE5 -> E5_CLIFOR := SE2->E2_FORNECE
		SE5 -> E5_LOJA   := SE2->E2_LOJA
		SE5 -> E5_BENEF  := SE2->E2_NOMFOR
		SE5 -> E5_DTDIGIT:= dDataBase
		SE5 -> E5_SEQ	  := cSequencia
		SE5 -> E5_DTDISPO:= SE5->E5_DATA
		If ( cPaisLoc != "BRA" )
			SE5->E5_VALOR   := xMoeda( nCm, 1, nMoedaBco,,,, nTxModBco )
			SE5->E5_VLMOED2 := xMoeda( nCm, 1, nMoedaTit,,,, nTxModTit )
			If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
			SE5->E5_MOEDA := StrZero(nMoedaBco,2)
		Else
			SE5 -> E5_VALOR  := nCm
			SE5->E5_VLMOED2  := xMoeda(nCM,1,SE2->E2_MOEDA,,,,nTxMoeda)
		Endif
	EndIf
Else
	If nOtrga > 0 //Localizacao Chile
		Reclock( "SE5", .T. )
		SE5 -> E5_FILIAL := cFilial
		SE5 -> E5_NUMERO := SE2->E2_NUM
		SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
		SE5 -> E5_RECPAG := "R"
		SE5 -> E5_TIPO   := SE2->E2_TIPO
		SE5 -> E5_PARCELA:= SE2->E2_PARCELA
		SE5 -> E5_TIPODOC:= "JR"
		SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
		SE5 -> E5_BANCO  := cBanco
		SE5 -> E5_AGENCIA:= cAgencia
		SE5 -> E5_CONTA  := cConta
		SE5 -> E5_DATA   := dBaixa
		SE5 -> E5_VALOR  := nOtrga
		SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
		If lPadrao .And. cLanca == "S"
			SE5 -> E5_LA  := "S"
		Else
			SE5 -> E5_LA  := "N"
		EndIf
		SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
		SE5 -> E5_LOTE   := cLoteFin
		SE5 -> E5_FORNECE:= SE2->E2_FORNECE
		SE5 -> E5_CLIFOR := SE2->E2_FORNECE
		SE5 -> E5_LOJA   := SE2->E2_LOJA
		SE5 -> E5_BENEF  := SE2->E2_NOMFOR
		SE5 -> E5_DTDIGIT:= dDataBase
		SE5 -> E5_SEQ	  := cSequencia
		SE5 -> E5_DTDISPO:= SE5->E5_DATA
			SE5 -> E5_VLMOED2 := xMoeda(nOtrga,1,SE2->E2_MOEDA)
	Endif
	If nImpsubst > 0
		Reclock( "SE5", .T. )
		SE5 -> E5_FILIAL := cFilial
		SE5 -> E5_NUMERO := SE2->E2_NUM
		SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
		SE5 -> E5_RECPAG := "R"
		SE5 -> E5_TIPO   := SE2->E2_TIPO
		SE5 -> E5_PARCELA:= SE2->E2_PARCELA
		SE5 -> E5_TIPODOC:= "IS"
		SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
		SE5 -> E5_BANCO  := cBanco
		SE5 -> E5_AGENCIA:= cAgencia
		SE5 -> E5_CONTA  := cConta
		SE5 -> E5_DATA   := dBaixa
		SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
		If lPadrao .And. cLanca == "S"
			SE5 -> E5_LA  := "S"
		Else
			SE5 -> E5_LA  := "N"
		EndIf
		SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
		SE5 -> E5_LOTE   := cLoteFin
		SE5 -> E5_FORNECE:= SE2->E2_FORNECE
		SE5 -> E5_CLIFOR := SE2->E2_FORNECE
		SE5 -> E5_LOJA   := SE2->E2_LOJA
		SE5 -> E5_BENEF  := SE2->E2_NOMFOR
		SE5 -> E5_DTDIGIT:= dDataBase
		SE5 -> E5_SEQ	  := cSequencia
		SE5 -> E5_DTDISPO:= SE5->E5_DATA
		If ( cPaisLoc != "BRA" )
			SE5 -> E5_VALOR   := xMoeda( nImpSubst, 1, nMoedaBco,,,, nTxModBco )
			SE5 -> E5_VLMOED2 := xMoeda( nImpSubst, 1, nMoedaTit,,,, nTxModTit )
			If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
			SE5->E5_MOEDA := StrZero(nMoedaBco,2)
		Else
			SE5 -> E5_VALOR   := nImpsubst
			SE5 -> E5_VLMOED2 := xMoeda(nImpsubst,1,SE2->E2_MOEDA)
		Endif
	EndIf
	If Round( Abs( nDifcambio), MsDecimais(nMoedaBco)) > 0 //Localizacao Chile
		Reclock( "SE5", .T. )
		SE5 -> E5_FILIAL := cFilial
		SE5 -> E5_NUMERO := SE2->E2_NUM
		SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
		SE5 -> E5_RECPAG := "R"
		SE5 -> E5_TIPO   := SE2->E2_TIPO
		SE5 -> E5_PARCELA:= SE2->E2_PARCELA
		SE5 -> E5_TIPODOC:= "CM"
		SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
		SE5 -> E5_BANCO  := cBanco
		SE5 -> E5_AGENCIA:= cAgencia
		SE5 -> E5_CONTA  := cConta
		SE5 -> E5_DATA   := dBaixa
		SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
		If lPadrao .And. cLanca == "S"
			SE5 -> E5_LA	:= "S"
		Else
			SE5 -> E5_LA	:= "N"
		EndIf
		SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
		SE5 -> E5_LOTE   := cLoteFin
		SE5 -> E5_FORNECE:= SE2->E2_FORNECE
		SE5 -> E5_CLIFOR := SE2->E2_FORNECE
		SE5 -> E5_LOJA   := SE2->E2_LOJA
		SE5 -> E5_BENEF  := SE2->E2_NOMFOR
		SE5 -> E5_DTDIGIT:= dDataBase
		SE5 -> E5_SEQ	  := cSequencia
		SE5 -> E5_DTDISPO:= SE5->E5_DATA
		If ( cPaisLoc <> "BRA" )
			If( Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1) )== 1
			SE5 -> E5_VALOR  := nDifCambio
			SE5 -> E5_VLMOED2:= xMoeda( nDifCambio, 1, nMoedaTit,,,, nTxModTit )
			Else
				SE5 -> E5_VALOR  := xMoeda( nDifCambio, 1, nMoedaBco,,,, nTxModBco )
				SE5 -> E5_VLMOED2:= nDifCambio 
			EndIf
			
			If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
			SE5->E5_MOEDA := StrZero(nMoedaBco,2)
		Else
			SE5 -> E5_VALOR  := nDifcambio
			SE5->E5_VLMOED2  := xMoeda(nDifcambio,1,SE2->E2_MOEDA)
		Endif
	Endif
EndIf

If nMulta > 0
	Reclock( "SE5", .T. )
	SE5 -> E5_FILIAL := cFilial
	SE5 -> E5_NUMERO := SE2->E2_NUM
	SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
	SE5 -> E5_RECPAG := "R"
	SE5 -> E5_TIPO   := SE2->E2_TIPO
	SE5 -> E5_PARCELA:= SE2->E2_PARCELA
	SE5 -> E5_TIPODOC:= "MT"
	SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
	SE5 -> E5_BANCO  := cBanco
	SE5 -> E5_AGENCIA:= cAgencia
	SE5 -> E5_CONTA  := cConta
	SE5 -> E5_DATA   := dBaixa
	SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
	IF lPadrao .And. cLanca == "S"
		SE5 -> E5_LA	:= "S"
	Else
		SE5 -> E5_LA	:= "N"
	EndIf
	SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
	SE5 -> E5_LOTE   := cLoteFin
	SE5 -> E5_FORNECE:= SE2->E2_FORNECE
	SE5 -> E5_CLIFOR := SE2->E2_FORNECE
	SE5 -> E5_LOJA   := SE2->E2_LOJA
	SE5 -> E5_BENEF  := SE2->E2_NOMFOR
	SE5 -> E5_DTDIGIT:= dDataBase
	SE5 -> E5_SEQ	  := cSequencia
	SE5 -> E5_DTDISPO:= SE5->E5_DATA
	If ( cPaisLoc != "BRA" )
		SE5 -> E5_VALOR   := xMoeda( nMulta, 1, nMoedaBco,,,, nTxModBco )
		SE5 -> E5_VLMOED2 := xMoeda( nMulta, 1, nMoedaTit,,,, nTxModTit )
		If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
		SE5->E5_MOEDA := StrZero(nMoedaBco,2)
	Else
		SE5 -> E5_VALOR  := nMulta
		SE5->E5_VLMOED2  := xMoeda(nMulta,1,SE2->E2_MOEDA,,,,nTxMoeda)
	Endif
Endif

If nDescont > 0
	Reclock( "SE5", .T. )
	SE5 -> E5_FILIAL := cFilial
	SE5 -> E5_NUMERO := SE2->E2_NUM
	SE5 -> E5_PREFIXO:= SE2->E2_PREFIXO
	SE5 -> E5_RECPAG := "R"
	SE5 -> E5_TIPO   := SE2->E2_TIPO
	SE5 -> E5_PARCELA:= SE2->E2_PARCELA
	SE5 -> E5_TIPODOC:= "DC"
	SE5 -> E5_MOTBX  := TrazCodMot(cMotBx)
	SE5 -> E5_BANCO  := cBanco
	SE5 -> E5_AGENCIA:= cAgencia
	SE5 -> E5_CONTA  := cConta
	SE5 -> E5_DATA   := dBaixa
	SE5 -> E5_NATUREZ:= SE2->E2_NATUREZ
	If lPadrao .And. cLanca == "S"
		SE5 -> E5_LA  := "S"
	Else
		SE5 -> E5_LA  := "N"
	EndIf
	SE5 -> E5_HISTOR := OemToAnsi( STR0112 ) //"BAIXA DE ADIANTAMENTO"
	SE5 -> E5_LOTE   := cLoteFin
	SE5 -> E5_FORNECE:= SE2->E2_FORNECE
	SE5 -> E5_CLIFOR := SE2->E2_FORNECE
	SE5 -> E5_LOJA   := SE2->E2_LOJA
	SE5 -> E5_BENEF  := SE2->E2_NOMFOR
	SE5 -> E5_DTDIGIT:= dDataBase
	SE5 -> E5_SEQ	  := cSequencia
	SE5 -> E5_DTDISPO:= SE5->E5_DATA
	If ( cPaisLoc != "BRA" )
		SE5->E5_VALOR   := xMoeda( nDescont, 1, nMoedaBco,,,, nTxModBco )
		SE5->E5_VLMOED2 := xMoeda( nDescont, 1, nMoedaTit,,,, nTxModTit )
		If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
		SE5->E5_MOEDA := StrZero(nMoedaBco,2)
	Else
		SE5->E5_VALOR   := nDescont
		SE5->E5_VLMOED2 := xMoeda(nDescont,1,SE2->E2_MOEDA,,,,nTxMoeda)
	Endif
Endif
// Retorna posicionamento ao E5 tipo BA (contabilizacao)
SE5->( DbGoto( nRecBA))
Return

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080DtVen³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 24/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Valida a Data de Vencimento do VENDOR							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080DtVen()															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080DtVen(dData)
Local lRet := .T.

If dData < dDataBase
	Help(" ",1,"FA080DTVEN")
	lRet := .F.
Endif
Return lRet


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³fa080Corr ³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 30/01/96 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Sugere o valor da corr. monetaria p/ titulos <> moeda 1	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Corr() 															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Program   ³ Data   ³ BOPS ³  Motivo da Alteracao                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Mauricio  ³01/12/97³05352A³ Corre‡„o do c lculo de Corr.Monet ria      ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080Corr(nEstOriginal,nTxMoeda)

Local nCentMd1	:= MsDecimais(1)
Local nValor1, cAlias := Alias()
Local lF080CM := ExistBlock("F080CM")
LOCAL nBaseCorrecao := 0		// Base para Correcao Monetaria
DEFAULT nTxMoeda := 0
nEstOriginal := Iif(nEstOriginal==Nil,nValEstrang,nEstOriginal)
If GetMV("MV_TIPOCM") == "O"		// Pelo Original (O)
	nBaseCorrecao := nEstOriginal
ELSE
	nBaseCorrecao := nValEstrang				// Pelo Total (T)
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Calcula o valor na moeda escolhida na data da ultima variacao   ³
//³ ou na data de emissao (caso nao tenha sofrido ainda nenhuma	  ³
//³ variacao.																		  ³
//³ Calcula o valor na moeda escolhida para a database.				  ³
//³ Subtrai um valor do outro para apurar a variacao. 				  ³
//³ A Correcao pode ser parametrizada para ser calculada pelo Origi-³
//³ nal ou pelo Total (Parametro MV_TIPOCOM)           				  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SE2")

If STR(nBaseCorrecao,17,2) == STR(SE2->E2_VALOR,17,2) .AND. Empty(SE2->E2_DTVARIA)
	nValor1 := SE2->E2_VLCRUZ
Else     
	If(SE2->(FieldPos("E2_TXMDCOR")>0 ) .And. !Empty(SE2->E2_TXMDCOR))
		nValor1 := Round(NoRound(xMoeda(nBaseCorrecao,SE2->E2_MOEDA,1,Iif(Empty(E2_DTVARIA),E2_EMISSAO,E2_DTVARIA),nCentMd1+1,SE2->E2_TXMDCOR),nCentMd1+1),nCentMd1)
	Else
		nValor1 := Round(NoRound(xMoeda(nBaseCorrecao,SE2->E2_MOEDA,1,Iif(Empty(E2_DTVARIA),E2_EMISSAO,E2_DTVARIA),nCentMd1+1,Iif(Empty(SE2->E2_DTVARIA),SE2->E2_TXMOEDA,0)),nCentMd1+1),nCentMd1)
	EndIf
Endif

nValorM := Round(NoRound(xMoeda(nBaseCorrecao,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Verifica atraves do parametro MV_CALCCM se sera calculada a cor-³
//³ recao monetaria.                                           	  ³
//³ Caso o parametro nao exista, sera assumido "S"						  ³
//³ O PE F080CM serve para calculo alternativo da Corre‡ao Monetaria³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If GetMv("MV_CALCCM") == "S" .and. SE2->E2_MOEDA > 1
	If lF080CM
		nCM := ExecBlock("F080CM",.F.,.F.)
	Else
		nCM := nValorM - nValor1
	Endif
Else
	nCM := 0
Endif
If Type("oDifCambio") == "O"	.And. cPaisLoc =="CHI"
	nDifCambio := (nValPgto -(nBaseCorrecao * (SE2->E2_VLCRUZ/SE2->E2_VALOR) ) )
	oDifCambio:Refresh()
EndIf
dbSelectArea(cAlias)
Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³fA080TitW ³ Autor ³ Wagner Xavier         ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fun‡„o utilizada para Baixa de Titulos - Windows           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ fA080Titw()                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Gen‚rico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function fA080TitW(cMarca,nTotal,nHdlPrv,lHdlPrv,lPadraoBx,cArquivo,cPadrao,nTotLtEZ,lAcessMul,lAcessJur,lAcessDes)

Local nOpca			
LOCAL lMovBco  	:= .T.
LOCAL lBaixou  	:= .F.

LOCAL oDlgLote
LOCAL oTitulo
LOCAL oParcela
LOCAL oBaixa
LOCAL oHist070	
LOCAL oMotBx	
LOCAL oValor	
LOCAL oTotAbat	
LOCAL oParciais
LOCAL oDescont
LOCAL oMulta
LOCAL oJuros
LOCAL oValPgto
LOCAL oBenef
LOCAL oAcresc
LOCAL oDecresc
LOCAL nAcresc
LOCAL nDecresc
Local nSalvRec  := RecNO( )
LOCAL cNomeFor
LOCAL cParcela
LOCAL cMoeda
LOCAL nValLiq  := 0
LOCAL aMotBx	:= ReadMotBx()
LOCAL aDescMotBx := {}
Local aCmc7:={}
Local lSpbInUse := SpbInUse()
LOCAL aModalSPB	:=  {"1=TED","2=CIP","3=COMP"}
LOCAL oModSpb
Local nTxMoeda := 0
Local nUltLin
Local oMultNat
Local lMultNat := .F.
Local nTolerCp := SuperGetMv("MV_TOLERCP",.F.,0)
Local nI := 0
Local nLinha := 0
LOCAL oPis
LOCAL oCofins
LOCAL oCsll
LOCAL lFa080Lt := Existblock("FA080LT")

Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )

LOCAL oIrrf

Local lIrfMp232 := .f.

Local lAcessImp:= .T.
Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)

Local oIss 

cBenef	:= CriaVar("E5_BENEF")

PRIVATE lUsaCmc7 := .F., lChqPre := .F.
PRIVATE oVlEstrang
PRIVATE oCM
PRIVATE aDadosRef := Array(7)
PRIVATE aDadosRet := Array(7)
PRIVATE nOldValPgto := 0

DEFAULT lAcessMul	:= .T.
DEFAULT lAcessJur	:= .T.
DEFAULT lAcessDes	:= .T.

aFill(aDadosRef,0)
aFill(aDadosRet,0)

If (ExistBlock( "FA080CMC" ) )
	lUsaCmc7:=ExecBlock("FA080CMC",.F.,.F.)
Endif


IF ExistBlock("F080MNAT")
	lMultNat := ExecBlock("F080MNAT",.F.,.F.)
Endif


//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Retorna o Array aDescMotbx contendo apenas a descricao do	³
//³ motivo das Baixas. 						  								³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If len( aDescMotbx ) ==0
	For NI := 1 to Len(aMotBx)
		If Substr(aMotBx[nI],34,01) == "A" .or. Substr(aMotBx[nI],34,01) =="P"
			AADD( aDescMotbx,Substr(aMotBx[nI],07,10))
		EndIf
	Next
EndIf

While !Eof()
	If SE2->E2_OK != cMarca
		dbSKip()
		Loop
	Else	
		Exit
	EndIf
EndDo
// Se não selecionou nenhum titulo para baixar, retorna sem fazer nada.
IF SE2->(EOF())
	RETURN lBaixou
ENDIF
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Posiciona Fornecedor no SA2                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SA2")
SA2->(dbSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))

lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )


dbSelectArea("SE2")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Carrega Variaveis da Baixa                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nSalvRec 	:= RecNo()
cTitulo := SE2->E2_PREFIXO + " " + SE2->E2_NUM+ " " + SE2->E2_PARCELA
cParcela  	:= SE2->E2_PARCELA
dEmissao		:= SE2->E2_EMISSAO
dVencRea		:= SE2->E2_VENCREA
cNomeFor 	:= SE2->E2_FORNECE + " - " + Subst(SA2->A2_NOME,1,40)
cHist			:= SE2->E2_HIST
dBaixa      := CriaVar("E2_BAIXA")
If cPaisLoc == "BRA"
	nTxMoeda	 := If(SE2->E2_MOEDA > 1,If(SE2->E2_TXMOEDA > 0, SE2->E2_TXMOEDA,RecMoeda(dBaixa,SE2->E2_MOEDA)),0)
Endif	
dDtCredito  := dDataBase
If SE2->E2_IMPCHEQ == "S"  // Cheque s/ Titulo
	cCheque		:= SE2->E2_NUMBCO
Else
	cCheque		:= CRIAVAR("E2_NUMBCO")
Endif
cHist070	:= Criavar("E5_HISTOR")		//Inicilizador padrao
If Empty(cHist070)
	cHist070 := OemToAnsi(STR0007)+Space(Len(cHist070)-24)  // "Valor recebido s/ T¡tulo"
Endif
cMotBx		:= aDescMotBx[1] 	//NORMAL
nValor		:= SE2->E2_VALOR
nTotAbat	:= SumAbatPag(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_FORNECE,SE2->E2_MOEDA,"S",dBaixa,SE2->E2_LOJA)
dbGoto(nSalvRec)
nParciais	:= SE2->E2_VALOR-SE2->E2_SALDO
nAcrescF 	:= SE2->E2_SDACRES
nDecrescF	:= SE2->E2_SDDECRE
nAcresc		:= Round(Noround(xMoeda(SE2->E2_SDACRES,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
nDecresc		:= Round(Noround(xMoeda(SE2->E2_SDDECRE,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)

// Para titulos de vendor antigos
If STR(SE2->E2_VALOR,17,2) == STR(SE2->E2_SALDO,17,2) .and. ;
	 SE2->E2_SDACRES == 0 .and. SE2->E2_ACRESC > 0
	nAcresc	:= Round(Noround(xMoeda(SE2->E2_ACRESC,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
	nAcrescF := SE2->E2_ACRESC
Endif	

nDescont    	:= 0
nMulta      	:= 0
nJuros      	:= 0
nPis				:= 0
nCofins			:= 0
nCsll				:= 0
nVlRetPis		:= 0
nVlRetCof		:= 0
nVlRetCsl		:= 0
nValPgto			:= 0
nOldValPgto		:= 0
nDiferImp		:= 0

nIrrf				:= 0
nVlRetIrf		:= 0
nIss				:= 0
nValPgto		:= Round(Noround(xMoeda(SE2->E2_SALDO-nTotAbat,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
nOldValPgto := nValPgto

F080IssBx()

If lPccBaixa
	fA080Data()
	f080TotMes(dBaixa,.T.)
Endif

fa080Val(nValPgto,nTxMoeda)
nOldValPgto := nValPgto
nCM         	:= 0
cMoeda 		:= IIF(Empty(SE2->E2_MOEDA),"1",AllTrim(Str(SE2->E2_MOEDA,2)))
cDescMoeda 	:= SubStr(GetMV("MV_SIMB"+cMoeda),1,3)
cTexto1	 	:= OemToAnsi(STR0084) + SubStr(GetMV("MV_SIMB"+cMoeda),1,3) //"Valor Original "
If Empty(cBenef)
	dbSelectArea("SA2")
	SA2->(dbSeek(cFilial+SE2->E2_FORNECE+SE2->E2_LOJA))
	dbSelectArea("SE2")
	cBenef   := SA2->A2_NOME
Endif

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Analisa se o titulo foi gerado a partir de um cheque pre datado.		³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lChqPre := .f.
dbSelectArea("SE5")
dbSetOrder(2)
If SE5->(dbSeek( xFilial("SE5") + "CD" + SE2->E2_PREFIXO + ;
		SE2->E2_NUM + SE2->E2_PARCELA + SE2->E2_TIPO + dToS(SE2->E2_EMISSAO )+;
		SE2->E2_FORNECE + SE2->E2_LOJA ))

	lChqPre := .T.
	cBanco   := SE5->E5_BANCO
	cAgencia := SE5->E5_AGENCIA
	cConta   := SE5->E5_CONTA
	cCheque  := SE5->E5_NUMCHEQ
	cBenef   := SE5->E5_BENEF
EndIf

// Carrega as variaveis bancarias
Fa080BDev()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Pr‚-inicializa a modalidade de SPB                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lSpbInUse
	If !Empty(SE2->E2_MODSPB)
		cModSpb := SE2->E2_MODSPB
	Else
	   cModSpb := "1"
	Endif		
Endif

If lFa080Lt		// ponto de entrada para manipulacao do titulo antes da baixa
	Execblock("FA080LT" ,.F.,.F.)
Endif        

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³PONTO DE ENTRADA FA080ACES ³
//³ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Permite ou nao que o usuario altere os valores dos impostos da lei 10925 ³
//³ calculados automaticamente pelo sistema.                                 ³
//³ Vari veis dispon¡veis para serem alteradas :                             ³
//³                                                                          ³
//³ lAcessImp ( .T. - PERMITE  /  .F. - NAO PERMITE )								  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If ExistBlock("FA080ACES")
	lAcessImp := ExecBlock("FA080ACES",.F.,.F.)
Endif

DEFINE MSDIALOG oDlgLote FROM	31,15 TO 527,574 TITLE OemToAnsi(STR0007)  PIXEL OF oMainWnd //"Baixas a Pagar"
@ 37, 001 TO 247, 137 LABEL OemToAnsi(STR0013) OF oDlgLote  PIXEL //"Dados Gerais"
@ 38, 143 TO 247, 278 LABEL OemToAnsi(STR0014) OF oDlgLote  PIXEL //"Valores da Baixa"
@ 01, 002 TO 035, 278 LABEL OemToAnsi(STR0015) OF oDlgLote  PIXEL //"Principal"

If lUsaCmc7
	aCmc7:=LjLeCmc7(1)
	If Len(aCmc7) > 0
		cBanco  :=aCmc7[1]
		cAgencia:=aCmc7[2]
		cConta  :=aCmc7[3]
		cCheque :=aCmc7[4]
	Endif
Endif

@ 010, 010 SAY OemToAnsi(STR0016)		SIZE 18,07 OF oDlgLote PIXEL // "T¡tulo"
@ 008, 030 MSGET oTitulo VAR cTitulo	F3 "SE2RDO" SIZE 57,10 OF oDlgLote PIXEL HASBUTTON
oTitulo:lReadOnly := .T.
@ 010, 095 SAY OemToAnsi(STR0017)		SIZE 31,07 OF oDlgLote PIXEL //"Emiss„o"
@ 008, 127 MSGET oEmissao VAR dEmissao SIZE 39,10 OF oDlgLote PIXEL When .F.
@ 010, 169 SAY OemToAnsi(STR0018)		SIZE 39,07 OF oDlgLote PIXEL //"Vencto.Atual"
@ 008, 202 MSGET oVencRea VAR dVencRea SIZE 39,10 OF oDlgLote PIXEL When .F.
@ 022, 005 SAY OemToAnsi(STR0019)		SIZE 22,07 OF oDlgLote PIXEL //"Fornec."
@ 020, 030 MSGET oNomeFor VAR cNomeFor	F3 "SA2" SIZE 211,9 OF oDlgLote PIXEL HASBUTTON
oNomeFor:lReadOnly := .T.
@ 046, 007 SAY OemToAnsi(STR0020)		SIZE 38,07 OF oDlgLote PIXEL //"Hist.Emiss„o"
@ 043, 050 MSGET oHist VAR cHist			SIZE 79,10 OF oDlgLote PIXEL When .F.
@ 057, 007 SAY OemToAnsi(STR0021)		SIZE 39,07 OF oDlgLote PIXEL //"Portador"
@ 056, 050 MSGET oPortado VAR cPortado	SIZE 66,10 OF oDlgLote PIXEL When .F.
@ 069, 007 SAY OemToAnsi(STR0029)		SIZE 37,07 OF oDlgLote PIXEL //"Mot.Baixa"
@ 068, 050 COMBOBOX oMotBx VAR cMotBx ITEMS aDescMotbx SIZE 56,47 OF oDlgLote PIXEL ;
	ON CHANGE (fa080ChkVdr(),oBanco:lReadOnly := !fa080digit()) Valid fa080BDev()

@ 081, 007 SAY OemToAnsi(STR0022)		SIZE 40,07 OF oDlgLote PIXEL //"Banco"
@ 080, 050 MSGET oBanco VAR cBanco 		SIZE 22,10 OF oDlgLote PIXEL HASBUTTON F3 "SA6" Valid CarregaSA6(@cBanco,,,.T.) .and. fa080BcoCx()
oBanco:lReadOnly := !fa080digit()

@ 093, 007 SAY OemToAnsi(STR0023)		SIZE 39,07 OF oDlgLote PIXEL //"Agˆncia"
@ 092, 050 MSGET oAgencia VAR cAgencia	SIZE 35,09 OF oDlgLote PIXEL When fa080digit() Valid ;
	CarregaSA6(@cBanco,@cAgencia,,.T.)
@ 106, 007 SAY OemToAnsi(STR0024)		SIZE 41,07 OF oDlgLote PIXEL //"Conta"
@ 104, 050 MSGET oConta VAR cConta 		SIZE 66,10 OF oDlgLote PIXEL When fa080digit() Valid ;
	If (CarregaSA6(@cBanco,@cAgencia,@cConta,.T.,,.T.),.T.,oBanco:SetFocus())	
@ 118, 007 SAY OemToAnsi(STR0027)		SIZE 40,07 OF oDlgLote PIXEL //"Cheque No."
@ 116, 050 MSGET oCheque VAR cCheque	SIZE 38,10 OF oDlgLote PIXEL When (fa080digit() .and. faDigiChq()) Valid fa080Cheq()
@ 130, 007 SAY OemToAnsi(STR0025)		SIZE 38,07 OF oDlgLote PIXEL //"Data Pagto."
@ 128, 050 MSGET oBaixa VAR dBaixa 		SIZE 50,09 OF oDlgLote PIXEL HASBUTTON Valid fa080Data(@nTxMoeda) .and. DtMovFin(dBaixa) .and. f080TotMes(dBaixa,.T.)
@ 142, 007 SAY OemToAnsi(STR0026)		SIZE 39,07 OF oDlgLote PIXEL //"Hist.Baixa"
@ 140, 050 MSGET oHist070 VAR cHist070	SIZE 83,10 OF oDlgLote PIXEL Picture "@!" VALID CheckSX3("E5_HISTOR") When VisualSX3("E5_HISTOR")
@ 154, 007 SAY OemToAnsi(STR0028)	 	SIZE 36,07 OF oDlgLote PIXEL //"Beneficiário"
@ 152, 050 MSGET oBenef VAR cBenef		SIZE 84,10 OF oDlgLote PIXEL Picture "@!" When cNivel >= NivelSx3("E5_BENEF") .and. fa080digit()
nUltLin := 152
If cPaisLoc == "BRA" 
	@ nUltLin+14,007 SAY STR0129 	SIZE 53, 07 OF oDlgLote PIXEL //"Taxa contratada"
	@ nUltLin+12,050 MSGET nTxMoeda  SIZE 66, 10 OF oDlgLote PIXEL Picture PesqPict( "SM2","M2_MOEDA"+AllTrim(Str(SE2->E2_MOEDA))) ;
				 When SE2->E2_MOEDA > 1	 Valid Fa080Val(0,nTxMoeda)
	nUltLin += 12
Endif	                   
If lSpbInUse
	@ nUltLin+14,007 SAY STR0128 SIZE 32, 07 OF oDlgLote PIXEL //"Modalidade SPB"
	@ nUltLin+12,050 COMBOBOX oModSPB VAR cModSpb ITEMS aModalSpb SIZE 56, 47 OF oDlgLote PIXEL ;
					  When MovBcoBx(cMotBx,.T.) 
	nUltLin+= 12	
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Somente exibe a opcao Rateio Multiplas Naturezas se parametro MV_MULNATP = .T.  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ       
If MV_MULNATP
	@ nUltLin+14,005 SAY STR0132 SIZE 100, 07 OF oDlgLote PIXEL   //"Rateio Mult.Naturezas"
	@ nUltLin+12,90 CHECKBOX oMultNat VAR lMultNat PROMPT "" SIZE 11,11 OF oDlgLote PIXEL
Endif

@ 047, 151 SAY oTexto1 VAR cTexto1 		SIZE 53,07 OF oDlgLote PIXEL //"Valor Original"
@ 044, 208 MSGET oValor VAR nValor		SIZE 66,10 OF oDlgLote PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
@ 058, 151 SAY OemToAnsi(STR0035)		SIZE 53,07 OF oDlgLote PIXEL //"- Abatimentos"
@ 056, 208 MSGET oTotAbat VAR nTotAbat	SIZE 66,10 OF oDlgLote PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
@ 070, 151 SAY OemToAnsi(STR0036)  		SIZE 53,07 OF oDlgLote PIXEL //"- Pagtos.Parciais"
@ 069, 208 MSGET oParciais VAR nParciais	SIZE 66,10 OF oDlgLote PIXEL When .F. Picture PesqPict("SE2","E2_VALOR")
@ 082, 151 SAY OemToAnsi(STR0121)	   SIZE 53,07 OF oDlgLote PIXEL //"- Decrescimo"
@ 081, 208 MSGET oDecresc VAR nDecresc	SIZE 66,10 OF oDlgLote PIXEL Picture PesqPict("SE2","E2_SDDECRE") When .f. //Valid Fa080Val(nDecresc) .and. nDecresc<=Moeda(SE2->E2_SALDO,1,"P",dBaixa)
@ 095, 151 SAY OemToAnsi(STR0120)  		SIZE 53,07 OF oDlgLote PIXEL //"+ Acrescimo"
@ 093, 208 MSGET oAcresc VAR nAcrescF 		SIZE 66,10 OF oDlgLote PIXEL Picture PesqPict("SE2","E2_SDACRES") When .f. //Valid Fa080Val(nAcresc)

@ 107, 151 SAY OemToAnsi(STR0037)	   SIZE 53,07 OF oDlgLote PIXEL //"- Descontos"
@ 105, 208 MSGET oDescont VAR nDescont	SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_DESCONT") Valid Fa080Val(nDescont,nTxMoeda,.T.) .and. nDescont<=xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dBAIXA,,nTxMoeda)
oDescont:SetEnable( lAcessDes )

@ 119, 151 SAY OemToAnsi(STR0038)		SIZE 53,07 OF oDlgLote PIXEL //"+ Multa"
@ 117, 208 MSGET oMulta VAR nMulta 		SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_MULTA") Valid Fa080Val(nMulta,nTxMoeda,.T.)
oMulta:SetEnable( lAcessMul )

@ 131, 151 SAY OemToAnsi(STR0039)  		SIZE 53,7 OF oDlgLote PIXEL //"+ Tx.Permanenc."
@ 129, 208 MSGET oJuros VAR nJuros 		SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_JUROS") Valid Fa080Val(nJuros,nTxMoeda,.T.)
oJuros:SetEnable( lAcessJur)

nLinha := 131

//Get do ISS na baixa
If lCalcIssBx .and. cPaisLoc == "BRA"
	@ 12+nLinha, 151 SAY "- Iss"	SIZE 53,07 OF oDlgLote PIXEL
	@ 10+nLinha, 208 MSGET oIss VAR nIss	SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
	Valid (Fa080Val(nIss,,.T.))
	nLinha +=12
Endif

If lPccBaixa .and. cPaisLoc == "BRA"

	@ 12+nLinha, 151 SAY "- Irrf"	SIZE 53,07 OF oDlgLote PIXEL
	@ 10+nLinha, 208 MSGET oIrrf VAR nIrrf	SIZE 66,10 OF oDlgLote When lIrfMP232 PIXEL HASBUTTON  Picture PesqPict("SE2","E2_IRRF")  ;
	Valid ( Fa080Val(nIrrf,,,.T.))
	nLinha +=12

	@ 12+nLinha, 151 SAY "- Pis"	SIZE 53,07 OF oDlgLote PIXEL
	@ 10+nLinha, 208 MSGET oPis VAR nPis	SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_PIS")  ;
	Valid ( Fa080Val(nPis,,,.T.))
	oPis:SetEnable( lAcessImp )
	nLinha +=12
	@ 12+nLinha, 151 SAY "- Cofins" 	SIZE 53,07 OF oDlgLote PIXEL
	@ 10+nLinha, 208 MSGET oCofins VAR nCofins SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_COFINS") ;
	Valid ( Fa080Val(nCofins,,,.T.)) 
	oCofins:SetEnable( lAcessImp )
	nLinha +=12
	@ 12+nLinha, 151 SAY "- Csll"	SIZE 53,07 OF oDlgLote PIXEL
	@ 10+nLinha, 208 MSGET oCsll VAR nCsll	SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_CSLL") ;
	Valid ( Fa080Val(nCsll,,,.T.))				
	oCsll:SetEnable( lAcessImp )
	nLinha +=12                              
Endif

nValTot	     := SE2->E2_VLCRUZ
nValEstrang  := SE2->E2_SALDO-nTotAbat-SE2->E2_SDACRES+SE2->E2_SDDECRE
nValOrig     := SE2->E2_SALDO-nTotAbat
nEstOriginal := nValEstrang-(xMoeda(nJuros+nMulta-nDescont,1,SE2->E2_MOEDA,,3,,nTxMoeda))
nValMoeda   := Round(Noround(xMoeda(nValOrig,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
nValMoeda1  := Round(NoRound(xMoeda(SE2->E2_VALOR-nTotAbat,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
nValPgto    := nValMoeda+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
IF (nMulta+nJuros+nDescont+nAcresc+nDecresc+nPis+nCoFins+nCsll) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),2 ) > 0.01
	nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
EndIF
nValLiq	    := nValPgto-nMulta-nJuros+nDescont-nAcresc+nDecresc+nPis+nCoFins+nCsll-nIrrf-nIss
FA080CORR(nEstOriginal,nTxMoeda)
@ 12+nLinha, 151 SAY OemToAnsi(STR0041)	 	SIZE 53,07 OF oDlgLote PIXEL //"= Valor Pago"
@ 10+nLinha, 208 MSGET oValPgto VAR nValPgto	SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALLIQ")  ;
	Valid ( oValPgto:Refresh(),;
	FA080REFRE(1),;
	Fa080ValVR(nTxMoeda,nTolerCp))
nLinha += 12	
cTexto2 	:= OemToAnsi(STR0042) + SubStr(GetMV("MV_SIMB"+cMoeda),1,3) //"Valor "
@ 12+nLinha, 151 SAY oTexto2 VAR cTexto2 SIZE 53,07 OF oDlgLote PIXEL //"Valor "
@ 10+nLinha, 208 MSGET oVlEstrang VAR nValEstrang		SIZE 66,10 OF oDlgLote PIXEL HASBUTTON Picture PesqPict("SE2","E2_VALOR")  ;
				When SE2->E2_MOEDA > 1 Valid FA080Estrang(nTxMoeda,nTolerCP) .and.  FA080REFRE()

nLinha += 12	

@ 12+nLinha, 151 SAY OemToAnsi(STR0040) 		SIZE 53,07 OF oDlgLote PIXEL //"+ Corr.Monet ria"
@ 10+nLinha, 208 MSGET oCM VAR nCM				SIZE 66,10 OF oDlgLote PIXEL Picture PesqPict("SE2","E2_CORREC") ;
	When SE2->E2_MOEDA > 1 .and. (IIf(GetMv("MV_CALCCM") == "S",.T.,.F.))
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Atualiza o valor caso seja necessario calcular juros no titulo          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ		
fa080Data()

DEFINE SBUTTON FROM 06, 246 TYPE 1 ENABLE OF oDlgLote ACTION ( nOpca := 1,;
	Fa080But(nOpca,lMovBco,@lBaixou,@cTitulo,@oTitulo,;
	@cParcela,@oParcela,@cNomeFor,@oNomeFor,;
	@cBanco,@oBanco,@cAgencia,@oAgencia,@cConta,@oConta,;
	@oBaixa,@oBenef,@cHist070,@oHist070,@cMotBx,@oMotBx,;
	@aDescMotBx,@nValor,;
	@oValor,@nTotAbat,@oTotAbat,@nParciais,@oParciais,@oDescont,;
	@oMulta,@oJuros,@oValPgto,@oVlEstrang,@oCM,@oDlgLote,cMarca,;
	@nTotal, @nHdlPrv, @lHdlPrv, @lPadraoBx,@cArquivo,@nValLiq,@cPadrao,;
	@cHist,@oHist,@nAcresc,@oAcresc,@nDecresc,@oDecresc,@nAcrescF,@nDecrescF,;
	aModalSpb,@oModSpb,lSpbInUse,nTxMoeda,@oMultNat,@lMultNat,@nTotLtEZ,nTolerCp,aMotBx,;
	@nPis,@nCoFins,@nCsll,@oPis,@oCoFins,@oCsll,lPccBaixa,@nOldValPgto,@nIrrf,@oIrrf,@nIss,@oIss))

DEFINE SBUTTON FROM 20, 246 TYPE 2 ENABLE OF oDlgLote ACTION ( nOpca := 0 ,;
	Fa080But(nOpca,lMovBco,@lBaixou,@cTitulo,@oTitulo,;
	@cParcela,@oParcela,@cNomeFor,@oNomeFor,;
	@cBanco,@oBanco,@cAgencia,@oAgencia,@cConta,@oConta,;
	@oBaixa,@oBenef,@cHist070,@oHist070,@cMotBx,@oMotBx,;
	@aDescMotBx,@nValor,;
	@oValor,@nTotAbat,@oTotAbat,@nParciais,@oParciais,@oDescont,;
	@oMulta,@oJuros,@oValPgto,@oVlEstrang,@oCM,@oDlgLote,cMarca,;
	@nTotal, @nHdlPrv, @lHdlPrv, @lPadraoBx,@cArquivo,@nValLiq,@cPadrao,;
	@cHist,@oHist,@nAcresc,@oAcresc,@nDecresc,@oDecresc,@nAcrescF,@nDecrescF,;
	aModalSpb,@oModSpb,lSpbInUse,nTxMoeda,@oMultNat,@lMultNat,@nTotLtEZ,nTolerCp,aMotBx,;
	@nPis,@nCoFins,@nCsll,@oPis,@oCoFins,@oCsll,lPccBaixa,@nOldValPgto,@nIrrf,@oIrrf,@nIss,@oIss))

ACTIVATE MSDIALOG oDlgLote

Return lBaixou

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³fA080OK   ³ Autor ³ Wagner Xavier         ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica se dados digitados esta OK                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ fA080ok()                                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Gen‚rico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Fa080OK(cBanco,cAgencia,cConta,nValPgto,dBaixa,nJuros,nCM,nMulta,;
	nDescont,nTotAbat,lMovBco,nValliq,aDescMotBx,lSpbinUse,nTxMoeda,nTolerCp,nPis,nCoFins,nCsll,nIrrf,nIss)

Local nOrdSEF := SEF->(IndexOrd())

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se valor da baixa ‚ maior que o valor m ximo a receber       ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF Str(nValPgto,17,2) > Str((xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda)+nJuros+nMulta-nDescont-nTotAbat+nAcresc-nDecresc+nTolerCp-nPis-nCoFins-nCsll-nIrrf-nIss),17,2)
	Help(" ",1,"ValorMaior")
	If ( SE2->E2_MOEDA == 1 )
		Return .F.
	EndIf
	//    Avisa o usu rio, por‚m deixa o usuario efetuar a baixa
	//    pois ocorre de o cliente receber o mesmo numero de US$
	//    com a cota‡„o acima a data cota‡„o di ria
Endif

dbSelectArea("SE2")
If Empty(cMotBx)
	cMotBx := aDescMotBx[1]  //NORMAL
Endif
IF Empty(dBaixa) .or. (nValPgto < 0 ) .or. Empty(cMotBx)
	Help(" ",1,"FA070INV")
	DbSelectArea("SE2")
	Return .F.
EndIF

IF (nTotAbat = 0 .and. nDescont = 0 .and. nDecresc = 0 .and. nPis = 0 .and. ;
	nCofins = 0 .and. nCsll = 0 .and. nIrrf = 0 .and. nIss = 0.and. nValPgto = 0) .or. ;
	(nValPgto=0.and.(nTotAbat+nDescont+nDecresc+nPis+nCofins+nCsll+nIrrf+nIss)!=xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dBaixa,,nTxMoeda))
	Help(" ",1,"FA070INV")
	Return .F.
EndIF

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Caso motivo seja VENDOR, dever   ser contabilizado na baixa. 			   ³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF SE2->E2_IMPCHEQ != "S"
	IF ((MovBcoBx(cMotBx, .T.) .and. (Empty(dBaixa) .Or. Empty(cBanco) .Or. Empty(cConta))) .Or. ;
			( nValPgto < 0 ))
		Help(" ",1,"FA080VAZ")
		DbSelectArea ("SE2")
		Return .F.
	Endif
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se cheque existe e nÆo foi gerado por rotina cheques s/Titulo   ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF !Empty(cCheque) .and. Substr(cCheque,1,1) != "*" .and. !lChqPre .and. SE2->E2_IMPCHEQ != "S"
	nOrdSEF := SEF->(IndexOrd())
	SEF->(dbSetOrder(1))
	If SEF->(dbSeek(xFilial("SEF")+cBanco+cAgencia+cConta+cCheque))
		Help(" ",1,"CHEQEXIST")
		dbSelectArea("SE2")
		Return .F.
	Endif
	SEF->(dbSetOrder(nOrdSEF))	
Endif
If SE5->(FieldPos("E5_VLACRES")) == 0  .and. SE5->(FieldPos("E5_VLDECRE")) == 0
	IF nValPgto < (nMulta+nJuros+nAcresc)
		Help(" ",1,"FA070INV")
		DbSelectArea("SE2")
		Return .F.
	Endif
EndIf

IF nValPgto != nValLiq .And. TrazCodMot(cMotBx) == "VEN"
	Help(" ",1,"FA080BXPARC")
	dbSelectArea("SE2")
	Return .F.
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Verifica se modalidade do SPB é valida.									    ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lSpbInUse
	cModSpb := Substr(cModSpb,1,1)
	IF !(SpbTipo("SE2",cModSpb,SE2->E2_TIPO))
		Return .f.
	Endif
Endif

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA080But  ³ Autor ³ Wagner Xavier         ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Recarrega Variaveis                                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Fa080But()                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Gen‚rico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Fa080But(nOpca,lMovBco,lBaixou,cTitulo,oTitulo,;
	cParcela,oParcela,cNomeFor,oNomeFor,;
	cBanco,oBanco,cAgencia,oAgencia,cConta,oConta,;
	oBaixa,oBenef,cHist070,oHist070,cMotBx,oMotBx,aDescMotBx,nValor,;
	oValor,nTotAbat,oTotAbat,nParciais,oParciais,oDescont,;
	oMulta,oJuros,oValPgto,oVlEstrang,oCM,oDlgLote,cMarca,;
	nTotal, nHdlPrv, lHdlPrv, lPadraoBx,cArquivo,nValLiq,cPadrao,;
	cHist,oHist,nAcresc,oAcresc,nDecresc,oDecresc,nAcrescF,nDecrescF,;
	aModalSpb,oModSpb,lSpbInUse,nTxMoeda,oMultNat,lMultNat,nTotLtEZ,nTolerCp,aMotBx,;
	nPis,nCoFins,nCsll,oPis,oCoFins,oCsll,lPccBaixa,nOldValPgto,nIrrf,oIrrf,nIss,oIss)

Local nSalvRec
LOCAL lPadraoVd
LOCAL cContabiliza := GETMV("MV_CTBAIXA")
LOCAL lContabiliza
Local cLanca	:= Iif(mv_par03==1,"S","N")
Local lFa080tit:= Existblock("FA080TIT")
LOCAL lRet:=.T.
Local nTamTitOri := TamParcela("E2_PARCELA",19,20,21)
Local lOk := .F. //Controla se foi confirmada a distribuicao 
Local aColsSEV := {}
Local lContabMnat

Local nOldVlPis := 0
Local nOldVlCof := 0
Local nOldVlCsl := 0

Local nOldVlIrf := 0
Local lIrfMP232 := .F.

Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)
DEFAULT nTxMoeda := 0

If nOpca == 1
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Ponto de Entrada - para confirmacao da baixa					³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If lFa080Tit
		lRet	:= ExecBlock("FA080TIT",.F.,.F.)
	Endif
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ-Ä¿
	//³ Conforme situacao do parametro abaixo, integra com o SIGAGSP ³
	//³             MV_SIGAGSP - 0-Nao / 1-Integra                   ³                
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ-ÄÄÙ
	If lRet .And. GetNewPar("MV_SIGAGSP","0") == "1" 
		lRet := GSPF050()
	EndIf
	
	If !lRet
		Return lRet
	EndIf	
	If MovBcoBx(cMotBx) .and. !CarregaSa6(cBanco,cAgencia,cConta,.T.,,.T.)
		Return .F.
	EndIf
	If !DtMovFin(dBaixa)
		Return .F.
	EndIf
	If !Fa080OK(cBanco,cAgencia,cConta,nValPgto,dBaixa,nJuros,;
			nCM,nMulta,nDescont,nTotAbat,lMovBco,nValLiq,aDescMotBx,lSpbInUse,nTxMoeda,nTolerCp,nPis,nCoFins,nCsll,nIrrf,nIss)
		Return .F.
	EndIf			
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Caso esteja ligado o controle de solicitacao de notas de credito e exista alguma ³
	//³ pendencia para este titulo                                                       ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If cPaisLoc <> "BRA"
		SCU->(DbSetOrder(2))
	Endif	
	If cPaisloc <> "BRA" .And. SuperGetMv('MV_SOLNCP') .And. SE2->E2_TIPO == MVNOTAFIS ;
			.And. SCU->(MsSeek(xFilial()+SE2->E2_FORNECE+SE2->E2_LOJA+SE2->E2_NUM+SE2->E2_PREFIXO)).And. Empty(SCU->CU_NCRED)
		HELP(" ",1,"SOLNCPAB")
		Return .F.
	Endif  

	nValPadrao := nValPgto-(nJuros+Iif(SE2->E2_MOEDA<=1,nCM,0)+nMulta-nDescont-nTotAbat+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss)
	If Empty( cMotBx )
		cMotBx := aDescMotBx[1]  //NORMAL
	Endif
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Identifica se contab. deve ocorrer na baixa ou gera‡„o de cheques e se³
	//³ o tipo do titulo for PA e existir cheque deve ser contabilizado  	  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SEF")
	dbSetOrder(3)
	If SE2->E2_TIPO $ MVPAGANT .and. SEF->(dbseek(xFilial("SEF")+SE2->E2_PREFIXO+SE2->E2_NUM+;
			SE2->E2_PARCELA+SE2->E2_TIPO))
		lContabiliza := .T.
	Else
		lContabiliza := IIf(cContabiliza = "B" .Or. cContabiliza = "A", .T., .F.)
	EndIf
	SEF->( dbSetOrder(1))
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³ Verifica onde ocorrer  a contabiliza‡„o 										  	³
	*³ Se for informado num. do cheque, deve contabilizar pela baixa			  	³
	*³ Se n„o informou num. do cheque ou num. cheque come‡ar com "*" na gera‡„o³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If (!Empty( cCheque ) .and. SubStr( cCheque, 1, 1 ) != "*" .and. SE2->E2_IMPCHEQ != "S") .or. ;
			cContabiliza = "B" .Or. cContabiliza = "A" .or. ;
			Substr(cBanco,1,2)=="CX" .or. cBanco$GetMV("MV_CARTEIR")
		lContabiliza := .T.
	Endif
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Caso motivo seja VENDOR, dever   ser contabilizado na baixa. 			   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If TrazCodMot(cMotBx) $ "VEN/DEB"
		lContabiliza := .T.
	EndIF

	If MovBcoBx(cMotBx, .T.) .and. !ChqMotBx(cMotBx)
		lContabiliza := .T.
	EndIF
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Soma nos totalizadores														³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nTotAGer += nValPgto
	nTotADesc+= nDescont+nDecresc
	nTotAMul += nMulta
	nTotAJur += nJuros+nAcresc
	nTotADesp+=Iif(SE2->E2_MOEDA<=1,nCM,0)
	cPadrao:="530"
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³Contabiliza se existir o lan‡amento e:									  ³
	*³ - a contabiliza‡„o for feita na baixa (parƒmetro mv_ctBaixa) ou  ³
	*³ - se digitou numero de cheque ou se a contabiliza‡„o for on-line ³
	*³ Verifica existencia do lan‡amento padr„o da baixa e/ou do gera‡„o³
	*³ do t¡tulo referente ao Vendor.											  ³
	*³ Lan‡amento Padr„o referente a baixa   := "530"                   ³
	*³ Lan‡amento Padr„o referente ao Vendor := "518"                   ³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	lPadraoBx := VerPadrao(cPadrao) .And. lContabiliza
	lPadraoVd := VerPadrao( "518" ) .And. lContabiliza
	VALOR := 0	
	ABATIMENTO := nTotAbat
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicio da prote‡„o via TTS								  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	nRegSE2:= SE2->(Recno())

	cNumBor := SE2->E2_NUMBOR
	
	If MV_MULNATP .and. lMultNat
		MultNatB("SE2",.F.,STR(mv_par05,1),@lOk,@aColsSEV,@lMultNat)
	Endif
                      
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Inicializa a gravacao dos lancamentos do SIGAPCO          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	PcoIniLan("000005")

	Begin Transaction
		lBaixou := fa080Grv(lPadraoBx,lPadraoVd,,cLanca,,nTxMoeda)
		IF lBaixou
			If lPccBaixa
				nOldVlPis := SE2->E2_PIS
				nOldVlCof := SE2->E2_COFINS
				nOldVlCsl := SE2->E2_CSLL
				nOldVlIrf := SE2->E2_IRRF				
				nOldVlIss := SE2->E2_ISS				
				
				Reclock("SE2")
				SE2->E2_PIS := nPis
				SE2->E2_COFINS := nCofins
				SE2->E2_CSLL := nCsll
				SE2->E2_IRRF := nIrrf
				SE2->E2_ISS := nIss
				MsUnlock()
			Endif
	
			// Verifica se esta utilizando multiplas naturezas
			// Chama rotina de gravacao do SEV e SEZ
			If MV_MULNATP .and. lMultNat .and. lOk
				lContabMNat := lContabiliza .and. mv_par03 == 1
				MultNatC("SE2",@nHdlPrv,@nTotal,@cArquivo,lContabMNat,.T.,STR(mv_par05,1),@nTotLtEZ,lOk,aColsSEV,lBaixou)
				lHdlPrv := nHdlPrv > 0
			Endif

			//Reposiciono o arquivo de bancos para a contabilizacao
			SA6->(DbSetOrder(1))
	    	SA6->(dbSeek(xFilial()+cBanco+cAgencia+cConta))

			//Reposiciono o arquivo de fornecedores para a contabilizacao
			SA2->(dbSetOrder(1))
			SA2->(MsSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))

			
			IF ( lPadraoBx .or. lPadraoVd ) .and. cLanca == "S" .and. !lHdlPrv
				nHdlPrv:=HeadProva(cLote,"FINA080",Substr(cUsuario,7,6),@cArquivo)
				lHdlPrv := .T.
			Endif
			IF lPadraoBx .and. cLanca == "S" .and. !lMultNat
				nTotal+=DetProva(nHdlPrv,cPadrao,"FINA080",cLote)
			Endif
			IF lPadraoVd .and. cLanca == "S" .and. TrazCodMot(cMotBx) == "VEN" .and. !lMultNat
				dbSelectArea( "SE2" )
				IF (dbSeek( cFilial +  Left(SE2-> E2_TITORIG,nTamTitOri) ) )
					nTotal+=DetProva(nHdlPrv,"518","FINA080",cLote)
				Endif
			Endif
			If lPccBaixa
				Reclock("SE2")
				SE2->E2_PIS := nOldVlPis
				SE2->E2_COFINS := nOldVlCof
				SE2->E2_CSLL := nOldVlCsl
				SE2->E2_IRRF := nOldVlIrf
				MsUnlock()
			Endif	
		
			PcoDetLan("000005","01","FINA080")
			
		Endif
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Final  da protecao via TTS								  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	End Transaction

	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Finaliza a gravacao dos lancamentos do SIGAPCO          ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	PcoFinLan("000005")
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Pontos de Entrada								    ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If (ExistTemplate( "FA080PE" ) )
		ExecTemplate("FA080PE",.F.,.F.)
	Endif
	If (ExistBlock( "FA080PE" ) )
		ExecBlock("FA080PE",.F.,.F.)
	Endif

	dbSelectArea("SE2")
	dbGoTo(nRegSE2)
Else
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Limpa marca para titulo com baixa abortada.                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SE2")
	Begin Transaction
		RecLock ("SE2",.F.)
		Replace E2_OK with ""
	End Transaction
Endif

While !Eof()
	If SE2->E2_OK != cMarca
 		If SE2->E2_OK == "xx"
   		dbSKip()
     		nProxRec := Recno()
         dbSkip(-1) 
         RecLock ("SE2",.F.)
         Replace E2_OK with ""
         dbGoto(nProxRec)
		Else
   		dbSKip()
  		Endif
 	Else
   	Exit
  	Endif
EndDo		

If Eof()
	oDlgLote:End()
	Return lBaixou
EndIf

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Posiciona Fornecedor no SA2                                          ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SA2")
SA2->(dbSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))
lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )

dbSelectArea("SE2")

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Carrega Variaveis da Baixa                                           ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nSalvRec    := RecNo()
cTitulo		:= SE2->E2_PREFIXO + " " + SE2->E2_NUM+ " " + SE2->E2_PARCELA
cParcela    := SE2->E2_PARCELA
dEmissao    := SE2->E2_EMISSAO
dVencRea    := SE2->E2_VENCREA
cNomeFor    := SE2->E2_FORNECE + " - " + Subst(SA2->A2_NOME,1,40)
cHist	    := SE2->E2_HIST
dBaixa      := CriaVar("E2_BAIXA")
If cPaisLoc == "BRA"
	nTxMoeda	 := If(SE2->E2_MOEDA > 1,If(SE2->E2_TXMOEDA > 0, SE2->E2_TXMOEDA,RecMoeda(dBaixa,SE2->E2_MOEDA)),0)
Endif	
dDtCredito  := dDataBase
cHist070    := Criavar("E5_HISTOR")		//Inicilizador padrao
If Empty(cHist070)
   cHist070 := OemToAnsi(STR0007)+Space(Len(cHist070)-24)  // "Valor recebido s/ T¡tulo"
Endif
nValor	    := SE2->E2_VALOR
nTotAbat    := SumAbatPag(SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_FORNECEn,SE2->E2_MOEDA,"S",dBaixa,SE2->E2_LOJA)
dbGoto(nSalvRec)
nParciais   := SE2->E2_VALOR-SE2->E2_SALDO
nDescont    := 0
nMulta      := 0
nJuros      := 0
nAcrescF 	:= SE2->E2_SDACRES
nDecrescF	:= SE2->E2_SDDECRE
nAcresc		:= Round(Noround(xMoeda(SE2->E2_SDACRES,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
nDecresc		:= Round(Noround(xMoeda(SE2->E2_SDDECRE,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)

// Para titulos de vendor antigos
If STR(SE2->E2_VALOR,17,2) == STR(SE2->E2_SALDO,17,2) .and. ;
	 SE2->E2_SDACRES == 0 .and. SE2->E2_ACRESC > 0
	nAcresc	:= Round(Noround(xMoeda(SE2->E2_ACRESC,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
	nAcrescF := SE2->E2_ACRESC
Endif	

nPis				:= 0
nCofins			:= 0
nCsll				:= 0
nVlRetPis		:= 0
nVlRetCof		:= 0
nVlRetCsl		:= 0
nValPgto			:= 0
nOldValPgto		:= 0
nDiferImp		:= 0
nIrrf				:= 0
nIss				:= 0
nValPgto		:= Round(Noround(xMoeda(SE2->E2_SALDO-nTotAbat,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss

F080IssBx()

If lPccBaixa
	fA080Data()
	f080TotMes(dBaixa,.T.)
Endif
fa080Val(nValPgto,nTxMoeda)
cMoeda 	   := IIF(Empty(SE2->E2_MOEDA),"1",AllTrim(Str(SE2->E2_MOEDA,2)))
cDescMoeda	:= SubStr(GetMV("MV_SIMB"+cMoeda),1,3)
cTexto1	   := OemToAnsi(STR0084) + SubStr(GetMV("MV_SIMB"+cMoeda),1,3)  //"Valor Original "
cTexto2	 	:= OemToAnsi(STR0042) + SubStr(GetMV("MV_SIMB"+cMoeda),1,3) //"Valor "
If Type("oTexto1")=="O"
	oTexto1:Refresh()
Endif
If Type("oTexto2")=="O"
	oTexto2:Refresh()
Endif
If SE2->E2_IMPCHEQ == "S"  // Cheque s/ Titulo
	cCheque		:= SE2->E2_NUMBCO
Else
	cCheque		:= CRIAVAR("E2_NUMBCO")
Endif
nValTot	    := SE2->E2_VLCRUZ
nValEstrang := nValOrig	  := SE2->E2_SALDO-nTotAbat
nEstOriginal:= nValEstrang-(xMoeda(nJuros+nMulta-nDescont,1,SE2->E2_MOEDA,,3,,nTxMoeda))
nValMoeda   := Round(Noround(xMoeda(nValOrig,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
nValMoeda1  := Round(NoRound(xMoeda(SE2->E2_VALOR-nTotAbat,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)
nValPgto    := nValMoeda+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
nOldValPgto := nValPgto
IF (nMulta+nJuros+nDescont+nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),2 ) > 0.01
   nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
EndIF
FA080Corr(nEstOriginal,nTxMoeda)
nValLiq	    := nValPgto-nMulta-nJuros+nDescont-nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss
cBenef	    := CriaVar("E5_BENEF")
*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Analisa se o titulo foi gerado a partir de um cheque pre datado.		³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
lChqPre := .f.
dbSelectArea("SE5")
dbSetOrder(2)
If SE5->(dbSeek( xFilial("SE5") + "CD" + SE2->E2_PREFIXO + ;
		SE2->E2_NUM + SE2->E2_PARCELA + SE2->E2_TIPO + dToS(SE2->E2_EMISSAO )+;
		SE2->E2_FORNECE + SE2->E2_LOJA ))

	lChqPre := .T.
	cBanco   := SE5->E5_BANCO
	cAgencia := SE5->E5_AGENCIA
	cConta   := SE5->E5_CONTA
	cCheque  := SE5->E5_NUMCHEQ
	cBenef   := SE5->E5_BENEF
EndIf

If Empty(cBenef)
	dbSelectArea("SA2")
	SA2->(dbSeek(cFilial+SE2->E2_FORNECE+SE2->E2_LOJA))
	dbSelectArea("SE2")
	cBenef   := SA2->A2_NOME
Endif

lMultNat		:= .F.

IF ExistBlock("F080MNAT")
	lMultNat := ExecBlock("F080MNAT",.f.,.f.)
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Pesquisa o codigo do motivo da baixa e atribui a descricao do motivo da baixa            ³
//³a variavel cMotBx, pois eh assim que o ComboBox le os motivos da baixa (pela descricao). ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If !Empty(CriaVar("E5_MOTBX"))
	cMotBx := CriaVar("E5_MOTBX")
Endif
nAscan := Ascan(aMotBx,{|e| AllTrim(Upper(cMotBx))==AllTrim(Upper(Substr(e,7,10)))})
cMotBx := If(Empty(cMotBx) .Or. nAscan = 0,aDescMotBx[1],aDescMotBx[nAscan]) 	//NORMAL
Fa080BDev()

oTitulo :Refresh()
oNomeFor:Refresh()
oBanco  :Refresh()
oBanco  :SetFocus()
oAgencia:Refresh()
oConta  :Refresh()
oCheque :Refresh()
oBaixa  :Refresh()
oHist070:Refresh()	
oMotBx  :Refresh()
oValor  :Refresh()
oTotAbat:Refresh()
oParciais:Refresh()
oDescont:Refresh()
oMulta  :Refresh()
oJuros  :Refresh()
oValPgto:Refresh()
oBenef  :Refresh()
oHist   :Refresh()
oAcresc :Refresh()
oDecresc:Refresh()
If MV_MULNATP
	oMultNat:Refresh()
Endif

If SE2->E2_MOEDA > 1 .And. Type("oValEstrang") == "O"
   oVlEstrang:Refresh()
   oCM:Refresh()
Endif
//Tratamento de impostos Pis Cofins e Csll na baixa
If lPccBaixa
	oPis		:Refresh()
	oCofins	:Refresh()
	oCsll		:Refresh()
	If lIrfMp232
		oIrrf:Refresh()
	Endif
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Pr‚-inicializa a modalidade de SPB                                 ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lSpbInUse
	If !Empty(SE2->E2_MODSPB)
		cModSpb := SE2->E2_MODSPB
	Else
	   cModSpb := "1"
	Endif		
	oModSpb:Refresh()
Endif
Return lBaixou

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³ fA080Data³ Autor ³ Wagner Xavier         ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao utilizada para consistir a Data 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ fA080Data()						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso	     ³ Generico 						  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Data(nTxMoeda,lButOk,lHelp)
LOCAL lRet := .T.
DEFAULT nTxMoeda := 0
DEFAULT lButOk := .F.  //Se a chamada da funcao foi feita do botao OK
DEFAULT lHelp := .F.

IF dBaixa < SE2->E2_EMISSAO
	IF lHelp
		Help( " ", 1, "DATAERRP",, STR0150,1,0 ) //"Data do pagamento não pode ser menor que a data de emissâo do título correspondente"
	Endif
	lRet := .F.
Endif

If (ExistBlock("FA080DT") )
	lRet := ExecBlock( "FA080DT", .F., .F.,dBaixa)
EndIf

//Quando chamado do botao ok, nao efetuar os calculos novamente
If !lButOk .and. lRet
	dbSelectArea("SE2")
	fa080Juros(1)
	//nJuros += SE2->E2_ACRESC
	If cPaisLoc == "BRA"
		nTxMoeda	 := If(SE2->E2_MOEDA > 1,If(SE2->E2_TXMOEDA > 0 .and. Empty(SE2->E2_DTVARIA), SE2->E2_TXMOEDA,RecMoeda(dBaixa,SE2->E2_MOEDA)),0)
	Endif	
	fa080Val(1,nTxMoeda)
Endif

Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Fa080Dbeva³ Autor ³ Wagner Xavier         ³ Data ³ 20/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Trata o dbeval para marcar e desmarcar item		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ Fa080dbeva()						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080							  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Dbeva()
LOCAL lSavTTS
Local lBxTit := .T.
Local nSaldo := xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1)

IF nValor <= nTotGer .And. nValor+nSaldo <= nTotGer .And. nQtdtit <= nNroTit
	lSavTTS := __TTSInUse
	__TTSInUse := .f.

	RecLock("SE2",.f.)
	SE2->E2_OK := cMarca
	MsUnlock()
	lBxTit := .T.
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ PONTO DE ENTRADA F080BXLT                                     ³
	//³ Verifica se titulo pode ser marcado para baixa ou nÆo. Caso	³
	//³ tenha sido alterada a marca‡Æo do titulo, ExecBlock dever     ³
	//³ retornar .F., para nÆo haver altera‡Æo dos acumuladores de    ³
	//³ valores e numero de titulos.                                  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	IF (ExistBlock("F080BXLT")) .and. !Empty(E2_OK)
		lBxTit := ExecBlock("F080BXLT",.F.,.F.)
	Endif
	__TTSInUse := lSavTTS
	If lBxTit
		nValor+=nSaldo
		nQtdtit++
	Endif
Else
	lSavTTS := __TTSInUse
	__TTSInUse := .f.
	RecLock("SE2",.f.)
	SE2->E2_OK := "  "
	MsUnlock()
	__TTSInUse := lSavTTS
EndIF
Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080ValVR³ Autor ³ Antonio Maniero Jr.   ³ Data ³ 13/05/94 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao utilizada para consistir o valor digitado			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080ValVR(Valor) 													  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080ValVR(nTxMoeda,nTolerCp,lCalcRet)
Local nCentMd1	:= MsDecimais(1)
Local lRet
Local lAltValor := STR(nValPgto,17,2) != STR(nOldValPgto,17,2)
Local lValPgto := SuperGetMv("MV_BP10925",.T.,"1") == "2" //1- Valor bruto da baixa parcial / 2- Valor da baixa parcial menos os impostos

DEFAULT nTxMoeda := 0
DEFAULT nTolerCp := SuperGetMv("MV_TOLERCP",.F.,0)
DEFAULT lCalcRet := .T.

If !((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .And. Round(nValPgto,2) != Round((nValMoeda+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss),2))

	nValTot		:= SE2->E2_VLCRUZ
	nValEstrang := nValOrig := SE2->E2_SALDO-nTotAbat
	nValMoeda1	:= Round(NoRound(xMoeda(SE2->E2_VALOR - nTotAbat	,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nValMoeda	:= Round(NoRound(xMoeda(nValOrig					,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nAcresc     := Round(NoRound(xMoeda(SE2->E2_SDACRES				,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nDecresc    := Round(NoRound(xMoeda(SE2->E2_SDDECRE				,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)

	If cPaisLoc == "BRA" .or. (nMulta+nJuros+nDescont+nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),2 ) > 0.01
		nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
	Endif
	If lCalcRet .And. lAltValor //Executa o recalculo de retencao
		F080IssBx()
		F080TotMes(dBaixa,.F.)
	Endif
	
	nValLiq		:= nValPgto-nMulta-nJuros+nDescont-nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss
	nEstOriginal := nValEstrang-(Round(NoRound(xMoeda(nJuros+nMulta-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss,1,SE2->E2_MOEDA,,3,,nTxMoeda),3),2))
	       
	If lValPgto .And. lAltValor
		nValPgto := nValPgto-nMulta-nJuros+nDescont-nAcresc+nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
		If SE2->E2_MOEDA == 1
			nValEstrang := nValPgto
		EndIf
	EndIf
	
	fa080Corr(nEstOriginal,nTxMoeda)
	lRet :=  (nValEstrang <= SE2->(E2_SALDO+E2_SDACRES-E2_SDDECRE)+Round(NoRound(xMoeda(nMulta+nJuros-nDescont+nTolerCP-nPis-nCoFins-nCsll-nIrrf-nIss,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2))
	If !lRet
		Help(" ",1,"ValorMaior")
	Endif 
Else
	nValPgto := nOldValPgto
	lRet := .F.
EndIf
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fA080Val ³ Autor ³ Wagner Xavier 		  ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao utilizada para consistir o valor digitado			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Val(Valor)														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Val(nVal,nTxMoeda,lCalcImp,lAtuVlr)
Local nCentMd1	:= MsDecimais(1)
LOCAL nValLiq := 0
//Controla o Pis Cofins e Csll na baixa
Default lCalcImp := .F.
Default lAtuVlr  := .F.

If !(nDescont<=xMoeda(SE2->E2_SALDO,SE2->E2_MOEDA,1,dBAIXA,,nTxMoeda) .and. ((SE2->E2_IMPCHEQ == "S" .or. lChqPre) .And. (nDescont!=0 	.Or. nMulta!=0 .Or. nJuros!=0)))

	nOtrGa      := If (Type("nOtrGa") != "N",0,nOtrGa)
	nDifCambio  := If (Type("nDifCambio") != "N",0,nDifCambio)
	nImpSubst   := If (Type("nImpSubst") != "N",0,nImpSubst)
	nAcresc     := If (Type("nAcresc") != "N",0,nAcresc)
	nDecresc    := If (Type("nDecresc") != "N",0,nDecresc)

	IF nVal<0
		Help(" ",1,"VALNEGAT")
		Return .F.
	Endif
	DEFAULT nTxMoeda := 0

	nValTot		:= SE2->E2_VLCRUZ
	nValEstrang := SE2->E2_SALDO-nTotAbat
	nValOrig    := SE2->E2_SALDO-nTotAbat
	nValMoeda1	:= Round(NoRound(xMoeda(SE2->E2_VALOR-nTotAbat	,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nValMoeda	:= Round(NoRound(xMoeda(nValOrig				,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nAcresc     := Round(NoRound(xMoeda(SE2->E2_SDACRES			,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	nDecresc    := Round(NoRound(xMoeda(SE2->E2_SDDECRE			,SE2->E2_MOEDA,1,dBaixa,nCentMd1+1,nTxMoeda),nCentMd1+1),nCentMd1)
	
	//Calculo os impostos de Pis Cofins e Csll
	If lCalcImp
		nValPgto 	:= nValMoeda+nMulta+nJuros-nDescont+nOtrGa+nImpSubst+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
		nOldValPgto	 := nValPgto
		F080IssBx()
		F080TotMes(dBaixa,.F.)
	Endif
	
	nValPgto 	:= nValMoeda+nMulta+nJuros-nDescont+nOtrGa+nImpSubst+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss
	
	If (nMulta+nJuros+nDescont+nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss) > 0 .or. Round(nValEstrang - xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),2 ) > 0.01
		nValEstrang := Round(NoRound(xMoeda(nValPgto,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
	Endif
	nValLiq		:= nValPgto-nMulta-nJuros+nDescont-nOtrGa-nImpSubst-nAcresc+nDecresc+nPis+nCoFins+nCsll+nIrrf+nIss
	nEstOriginal := nValEstrang- Round(NoRound(xMoeda(nJuros+nMulta-nDescont+nOtrGa+nImpSubst+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss,1,SE2->E2_MOEDA,,3,,nTxMoeda),3),2)
	FA080Corr(nEstOriginal,nTxMoeda)
	
	If lAtuVlr //Atualiza o valor em memoria (antigo) com o conteudo (valor) informado.
		nOldValPgto	 := nValPgto
	Endif
Else
	Help(" ",1,"JACHQSTIT")
	nDescont:=0	
	nMulta:=0
	nJuros:=0
EndIf

Return .t.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080Vdr	³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que cadastra dados para processar VENDOR 			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Vdr(void) 														  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080Vdr(aVendor, nVlrtitV, dVencTitV)

LOCAL lRet := .F.
LOCAL nOpcA
LOCAL oDlgVendor

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Variaveis para o tratamento do Vendor 							  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
cBancoV		:= CriaVar("E9_BANCO")
cAgenciaV	:= CriaVar("E9_AGENCIA")
cContrato	:= CriaVar("E9_NUMERO")
cPrefV		:= CriaVar("E2_PREFIXO")
cNumV 		:= CriaVar("E2_NUM")
cParcV		:= CriaVar("E2_PARCELA")
cTipV 		:= CriaVar("E2_TIPO")
cNaturV		:= CriaVar("E2_NATUREZ")
nValAcres	:= CriaVar("E2_ACRESC")
dDataVencV	:= CriaVar("E2_VENCTO")
nTxAcresV	:= CriaVar("E9_TXACRES")
nValtitV 	:= 0
cFornecV 	:= Space(6)
dDataVencV	:= If(dVencTitV == Nil, SE2->E2_VENCTO, dVencTitV)
nValTitV 	:= If(nVlrtitV == Nil, SE2->E2_SALDO, nVlrtitV)
cNaturV		:= GetMV("MV_NATVEND")+Space(10-Len(GetMv("MV_NATVEND")))

If cMotBx <> "VEN"
	lRet := .T.
	Return lRet
Endif

While .T.
	nOpca := 0

	DEFINE MSDIALOG oDlgVendor FROM	98,73 TO 294,485 TITLE OemToAnsi(STR0106) PIXEL //"Baixa por Vendor"
	@ 1, 3	TO 90, 098 LABEL "" OF oDlgVendor  PIXEL
	@ 1, 103 TO 80, 205 LABEL "" OF oDlgVendor  PIXEL
	@ 08, 011 SAY OemToAnsi(STR0091) 	SIZE 40, 7 OF oDlgVendor PIXEL //"Nro.Contrato"
	@ 06, 053 MSGET cContrato	 			SIZE 36,10 OF oDlgVendor PIXEL F3 "SE9" Picture  "@!"  Valid ( Fa080Contr(cContrato) )
	@ 21, 011 SAY OemToAnsi(STR0022 )	SIZE 20, 7 OF oDlgVendor PIXEL //"Banco"
	@ 18, 053 MSGET cBancoV 		 		SIZE 14,10 OF oDlgVendor PIXEL Picture  "!!!"
	@ 35, 011 SAY OemToAnsi(STR0023 )	SIZE 26, 7 OF oDlgVendor PIXEL //"Agˆncia"
	@ 32, 053 MSGET cAgenciaV	 			SIZE 32,10 OF oDlgVendor PIXEL Picture  "@!"
	@ 49, 011 SAY OemToAnsi(STR0092 ) 	SIZE 23, 7 OF oDlgVendor PIXEL //"Prefixo"
	@ 47, 053 MSGET cPrefV			 		SIZE 19,10 OF oDlgVendor PIXEL Picture  "@!"
	@ 62, 011 SAY OemToAnsi(STR0093 )	SIZE 24, 7 OF oDlgVendor PIXEL //"Numero"
	@ 60, 053 MSGET cNumV			 		SIZE 31,10 OF oDlgVendor PIXEL Picture  "@!"  Valid NaoVazio()
	@ 76, 011 SAY OemToAnsi(STR0094 )	SIZE 25, 7 OF oDlgVendor PIXEL //"Parcela"
	@ 74, 053 MSGET cParcV			 		SIZE 14,10 OF oDlgVendor PIXEL Picture  "@!"
	@ 10, 109 SAY OemToAnsi(STR0095 )	SIZE 40, 7 OF oDlgVendor PIXEL //"Tipo"
	@ 07, 154 MSGET cTipV			 		SIZE 14,10 OF oDlgVendor PIXEL Picture  "@!" F3 "05" Valid ( Fa080NRV(cPrefV,cNumV,cParcV,cTipV) ;
		.And. Fa080Tip(cTipV) )
	@ 23, 109 SAY OemToAnsi(STR0096) 	SIZE 41, 7 OF oDlgVendor PIXEL //"Data Vencto."
	@ 20, 154 MSGET dDataVencV  			SIZE 37,10 OF oDlgVendor PIXEL Valid Fa080DtVen(dDataVencV)
	@ 37, 109 SAY OemToAnsi(STR0097)  	SIZE 41, 7 OF oDlgVendor PIXEL //"Tx.Acrescimo"
	@ 34, 154 MSGET nTxAcresV	 			SIZE 37,10 OF oDlgVendor PIXEL Picture  PesqPict("SE9", "E9_TXACRES")
	@ 51, 109 SAY OemToAnsi(STR0098) 	SIZE 41, 7 OF oDlgVendor PIXEL //"Natureza"
	@ 48, 154 MSGET cNaturV 		 		SIZE 50,10 OF oDlgVendor PIXEL Picture  "@!" Valid Fa080Nat(cNaturV) F3 "SED"
	@ 64, 109 SAY OemToAnsi(STR0099)  	SIZE 40, 7 OF oDlgVendor PIXEL //"Valor T¡tulo"
	@ 62, 154 MSGET nValTitV		 		SIZE 50,10 OF oDlgVendor PIXEL Picture  PesqPict("SE2","E2_VALOR")
	DEFINE SBUTTON FROM 84, 123 TYPE 1 ENABLE OF oDlgVendor ACTION ( nOpcA := 1,If(Fa080Nat(cNaturV),oDlgVendor:End(),.F.))
	DEFINE SBUTTON FROM 84, 152 TYPE 2 ENABLE OF oDlgVendor ACTION ( oDlgVendor:End() )
	ACTIVATE MSDIALOG oDlgVendor
	If nOpcA == 1
		lRet := Fa080VerVd()
		If !lRet
			Loop
		EndIF
		Exit
	Else
		lRet := .F.
		Exit
	EndIf

EndDO
// Atualiza dados do vendor (matriz enviada por referencia)
aVendor := {cContrato, cBancoV, cAgenciaV, cPrefV, cNumV, cParcV, cTipV, dDataVencV, nTxAcresV, cNaturV, nValTitV}
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080Contr³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que procura o contrato do VENDOR						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Contr(cBanco,cAgencia,cContrato)							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080Contr(cContr)

LOCAL cAlias := Alias(), lRet := .T.

dbSelectArea("SE9")
IF ! dbSeek(cFilial+cContr)
	HELP(" " , 1 , "FA080NOCONTR")
	lRet := .F.
Else
	nTxAcresV:= SE9->E9_TXACRES
	cBancoV	:= SE9->E9_BANCO
	cAgenciaV:= SE9->E9_AGENCIA
Endif

dbSelectArea(cAlias)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080NRV	³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Funcao que procura o titulo a ser gerado pelo VENDOR		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080NRV(cPrefixo,cNumero,cParcela,cTipo) 					  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080Nrv(cPref,cNum,cParc,cTip)

LOCAL lRet := .T., nRec

dbSelectArea("SE2")
nRec := Recno()
IF dbSeek(cFilial+cPref+cNum+cParc+cTip)
	HELP(" " , 1 , "FA080TITEX")
	lRet := .F.
Endif
dbGoto(nRec)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080Tip	³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Valida o tipo do titulo no VENDOR								  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Tip()																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080Tip(cTipo)
LOCAL cAlias := Alias(), lRet := .T.

dbSelectArea("SX5")
If !dbSeek(cFilial+"05"+cTipo)
	Help(" ",1,"FA080NOTIP")
	lRet := .F.
Else
	If cTipo $ MVABATIM
		Help(" ",1,"FA080NOAB")
		lRet := .F.
	Endif
Endif

dbSelectArea(cAlias)
Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080Nat	³ Autor ³ Pilar S. Albaladejo   ³ Data ³ 18/01/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Valida a Natureza do titulo no VENDOR							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Nat()																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080Nat(cNat)
LOCAL cAlias := Alias(), lRet := .T.

dbSelectArea("SED")
IF !dbSeek(xFilial()+cNat)
	IF cNat != GetMv("MV_NATVEND")
		Help(" ",1,"FA080NONAT")
		lRet := .F.
	Else
		RecLock("SED",.T.)
		SED->ED_FILIAL		:=  cFilial
		SED->ED_CODIGO   	:=  GetMv("MV_NATVEND")
		SED->ED_DESCRIC  	:=  "Natureza de Vendor"
		SED->ED_CALCIRF  	:=  "N"
		SED->ED_CALCISS  	:=  "N"
		SED->ED_PERCIRF  	:=  0
		SED->ED_CALCCSL	:= "N"
		SED->ED_CALCCOF	:= "N"
		SED->ED_CALCPIS	:= "N"
	Endif
Endif
dbSelectArea(cAlias)
Return lRet
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fA080Grv ³ Autor ³ Wagner Xavier 		  ³ Data ³ 26/05/92 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Fun‡„o utilizada para atualizar a baixa efetuada			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fA080Grv(lPadraoBx,PadraoVd)		                      	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Grv(lPadraoBx,lPadraoVd,lCNAB,cLanca,cArqEnt,nTxMoeda,dDebito,nVlImpPCC)
Local nSaldo
Local i
Local cTpDoc:=""
Local cHistMov:=""
Local cNum
Local cPrefixo
Local cParcela
Local nSalvRec
Local cFornece
Local nRecNo:=0
Local lAdiantamento := .f.
Local cSequencia := "00"
Local aTipoSeq := {}
Local lFina390 := Iif(SE2->E2_IMPCHEQ == "S",.T.,.F.)
Local lFa080VIR:= ExistBlock("FA080VIR")
Local cChave_EF	
Local nOrdbx
Local nAtraso := 0
Local nToler := SuperGetMv("MV_TOLERCP",.F.,0)
Local lMovBcoBx := .T.
Local lSpbInUse := SpbInUse()
Local lSE5FI080 := ExistBlock("SE5FI080")
Local nLaco
Local lAcreDecre := .F.
Local cModRetPIS := GetNewPar( "MV_RT10925", "1" ) 
//Considero juros multa ou desconto na base do imposto.
// 1 = Considera valores juros multa ou desconto
// 2 = Nao considera valores juros multa ou desconto
Local lJurMulDes := (SuperGetMv("MV_IMPBAIX",.t.,"1") == "1")
Local lContrRet := !Empty( SE2->( FieldPos( "E2_VRETPIS" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE2->( FieldPos( "E2_VRETCSL" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETPIS" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_PRETCOF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETCSL" ) ) )

Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )


Local nVlMinImp := GetNewPar("MV_VL10925",5000)
Local nSavRec := 0
Local lRetParc := .T.
Local aRecnos := {}
Local nLoop := 0
Local	cPrefOri  := SE2->E2_PREFIXO
Local	cNumOri   := SE2->E2_NUM
Local	cParcOri  := SE2->E2_PARCELA
Local	cTipoOri  := SE2->E2_TIPO
Local	cCfOri    := SE2->E2_FORNECE
Local cLojaOri  := SE2->E2_LOJA
Local nMoedaBco := If( cPaisLoc<>"BRA", MoedaBco(cBanco,cAgencia,cConta), 1 )
Local nMoedaTit := SE2->E2_MOEDA
Local nTxModBco := If( cPaisLoc<>"BRA", aTxMoedas[Max(nMoedaBco		,1)][2]	, 0 )
Local nTxModTit := If( cPaisLoc<>"BRA", aTxMoedas[Max(SE2->E2_MOEDA	,1)][2]	, 0 )

Local lBaseSE2 := SuperGetMv("MV_BS10925",.T.,"1") == "1"  .and. ;
						(	!Empty( SE1->( FieldPos( "E1_BASEPIS" ) ) ) .And.;
							!Empty( SE1->( FieldPos( "E1_BASECOF" ) ) ) .And. ; 
							!Empty( SE1->( FieldPos( "E1_BASECSL" ) ) ) .And. ; 
							!Empty( SE2->( FieldPos( "E2_BASEPIS" ) ) ) .And.;
							!Empty( SE2->( FieldPos( "E2_BASECOF" ) ) ) .And. ; 
							!Empty( SE2->( FieldPos( "E2_BASECSL" ) ) )	)

Local nBaseRet := 0  //Base de retencao                    

//1-Cria NCC/NDF referente a diferenca de impostos entre emitidos (SE2) e retidos (SE5)
//2-Nao Cria NCC/NDF, ou seja, controla a diferenca num proximo titulo
//3-Nao Controla
Local cNccRet  := SuperGetMv("MV_NCCRET",.F.,"1")

Local lSest := SE2->(FieldPos("E2_SEST"))	> 0  //Verifica campo de SEST

Local lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )

Local lAplVlMin := .T.
Local lRetManual:= .F.
Local cSeqCheque:= "00"

Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)

cArqEnt  := Iif(cArqEnt==Nil," ",cArqEnt)		// Oriundo do Fina430 (Arquivo Cnab)
// feita por lote.
Private cTitOrig 

Default dDebito   := dBaixa
Default nVlImpPCC	:= 0

If Type("aDadosRet") == "U"
	aDadosRet := Array(6)
	aFill(aDadosRet,0)
Endif

lCNAB := Iif(lCNAB==Nil,.F.,lCnab)
nOtrGa      := If (Type("nOtrGa") != "N",0,nOtrGa)
nDifCambio  := If (Type("nDifCambio") != "N",0,nDifCambio)
nImpSubst   := If (Type("nImpSubst") != "N",0,nImpSubst)
nAcresc     := If (Type("nAcresc") != "N",0,nAcresc)
nDecresc    := If (Type("nDecresc") != "N",0,nDecresc)
cModSpb		:= If (Type("cModSpb") != "C","1",cModSpb)
cAutentica	:= If (Type("cAutentica") != "C",Space(25),cAutentica)
nPis			:= If (Type("nPis") != "N",0,nPis)
nCofins	   := If (Type("nCofins") != "N",0,nCofins)
nCsll			:= If (Type("nCsll") != "N",0,nCsll)
nVlRetPis 	:= If (Type("nVlRetPis") != "N",0,nVlRetPis)
nVlRetCof 	:= If (Type("nVlRetCof") != "N",0,nVlRetCof)
nVlRetCsl	:= If (Type("nVlRetCsl") != "N",0,nVlRetCsl)
nDiferImp	:= If (Type("nDiferImp") != "N",0,nDiferImp)
nIrrf			:= If (Type("nIrrf") != "N",0,nIrrf)
nVlRetIrf 	:= If (Type("nVlRetIrf") != "N",0,nVlRetIrf)

nIss			:= If (Type("nIss") != "N",0,nIss)

If lCnab
	lPccBaixa := .F.
Endif

//Verificar ou nao o limite de 5000 para Pis cofins Csll
// 1 = Verifica o valor minimo de retencao
// 2 = Nao verifica o valor minimo de retencao
If !Empty( SE2->( FieldPos( "E2_APLVLMN" ) ) ) .and. SE2->E2_APLVLMN == "2"
	lAplVlMin := .F.
Endif	  
If lBaseSE2 .and. SE2->(E2_BASEPIS + E2_BASECOF + E2_BASECSL) > 0
	If (nValPgto+nPis+nCofins+nCsll+nIrrf+nIss+nDescont+nTotAbat-nJuros-nMulta) < If(!Empty(SE2->E2_BASEPIS),SE2->E2_BASEPIS,If(!Empty(SE2->E2_BASECOF),SE2->E2_BASECOF,SE2->E2_BASECSL))
		nBaseRet := nValPgto+nPis+nCofins+nCsll+nIrrf+nIss+nDescont+nTotAbat-nJuros-nMulta
		If STR(nBaseRet,17,2) == STR(SE2->E2_SALDO,17,2)
			nBaseRet += SE2->(E2_IRRF+E2_INSS+E2_ISS) 
			If lSest
				nBaseRet += SE2->E2_SEST
			Endif
	   Endif
	Else
		nBaseRet := If(!Empty(SE2->E2_BASEPIS),SE2->E2_BASEPIS,If(!Empty(SE2->E2_BASECOF),SE2->E2_BASECOF,SE2->E2_BASECSL))
	Endif
Else			
	nBaseRet := nValPgto+nPis+nCofins+nCsll+nIrrf+nIss+nDescont+nTotAbat-nJuros-nMulta
	If STR(nBaseRet,17,2) == STR(SE2->E2_SALDO,17,2)
		nBaseRet += SE2->(E2_IRRF+E2_INSS+E2_ISS) 
		If lSest
			nBaseRet += SE2->E2_SEST
		Endif
   Endif
Endif

DEFAULT nTxMoeda := 0
If SE2->E2_SALDO + SE2->E2_SDACRES == 0
	Return .f.
Endif

lGerouSef := .F.

//verifica se existem os campos de valores de acrescimo e decrescimo no SE5
If SE5->(FieldPos("E5_VLACRES")) > 0 .and. SE5->(FieldPos("E5_VLDECRE")) > 0
	lAcreDecre := .T.
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Grava Dados do Vendor													  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If TrazCodMot(cMotBx) == "VEN"
	Fa080GrVen(@cTitOrig,lPadraoVd,cLanca)
End

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Atualiza a baixa do titulo											  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nValPadrao := nValPgto-(nJuros+Iif(SE2->E2_MOEDA<=1,nCM,0)+nMulta-nDescont+nOtrga+nImpSubst+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss)

*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
*³Verifica se saldo estava em outra moeda, caso estiver, converte valor ³
*³recebido pela taxa diaria da moeda												³
*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nSaldo := Round(SE2->E2_SALDO-xMoeda(nValPadrao,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),2)

//Verifico se existe tolerancia de pagamento
If nSaldo != 0 .and. nToler > 0
	//Pagamentos a menor
	If nToler > 0 .And. nSaldo > 0
		If nSaldo <= nToler
			nDescont += nSaldo
			nSaldo   := 0	
		EndIf
	//Pagamentos a maior
	ElseIf nToler > 0 .and. nSaldo < 0
		nJuros += Abs(nSaldo)
		nSaldo += Abs(nSaldo)
	Endif
Else
	If nSaldo >= 0.01
		nSaldo := Round(NoRound(SE2->E2_SALDO-xMoeda(nValPadrao,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
	Else
		nSaldo := 0
	Endif
Endif	

If SE2->E2_MOEDA > 1
	*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	*³For‡a saldo = 0 quando diferen‡a == 0.01 por problema de arredondamento³
	*ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If Round(NoRound(nSaldo,3),2) <= 0.01
		nSaldo := 0
	Endif
Endif

RecLock("SE2")
nSE2Rec := Recno()
SE2->E2_BAIXA	  := iif(SE2->E2_BAIXA <= dBaixa, dBaixa, SE2->E2_BAIXA)
SE2->E2_LOTE	  := cLoteFin
SE2->E2_MOVIMEN  := dBaixa
SE2->E2_DESCONT  := nDescont + nDecresc
SE2->E2_MULTA	  := nMulta
If ( cPaisLoc != "BRA" )
	SE2->E2_VALLIQ := xMoeda( nValPgto, 1, SE2->E2_MOEDA,,,, nTxMoeda  )
Else
	SE2->E2_VALLIQ := nValpgto
Endif

If  nValpgto < SE2->E2_SDACRES
	SE2->E2_SDACRES  -= nValPgto
Else
	SE2->E2_SDACRES  := 0
EndIf


SE2->E2_SDDECRE  := 0
If cPaisLoc == "CHI"
   IIf (SE2->(FieldPos("E2_OTRGA"))  > 0,SE2->E2_OTRGA    := nOtrga,.T.)   
   IIf (SE2->(FieldPos("E2_CAMBIO")) > 0,SE2->E2_CAMBIO   := SE2->E2_CAMBIO + nDifCambio,.T.)        
   IIf (SE2->(FieldPos("E2_IMPSUBS")) > 0,SE2->E2_IMPSUBS := nImpSubst,.T.)
	SE2->E2_JUROS	:= nOtrga + nImpsubst
	SE2->E2_CORREC	:= nDifCambio   
Else
	SE2->E2_JUROS	:= nJuros + nAcresc
	SE2->E2_CORREC	:= nCm
EndIf
If !Empty(cBanco)
	SE2->E2_BCOPAG   := cBanco
Endif
If !Empty(cCheque)
	SE2->E2_NUMBCO   := cCheque
Endif
//Para TOP limpa-se a marca.
//Para Codebase gravo "xx" para manter o titulo no filtro e possibilitar contabilizacao
//e baixa correta.
#IFDEF TOP
	If TcSrvType() == "AS/400"
		SE2->E2_OK		  := Iif(E2_OK==cMarca,"xx" ,E2_OK)	
	Else
		SE2->E2_OK		  := Iif(E2_OK==cMarca,"  " ,E2_OK)
	Endif
#ELSE
	SE2->E2_OK		  := Iif(E2_OK==cMarca,"xx" ,E2_OK)
#ENDIF

If !Empty(cPortado)
	SE2->E2_PORTADO  := cPortado
Endif
If TrazCodMot(cMotBx) == "VEN"
	SE2->E2_TITORIG	:= cTitOrig
Endif

//Marco que o titulo tem os impostos calculados
//pela baixa (Pis, Cofins e Csll)
If lContrRet .And. lPCCBaixa
	SE2->E2_PRETPIS := "3"
	SE2->E2_PRETCOF := "3"
	SE2->E2_PRETCSL := "3"
Endif

IF Str(nSaldo,16,2)=Str(nTotAbat,16,2)
	nSaldo := 0
Endif
     
//Verifica se existe solicitacao de NCP e caso exista atualiza o campo CU_DTBAIXA...
If cPaisLoc <> "BRA" 
	A055AtuDtBx("1",SE2->E2_FORNECE,SE2->E2_LOJA,SE2->E2_NUM,SE2->E2_PREFIXO,SE2->E2_BAIXA)
EndIf
dbSelectArea("SE2")
nSalvRec := SE2->( RecNo() )
cNum		:= SE2->E2_NUM
cPrefixo := SE2->E2_PREFIXO
cParcela := SE2->E2_PARCELA
cFornece := SE2->E2_FORNECE
nOrdBx	:= IndexOrd()

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Baixar titulos de abatimento se for baixa total				  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
IF nSaldo = 0
	If Select("__SE2") == 0
	   ChkFile("SE2",.F.,"__SE2")
	Else
  	   DbSelectArea("__SE2")
	EndIf
	dbSetOrder(1)
	dbSeek(xFilial("SE2")+cPrefixo+cNum+cParcela)
	While !EOF() .And. E2_FILIAL==xFilial("SE2") .And. E2_PREFIXO=cPrefixo .And. ;
			E2_NUM==cNum .And. E2_PARCELA==cParcela
		IF E2_TIPO $ MVABATIM .And. E2_FORNECE==cFornece
			RecLock("__SE2")
			Replace E2_SALDO		With 0
			Replace E2_BCOPAG		With cBanco
			Replace E2_BAIXA		With dBaixa
			Replace E2_LOTE		With cLoteFin
			Replace E2_MOVIMEN	With dBaixa
			Replace E2_SDACRES  With 0
			Replace E2_SDDECRE  With 0
		Endif
		dbSkip()
	Enddo
Endif
dbSelectArea("SE2")
dbGoto(nSalvRec)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Ponto de entrada p/ alteracao da data de vencto do IR (Salvador) ³
//³ Guardo o Recno para caso o Rdmake nao retorne ao titulo baixado, ³
//³ o sistema force isto, evitando problemas na continuidade do pro- ³
//³ cesso de baixa do titulo.                                        ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If lFa080VIR .and. !Empty(SE2->E2_IRRF)
	nRecno := SE2->(Recno())
	Execblock("FA080VIR",.F.,.F.)
	dbGoTo(nRecno)
	nRecno := 0
Endif

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Atualiza a Movimentacao Bancaria									  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
nValPadrao:=nValPgto-(nJuros+nMulta+nAcresc)+(nDescont+nDecresc+nPis+nCoFins+nCsll+nIrrf-nIss) //Valor Original
nJuros := nJuros + nAcresc
nDescont := nDescont + nDecresc
cSequencia := "00"

If SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG
	lAdiantamento := .t.
	fa080adiant( lPadraoBx, cLanca, nTxMoeda )
Endif

//Caso o titulo nao tenha impostos e os mesmos tenham sido digitados manualmente,
//altero variavel para gravacao dos titulos de impostos
If Empty(nVlImpPCC) .And. nPis+nCofins+nCsll > 0
	lRetManual := .T.
EndIf

If !lAdiantamento
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Para numerar as sequencias o sistema precisa procurar os	³
	//³ registros com  tipodoc igual a vl ou ba.							³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	aTipoSeq := { "VL","BA","CP" }
	dbSelectArea("SE5")
	SE5->(dbSetOrder(2))
	For nLaco := 1 to len(aTipoSeq)
		SE5->(dbSeek(xFilial("SE5") + aTipoSeq[nLaco] + SE2->E2_PREFIXO + SE2->E2_NUM + ;
			SE2->E2_PARCELA + SE2->E2_TIPO) )

		While !SE5->(Eof()) .And. ;
				SE5->E5_FILIAL == xFilial("SE5") .And. ;
				SE5->E5_TIPODOC == aTipoSeq[nLaco] .And. ;
				SE5->E5_PREFIXO == SE2->E2_PREFIXO .And. ;
				SE5->E5_NUMERO == SE2->E2_NUM .And. ;
				SE5->E5_PARCELA == SE2->E2_PARCELA .And. ;
				SE5->E5_TIPO == SE2->E2_TIPO

			If SE5->(E5_CLIFOR+E5_LOJA) == SE2->(E2_FORNECE+SE2->E2_LOJA)
				If cSequencia < SE5->E5_SEQ
					cSequencia := SE5->E5_SEQ
				EndIf
			EndIf

			SE5->( dbSkip() )
		Enddo
	Next
	cSequencia := Soma1(cSequencia,2)
	For i:=1 To 6
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Atualiza a Movimentacao Bancaria 									 ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF i==1
			cCpoTp := "nDescont"
			cTpDoc := "DC"
			cHistMov := OemToAnsi( STR0107 ) //"Desconto s/Pgto de Titulo"
		Elseif i==2
			cCpoTp := IIf(cPaisLoc<>"CHI","nJuros","nOtrga")
			cTpDoc := "JR"
			cHistMov := OemToAnsi( STR0108 ) //"Juros s/Pgto de Titulo"
		Elseif i==3
			cCpoTp := "nMulta"
			cTpDoc := "MT"
			cHistMov := OemToAnsi( STR0109 ) //"Multa s/Pgto de Titulo"
		Elseif i==4
			cCpoTp := IIf(cPaisLoc<>"CHI","nCM","nDifCambio")
			cTpDoc := "CM"
			cHistMov := OemToAnsi( STR0110 ) //"Correcao Monet s/Pgto de Titulo"
		Elseif i==5
			cCpoTp := "nImpSubst"
			cTpDoc := "IS"
			cHistMov := OemToAnsi( STR0108 ) //"Juros s/Pgto de Titulo"
		Elseif i==6
			cCpoTp := "nValPgto"
			cTpDoc := Iif(MovBcoBx(cMotBx, .T.),"VL","BA")
			//Se o motibo de baixa gerar cheque, pelas novas especificacoes, será gravado:
			//um movimento BA para a baixa
			//um movimento CH na geração do cheque
			If ChqMotBx(cMotBx) .or.;				
				SUBSTR(cMotBx,1,3) == "CEC" .or. SE2->E2_IMPCHEQ == "S" .or. ;
				GetMv("MV_LIBCHEQ") == "N"  .or. (lCnab .and. !Empty(cLoteFin))
				cTpDoc := "BA"
			Endif
			If (lCnab .AND. Empty(cLoteFin)) .or. ;
					(Substr(cBanco,1,2) == "CX" .and. MovBcoBx(cMotBx, .T.)) .or. ;
					(cBanco $ GetMv("MV_CARTEIR") .and. MovBcoBx(cMotBx, .T.)) .or. ;
					(MovBcoBx(cMotBx, .T.) .and. !ChqMotBx(cMotBx) .and. !lCnab)
				cTpDoc := "VL"		// For‡a mov banc ria quando CAIXA ou Via CNAB
			Endif
			cHistMov := Iif(!Empty(cHist070),cHist070,OemToAnsi( STR0111 )) //"Valor pago s /Titulo"
		Endif

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Verifica se existe cheque j  relacionado anteriormente para  ³
		//³ este t¡tulo. Deve buscar pelo registro do Cheque com a se-   ³
		//³ quencia em branco (Cheque gerado pelo FINA390 - Cheque s/    ³
		//³ t¡tulo.                                                      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If lFina390
			dbSelectArea("SEF")
			dbSetOrder(3)
			cChave_EF := xFilial("SEF")+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO
			If DbSeek(cChave_EF)
				DO WHILE (cChave_EF == SEF->EF_FILIAL + SEF->EF_PREFIXO+SEF->EF_TITULO;
					+SEF->EF_PARCELA+SEF->EF_TIPO) .and. !(SEF->(EOF()))

					IF Empty(SEF->EF_SEQUENC) .and. SEF->EF_FORNECE+SEF->EF_LOJA == SE2->E2_FORNECE+SE2->E2_LOJA
						cBanco  :=SEF->EF_BANCO
						cAgencia:=SEF->EF_AGENCIA
						cConta  :=SEF->EF_CONTA
						cCheque :=SEF->EF_NUM
						EXIT
					Endif
					SEF->(DbSkip())
				ENDDO
			Endif
		Endif

		IF &cCpoTp != 0 .or. i == 6
			RecLock("SE5",.T.)
			SE5-> E5_FILIAL 	:= cFilial
			SE5-> E5_BANCO		:= cBanco
			SE5-> E5_AGENCIA	:= cAgencia
			SE5-> E5_CONTA		:= cConta
			SE5-> E5_DATA		:= dBaixa
			SE5-> E5_HISTOR 	:= cHistMov
			If ( cPaisLoc <> "BRA" )
				nMoedaBco := Max( SA6->A6_MOEDA, 1)
				SE5->E5_VALOR   := xMoeda( &cCpoTp, 1, nMoedaBco,,,, nTxModBco )
				SE5->E5_VLMOED2 := xMoeda( &cCpoTp, 1, nMoedaTit,,,, nTxModTit )
				If( SE5->(FieldPos("E5_TXMOEDA"))>0, SE5->E5_TXMOEDA:=nTxModBco,.T. )
				SE5->E5_MOEDA := StrZero(nMoedaBco,2)
			Else
				SE5-> E5_VALOR	 	:= &cCpoTp
			EndIf
			SE5-> E5_NATUREZ	:= SE2->E2_NATUREZ
			SE5-> E5_RECPAG 	:= "P"
			SE5-> E5_TIPO		:= SE2->E2_TIPO
			SE5-> E5_NUMCHEQ	:= cCheque
			SE5-> E5_LA			:= If( lPadraoBx .And. cLanca == "S","S","N")
			SE5-> E5_TIPODOC	:= cTpDoc
			SE5-> E5_LOTE		:= cLoteFin
			SE5-> E5_PREFIXO	:= SE2->E2_PREFIXO
			SE5-> E5_NUMERO 	:= SE2->E2_NUM
			SE5-> E5_PARCELA	:= SE2->E2_PARCELA
			SE5-> E5_FORNECE	:= SE2->E2_FORNECE
			SE5-> E5_CLIFOR 	:= SE2->E2_FORNECE
			SE5-> E5_LOJA		:= SE2->E2_LOJA
			SE5-> E5_BENEF		:= IIF(Empty(cBenef),SE2->E2_NOMFOR,cBenef)
			SE5-> E5_DTDIGIT	:= dDataBase
			SE5-> E5_MOTBX		:= TrazCodMot(cMotBx)
			If cPaisLoc = "BRA"
				If nValEstrang != 0 .and. i == 6  // VL ou BA
					SE5-> E5_VLMOED2	:= nValEstrang
				Else
					SE5-> E5_VLMOED2	:= Iif(i!=4 .or. SE2->E2_MOEDA<=1,Round(NoRound(xMoeda(&cCpoTp.,1,SE2->E2_MOEDA,dBaixa,3,nTxMoeda),3),2),0)
				EndIf
			EndIf
			SE5->E5_SEQ 		:= cSequencia
			SE5->E5_DOCUMEN	:= If(Empty(cNumBor),SE2->E2_NUMBOR,cNumBor) // Vem do Fina240()
			SE5->E5_DTDISPO	:= dDebito
			SE5->E5_ARQCNAB   := cArqEnt
			SE5->E5_FILORIG   := SE2->E2_FILORIG
			If lSpbInUse
				SE5->E5_MODSPB := cModSpb
			Endif
			
			If cPaisLoc == "BRA" .And. SE2->E2_MOEDA > 1
				SE5->E5_TXMOEDA := nTxMoeda
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Grava os valores agregados ao titulo no totalizador ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If i == 6		// registro totalizador
				Replace E5_VLMULTA With nMulta
				Replace E5_VLDESCO With nDescont
				If cPaisloc <> "CHI"
					Replace E5_VLJUROS With nJuros
					Replace E5_VLCORRE With nCm
				Else
					Replace E5_VLJUROS With nOtrga + nImpSubst
					Replace E5_VLCORRE With nDifcambio
				EndIf
				If lAcreDecre
					SE5->E5_VLACRES	:= nAcresc
					SE5->E5_VLDECRE   := nDecresc
				Endif	
				//Autenticacao bancaria
			   IIf (SE5->(FieldPos("E5_AUTBCO"))> 0,SE5->E5_AUTBCO := cAutentica, .T.)   
				If lCalcIssBx
					SE5->E5_VRETISS := nIss
				Endif
					
				If lContrRet .and. lPccBaixa

					SE5->E5_VRETPIS := nPis
					SE5->E5_VRETCOF := nCofins
					SE5->E5_VRETCSL := nCsll

					If lIrfMp232
						SE5->E5_VRETIRF := nIrrf
					Endif                      
					
					Do Case 
					Case cModRetPIS == "1" 
						If aDadosRet[ 1 ] + nBaseRet	> nVlMinImp .or. !lAplVlMin
							lRetParc := .T. 
					
							//Rotina para gerar titulo de adiantamento
							If cNCCRet == "1" .and. nDiferImp < 0 
								FGerCredRt(Abs(nDiferImp),SE2->E2_MOEDA,SE5->E5_SEQ)						
							Endif			
							nSavRec := SE5->( Recno() ) 
								
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Exclui a Marca de "pendente recolhimento" dos demais registros   ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If aDadosRet[1] > 0
								aRecnos := aClone( aDadosRet[ 6 ] ) 
						
								cPrefOri  := SE5->E5_PREFIXO
								cNumOri   := SE5->E5_NUMERO
								cParcOri  := SE5->E5_PARCELA
								cTipoOri  := SE5->E5_TIPO
								cCfOri    := SE5->E5_CLIFOR
								cLojaOri  := SE5->E5_LOJA
										
								For nLoop := 1 to Len( aRecnos )
									
									SE5->( dbGoto( aRecnos[ nLoop ] ) )
										
									RecLock( "SE5", .F. ) 
									
									If !Empty(SE5->E5_PRETPIS) .And. !Empty(SE5->E5_PRETCOF) .And. !Empty(SE5->E5_PRETCSL)
										SE5->E5_PRETPIS := "2"
										SE5->E5_PRETCOF := "2"
										SE5->E5_PRETCSL := "2"
									EndIf
																	
									If lIrfMP232 .and. SE5->E5_PRETIRF == "1"
										SE5->E5_PRETIRF := "2"									
									Endif             
									
									SE5->( MsUnlock() )  																								
			
									If FindFunction("ALIASINDIC")
										If AliasIndic("SFQ") 
											If nSavRec <> aRecnos[ nLoop ] 
												dbSelectArea("SFQ")
												RecLock("SFQ",.T.)
												SFQ->FQ_FILIAL  := xFilial("SFQ")
												SFQ->FQ_ENTORI  := "SE5"
												SFQ->FQ_PREFORI := cPrefOri
												SFQ->FQ_NUMORI  := cNumOri
												SFQ->FQ_PARCORI := cParcOri
												SFQ->FQ_TIPOORI := cTipoOri										
												SFQ->FQ_CFORI   := cCfOri
												SFQ->FQ_LOJAORI := cLojaOri
												SFQ->FQ_SEQORI  := cSequencia
												
												SFQ->FQ_ENTDES  := "SE5"
												SFQ->FQ_PREFDES := SE5->E5_PREFIXO
												SFQ->FQ_NUMDES  := SE5->E5_NUMERO
												SFQ->FQ_PARCDES := SE5->E5_PARCELA                             
												SFQ->FQ_TIPODES := SE5->E5_TIPO
												SFQ->FQ_CFDES   := SE5->E5_CLIFOR
												SFQ->FQ_LOJADES := SE5->E5_LOJA
												SFQ->FQ_SEQDES  := SE5->E5_SEQ

												//Grava a filial de destino caso o campo exista
												If !Empty( SFQ->( FieldPos( "FQ_FILDES" ) ) ) 
													SFQ->FQ_FILDES := SE5->E5_FILIAL 
												EndIf 											

												MsUnlock()
											Endif								
										Endif					
									Endif	
								Next nLoop 
							Endif	
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Retorna do ponteiro do SE2 para a parcela         ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							SE5->( MsGoto( nSavRec ) ) 
							Reclock( "SE5", .F. ) 

						//Somente Gerou IRRF P.Fisica
						ElseIf lIrfMP232 .and. nIrrf > 0 .and. SA2->A2_TIPO == "F" .and. ;
							aDadosRet[ 1 ] + nBaseRet	> MaTbIrfPF(nIrrf)[4]

							lRetParc := .T. 
					
							//Rotina para gerar titulo de adiantamento
							If cNCCRet == "1" .and. nDiferImp < 0 
								FGerCredRt(Abs(nDiferImp),SE2->E2_MOEDA,SE5->E5_SEQ)						
							Endif			

							nSavRec := SE5->( Recno() ) 
								
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Exclui a Marca de "pendente recolhimento" dos demais registros   ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							If aDadosRet[1] > 0
								aRecnos := aClone( aDadosRet[ 6 ] ) 
						
								cPrefOri  := SE5->E5_PREFIXO
								cNumOri   := SE5->E5_NUMERO
								cParcOri  := SE5->E5_PARCELA
								cTipoOri  := SE5->E5_TIPO
								cCfOri    := SE5->E5_CLIFOR
								cLojaOri  := SE5->E5_LOJA
										
								For nLoop := 1 to Len( aRecnos )
									
									SE5->( dbGoto( aRecnos[ nLoop ] ) )
										
									RecLock( "SE5", .F. ) 
									SE5->E5_PRETPIS := "1"
									SE5->E5_PRETCOF := "1"
									SE5->E5_PRETCSL := "1"
									SE5->E5_PRETIRF := "3"									
									SE5->( MsUnlock() )  																								
			
									If FindFunction("ALIASINDIC")
										If AliasIndic("SFQ") 
											If nSavRec <> aRecnos[ nLoop ] 
												dbSelectArea("SFQ")
												RecLock("SFQ",.T.)
												SFQ->FQ_FILIAL  := xFilial("SFQ")
												SFQ->FQ_ENTORI  := "SE5"
												SFQ->FQ_PREFORI := cPrefOri
												SFQ->FQ_NUMORI  := cNumOri
												SFQ->FQ_PARCORI := cParcOri
												SFQ->FQ_TIPOORI := cTipoOri										
												SFQ->FQ_CFORI   := cCfOri
												SFQ->FQ_LOJAORI := cLojaOri
												SFQ->FQ_SEQORI  := cSequencia
												
												SFQ->FQ_ENTDES  := "SE5"
												SFQ->FQ_PREFDES := SE5->E5_PREFIXO
												SFQ->FQ_NUMDES  := SE5->E5_NUMERO
												SFQ->FQ_PARCDES := SE5->E5_PARCELA                             
												SFQ->FQ_TIPODES := SE5->E5_TIPO
												SFQ->FQ_CFDES   := SE5->E5_CLIFOR
												SFQ->FQ_LOJADES := SE5->E5_LOJA
												SFQ->FQ_SEQDES  := SE5->E5_SEQ

												//Grava a filial de destino caso o campo exista
												If !Empty( SFQ->( FieldPos( "FQ_FILDES" ) ) ) 
													SFQ->FQ_FILDES := SE5->E5_FILIAL 
												EndIf 											

												MsUnlock()
											Endif								
										Endif					
									Endif	
								Next nLoop 
							Endif	
							//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
							//³ Retorna do ponteiro do SE2 para a parcela         ³
							//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
							SE5->( MsGoto( nSavRec ) ) 
							Reclock( "SE5", .F. ) 
							SE5->E5_VRETPIS := nVlRetPis
							SE5->E5_VRETCOF := nVlRetCof
							SE5->E5_VRETCSL := nVlRetCsl
							SE5->E5_PRETPIS := "1"
							SE5->E5_PRETCOF := "1"
							SE5->E5_PRETCSL := "1"
							SE5->( MsUnlock() )				
						Else 	
							If nVlRetPis + nVlRetCof + nVlRetCsl + nVlRetIrf > 0
								Reclock( "SE5", .F. ) 
								If !lRetManual
									SE5->E5_VRETPIS := nVlRetPis
									SE5->E5_VRETCOF := nVlRetCof
									SE5->E5_VRETCSL := nVlRetCsl
									SE5->E5_PRETPIS := "1"
									SE5->E5_PRETCOF := "1"
									SE5->E5_PRETCSL := "1"
								EndIf

								If lIrfMP232
									SE5->E5_VRETIRF := nVlRetIrf
									SE5->E5_PRETIRF := "1"
								Endif								

								SE5->( MsUnlock() )  																								
							EndIf	
							lRetParc := .F. 
						EndIf

					Case cModRetPIS == "2" 
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Efetua a retencao                                                 ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						nSavRec := SE5->( Recno() ) 
							
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Exclui a Marca de "pendente recolhimento" dos demais registros   ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						If aDadosRet[1] > 0
							aRecnos := aClone( aDadosRet [ 6 ] ) 
					
							cPrefOri  := SE5->E5_PREFIXO
							cNumOri   := SE5->E5_NUMERO
							cParcOri  := SE5->E5_PARCELA
							cTipoOri  := SE5->E5_TIPO
							cCfOri    := SE5->E5_CLIFOR
							cLojaOri  := SE5->E5_LOJA
									
							For nLoop := 1 to Len( aRecnos )
								
								SE5->( dbGoto( aRecnos[ nLoop ] ) )
									
								RecLock( "SE5", .F. ) 
								
								If !Empty(SE5->E5_PRETPIS) .And. !Empty(SE5->E5_PRETCOF) .And. !Empty(SE5->E5_PRETCSL)
									SE5->E5_PRETPIS := "2"
									SE5->E5_PRETCOF := "2"
									SE5->E5_PRETCSL := "2"
								EndIf									
																
								If lIrfMP232
									SE5->E5_PRETIRF := "2"									
								Endif             
																
								SE5->( MsUnlock() )  																								
		
								If FindFunction("ALIASINDIC")
									If AliasIndic("SFQ") 
										If nSavRec <> aRecnos[ nLoop ] 
											dbSelectArea("SFQ")
											RecLock("SFQ",.T.)
											SFQ->FQ_FILIAL  := xFilial("SFQ")
											SFQ->FQ_ENTORI  := "SE5"
											SFQ->FQ_PREFORI := cPrefOri
											SFQ->FQ_NUMORI  := cNumOri
											SFQ->FQ_PARCORI := cParcOri
											SFQ->FQ_TIPOORI := cTipoOri										
											SFQ->FQ_CFORI   := cCfOri
											SFQ->FQ_LOJAORI := cLojaOri
											SFQ->FQ_SEQORI  := cSequencia
																						
											SFQ->FQ_ENTDES  := "SE5"
											SFQ->FQ_PREFDES := SE5->E5_PREFIXO
											SFQ->FQ_NUMDES  := SE5->E5_NUMERO
											SFQ->FQ_PARCDES := SE5->E5_PARCELA                             
											SFQ->FQ_TIPODES := SE5->E5_TIPO
											SFQ->FQ_CFDES   := SE5->E5_CLIFOR
											SFQ->FQ_LOJADES := SE5->E5_LOJA
											SFQ->FQ_SEQDES  := SE5->E5_SEQ											

											//Grava a filial de destino caso o campo exista
											If !Empty( SFQ->( FieldPos( "FQ_FILDES" ) ) ) 
												SFQ->FQ_FILDES := SE5->E5_FILIAL 
											EndIf 											

											MsUnlock()
										Endif								
									Endif					
								Endif	
							Next nLoop 
						Endif	
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Retorna do ponteiro do SE1 para a parcela         ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						SE5->( MsGoto( nSavRec ) ) 
						Reclock( "SE2", .F. ) 
						lRetParc := .T. 
					Case cModRetPIS == "3" 			
						//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
						//³ Grava a Marca de "pendente recolhimento" dos demais registros    ³
						//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ	
						If nVlRetPis + nVlRetCof + nVlRetCsl + nVlRetIrf > 0
							Reclock( "SE5", .F. ) 
							SE5->E5_VRETPIS := nVlRetPis
							SE5->E5_VRETCOF := nVlRetCof
							SE5->E5_VRETCSL := nVlRetCsl
							SE5->E5_PRETPIS := "1"
							SE5->E5_PRETCOF := "1"
							SE5->E5_PRETCSL := "1"
							If lIrfMP232
								SE5->E5_VRETIRF := nVlRetIrf
								SE5->E5_PRETIRF := "1"
							Endif								

							SE5->( MsUnlock() )  																								
						EndIf	
						lRetParc := .F.
					EndCase 			
				EndIf 					
			Endif
         
			If i = 4
				Replace E5_IDENTEE	With SE2->E2_IDENTEE
			Endif

			// Gravacao de dados complementares da baixa
			If lSE5FI080
				ExecBlock('SE5FI080',.f.,.F.)
			Endif

			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³ Caso exista cheque j  relacionado anteriormente para este    ³
			//³ titulo, atualiza sequencia .											  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If lFina390	
				dbSelectArea("SEF")
				If !Eof()
					RecLock("SEF",.f.)
					SEF->EF_SEQUENC := cSequencia
				Endif
			Endif
		Endif
	Next i
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Atualiza o Cadastro de Cheques Emitidos, se for em Banco						³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
If MovBcoBx(cMotBx, .T.) .and. !lAdiantamento .And. !lCNAB .and. TrazCodMot(cMotBx) != "DEB" .And.;
	ChqMotBx(cMotBx)
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Se for cheque pre-datado, nao cria novo cheque, pois este ja'          ³
	//³ foi criado quando da emissao do pre'datado.                            ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If !lChqPre .and. nValPgto > 0 .and. SE2->E2_IMPCHEQ != "S" .And.;
			!cBanco $ Left(GetMv("MV_CXFIN"),3) .And. !cBanco $ GetMv("MV_CARTEIR")
		RecLock("SEF",.T.)
		SEF->EF_FILIAL  := xfilial()
		SEF->EF_NUM 	 := cCheque
		SEF->EF_BANCO	 := cBanco
		SEF->EF_AGENCIA := cAgencia
		SEF->EF_CONTA	 := cConta
		SEF->EF_VALOR	 := nValPgto
		SEF->EF_DATA	 := dBaixa
		SEF->EF_BENEF	 := IIF(Empty(cBenef),SA2->A2_NOME,cBenef)
		SEF->EF_PORTADO := cPortado
		SEF->EF_HIST	 := cHist070
		SEF->EF_PREFIXO := SE2->E2_PREFIXO
		SEF->EF_TITULO  := SE2->E2_NUM
		SEF->EF_PARCELA := SE2->E2_PARCELA
		SEF->EF_FORNECE := SE2->E2_FORNECE
		SEF->EF_LOJA	 := SE2->E2_LOJA
		SEF->EF_TIPO	 := SE2->E2_TIPO
		SEF->EF_IMPRESS := IIf(Subs(cCheque,1,1)="*","A"," ")
		SEF->EF_SEQUENC := cSequencia
		SEF->EF_ORIGEM  := "FINA080"
		MsUnlock()
		lGerouSef := .T.

		If ExistBlock("FA080SEF")
			Execblock("FA080SEF",.F.,.F.)
		Endif	
	Endif 	
   
   //Gera registro no SE5 para a geracao do cheque e gera cheque no SEF.
	If lGerouSef .And. !Empty(cCheque) .and. GetMv("MV_LIBCHEQ") == "S"
		RecLock("SEF")
		SEF->EF_IMPRESS := "A"
		SEF->EF_LIBER   := "S"
		If lPadraoBx .And. cLanca == "S"
			SEF->EF_LA		 := "S"
		EndIf
		MsUnlock()
		cSeqCheque := Soma1(cSequencia,2)
		//Inclui registro no SE5 para a geracao do cheque
		RecLock("SE5",.T.)
		SE5->E5_FILIAL  := cFilial
		SE5->E5_AGENCIA := cAgencia
		SE5->E5_BANCO   := cBanco
		SE5->E5_BENEF   := cBenef
		SE5->E5_CONTA   := cConta
		SE5->E5_DATA    := dBaixa
		SE5->E5_NUMCHEQ := cCheque
		SE5->E5_DTDIGIT := dDataBase
		SE5->E5_HISTOR  := cHistMov
		SE5->E5_RECPAG  := "P"
		SE5->E5_TIPODOC := "CH"
		SE5->E5_VALOR   := nValPgto
		SE5->E5_DTDISPO := dDebito
		SE5->E5_NATUREZ := SE2->E2_NATUREZ
		SE5->E5_SEQ		 := cSeqCheque
		SE5-> E5_LA		 := If( lPadraoBx .And. cLanca == "S","S","N")
		If SpbInUse()
			SE5->E5_MODSPB := "3"
		Endif
		MsUnlock()
		//Gera cheque
		RecLock("SEF",.T.)
		SEF->EF_FILIAL  := xfilial()
		SEF->EF_NUM 	 := cCheque
		SEF->EF_BANCO	 := cBanco
		SEF->EF_AGENCIA := cAgencia
		SEF->EF_CONTA	 := cConta
		SEF->EF_VALOR	 := nValPgto
		SEF->EF_DATA	 := dBaixa
		SEF->EF_BENEF	 := IIF(Empty(cBenef),SA2->A2_NOME,cBenef)
		SEF->EF_PORTADO := cPortado
		SEF->EF_HIST	 := cHist070
		SEF->EF_LIBER   := "S"
		SEF->EF_SEQUENC := cSeqCheque
		SEF->EF_ORIGEM  := "FINA080"
		MsUnlock()		             
	EndIf
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Atualiza o totalizador																 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	If SubStr(cCheque,1,1) = "*" .and. nValPgto > 0 .And. SE2->E2_IMPCHEQ != "S"
		dbSelectArea("SEF")
		SEF->( dbSeek(cFilial+cBanco+cAgencia+cConta+cCheque+cSeqCheque) )
		nRecNo := 0
		While !SEF->( Eof() )	.And. SEF->EF_FILIAL	 =	 cFilial  ;
				.And. SEF->EF_BANCO	 =  cBanco	 ;
				.And. SEF->EF_AGENCIA =  cAgencia ;
				.And. SEF->EF_CONTA	 =  cConta	 ;
				.And. SEF->EF_NUM 	 =  cCheque
			nRecNo := IIf(Empty(SEF->EF_TITULO),SEF->(RecNo()),nRecNo)
			dbSkip( )
		Enddo
		If nRecNo == 0 .And.;
				!cBanco $ Left(GetMv("MV_CXFIN"),3) .And. !cBanco $ GetMv("MV_CARTEIR")
			RecLock("SEF",.T.)
			SEF->EF_FILIAL  := cFilial
			SEF->EF_NUM 	 := cCheque
			SEF->EF_BANCO	 := cBanco
			SEF->EF_AGENCIA := cAgencia
			SEF->EF_CONTA	 := cConta
			SEF->EF_VALOR	 := nValPgto
			SEF->EF_DATA	 := dBaixa
			SEF->EF_BENEF	 := SA6->A6_NOME
			SEF->EF_SEQUENC := "01"
			SEF->EF_ORIGEM  := "FINA080"
			MsUnlock()
		Else
			dbGoTo( nRecNo )
			RecLock("SEF")
			SEF->EF_VALOR	+= nValPgto
			SEF->EF_DATA	:= dBaixa
		Endif
	Endif
Endif

If !lAdiantamento
	lMovBcoBx := MovBcoBx(cMotBx, .T.)
	IF (!Empty(cCheque) .and. lMovBcoBx .and. Substr(cCheque,1,1) != "*") .and.;
			GetMV("MV_LIBCHEQ") == "S" .and. SE2->E2_IMPCHEQ != "S"
		AtuSalBco( cBanco, cAgencia, cConta, dDebito, nValPgto, "-" )
	ElseIf lCNAB .and. Empty(cLoteFin)
		AtuSalBco( cBanco, cAgencia, cConta, dDebito, nValPgto, "-" )
	ElseIf lMovBcoBx .and. (Substr(cBanco,1,2) == "CX" .or. cBanco $ GetMv("MV_CARTEIR"))
		AtuSalBco( cBanco, cAgencia, cConta, dDebito, nValPgto, "-" )
	ElseIf lMovBcoBx .and. !ChqMotBx(cMotBx) .and. !lCnab
		AtuSalBco( cBanco, cAgencia, cConta, dDebito, nValPgto, "-" )
	Endif
Endif

dbSelectArea("SEF")
dbSetOrder(1)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Atualiza o Cadastro de Fornecedores								  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SE2")
dbSetOrder(nOrdBx)
SE2->( dbGotO( nSalvRec ) )
SED->( dbSeek ( cFilial + SE2 -> E2_NATUREZ ) )
IF SA2->( dbSeek(cFilial+SE2->E2_FORNECE+SE2->E2_LOJA) )
	RecLock("SA2")
	If SE2->E2_MOEDA > 1	
		//Acho valor em dolares para converter para real na data de emissao
		nSaldup := Round(NoRound(xMoeda(nValPadrao,1,SE2->E2_MOEDA,dBaixa,3,,nTxMoeda),3),2)
		//Acho valor em reais na data da emissao
		nSaldup := Round(NoRound(xMoeda(nSalDup,SE2->E2_MOEDA,1,SE2->E2_EMISSAO,3,,nTxMoeda),3),2)	
	Else
		nSaldup := nValPadrao
	Endif			
	If SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG
		SA2->A2_SALDUP		+= nSalDup
		SA2->A2_SALDUPM	+= xMoeda(nSaldup,1,Val(GetMv("MV_MCUSTO")),SE2->E2_EMISSAO,3,,nTxMoeda)
	Else
		SA2->A2_SALDUP		-= nSalDup
		SA2->A2_SALDUPM	-= xMoeda(nSaldup,1,Val(GetMv("MV_MCUSTO")),SE2->E2_EMISSAO,3,,nTxMoeda)
	Endif
	nAtraso:=dBaixa-SE2->E2_VENCTO
	If nAtraso > 1
		IF Dow(SE2->E2_VENCTO) == 1 .Or. Dow(SE2->E2_VENCTO) == 7
			IF Dow(dBaixa) == 2 .and. nAtraso <= 2
				nAtraso := 0
			EndIF
		EndIF
		nAtraso:=IIF(nAtraso<0,0,nAtraso)
		If SA2->A2_MATR < nAtraso
			Replace A2_MATR With nAtraso
		EndIf
	Endif
	SA2->(MSUnlock())	// Destrava SA2 apos alteracoes...
	dbSelectArea("SE2")
	SE2->(dbGoTo( nSalvRec ))
Endif
//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ Complementa grava‡Æo da baixa tit. principal  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
dbSelectArea("SE2")
dbGoto(nSalvRec)

//Altera o vencimento dos impostos
If !lPccBaixa
	AltVencImp(SE2->E2_BAIXA)
Endif

//Acerto dos impostos Pis, Cofins e Csll
If (cPaisLoc=="BRA") .And. !lPccBaixa .and. (nJuros > 0 .or. nDescont > 0 .or. nMulta > 0 ) .and. (SE2->E2_PIS+SE2->E2_COFINS+SE2->E2_CSLL > 0)
	F080Impost(nSalvRec,.F.,nJuros,nMulta,nDescont,nValPgto)
Endif

If lRetManual
 	lRetParc := .T.
EndIf

//Gravo os titulos de impostos Pis Cofins Csll quando controlados pela baixa
If (lContrRet .and. lPccBaixa .and. lRetParc).or. (lCalcIssBx .and. nIss > 0)
	FGrvImpPcc(@nPis,@nCofins,@nCsll,nSalvRec,.F.,lRetParc,cSequencia,"FINA080",SE2->E2_MOEDA,,nIrrf,nIss)
Endif

dbSelectArea("SE2")
dbGoto(nSalvRec)
RecLock("SE2")
Replace E2_SALDO	  With nSaldo
MsUnlock()

Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³fa080ChkVdr ³ Autor ³ Vincius S. Barreira	 ³Data  ³18/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Verifica se o Combo do Motivo da Baixa est  como VENDOR		³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³fa080ChkVdr( )																³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080ChkVdr()
If TrazCodMot(cMotBx) == "VEN"
	Fa080Vdr()
Endif

Return Nil

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ValidaTot	  ³ Autor ³ Vincius S. Barreira	 ³Data  ³18/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Verifica Valor total                                   		³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ValidaTot( )																	³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function ValidaTot(cLote)
LOCAL lRet := .t.
Do Case
Case !CarregaSa6(@cBanco,@cAgencia,@cConta,.T.,,.T.)
	lRet := .F.	
Case Empty(cLote)
	lRet := .F.
Case nTotGer+nTotDesp-nTotDesc+nTotMul+nTotJur != nDebConta //(Soma despesa)
	Help(" ",1,"VLRTOTINV")
	lRet := .f.
EndCase
Return lRet

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³MontaTot	  ³ Autor ³ Vincius S. Barreira	 ³Data  ³18/12/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³                                                       		³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³MontaTot(oGet)																³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function MontaTot(oGet)
nDebConta := nTotGer+nTotDesp-nTotDesc+nTotMul+nTotJur
oGet:refresh()
Return .T.

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FA080Inverte³ Autor ³ Wagner Xavier       ³ Data ³ 07/11/95 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Marca e Desmarca Titulos, invertendo a marca‡†o existente  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ Fa080Inverte()                                             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Fa080Inverte(cMarca,oValor,oQtda)
LOCAL nReg := SE2->(Recno())
LOCAL lBxTit := .T.
dbSelectArea("SE2")
dbSeek(cFilial)
While !Eof() .and. cFilial == E2_FILIAL
	RecLock("SE2")
	IF E2_OK == cMarca
		SE2->E2_OK := "  "
		nValor -= xMoeda(E2_SALDO,SE2->E2_MOEDA,1)
		nQtdtit--
		nValor := Iif(nValor<0,0,nValor)
		nQtdTit:= Iif(nQtdTit<0,0,nQtdTit)
	Else
		lBxTit := .T.
		SE2->E2_OK := cMarca
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ PONTO DE ENTRADA F080BXLT                                     ³
		//³ Verifica se titulo pode ser marcado para baixa ou nÆo. Caso	³
		//³ tenha sido alterada a marca‡Æo do titulo, ExecBlock dever     ³
		//³ retornar .F., para nÆo haver altera‡Æo dos acumuladores de    ³
		//³ valores e numero de titulos.                                  ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		IF (ExistBlock("F080BXLT")) .and. !Empty(E2_OK)
			lBxTit := ExecBlock("F080BXLT",.F.,.F.)
		Endif
		If lBxTit
			nValor += xMoeda(E2_SALDO,SE2->E2_MOEDA,1)
			nQtdtit++
		Endif
	Endif
	dbSkip()
Enddo
SE2->(dbGoto(nReg))
oValor:Refresh()
oQtda:Refresh()
oMark:oBrowse:Refresh(.t.)
Return Nil


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ fa080BcoCx ³ Autor ³ Mauricio Pequim Jr.   ³ Data ³ 17/03/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Correcao de n§. do cheque para Banco = "CX"						 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ fa080BcoCx() 																 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																		 ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fa080BcoCx()
Local lRet := .T.
If SubStr(cBanco,1,2) == "CX" .or. cBanco $ GetMv("MV_CARTEIR")
	cCheque := Space(15)
	If Type("oCheque")=="O"
		oCheque:Refresh()
	Endif
Endif
If lfa080Bco == NIL
	lFa080Bco := ExistBlock("FA080BCO")
Endif
If lFa080Bco
	lRet := ExecBlock("FA080BCO", .F., .F., {cBanco,cAgencia,cConta})
Endif	
Return lRet
/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080BDev ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 02/06/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Limpa conteudo de Bco/Age/Cta/N.Chque se baixa DEVOLUCAO   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ Fa080bDev()																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function Fa080BDev(lValida)
LOCAL cChave_EF
LOCAL aArea := GetArea()
LOCAL aAreaSef := SEF->(GetArea())
Local lRet := .T.
DEFAULT lValida := .T.

If !MovBcoBx(cMotBx, .T.)
	cBanco 	:= Space(3)
	cAgencia	:=	Space(5)
	cConta 	:= Space(10)
	cCheque 	:= Space(10)
	If Type('lF080Auto') =='U' .or. ! lF080Auto .And. Type("oBanco") == "O" .and. Type("oCheque")=="O"
		oBanco:Refresh()
		oAgencia:Refresh()
		oConta:Refresh()
		oCheque:Refresh()
   Endif
Else
   //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Se tem cheque relacionado ao Titulo, vasculha SEF c/ sequencia em  ³
	//³ branco (Gerado pelo Chq s/ Titulo) e carrega Bco/Ag/Conta e N§Chq  ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SEF")
	dbSetOrder(3)
	If SE2->E2_IMPCHEQ=="S" .and. SEF->(dbseek(xFilial("SEF")+SE2->E2_PREFIXO+SE2->E2_NUM+;
			SE2->E2_PARCELA+SE2->E2_TIPO))
	
		cChave_EF := xFilial("SEF")+SE2->E2_PREFIXO+SE2->E2_NUM+SE2->E2_PARCELA+SE2->E2_TIPO
		DO WHILE (cChave_EF == SEF->EF_FILIAL + SEF->EF_PREFIXO+SEF->EF_TITULO;
				+SEF->EF_PARCELA+SEF->EF_TIPO) .and. !(SEF->(EOF()))
			IF empty(SEF->EF_SEQUENC) .and. SE2->(E2_FORNECE+E2_LOJA) == SEF->(EF_FORNECE+EF_LOJA)
				cBanco  :=SEF->EF_BANCO
				cAgencia:=SEF->EF_AGENCIA
				cConta  :=SEF->EF_CONTA
				cCheque :=SEF->EF_NUM
				If Type('lF080Auto') =='U' .or. ! lF080Auto .And. Type("oBanco") == "O" .and. Type("oCheque")=="O"
					oBanco:Refresh()
					oAgencia:Refresh()
					oConta:Refresh()
					oCheque:Refresh()
			   Endif
				EXIT
			Endif
			SEF->(DbSkip())
		ENDDO
	EndIf
	Sef->(RestArea(aAreaSef))
	RestArea(aArea)
Endif             

lRet:=Fa080ValCh(lValida)

If TrazCodMot(cMotBx) == "DEB"  .and. lRet
		cCheque 	:= Space(10)
		If Type('lF080Auto') =='U' .or. ! lF080Auto .And. Type("oCheque") == "O" .and. Type("oCheque")=="O"
			oCheque:Refresh()
		EndIF
Endif

Return (lRet)

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³Fa080REFRE³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 27/08/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Da Refresh() nos objetos                                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ Fa080Refresh()															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
FUNCTION FA080Refre(nCampo)
DEFAULT nCampo := 0
IF SE2->E2_MOEDA > 1
	oVlEstrang:Refresh()
   If Type('lF080Auto') =='U' .or. ! lF080Auto
		IIf( cPaisloc <> "CHI",oCm:Refresh(),.T.)
   EndIF
ENDIF
If nCampo == 1 // Valor do Pagto.
	If (SE2->E2_IMPCHEQ == "S" .or. lChqPre) .And. Round(nValPgto,2) != Round((nValMoeda+nMulta+nJuros-nDescont+nAcresc-nDecresc-nPis-nCoFins-nCsll-nIrrf-nIss),2)
		Help(" ",1,"JACHQSTIT")
		nValPgto := nOldValPgto		
		Return .F.
	Endif	
Endif

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Sel080baix³ Autor ³ Andreia dos Santos    ³ Data ³ 03/11/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Seleciona Baixas a serem canceladas                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Sel080Baixa()                                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Gen‚rico                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function Sel080Baixa(cTipoDoc,cPrefixo, cNum, cParcela,cTipo,nTotComp,lBaixaAbat,cFornece,cLoja,lBxCEC,lFltrOrdPg,lRetHelp,nTotImpost,lAglImp,lConsCMP)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³           ..:: Paises Localizados ::..                    ³
//³                                                           ³
//³ A variavel lFltrOrdPg servira para definir se a           ³
//³ Ordem de Pago podera ser baixada ou nao por esta rotina.  ³
//³	lFltrOrdPg = Filtra Orden de Pago						  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ

LOCAL __k
LOCAL cTipoBaixa
LOCAL nRecAtu
LOCAL cSequencia
LOCAL lEstornada := .f.
LOCAL aBaixa := {}
LOCAL cNumero

DEFAULT lFltrOrdPg	:= .F.
DEFAULT lRetHelp	:= .F.
DEFAULT nTotImpost := 0
DEFAULT lAglImp := .F.
DEFAULT lConsCMP := .F.

lBxCec := IIF(lBxCec == NIL,.F.,lBxCec)

FOR __k := 1 TO Len(cTipoDoc) Step 4

	cTipoBaixa := AllTrim(Substr(cTipodoc,__k,3 ) )
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Procura pela baixas dependendo do Tipodoc passado como parametro      ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	dbSelectArea("SE5")
	SE5->(dbSetOrder(2))
	SE5->(dbSeek(cFilial+cTipoBaixa+cPrefixo+cNum+cParcela+cTipo))
	While !SE5->(Eof()) .and. SE5->E5_FILIAL==cFilial .and. ;
			SE5->E5_TIPODOC+SE5->E5_PREFIXO+SE5->E5_NUMERO+SE5->E5_PARCELA+SE5->E5_TIPO==cTipoBaixa+cPrefixo+cNum+cParcela+cTipo

		If SE5->E5_MOTBX == "FAT"
			dbSkip()
			Loop
		Endif

		If SE5->E5_MOTBX == "PCC"
			nTotImpost += SE5->E5_VALOR
			dbSkip()
			Loop
		Endif

		If lFltrOrdPg .And. SE5->(FieldPos('E5_ORDREC'))>0 .And. !Empty( SE5->E5_ORDREC )
			lRetHelp := .T.
			dbSkip()
			Loop
		Endif         
		
		If (SE5->(FieldPos("E5_AGLIMP"))) > 0 .And. !Empty(SE5->E5_AGLIMP) .And. SE5->E5_TIPO $ MVTAXA+"/"+MVTXA
			lAglImp := .T.
			dbSkip()
			Loop
		EndIf		

		If SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Verifica se as baixas sao de adiantamento (NORmal,DEVolucao,DACao)  ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			If cTipoBaixa =="VL" .or. cTipoBaixa =="BA"
				lBaixaAbat := .t.
			EndIf
			IF SE5->E5_SITUACAO == "C" .or. SE5->E5_RECPAG != "R"
				SE5->(dbSkip())
				Loop
			EndIF
		Else
			IF SE5->E5_SITUACAO == "C" .or. SE5->E5_RECPAG != "P"
				SE5->(dbSkip())
				Loop
			EndIF
		Endif

		IF SE5->E5_CLIFOR != cFornece .OR. SE5->E5_LOJA != cLoja
			SE5->(dbSkip())
			Loop
		EndIF

		If cTipoBaixa == "BA" .and. ( SE5->E5_TIPO $ MVPAGANT+"/"+MV_CPNEG) .AND. !EMPTY(SE5->E5_DOCUMEN)
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Incrementa o valor compensado quando for baixa de compensacao e  ³
			//³o titulo for PA ou NDF.                                          ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nTotComp += SE5->E5_VALOR
			dbskip()
			loop
		EndIf

		nRecAtu := SE5->(recno())
		cSequencia := SE5->E5_SEQ
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Verifica se existe uma baixa cancelada para esta baixa efetuada       ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		SE5->(dbSeek(cFilial+"ES"+cPrefixo+cNum+cParcela+cTipo))
		While !SE5->(Eof()) .and. SE5->E5_FILIAL==cFilial .and. ;
				SE5->E5_TIPODOC+SE5->E5_PREFIXO+SE5->E5_NUMERO+SE5->E5_PARCELA+SE5->E5_TIPO=="ES"+cPrefixo+cNum+cParcela+cTipo

			If SE5->E5_MOTBX == "FAT"
				dbSkip()
				Loop
			Endif

			IF SE5->E5_CLIFOR != cFornece .OR. SE5->E5_LOJA != cLoja
				SE5->(dbSkip())
				Loop
			EndIF

			if SE5->E5_SEQ == cSequencia
				lEstornada := .T.
				Exit
			EndIf
			SE5->( dbSkip() )
		EndDo
		SE5->(dbGoTo(nRecAtu))
		If lEstornada
			lEstornada := .f.
			SE5->(dbSkip())
			Loop
		EndIf

		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³Aten‡„o, o array aBaixaSE5 ‚ o elemento fundamental para que ³
		//³a baixa funcione a contento. Se for necess rio alter -lo,deve³
		//³ser feito com a MAXIMA ATENCAO, pois as variaveis tratadas na³
		//³funcao est„o com posi‡”es fixas dentro do array              ³
		//³Mem¢ria de Calculo do array em quest„o.                      ³
		//³                                                             ³
		//³Informa‡„o        Posicao     Tamanho  					       ³
		//³                                                             ³
		//³Prefixo            01           03  					          ³
		//³Numero             02           12           					 ³
		//³Parcela            03           01						          ³
		//³Tipo               04           03					             ³
		//³Cliente/Fornec     05           06					             ³
		//³Loja               06           02					             ³
		//³Data da baixa      07           08					             ³
		//³Valor              08           15					             ³
		//³Sequencia          09           02					             ³
		//³Data Dispon.       10           08					             ³
		//³Banco              11           03					             ³
		//³Agencia            12           05					             ³
		//³Conta              13           10					             ³
		//³Dt. Disponibil.    14           08				             ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		If (cTipoBAixa =="CP" .or. SE5->E5_MOTBX == "CEC") .and. !lConsCMP
			//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
			//³Incrementa o valor compensado quando for baixa de compensacao e  ³
			//³for o titulo principal.		                                      ³
			//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
			nTotComp += SE5->E5_VALOR
			If SE5->E5_MOTBX == "CEC"
				lBxCEC := .T.
			Endif
		Else
			cNumero := SE5->E5_NUMERO+Iif(Len(SE5->E5_NUMERO)==TamSx3("E5_NUMERO")[1],Space(Len(SE5->E5_NUMERO)),"")
			
			Aadd(aBaixa,SE5->E5_PREFIXO+" "+cNumero       +;
				" "+SE5->E5_PARCELA+" "+E5_TIPO+" "+E5_CLIFOR +;
				" "+E5_LOJA+" "+Dtoc(E5_DATA)        +;
				" "+Transf(E5_VALOR,"@E 9999,999,999.99")+"   "+E5_SEQ  )

			Aadd(aBaixaSE5,{ SE5->E5_PREFIXO,SE5->E5_NUMERO,SE5->E5_PARCELA,+E5_TIPO	,;
				SE5->E5_CLIFOR,SE5->E5_LOJA,SE5->E5_DATA				,;
				SE5->E5_VALOR,SE5->E5_SEQ,SE5->E5_DTDISPO				,;
				SE5->E5_BANCO,SE5->E5_AGENCIA,SE5->E5_CONTA,SE5->E5_DTDISPO ,;
				SE5->E5_VRETPIS,SE5->E5_VRETCOF,SE5->E5_VRETCSL})				
		EndIf
		SE5->(dbSkip())
	EndDo
Next __k

Return( aBaixa )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FA080Cont ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 05/11/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Valida Bco/Agen/Cta e titulos c/cheque gerado anteriormente ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FA080Cont(ExpA1)                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function fA080Cont()
LOCAL lRet:=.T.

//Baixa de titulo com cheque j  gerado
If Empty(cBanco+cAgencia+cConta) .and. SE2->E2_IMPCHEQ == "S"
	lRet := .T.
Else
	lRet := CarregaSa6(cBanco,cAgencia,cConta,,,.T.)
Endif
Return lRet

Static Function Get080Mark()
Local cMarca

cMarca :=GetMark()
While cMarca == "xx"
	cMarca := Getmark()
Enddo
Return cMarca
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³Fa080SetMd³ Autor ³ Fernando Machima      ³ Data ³ 09/01/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Mostra a tela de taxas de moeda    						  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³Fa080SetMd()                                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³FINA080                                                     ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Static Function Fa080SetMd()
Local nCentMd1	:= MsDecimais(1)
Local oDlg, nLenMoedas	:= Len(aTxMoedas)
Local nOpc := 0
aBkpMoedas := aClone( aTxMoedas)

If nLenMoedas > 1
	DEFINE MSDIALOG oDlg From 200,0 TO 362,230 TITLE OemToAnsi(STR0116) PIXEL
	@ 005,005  To 062,110 OF oDlg PIXEL
	@ 012,010 SAY  aTxMoedas[2][1]  Of oDlg PIXEL
	@ 010,060 MSGET aTxMoedas[2][2] PICTURE aTxMoedas[1][3] VALID aTxMoedas[2][2]>0 Of oDlg PIXEL 
	If nLenMoedas > 2
		@ 024,010 SAY  aTxMoedas[3][1]  Of oDlg PIXEL
		@ 022,060 MSGET aTxMoedas[3][2] PICTURE aTxMoedas[2][3] VALID aTxMoedas[3][2]>0 Of oDlg PIXEL
		If nLenMoedas > 3
			@ 036,010 SAY  aTxMoedas[4][1]  Of oDlg PIXEL
			@ 034,060 MSGET aTxMoedas[4][2] PICTURE aTxMoedas[3][3] VALID aTxMoedas[4][2]>0 Of oDlg PIXEL
			If nLenMoedas > 4
				@ 048,010 SAY  aTxMoedas[5][1]  Of oDlg PIXEL
				@ 046,060 MSGET aTxMoedas[5][2] PICTURE aTxMoedas[4][3] VALID aTxMoedas[5][2]>0 Of oDlg PIXEL
			Endif
		Endif
	Endif
	DEFINE SButton FROM 064,80 TYPE 1 Action (nOpc:=1, oDlg:End() ) ENABLE OF oDlg  PIXEL

	ACTIVATE MSDialog oDlg CENTERED

	If nOpc <> 1  // nao confirmou, volta o backup das taxas
		aTxMoedas := aClone( aBkpMoedas)	
	EndIf
	nDifCambio	:= ( Round( (SE2->E2_VALOR * aTxMoedas[SE2->E2_MOEDA][2]), nCentMd1 ) - Round( SE2->E2_VLCRUZ, nCentMd1 ) )

Endif

Return( aTxMoedas[SE2->E2_MOEDA][2] )

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³VerCpoSPB ³ Autor ³ Mauricio Pequim Jr.   ³ Data ³ 22/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³ Verifica existencia dos campos de SPB                 	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ VerCpoSPB()																  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080																	  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function VerCpoSPB()

Local lRet := .T.
Local nK

dbSelectArea("SE2")
IF !(	SE2->(FieldPos("E2_CODBAR"))	  > 0 .and. SE2->(FieldPos("E2_OKSPB"))	> 0 .and.;
		SE2->(FieldPos("E2_CLEARIN")) > 0 .and. SE2->(FieldPos("E2_TPPGTO"))> 0 .and.;
		SE2->(FieldPos("E2_HORASPB")) > 0 .and. SE2->(FieldPos("E2_EVTSPB"))> 0 )
	lRet := .F.
Endif
If lRet
	dbSelectArea("SX5")
	For nK := 0 to 9
		cTabela := "X"+Alltrim(STR(nK))
		If !DbSeek(cFilial+cTabela)
			lRet := .F.
			Exit
		Endif
	Next
Endif
IF !File("SIGAADV.SPB")
	nHdlMot := MSFCreate("SigaAdv.SPB",0)
	IF nHdlMot == -1
		HELP(" ",1,"MOT_ERROR")
		Final("Erro F_"+str(ferror(),2)+" em SIGAADV.SPB")
	Endif
	fClose(nHdlMot)
Endif

Return lRet


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³F080SPB   ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 22/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Abre tela para digitação dos dados de SPB                   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ F080SPB(ExpL1,ExpC1,ExpC2,ExpC3,ExpC4,ExpC5)               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpL1 := Utiliza SPB ou nao                                ³±±
±±³          ³ ExpC1 := Clearing                                          ³±±
±±³          ³ ExpC2 := Tipo de Pagamento (Tabela 59)                     ³±±
±±³          ³ ExpC3 := Stored a ser disparada                            ³±±
±±³          ³ ExpC4 := Hora do agendamento da operacao              	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function F080SPB(lSPB,cClearing,cTipoPgto,cStored,cHora)
Local nOpca := 0
Local oClearing
Local aClearing := {"TED","CIP"}
Local oTpPagto

DEFAULT cClearing := "TED"
lSPB := VerCpoSPB()

If lSPB
	If TrazCodMot(cMotBx) $ "SPB"
		//	tela dos dados complementares para SPB
		While .T.
			DEFINE MSDIALOG oDlgs FROM	22,9 TO 115,400 TITLE STR0122 PIXEL //"Dados SPB"

			@ 020, 014 COMBOBOX oClearing VAR cClearing ITEMS aClearing SIZE 30,50 OF oDlgs PIXEL
			@ 020, 050 MSGET oTpPagto VAR cTipoPgto	F3 "X9" Picture "@!" Valid ExistCpo("SX5", + "X9" + cTipoPgto) SIZE 30, 11 OF oDlgs PIXEL
			@ 020, 084 MSGET cHora	Picture "99:99" Valid !Empty(cHora) .and. VldHoraSPB(cHora) SIZE 30, 11 OF oDlgs PIXEL

			@ 010, 014 SAY STR0123 SIZE 20, 7 OF oDlgs PIXEL  //"Clearing"
			@ 010, 050 SAY STR0124 SIZE 50, 7 OF oDlgs PIXEL  //"Tipo Pgto"
			@ 010, 084 SAY STR0125 SIZE 49, 7 OF oDlgs PIXEL  //"Hora Agendamento"

			@ 004, 007 TO 036, 150 OF oDlgs PIXEL
   	
			DEFINE SBUTTON FROM 07, 155 TYPE 1 ACTION (nOpca:=1,IF(F080VldSPB(cClearing,cTipoPgto,@cStored,cHora),oDlgs:End(),nOpca:=2)) ENABLE OF oDlgs
			DEFINE SBUTTON FROM 21, 155 TYPE 2 ACTION (nOpca:=0,oDlgs:End()) ENABLE OF oDlgs

			ACTIVATE MSDIALOG oDlgs CENTERED		  
			If nOpca == 0
				lSPB := .F.
			ElseIf nOpca == 2
				nOpca := 0
				Loop
			Endif
			Exit
		Enddo
	Else
		lSPB := .F.
	Endif
Endif
Return .T.


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³F080BxSPB ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 22/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Valida e executa emissao de dadodos para SPB                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ F080BxSPB(ExpL1,ExpC1,ExpC2,ExpC3,ExpC4,ExpC5)             ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpL1 := Utiliza SPB ou nao                                ³±±
±±³          ³ ExpC1 := Clearing                                          ³±±
±±³          ³ ExpC2 := Tipo de Pagamento (Tabela 59)                     ³±±
±±³          ³ ExpC3 := Stored a ser disparada                            ³±±
±±³          ³ ExpC4 := Hora do agendamento da operacao              	  ³±±
±±³          ³ ExpC4 := Codigo de Barras                             	  ³±±
±±³          ³ ExpN1 := Numero Evento SPB                            	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function F080BxSPB(cClearing,cTipoPgto,cStored,cHora,cCodbar,nEventoSpb)
Local lRet := .T.
Local nValBaixa := nValPgto-(nJuros+nMulta-nDescont)
Local aSPB := {}
Local aDadosSpb := {}

IF STR(nValBaixa,17,2) != STR(Round(NoRound(xMoeda(SE2->E2_VALOR-nTotAbat,SE2->E2_MOEDA,1,dBaixa,3),3),2),17,2)
	Help(" ",1,"FA070INV")
	lRet := .F.
Endif

If lRet
	cCodBar	:= SE2->E2_CODBAR+Space(44-Len(SE2->E2_CODBAR))
	AADD(aSPB,{cClearing,cTipoPgto,cStored,cHora,cCodBar})
	// Execblock para iniciar Stored Procedure
	IF ExistBlock("FA080SPB")
		aDadosSPB := ExecBlock("FA080SPB",.f.,.f.,aSPB)
		cCodBar := aDadosSpb[1]
		nEventoSPB := aDadosSpb[2]
		If nEventoSPB == 0	//Erro no SPB. Não permite a baixa
			lRet := .F.
		Endif		
	Endif
Endif	

Return lRet


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³TrazCodSPB³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 23/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Retorna o codigo da Stored a ser utilizada                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³TrazCodSPB(ExpC1)		                                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1 - Codigo do SPB (Clearing+Tipo Pgto)   					  ³±±    
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³Generico                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function TrazCodSPB( cCodSPB )
LOCAL nPos
LOCAL aCodSPB := ReadCodSPB()
nPos := Ascan(aCodSPB, {|x| Substr(x,1,5) = Upper(cCodSPB) })
If nPos > 0
	cStored := Upper(Substr(aCodSPB[nPos],6,4))
Else
	cStored := Space(4)
EndIf
Return cStored

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ReadCodSPB³ Autor ³ Mauricio Pequim Jr	  ³ Data ³ 22/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Leitura do arquivo SIGAADV.SPB para carregar array aMotBx c/³±±
±±³			 ³o Codigo da mensagem do SPB a ser utilizado             	  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ ReadCodSpb()															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno	 ³ Array aCodSpb															  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function ReadCodSPB()
Local nHdlCod := 0
Local nBytes:=0
Local nTamArq
Local xBuffer
Local aCodSpb:={}

If !FILE("SIGAADV.SPB")
	nHdlCod := fCreate("SigaAdv.SPB")
	If nHdlCod == -1
		HELP(" ",1,"SPB_ERROR")
		Final("Erro F_"+str(ferror(),2)+" em SIGAADV.SPB")
	EndIf
	fClose(nHdlCod)
EndIf

nHdlCod := FOPEN("SIGAADV.SPB",64)

If nHdlCod <0
	HELP(" ",1,"SIGAADV.SPB")
	Final("SIGAADV.SPB")
EndIf
nTamArq:=FSEEK(nHdlCod,0,2)	// VerIfica tamanho do arquivo
FSEEK(nHdlCod,0,0)			// Volta para inicio do arquivo

While nBytes<nTamArq
	
	xBuffer:=Space(11)
	FREAD(nHdlCod,@xBuffer,11)
	
	AADD(aCodSpb,Upper(SubStr(xBuffer,1,9)))
	nBytes+=11
Enddo

Fclose(nHdlCod)

Return aCodSpb

/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³ValidSPB  ³ Autor ³ Mauricio Pequim Jr	  ³ Data ³ 22/09/01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Valida os dados do SPB no momento da baixa                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³ ValidaSPB(ExpC1,ExpC2,ExpC3,ExpN1)								  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametro ³ ExpC1 = Codigo do Clearing SPB									  ³±±
±±³       	 ³ ExpC2 = Tipo de Pagamento (Tabela 59)							  ³±±
±±³       	 ³ ExpC3 = Mensagem do piloto SPB a ser utilizada				  ³±±
±±³          ³ ExpN1 = Hora do Agendamento										  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function F080VldSPB(cClearing,cTipoPgto,cStored,cHora)
Local lRet := .T.

If	!VldHoraSPB(cHora) .or. Empty(cTipoPgto)
	lRet := .F.
Endif
If lRet
	cStored := TrazCodSPB(cClearing+cTipoPgto)
	If Empty(cStored)
		MSGSTOP("Operacao nao cadastrada na Tabela de SPB.")
		lRet := .F.
	Endif
Endif
Return lRet 

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³VldHoraSPB³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 24.09.01 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Consiste se a hora digitada ‚ v lida.							  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe e ³ VldHoraSPB(ExpC1) 													  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Hora no formato 99:99 						    		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
*/
Function VldHoraSPB(cHora)

Local lRet		:= .F.
Local cHoras	:= Substr(cHora,1,2)
Local cMinutos := Substr(cHora,4,2)

If cHoras >= "00" .And. cHoras < "24" .And. cMinutos >= "00" .And. cMinutos < "60"
	lRet := .T.
EndIf
If ( !lRet)
	Help(" ",1,"VLDHORA")
EndIf

Return(lRet)

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³Fa080ValEs³ Autor ³ Claudio D. de Souza   ³ Data ³ 17.09.03 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Validacao do valor recebido em moeda estrangeira			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe e ³ Fa080ValEstrang(	nValEstrang,nTxMoeda,nValPgto,dBaixa, 	  ³±±
±±³			 ³ 						oValPgto,oTxMoeda,nJuros,nMulta,nDescont,³±±
±±³			 ³ 						nOtrga,nImpSubst,nEstOriginal)			  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Hora no formato 99:99 						    		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080  																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
*/
Function Fa080ValEstrang(	nValEstrang,nTxMoeda,nValPgto,dBaixa,oValPgto,oTxMoeda,;
											nJuros,nMulta,nDescont,nOtrga,nImpSubst,nEstOriginal)
Local nValPgOld := nValPgto

If nTxMoeda > 0
	// Converte o valor em moeda estrangeira para identificar o valor total do pagto. 
	nValPgto := Round(NoRound(xMoeda(nValEstrang,SE2->E2_MOEDA,1,dBaixa,3,nTxMoeda),3),2)

	//Problemas de arredondamento
	If ABS(nValPgOld - nValPgto) == ABS(0.01)
		nValpgto := nValPgOld
	Endif
		
	// Verifica a taxa utilizada
	nTxMoeda := Round(NoRound(nValPgto/nValEstrang,5),4)
	
	// Somente atualiza os objetos caso nao seja rotina automatica
	If ValType(oTxMoeda) == "O"
		// Atualiza os objetos
		If cPaisLoc=="BRA"
			oTxMoeda:Refresh()
		EndIf
		oValPgto:Refresh()
	EndIf

	// Calcula a correcao monetaria
 	nEstOriginal := nValEstrang- Round(NoRound(xMoeda(nJuros+nMulta-nDescont+nOtrga+nImpSubst,1,SE2->E2_MOEDA,,3,,nTxMoeda),3),2)
	FA080CORR(nEstOriginal,nTxMoeda)
Endif	

Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³AltVencImp³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 27.02.04 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Altera data de vencimento dos titulos de impostos quando da³±±
±±³          ³ baixa do titulo principal.											  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe e ³ AltVencImp()		 													  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpC1 = Hora no formato 99:99 						    		  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico 																  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
/*/
Function AltVencImp(dDtBaixa)

Local aArea		 := GetArea()
Local dVencRea	 := CTOD("//")
Local cChaveIrf := ""
Local cChavePIS := ""	
Local cChaveCOF := ""
Local cChaveCSL := ""
Local nRegSe2	 := SE2->(RecNo())
Local cUniao	 := PadR(GetMv("MV_UNIAO"),6)
Local cCodRetIr := SE2->(If(FieldPos("E2_CODRET")>0,E2_CODRET,""))
Local cTipoFor := ""

DEFAULT dDtBaixa := dDataBase
If Select("__SE2") == 0
   ChkFile("SE2",.F.,"__SE2")
Else
   DbSelectArea("__SE2")
EndIf

cAlias := "__SE2"

//Permite ou nao a alteracao dos vencimentos dos impostos.
If !(SuperGetMv("MV_ATVCIMP",.F.,.F.))
	RestArea(aArea)
	dbGoto(nRegSe2)
	Return .T.
Endif

If ( cPaisLoc == "BRA" )
	cChaveIrf := If(SE2->E2_IRRF > 0, SE2->E2_PREFIXO +;
		 				SE2->E2_NUM + SE2->E2_PARCIR +;
		 				Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
	
	cChavePis	:= If(SE2->E2_PIS > 0, SE2->E2_PREFIXO +;
	 					SE2->E2_NUM + SE2->E2_PARCPIS +;
	 					Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
	
	cChaveCOF	:= If(SE2->E2_COFINS > 0, SE2->E2_PREFIXO +;
		 				SE2->E2_NUM + SE2->E2_PARCCOF +;
	 					Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
	
	cChaveCSL	:= If(SE2->E2_CSLL > 0, SE2->E2_PREFIXO +;
		 				SE2->E2_NUM + SE2->E2_PARCSLL +;
	 					Iif(SE2->E2_TIPO $ MVPAGANT+"/"+MV_CPNEG,MVTXA,MVTAXA), "")
Endif 					

cTipoFor := SA2->A2_TIPO

dbSelectArea(cAlias)
dbSetOrder(1)	
dVencRea := F050VImp("IRRF",SE2->E2_EMISSAO,SE2->E2_EMIS1,dDtBaixa,cCodRetIr,cTipoFor) // Calcula o vencimento do imposto
If !Empty(cChaveIrf) .and. MsSeek(xFilial("SE2")+cChaveIrf+cUniao)
	If E2_SALDO > 0
		Reclock(cAlias)
		E2_VENCREA 	:= dVencrea
		E2_VENCTO 	:= dVencrea
		MsUnlock()
	Endif
Endif
SE2->(dbGoto(nRegSe2))
dVencRea := F050VImp("PIS",SE2->E2_EMISSAO,SE2->E2_EMIS1,dDtBaixa) // Calcula o vencimento do imposto
//Atualiza data de vencimento do titulo de PIS
If !Empty(cChavePis) .and. MsSeek(xFilial("SE2")+cChavePis+cUniao)
	If E2_SALDO > 0
		Reclock(cAlias)
		E2_VENCREA 	:= dVencrea
		E2_VENCTO 	:= dVencrea
		MsUnlock()
	Endif
Endif
//Atualiza data de vencimento do titulo de Cofins
If !Empty(cChaveCof) .and. MsSeek(xFilial("SE2")+cChaveCof+cUniao)
	If E2_SALDO > 0
		Reclock(cAlias)
		E2_VENCREA 	:= dVencrea
		E2_VENCTO 	:= dVencrea
		MsUnlock()
	Endif
Endif
//Atualiza data de vencimento do titulo de Cofins
If !Empty(cChaveCsl) .and. MsSeek(xFilial("SE2")+cChaveCsl+cUniao)
	If E2_SALDO > 0
		Reclock(cAlias)
		E2_VENCREA 	:= dVencrea
		E2_VENCTO 	:= dVencrea
		MsUnlock()
	Endif
Endif
RestArea(aArea)
dbGoto(nRegSe2)
Return .T.

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³MoedaBco  ³ Autor ³ Cristiano Denardi  ³ Data ³ 07.05.04 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Busca a moeda no cadastro do banco.                     ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ cBco    = Codigo do Banco 						       ³±±
±±³          ³ cAg     = Codigo da Agencia					           ³±±
±±³          ³ cCC     = Codigo da Conta 							   ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Return    ³ nMd -> Numero da moeda do banco                         ³±±
±±³          ³        0 - erro na busca ou nao encontrou               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080 (paises localizados)							   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
/*/
Function MoedaBco( cBco, cAg, cCC )

Local aArea	:= GetArea()
Local nMd	:= 0	// Moeda usada pelo Banco
Local lPar	:= .T.	// Validacao os parametros passados a funcao

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³Validacao das variaveis usadas na funcao ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
Do Case
	Case ( cBco   == Nil ) .Or. Empty(cBco  )
		lPar := .F.    
	Case ( cAg    == Nil ) .Or. Empty(cAg   )
		lPar := .F.
	Case ( cCC    == Nil ) .Or. Empty(cCC   )
		lPar := .F.     
EndCase                 

If lPar
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³Busca a Moeda do Banco Informado ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	DbSelectArea("SA6")
	DbSetOrder(1) // A6_FILIAL+A6_COD+A6_AGENCIA+A6_NUMCON
	DbSeek( xFilial("SA6")+cBco+cAg+cCC )
	If Found()
		If cPaisLoc <> "CHI"
			nMd := SA6->A6_MOEDA
		Else
			nMd := Max(IIf(Type("SA6->A6_MOEDAP")=="U",SA6->A6_MOEDA,SA6->A6_MOEDAP),1)	
		EndIf	
	Endif
Endif

RestArea(aArea)
Return( nMd )
/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³F080Impost³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 05/11/98 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Valida Bco/Agen/Cta e titulos c/cheque gerado anteriormente ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe   ³ FA080Cont(ExpA1)                                           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³                                                            ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function F080Impost(nRegSe2,lCancel,nJuros,nMulta,nDescont,nValPgto)

Local aArea	:= GetArea()
Local nBaseImp := 0
Local cForUniao := ""
Local cLojUniao := ""
Local nValImp := 0                           
Local cPrefNum := If( cPaisLoc=="BRA", SE2->(E2_PREFIXO+E2_NUM), "" )
Local cParcPis := If( cPaisLoc=="BRA", SE2->E2_PARCPIS, "" )
Local cParcCof := If( cPaisLoc=="BRA", SE2->E2_PARCCOF, "" )
Local cParcCsl := If( cPaisLoc=="BRA", SE2->E2_PARCSLL, "" )
Local nX := 0
Local cChaveImp := ""

Default lCancel := .F.

If ( cPaisLoc == "BRA" )
	//Se o usuario fez opcao por nao calcular impostos na baixa
	If SuperGetMv("MV_IMPBAIX",.t.,"1") == "2"
		Return .T.
	Endif
	
	DbSelectArea("SA2")
	DbSetOrder(1)
	MsSeek(xFilial("SA2")+GetMv("MV_UNIAO")+Space(Len(A2_COD)-Len(GetMv("MV_UNIAO")))+"00")
	cForUniao	:= SA2->A2_COD
	cLojUniao	:= SA2->A2_LOJA
	
	dbSelectArea("SE2")
	dbSetOrder(1)	
	
	//Abro o SE2 com outro alias pois pode estar filtrado pela 
	//Baixa por lote
	If Select("__SE2") == 0
	   ChkFile("SE2",.F.,"__SE2")
	Else
	   DbSelectArea("__SE2")
	EndIf
	dbSetOrder(1)
	dbGoto(nRegSE2)
	
	nBaseImp	:= __SE2->(E2_VALOR+E2_IRRF+E2_INSS+E2_ISS+E2_SEST+E2_PIS+E2_COFINS+E2_CSLL)
	
	//Calculo o valor do imposto sobre os valores de juros e descontos
	If nDescont > 0 .and. nValPgto == 0  //Baixa por desconto
		nValPisBx := ( (nJuros + nMulta - nDescont) * __SE2->E2_PIS ) / __SE2->E2_VALOR
		nValCofBx := ( (nJuros + nMulta - nDescont) * __SE2->E2_COFINS ) / __SE2->E2_VALOR
		nValCslBx := ( (nJuros + nMulta - nDescont) * __SE2->E2_CSLL ) / __SE2->E2_VALOR
	Else 
		nValPisBx := ( (nJuros + nMulta - nDescont) * __SE2->E2_PIS ) / nBaseImp
		nValCofBx := ( (nJuros + nMulta - nDescont) * __SE2->E2_COFINS ) / nBaseImp
		nValCslBx := ( (nJuros + nMulta - nDescont) * __SE2->E2_CSLL ) / nBaseImp
	Endif
	
	//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
	//³ Analise dos codigos das naturezas envolvidas                 ³
	//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	For nX := 1 to 3 
		Do Case
			Case nX == 1	//Pis
				cNatureza	:= GetMv("MV_PISNAT",.F.,"PIS")
				cValor		:= "nValPisBx"
				cChaveImp	:= IIf(ABS(nValPisBx) > 0, cPrefNum+cParcPis+"TX "+cForUniao+cLojUniao, "")
			Case nX == 2	//Cofins
				cNatureza	:= GetMv("MV_COFINS",.F.,"COF")
				cValor		:= "nValCofBx"
				cChaveImp	:= IIf(ABS(nValCofBx) > 0, cPrefNum+cParcCof+"TX "+cForUniao+cLojUniao, "")
			Case nX == 3	//Csll
				cNatureza	:= GetMv("MV_CSLL",.F.,"CSL")
				cValor		:= "nValCslBx"
				cChaveImp	:= IIf(ABS(nValCslBx) > 0, cPrefNum+cParcCsl+"TX "+cForUniao+cLojUniao, "")
		EndCase	
	
		nValImp := &(cValor)
	
		If ABS(nValimp) > 0
			If MsSeek(xFilial("SE2")+cChaveImp)
				RecLock("__SE2")
				If lCancel
					If nValImp > 0 .and. E2_SALDO > 0
						E2_ACRESC -= nValImp
						E2_SDACRES -= nValImp
					Else
						E2_DECRESC -= ABS(nValImp)
						E2_SDDECRE -= ABS(nValImp)
					Endif
				Else	
					If nValImp > 0 .and. E2_SALDO > 0
						E2_ACRESC += nValImp
						E2_SDACRES += nValImp
					Else
						E2_DECRESC += ABS(nValImp)
						E2_SDDECRE += ABS(nValImp)
					Endif
				Endif
				If E2_ACRESC < 0
					E2_ACRESC := 0
				ENDIF
				If E2_DECRESC < 0
					E2_DECRESC := 0
				ENDIF
				If E2_SDACRES < 0
					E2_SDACRES := 0
				ENDIF
				If E2_SDDECRE < 0
					E2_SDDECRE := 0
				ENDIF
				MsUnlock()
			Endif
		Endif
	Next
	
	RestArea(aArea)
	dbGoto(nRegSE2)
Endif
Return .T.

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³F080TotMes³ Autor ³Mauricio Pequim Jr     ³ Data ³19/10/2004³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Verifica o total de notas do Fornecedor que vencem no mesmo ³±±
±±³          ³mes.                                                        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpD1 - Data de referencia                                  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function F080TotMes(dReferencia,lCalcRet,lCalcPA,lSE2) 

Local aAreaSE2  := SE2->( GetArea() ) 
Local aRecnos   := {}      
Local dDataIni  := FirstDay( dReferencia )   
Local dDataFim  := LastDay( dReferencia ) 
Local nVlMinImp := GetNewPar("MV_VL10925",5000)
Local nValorPg := 0
Local nValTit := 0
Local nVlrTit := 0
Local lSest := SE2->(FieldPos("E2_SEST"))	> 0  //Verifica campo de SEST
Local cModRetPIS := GetNewPar( "MV_RT10925", "1" ) 
Local lContrRet := !Empty( SE2->( FieldPos( "E2_VRETPIS" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE2->( FieldPos( "E2_VRETCSL" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETPIS" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_PRETCOF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETCSL" ) ) )
//Considero juros multa ou desconto na base do imposto.
// 1 = Considera valores juros multa ou desconto
// 2 = Nao considera valores juros multa ou desconto
Local lJurMulDes := (SuperGetMv("MV_IMPBAIX",.t.,"1") == "1")
Local lAltValor := STR(nValPgto,17,2) != STR(nOldValPgto,17,2)
//Controla o Pis Cofins e Csll na baixa
Local lPCCBaixa := SuperGetMv("MV_BX10925",.T.,"2") == "1"  .and. (!Empty( SE5->( FieldPos( "E5_VRETPIS" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_VRETCOF" ) ) ) .And. ; 
				 !Empty( SE5->( FieldPos( "E5_VRETCSL" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETPIS" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_PRETCOF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETCSL" ) ) ) .And. ;
				 !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .And. !Empty( SFQ->( FieldPos( "FQ_SEQDES"  ) ) ) )

Local nValOutImp := 0

Local cModTot   := GetNewPar( "MV_MT10925", "1" ) 

Local lBaseSE2 := SuperGetMv("MV_BS10925",.T.,"1") == "1"  .and. ;
						(	!Empty( SE1->( FieldPos( "E1_BASEPIS" ) ) ) .And.;
							!Empty( SE1->( FieldPos( "E1_BASECOF" ) ) ) .And. ; 
							!Empty( SE1->( FieldPos( "E1_BASECSL" ) ) ) .And. ; 
							!Empty( SE2->( FieldPos( "E2_BASEPIS" ) ) ) .And.;
							!Empty( SE2->( FieldPos( "E2_BASECOF" ) ) ) .And. ; 
							!Empty( SE2->( FieldPos( "E2_BASECSL" ) ) )	)

Local nProp := 1
Local nProp2 := 1
Local nBaseRet := 0  //Base de retencao
Local nSE2Reg := SE2->(RECNO())
Local lFa080PCC	:= ExistBlock("FA080PCC")

Local lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )

//1-Cria NCC/NDF referente a diferenca de impostos entre emitidos (SE2) e retidos (SE5)
//2-Nao Cria NCC/NDF, ou seja, controla a diferenca num proximo titulo
//3-Nao Controla
Local cNccRet  := SuperGetMv("MV_NCCRET",.F.,"1")

Local nVlMinIrf := 0

Local cChaveTit := SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA)

Local nX := 0 
Local lTodasFil := ExistBlock("MT103FRT")
Local aFil10925 := {}
Local cFilAtu	:= SM0->M0_CODFIL
Local aArea		:= GetArea()

Local aFor10925	:= {}
Local lVerForLj	:= ExistBlock("F080LOJA")
Local cQuery    := "" 	
Local nLoop		:= 0
Local aValorBx := {}
Local lPendPA  := .F.
Local lPaComp  := .F.
Local lAbatPA  := .F.                                          
Local lAltBxVal := .F.

// Considera baixas que geram ou nao movimento bancario.
// 1 = Somente os motivos que geram movimento bancario
// 2 = Considera todos os motivos de baixa.
Local lMotBxMBco  := (SuperGetMv("MV_MB10925",.t.,"2") == "1")
Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)

Local lAplVlMin := .T.

Local aDadosImp := Array(5)    
Local aTitBsImp := {}
Local lGravou := .F.

Local lLojaAtu  := ( GetNewPar( "MV_LJ10925", "1" ) == "1" )   
Local nTamTit  := TamSX3("E5_PREFIXO")[1]+TamSX3("E5_NUMERO")[1]+TamSX3("E5_PARCELA")[1]+TamSX3("E5_TIPO")[1]
Local lImp10925 := ExistBlock("FA080IMP")
Local lAchouPa  := .F.
Local lValPgto := SuperGetMv("MV_BP10925",.T.,"1") == "2" //1- Valor bruto da baixa parcial / 2- Valor da baixa parcial menos os impostos
Local nValProp := 0
Local nTotAdto := 0		
Local lBaixaAbat := .F.
Local lBxCec := .F.
Local lNotBax := .F.
Local nTotImpost := 0
Local lAglImp := .F.
Local aBaixa := {}
Local nY
Local cChaveBx := ""

#IFDEF TOP
	Local aStruct   := {} 
	Local aCampos   := {} 
	Local cAliasQry := ""  
	Local cSepNeg   := If("|"$MV_CPNEG,"|",",")
	Local cSepProv  := If("|"$MVPROVIS,"|",",") 
	Local cAliasSE2 := ""
#ELSE
	Local cIndexSE5
	Local nIndexSe5
#ENDIF 
               
aFill(aDadosImp,0)

PRIVATE aBaixaSE5 := {}

Default lCalcRet := .F.
Default lCalcPA  := .F.
Default lSE2  := .T.   //Variavel para controle do uso do alias alternativo __SE2 para alguns posicionamentos.

nIss     := If(Type("nIss") != "N",0,nIss)
nValComp := If(Type("nValComp") != "N",0,nValComp)

//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
//³ POR MAIS ESTRANHO QUE PARE€A, ESTA FUNCAO DEVE SER CHAMADA AQUI! ³
//³                                                                  ³
//³ A fun‡„o SomaAbat reabre o SE2 com outro nome pela ChkFile para  ³
//³ efeito de performance. Se o alias auxiliar para a SumAbat() n„o  ³
//³ estiver aberto antes da IndRegua, ocorre Erro de & na ChkFile,   ³
//³ pois o Filtro do SE2 uptrapassa 255 Caracteres.                  ³
//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
SomaAbat("","","","P")

//Verificar ou nao o limite de 5000 para Pis cofins Csll
// 1 = Verifica o valor minimo de retencao
// 2 = Nao verifica o valor minimo de retencao
If !Empty( SE2->( FieldPos( "E2_APLVLMN" ) ) ) .and. SE2->E2_APLVLMN == "2"
	lAplVlMin := .F.
Endif	  

nDiferImp := 0

//Garanto o tamanho dos arrays de retencao
If Len(aDadosRef) < 7
	aDadosRef := Array(7)
	AFill( aDadosRef, 0 ) 
Endif
If Len(adadosRet) < 7
	aDadosRet := Array(7)
	AFill( aDadosRet, 0 ) 
Endif	        
aValorBx := Array(3)
AFill( aValorBx, 0 ) 

If !lPccBaixa
	Return .T.
Endif

//Titulo ja teve retencao na emissao
If !lCalcPA .And. (!(SE2->E2_PRETPIS $ "1#3") .OR. !(SE2->E2_PRETCOF $ "1#3") .OR. !(SE2->E2_PRETCSL $ "1#3"))
	Return .T.
Endif

// Verificar se eh PA para não gerar recalculo de impostos.
If !lCalcPA .And. (SE2->E2_TIPO $ MVPAGANT)
	Return .T.
Endif
        
// Faz verificacao das baixas do titulo.
// Consiste se o motivo gera ou nao movimento bancario.
If lMotBxMBco .And. !lCalcPA .And. !Fa080MovBc() 
	nValPgto += nPis+nCofins+nCsll+nIrrf+nIss
	nOldValPgto := nValPgto
	nPis := 0
	nCofins := 0
	nCsll := 0
	nIrrf := 0
	Return .T.	
Endif

//Se a validação nao partiu do campo de valor
If !lAltValor .and. ( Type('lF080Auto') =='U' .or. ! lF080Auto)
	nValPgto += nPis+nCofins+nCsll+nIrrf+nIss
Endif

If lCalcRet

	//Verifico todas as filiais apenas quando SA2 compartilhado
	If lTodasFil
		aFil10925 := ExecBlock( "MT103FRT", .F., .F. ) 
	Else
		aFil10925 := { cFilant }
	Endif

	If lVerForLj
		aFor10925 := ExecBlock("F080LOJA",.F.,.F.)
	Endif
	
	AFill( aDadosRef, 0 ) 
	AFill( aDadosRet, 0 ) 

	For nX := 1 to Len(aFil10925)
	
		dbSelectArea("SE5")
		cFilAnt := aFil10925[nX]
		
		#IFDEF TOP 
		        
			If lIrfMP232
				aCampos := { "E5_VALOR","E5_VRETPIS","E5_VRETCOF","E5_VRETCSL","E5_VLJUROS","E5_VLMULTA","E5_VLDESCO","E5_VRETIRF"} 
	   	Else
				aCampos := { "E5_VALOR","E5_VRETPIS","E5_VRETCOF","E5_VRETCSL","E5_VLJUROS","E5_VLMULTA","E5_VLDESCO"}    	
			Endif

			If lCalcIssBx
				aadd(aCampos,"E5_VRETISS")
			Endif				
			
			aStruct := SE5->( dbStruct() ) 	
		
			SE5->( dbCommit() ) 
		   
		  	cAliasQry := GetNextAlias()
		
			cQuery := "SELECT E5_PREFIXO,E5_NUMERO,E5_PARCELA,E5_TIPO,E5_CLIFOR,E5_LOJA,"
			cQuery += "E5_SEQ,E5_VALOR,E5_VRETPIS,E5_VRETCOF,E5_VRETCSL,E5_DATA,E5_VLJUROS,"
			cQuery += "E5_VLMULTA,E5_VLDESCO,E5_PRETPIS,E5_PRETCOF,E5_PRETCSL,E5_MOTBX,"
			cQuery += "E5_DOCUMEN,E5_FORNADT,E5_LOJAADT,E5_RECPAG,"
	
			If lIrfMP232
				cQuery += "E5_VRETIRF,E5_PRETIRF,"
			Endif
	
			If lCalcIssBx
				cQuery += "E5_VRETISS,"
			Endif

			cQuery += "R_E_C_N_O_ RECNO FROM "
			cQuery += RetSqlName( "SE5" ) + " SE5 " 
			cQuery += "WHERE " 
			cQuery += "E5_FILIAL='"    + xFilial("SE5")       + "' AND " 		

			If Len(aFor10925) > 0  //Verificar determinados fornecedores (raiz do CNPJ)
				cQuery += "( " 	
				For nLoop := 1 to Len(aFor10925) 
					cQuery += "(E5_CLIFOR ='"   + aFor10925[nLoop,1]  + "' AND " 	
					cQuery += "E5_LOJA='"       + aFor10925[nLoop,2]  + "') OR "
				Next			
				//Retiro o ultimo OR
				cQuery := Left( cQuery, Len( cQuery ) - 4 ) 
				cQuery += ") AND " 	
			Else  //Apenas o Fornecedor Atual
				If !lCalcPA
					cQuery += "E5_CLIFOR='"		+ SE2->E2_FORNECE			+ "' AND " 	
					If lLojaAtu  //Considero apenas a loja atual
						cQuery += "E5_LOJA='"		+ SE2->E2_LOJA				+ "' AND "
					EndIf
				Else                                                            
					cQuery += "E5_CLIFOR='"		+ M->E2_FORNECE			+ "' AND " 	
					If lLojaAtu  //Considero apenas a loja atual					
						cQuery += "E5_LOJA='"		+ M->E2_LOJA				+ "' AND "
					EndIf
				Endif
			Endif
			
			cQuery += "E5_DATA>= '"		+ DToS( dDataIni )      + "' AND "		
			cQuery += "E5_DATA<= '"		+ DToS( dDataFim )      + "' AND " 
			cQuery += "E5_TIPO NOT IN " + FormatIn(MVABATIM,"|") + " AND "
			cQuery += "E5_TIPO NOT IN " + FormatIn(MV_CPNEG,cSepNeg)  + " AND "
			cQuery += "E5_TIPO NOT IN " + FormatIn(MVPROVIS,cSepProv) + " AND "
			cQuery += "E5_MOTBX <> 'FAT' AND "	
			cQuery += "E5_SITUACA <> 'C' AND "	
	
			//Apenas titulos que tem retencao de PIS,Cofins e CSLL
			If cModTot == "2"
				If lIrfMP232
					cQuery += " ((E5_VRETPIS > 0 OR E5_VRETCOF > 0 OR E5_VRETCSL > 0 OR E5_VRETIRF > 0) .OR. "
					cQuery += " (E5_MOTBX = 'CMP')) AND "
				Else
					cQuery += " ((E5_VRETPIS > 0 OR E5_VRETCOF > 0 OR E5_VRETCSL > 0) OR (E5_MOTBX = 'CMP')) AND "
				Endif
	   	Endif
			
			cQuery += "D_E_L_E_T_=' '"                                             
			cQuery += "AND NOT EXISTS ( "
			cQuery += "SELECT A.E5_NUMERO "
			cQuery += "FROM "+RetSqlName("SE5")+" A "
			cQuery += "WHERE A.E5_FILIAL='"+xFilial("SE5")+"' AND "
			cQuery +=		"A.E5_PREFIXO=SE5.E5_PREFIXO AND "
			cQuery +=		"A.E5_NUMERO=SE5.E5_NUMERO AND "
			cQuery +=		"A.E5_PARCELA=SE5.E5_PARCELA AND "
			cQuery +=		"A.E5_TIPO=SE5.E5_TIPO AND "
			cQuery +=		"A.E5_CLIFOR=SE5.E5_CLIFOR AND "
			cQuery +=		"A.E5_LOJA=SE5.E5_LOJA AND "
			cQuery +=		"A.E5_SEQ=SE5.E5_SEQ AND "
			cQuery +=		"A.E5_TIPODOC='ES' AND "
			cQuery +=		"A.E5_RECPAG<>'P' AND "
			cQuery +=		"A.D_E_L_E_T_<>'*')"
			
			cQuery := ChangeQuery( cQuery ) 
			
			dbUseArea( .T., "TOPCONN", TcGenQry(,,cQuery), cAliasQry, .F., .T. )
			
			For nLoop := 1 To Len( aStruct ) 
				If !Empty( AScan( aCampos, AllTrim( aStruct[nLoop,1] ) ) ) 
					TcSetField( cAliasQry, aStruct[nLoop,1], aStruct[nLoop,2],aStruct[nLoop,3],aStruct[nLoop,4])
				EndIf 			
			Next
			
			While !( cAliasQRY )->( Eof()) 

				// Consiste se o motivo gera ou nao movimento bancario.
				If lMotBxMBco              
					If !Fa080MovBc((cAliasQRY)->E5_MOTBX)
						(cAliasQRY)->(DbSkip())
						Loop
					Endif
				Endif
				
				nProp := 1			
				nProp2 := 1
				If ( cAliasQRY )->E5_VRETPIS + ( cAliasQRY )->E5_VRETCOF + ( cAliasQRY )->E5_VRETCSL + IF(lIrfMP232, ( cAliasQRY )->E5_VRETIRF , 0 ) > 0
					If lSE2
						cAliasSE2 := "SE2"
					Else
						cAliasSE2 := "__SE2"					
					Endif					
					(cAliasSE2)->(dbSetOrder(1))
					(cAliasSE2)->(MsSeek(xFilial("SE2")+(cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)))
               
					//Se for PA, verifica se houve baixa parcial para carregar varivael
					//nProp2 com o percentual proporcional para recalcular os impostos.
					If (cAliasSE2)->E2_TIPO $ MVPAGANT
						If (cAliasSE2)->E2_VALOR - (cAliasSE2)->E2_SALDO > 0
							nProp2 := (((cAliasSE2)->E2_VALOR - (cAliasSE2)->E2_SALDO) / (cAliasSE2)->E2_VALOR)
						Endif
					Endif
      			
					If lIrfMP232
						nVlrTit := (cAliasSE2)->(E2_VALOR+E2_ISS+E2_INSS)
					Else
						nVlrTit := (cAliasSE2)->(E2_VALOR+E2_IRRF+E2_ISS+E2_INSS)
					Endif

					If lSest
						nVlrTit += (cAliasSE2)->E2_SEST
					Endif					

					If lCalcIssBx
						nVlrTit -= (cAliasSE2)->E2_ISS
					Endif

					If !Empty((cAliasSE2)->E2_BASEPIS)
						nProp := (cAliasSE2)->E2_BASEPIS / nVlrTit
					Else
						nValProp := (cAliasQRY)->(E5_VALOR+E5_VLDESCO-E5_VLJUROS-E5_VLMULTA)
						If Empty( ( cAliasQRY )->E5_PRETPIS ) .Or. Empty( ( cAliasQRY )->E5_PRETCOF ) .Or. Empty( ( cAliasQRY )->E5_PRETCSL )
							nValProp += (cAliasQRY)->(E5_VRETPIS+E5_VRETCOF+E5_VRETCSL)
						EndIf						
						nProp := nValProp /(cAliasSE2)->E2_VALOR
					Endif
					//Incrementa a base de calculo para gerar os titulos se nao for
					//compensação entre carteiras e baixa de impostos via bordero
					If !(cAliasQRY)->E5_MOTBX $ "PCC#CEC"
						nVlrTit := nVlrTit * nProp
						aDadosRef[1] += nVlrTit * nProp2					
					EndIf
				Else				
					If !(cAliasQRY)->E5_MOTBX $ "PCC#CEC"
						aDadosRef[1] += (cAliasQRY)->(E5_VALOR+E5_VLDESCO-E5_VLJUROS-E5_VLMULTA)					
					EndIf
				Endif

				//Incrementa a base de calculo para gerar os titulos          
				If (cAliasQRY)->E5_MOTBX == "PCC" 
					aDadosRef[1] += nVlrTit - (cAliasQRY)->(E5_VRETPIS+E5_VRETCOF+E5_VRETCSL) 
				EndIf
				
				//Guardo os valores compensados entre carteiras para recompor a base de calculo
				If (cAliasQRY)->E5_MOTBX == "CEC" .And. (cAliasQRY)->E5_RECPAG == "P" .And.;
					(cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) == cChaveTit
					nValComp += (cAliasQRY)->E5_VALOR
				EndIf
				
				//Recalcula o valor do titulo principal para adicionar no campo
				// com os valores de titulos retidos
				If AliasIndic("SFQ")
					aAreaQry := GetArea()
					SFQ->(dbSetOrder(1))
					cChaveSE5 := (cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)
					If SFQ->(MsSeek(xFilial("SFQ")+cAliasSE2+cChaveSE5))
						While SFQ->(!Eof()) .and. SFQ->FQ_FILIAL == xFilial("SFQ") .And.;
								SFQ->(FQ_PREFORI+FQ_NUMORI+FQ_PARCORI+FQ_TIPOORI+FQ_CFORI+FQ_LOJAORI) == cChaveSE5
							cChaveSFQ := SFQ->(FQ_PREFDES+FQ_NUMDES+FQ_PARCDES+FQ_TIPODES+FQ_CFDES+FQ_LOJADES)
							(cAliasSE2)->(dbSetOrder(1))
							If (cAliasSE2)->(MsSeek(xFilial(cAliasSE2)+cChaveSFQ))
								aDadosRef[1] += (cAliasSE2)->E2_VALOR 
							EndIf							
							SFQ->(dbSkip())        	
						EndDo
					EndIf							
					RestArea(aAreaQry)
				EndIf
				
				If (cAliasQRY)->E5_MOTBX == "CMP" .OR. ( cAliasQRY )->E5_VRETPIS + ( cAliasQRY )->E5_VRETCOF + ( cAliasQRY )->E5_VRETCSL + IF(lIrfMP232, ( cAliasQRY )->E5_VRETIRF , 0 ) > 0

					If lSE2
						cAliasSE2 := "SE2"
					Else
						cAliasSE2 := "__SE2"
					Endif					

					(cAliasSE2)->(dbSetOrder(1))
					(cAliasSE2)->(MsSeek(xFilial("SE2")+(cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)))
				
					If (Ascan(aTitBsImp,{|x| x == (cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ)})) = 0
						
						If (cAliasQRY)->E5_MOTBX != "PCC"
							//Armazeno os valores calculados por titulo.
							If (cAliasSE2)->E2_PIS > 0 .aND. !(cAliasQRY)->E5_TIPO $ MVPAGANT
								aDadosImp[1] += (cAliasSE2)->E2_PIS * nProp
								lGravou := .T.
							EndIf	
				
							If (cAliasSE2)->E2_COFINS > 0 .aND. !(cAliasQRY)->E5_TIPO $ MVPAGANT 
								aDadosImp[2] += (cAliasSE2)->E2_COFINS * nProp
								lGravou := .T.							
							EndIf	
			
							If (cAliasSE2)->E2_CSLL > 0 .aND. !(cAliasQRY)->E5_TIPO $ MVPAGANT
								aDadosImp[3] += (cAliasSE2)->E2_CSLL * nProp
								lGravou := .T.							
							EndIf	
						EndIf
						
						//Somo valores dos impostos de IRRF/ISS/INSS dos titulos que foram compensados
						//por PA que não reteve impostos, para recompor a base de calculo
						If (cAliasSE2)->(E2_IRRF+E2_ISS+E2_INSS) > 0 .AND. !(cAliasQRY)->E5_TIPO $ MVPAGANT .And.;
							(cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) != cChaveTit
							aAreaSE5 := (cAliasQRY)->(GetArea())
							dbSelectArea("SE5")
							dbSetOrder(7)
							If MsSeek(xFilial("SE5")+SUBSTR((cAliasQRY)->E5_DOCUMEN,1,nTamTit)+(cAliasQRY)->E5_FORNADT+;
								(cAliasQRY)->E5_LOJAADT)
								If	SE5->E5_PRETPIS == "1" .Or. SE5->E5_PRETCOF == "1" .Or. SE5->E5_PRETCSL == "1" 
									aDadosImp[4] += (cAliasSE2)->(E2_IRRF+E2_ISS+E2_INSS)
									lGravou := .T.							
								EndIf
							EndIf
							RestArea(aAreaSE5)
						EndIf	
						
						//Somo valores dos impostos de IRRF/ISS/INSS dos titulos do tipo PA (Pagto Adiantado) 
						//que foram compensados, para recompor a base de calculo(nBaseImp) do PIS/COF/CSL
						If (cAliasSE2)->(E2_IRRF+E2_ISS+E2_INSS) > 0 .AND. (cAliasQRY)->E5_TIPO $ MVPAGANT .And.;
							SUBSTR((cAliasQRY)->E5_DOCUMEN,1,nTamTit)+(cAliasQRY)->(E5_FORNADT+E5_LOJAADT) == cChaveTit
							aAreaSE5 := (cAliasQRY)->(GetArea())
							dbSelectArea("SE5")
							dbSetOrder(7)
							If MsSeek(xFilial("SE5")+(cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA))
								If AliasIndic("SFQ")
									SFQ->(dbSetOrder(2))
									cChaveSE5 := SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)
									If SFQ->(MsSeek(xFilial("SFQ")+"SE5"+cChaveSE5))
										lAchouPa := .T.
									EndIf							
								EndIf
								If	(SE5->E5_PRETPIS $ "1# " .Or. SE5->E5_PRETCOF $ "1# " .Or. SE5->E5_PRETCSL $ "1# ") .And.;
									!lAchouPa									
									aDadosImp[5] += (cAliasSE2)->(E2_IRRF+E2_ISS+E2_INSS)
									lGravou := .T.							
									AAdd( aRecnos, ( cAliasQRY )->RECNO ) 
								EndIf
							EndIf
							RestArea(aAreaSE5)
						EndIf	
						
						If lGravou
							AADD(aTitBsImp,(cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))
							lGravou := .F.
						Endif		  
					Endif
				EndIf				
					
				nImpostos := 0						
	         
				If Empty( ( cAliasQRY )->E5_PRETPIS ) .Or. ( cAliasQRY )->E5_PRETPIS == '4'
					aDadosRef[1] += (cAliasQRY)->E5_VRETPIS * nProp2
					nImpostos += (cAliasQRY)->E5_VRETPIS * nProp2
					//Armazeno os valores calculados por titulo, retirando os valores retidos
					If ( cAliasQRY )->E5_VRETPIS + ( cAliasQRY )->E5_VRETCOF + ( cAliasQRY )->E5_VRETCSL + IF(lIrfMP232, ( cAliasQRY )->E5_VRETIRF , 0 ) > 0 .And.;
						(cAliasQRY)->E5_MOTBX != "PCC" .aND. !(cAliasQRY)->E5_TIPO $ MVPAGANT
						aDadosImp[1] -= (cAliasQRY)->E5_VRETPIS * nProp2
					Endif					
				EndIf 								
		
				If Empty( ( cAliasQRY )->E5_PRETCOF ) .Or. ( cAliasQRY )->E5_PRETCOF == '4'
					aDadosRef[1] += ( cAliasQRY )->E5_VRETCOF * nProp2
					nImpostos += (cAliasQRY)->E5_VRETCOF * nProp2
					//Armazeno os valores calculados por titulo, retirando os valores retidos
					If ( cAliasQRY )->E5_VRETPIS + ( cAliasQRY )->E5_VRETCOF + ( cAliasQRY )->E5_VRETCSL + IF(lIrfMP232, ( cAliasQRY )->E5_VRETIRF , 0 ) > 0 .And.;
						(cAliasQRY)->E5_MOTBX != "PCC" .aND. !(cAliasQRY)->E5_TIPO $ MVPAGANT
						aDadosImp[2] -= (cAliasQRY)->E5_VRETCOF * nProp2
					Endif					
				EndIf 								
		
				If Empty( ( cAliasQRY )->E5_PRETCSL ) .Or. ( cAliasQRY )->E5_PRETCSL == '4'
					aDadosRef[1] += ( cAliasQRY )->E5_VRETCSL * nProp2 
					nImpostos += (cAliasQRY)->E5_VRETCSL * nProp2
					//Armazeno os valores calculados por titulo, retirando os valores retidos
					If ( cAliasQRY )->E5_VRETPIS + ( cAliasQRY )->E5_VRETCOF + ( cAliasQRY )->E5_VRETCSL + IF(lIrfMP232, ( cAliasQRY )->E5_VRETIRF , 0 ) > 0 .And.;
						(cAliasQRY)->E5_MOTBX != "PCC" .aND. !(cAliasQRY)->E5_TIPO $ MVPAGANT
						aDadosImp[3] -= (cAliasQRY)->E5_VRETCSL * nProp2
					Endif					
				EndIf 								
				
				If lIrfMP232 .and. Empty( ( cAliasQRY )->E5_PRETIRF )
					aDadosRef[1] += ( cAliasQRY )->E5_VRETIRF
					nImpostos += (cAliasQRY)->E5_VRETIRF
				EndIf 								
	
				If lCalcIssBx
					aDadosRef[1] += SE5->E5_VRETISS
				Endif

	
				//Guardo o valor dos impostos descontados para que seja recomposta a base de calculo
				If (cAliasQRY)->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) == cChaveTit
					//Caso o sistema gravar como valor de pagamento na baixa parcial, o valor da baixa menos os impostos
					//calculados, não ha a necessidade de recompor a base de calculo
					If  !lValPgto
						aDadosRef[7] += nImpostos
					EndIf
				Endif
	
				If ( cAliasQRY )->E5_PRETPIS == "1" .Or. ( cAliasQry )->E5_PRETCOF == "1" .Or. ( cAliasQry )->E5_PRETCSL == "1" 
					
					If ( cAliasQRY )->E5_PRETPIS == "1"
						aDadosRef[2] += ( cAliasQRY )->E5_VRETPIS * nProp2
					EndIf	
		
					If ( cAliasQRY )->E5_PRETCOF == "1"
						aDadosRef[3] += ( cAliasQRY )->E5_VRETCOF * nProp2 
					EndIf	
							
					If ( cAliasQRY )->E5_PRETCSL == "1"
						aDadosRef[4] += ( cAliasQRY )->E5_VRETCSL * nProp2        
					EndIf 	
	
					If lIrfMP232 .and. ( cAliasQRY )->E5_PRETIRF == "1"
						aDadosRef[5] += ( cAliasQRY )->E5_VRETIRF       
					EndIf 	                                

					// Caso exista titulo de PA com pendencia de 
					// retencao, marco o flag para ser usado na baixa.					
					If (cAliasQRY)->E5_TIPO $ MVPAGANT
						lPendPA := .T.
					Endif					
					
					AAdd( aRecnos, ( cAliasQRY )->RECNO ) 
			
				// Acumula os valores das baixas realizadas parcialmente
				// para ser utilizada na analise de possiveis problemas 
				// de arredondamento que ocorrem na baixa total.
				ElseIf  Empty((cAliasQRY)->E5_PRETPIS) .Or. Empty((cAliasQry)->E5_PRETCOF) .Or. Empty((cAliasQry)->E5_PRETCSL)

					If Empty((cAliasQRY)->E5_PRETPIS)
						aValorBx[1] += ( cAliasQRY )->E5_VRETPIS
					EndIf	
		
					If Empty((cAliasQRY)->E5_PRETCOF)
						aValorBx[2] += ( cAliasQRY )->E5_VRETCOF
					EndIf	
							
					If Empty((cAliasQRY)->E5_PRETCSL)
						aValorBx[3] += ( cAliasQRY )->E5_VRETCSL
					EndIf 	
	
				Endif
                 
				// Caso exista uma CMP envolvendo um PA, marco flag para uso
				//	no momento da baixa para compor o valor a ser baixado.
				If (cAliasQRY)->E5_MOTBX = "CMP"
					lPaComp := .T.               
				Endif
			
				( cAliasQRY )->( dbSkip()) 
				
		   EndDo 
		   
			// Fecha a area de trabalho da query 
		   ( cAliasQRY )->( dbCloseArea() ) 
		   dbSelectArea( "SE2" ) 
		
		#ELSE 
		
			ChkFile("SE5",.F.,"NEWSE5")
			cIndexSE5 := CriaTrab(,.f.)
				
			cQuery := "E5_FILIAL='"      + xFilial( "SE5" )     + "' .AND. "
			If Len(aFor10925) > 0  //Verificar determinados fornecedores (raiz do CNPJ)
				cQuery += "( " 	
				For nLoop := 1 to Len(aFor10925) 
					cQuery += "(E5_CLIFOR ='"   + aFor10925[nLoop,1]  + "' .AND. " 	
					cQuery += "E5_LOJA='"       + aFor10925[nLoop,2]  + "') .OR."
				Next			
				cQuery := Left( cQuery, Len( cQuery ) - 5 ) 
				cQuery += ") .AND. " 	
			Else  //Apenas Fornecedor atual
				If !lCalcPA
					cQuery += "E5_CLIFOR='"     + SE2->E2_FORNECE        + "' .AND. " 	
					If lLojaAtu  //Considero apenas a loja atual
						cQuery += "E5_LOJA='"        + SE2->E2_LOJA           + "' .AND. "
					EndIf
				Else
					cQuery += "E5_CLIFOR='"     + M->E2_FORNECE        + "' .AND. " 	
					If lLojaAtu  //Considero apenas a loja atual
						cQuery += "E5_LOJA='"        + M->E2_LOJA           + "' .AND. "			
					EndIf
				Endif
			Endif
			cQuery += "DTOS(E5_DATA)>='" + DToS( dDataIni ) + "' .AND. "		
			cQuery += "DTOS(E5_DATA)<='" + DToS( dDataFim ) + "' .AND. "
			cQuery += "E5_MOTBX <> 'FAT' .AND. "	
			cQuery += "E5_SITUACA <> 'C' .AND. "	
			//Apenas titulos que tem retencao de PIS,Cofins e CSLL
			If cModTot == "2"
				If lIrfMP232
					cQuery += " ((E5_VRETPIS > 0 .OR. E5_VRETCOF > 0 .OR. E5_VRETCSL > 0 .OR. E5_VRETIRF > 0  ) .OR. "
					cQuery += " (E5_MOTBX = 'CMP')) .AND. "				
				Else
					cQuery += " ((E5_VRETPIS > 0 .OR. E5_VRETCOF > 0 .OR. E5_VRETCSL > 0 ) .OR. (E5_MOTBX = 'CMP')) .AND. "			
				Endif
	   	Endif
                    
			cQuery += "!(E5_TIPO $ '"+MVABATIM + "/" + MV_CPNEG + "/" + MVPROVIS + "')"
			
			IndRegua("SE5",cIndexSE5,"DTOS(E5_DATA)",, cQuery ,"")
			nIndexSE5 :=RetIndex("SE5")+1
			dbSetIndex(cIndexSE5+OrdBagExt())
			dbSetorder(nIndexSe5)
			SE5->( dbSetOrder( nIndexSE5 ) )
			SE5->( dbSeek( DTOS( dDataIni ), .T. ) ) 
			
			While !SE5->( Eof() ) .And. SE5->E5_DATA >= dDataIni .And. SE5->E5_DATA <= dDataFim 
								
				//Verifica se tem baixa cancelada
				If TemBxCanc(SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))
					SE5->( dbskip())
					loop
				EndIf
				
				// Consiste se o motivo gera ou nao movimento bancario.
				If lMotBxMBco              
					If !Fa080MovBc(SE5->E5_MOTBX)
						SE5->(DbSkip())
						Loop
					Endif
				Endif
	
				nProp := 1			
				nProp2 := 1			
				If lBaseSE2 .and. SE5->(E5_VRETPIS + E5_VRETCOF + E5_VRETCSL)+ If(lIrfMP232,SE5->E5_VRETIRF,0) > 0
					SE2->(dbSetOrder(1))
					SE2->(MsSeek(xFilial("SE2")+SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)))

					//Se for PA, verifica se houve baixa parcial para carregar varivael
					//nProp2 com o percentual proporcional para recalcular os impostos.
					If SE2->E2_TIPO $ MVPAGANT
						If SE2->E2_VALOR - SE2->E2_SALDO > 0
							nProp2 := ((SE2->E2_VALOR - SE2->E2_SALDO) / SE2->E2_VALOR)
						Endif
					Endif

					If lIrfMP232
						nVlrTit := SE2->(E2_VALOR+E2_ISS+E2_INSS)
					Else
						nVlrTit := SE2->(E2_VALOR+E2_IRRF+E2_ISS+E2_INSS)
					Endif

					If lSest
						nVlrTit += SE2->E2_SEST
					Endif					

					If !Empty(SE2->E2_BASEPIS)
						nProp := SE2->E2_BASEPIS / nVlrTit
					Else
						nValProp := SE5->(E5_VALOR+E5_VLDESCO-E5_VLJUROS-E5_VLMULTA)
						If Empty( SE5->E5_PRETPIS ) .Or. Empty( SE5->E5_PRETCOF ) .Or. Empty( SE5->E5_PRETCSL )
							nValProp += SE5->(E5_VRETPIS+E5_VRETCOF+E5_VRETCSL)
						EndIf
						nProp := nValProp /SE2->E2_VALOR
					Endif
					//Incrementa a base de calculo para gerar os titulos se nao for
					//compensação entre carteiras e baixa de impostos via bordero
					If !SE5->E5_MOTBX $ "PCC#CEC"
						nVlrTit := nVlrTit * nProp
						aDadosRef[1] += nVlrTit * nProp2					
					EndIf
				Else				                                                     
					If !SE5->E5_MOTBX $ "PCC#CEC"
						aDadosRef[1] += SE5->(E5_VALOR+E5_VLDESCO-E5_VLJUROS-E5_VLMULTA)
					EndIf
				Endif

				//Incrementa a base de calculo para gerar os titulos          
				If SE5->E5_MOTBX == "PCC" 
					aDadosRef[1] += nVlrTit - SE5->(E5_VRETPIS+E5_VRETCOF+E5_VRETCSL) 
				EndIf
				
				//Guardo os valores compensados entre carteiras para recompor a base de calculo
				If SE5->E5_MOTBX == "CEC" .And. SE5->E5_RECPAG == "P" .And.;
					SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) == cChaveTit
					nValComp += SE5->E5_VALOR
				EndIf

				//Recalcula o valor do titulo principal para adicionar no campo
				// com os valores de titulos retidos
				If AliasIndic("SFQ")
					aAreaQry := GetArea()
					SFQ->(dbSetOrder(1))
					cChaveSE5 := SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)
					If SFQ->(MsSeek(xFilial("SFQ")+"SE2"+cChaveSE5))
						While SFQ->(!Eof()) .and. SFQ->FQ_FILIAL == xFilial("SFQ") .And.;
								SFQ->(FQ_PREFORI+FQ_NUMORI+FQ_PARCORI+FQ_TIPOORI+FQ_CFORI+FQ_LOJAORI) == cChaveSE5
							cChaveSFQ := SFQ->(FQ_PREFDES+FQ_NUMDES+FQ_PARCDES+FQ_TIPODES+FQ_CFDES+FQ_LOJADES)
							SE2->(dbSetOrder(1))
							If SE2->(MsSeek(xFilial("SE2")+cChaveSFQ))
								aDadosRef[1] += SE2->E2_VALOR 
							EndIf							
							SFQ->(dbSkip())        	
						EndDo
					EndIf							
					RestArea(aAreaQry)
				EndIf

				If SE5->E5_MOTBX == "CMP" .OR. SE5->(E5_VRETPIS + E5_VRETCOF + E5_VRETCSL)+ If(lIrfMP232,SE5->E5_VRETIRF,0) > 0
					
					SE2->(dbSetOrder(1))
					SE2->(MsSeek(xFilial("SE2")+SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)))
               
					If (Ascan(aTitBsImp,{|x| x == SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ)})) = 0
						
						If SE5->E5_MOTBX != "PCC"
							//Armazeno os valores calculados por titulo.
							If SE2->E2_PIS > 0 .And. !SE5->E5_TIPO $ MVPAGANT  
								aDadosImp[1] += SE2->E2_PIS * nProp
								lGravou := .T.
							EndIf	
				
							If SE2->E2_COFINS > 0 .And. !SE5->E5_TIPO $ MVPAGANT  
								aDadosImp[2] += SE2->E2_COFINS * nProp
								lGravou := .T.							
							EndIf	
		
							If SE2->E2_CSLL > 0 .And. !SE5->E5_TIPO $ MVPAGANT  
								aDadosImp[3] += SE2->E2_CSLL * nProp
								lGravou := .T.							
							EndIf
						EndIf	       
						
						//Somo valores dos impostos de IRRF/ISS/INSS dos titulos que foram compensados
						//por PA que não reteve impostos, para recompor a base de calculo
						If SE2->(E2_IRRF+E2_ISS+E2_INSS) > 0 .AND. !SE5->E5_TIPO $ MVPAGANT .And.;
							SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)!= cChaveTit
							aAreaSE5 := SE5->(GetArea())                                 
							//Seleciono SE5 sem Indregua (NEWSE5)
							dbSelectArea("NEWSE5")
							dbSetOrder(7)
							If MsSeek(xFilial("SE5")+SUBSTR(SE5->E5_DOCUMEN,1,nTamTit)+SE5->E5_FORNADT+SE5->E5_LOJAADT)							  
								If	NEWSE5->E5_PRETPIS == "1" .Or. NEWSE5->E5_PRETCOF == "1" .Or. NEWSE5->E5_PRETCSL == "1" 
									aDadosImp[4] += SE2->(E2_IRRF+E2_ISS+E2_INSS)
									lGravou := .T.							
								EndIf
							EndIf                    
							RestArea(aAreaSE5)
						EndIf							
						
						//Somo valores dos impostos de IRRF/ISS/INSS dos titulos do tipo PA (Pagto Adiantado) 
						//que foram compensados, para recompor a base de calculo(nBaseImp) do PIS/COF/CSL
						If SE2->(E2_IRRF+E2_ISS+E2_INSS) > 0 .AND. SE5->E5_TIPO $ MVPAGANT .And.;
							SUBSTR(SE5->E5_DOCUMEN,1,nTamTit)+SE5->(E5_FORNADT+E5_LOJAADT) == cChaveTit							  
							aAreaSE5 := SE5->(GetArea())
							//Seleciono SE5 sem Indregua (NEWSE5)
							dbSelectArea("NEWSE5")
							dbSetOrder(7)
							If MsSeek(xFilial("SE5")+SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA))
								If AliasIndic("SFQ")
									SFQ->(dbSetOrder(2))
									cChaveSE5 := NEWSE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA)
									If SFQ->(MsSeek(xFilial("SFQ")+"SE5"+cChaveSE5))
										lAchouPa := .T.
									EndIf							
								EndIf
								If	NEWSE5->E5_PRETPIS $ "1# " .Or. NEWSE5->E5_PRETCOF $ "1# " .Or. NEWSE5->E5_PRETCSL $ "1# " 
									aDadosImp[5] += SE2->(E2_IRRF+E2_ISS+E2_INSS)
									lGravou := .T.						
									AAdd( aRecnos, SE5->( RECNO() ) )	
								EndIf
							EndIf
							RestArea(aAreaSE5)
						EndIf							

						If lGravou
							AADD(aTitBsImp,SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA+E5_SEQ))
							lGravou := .F.
						Endif
					Endif				
				EndIf      
				
				nImpostos := 0  

				If Empty( SE5->E5_PRETPIS ) .Or. SE5->E5_PRETPIS == '4'
					aDadosRef[1] += SE5->E5_VRETPIS * nProp2                                
					nImpostos += SE5->E5_VRETPIS * nProp2                                   
					//Armazeno os valores calculados por titulo, retirando os valores retidos
					If SE5->(E5_VRETPIS + E5_VRETCOF + E5_VRETCSL)+ If(lIrfMP232,SE5->E5_VRETIRF,0) > 0 .And.;
						SE5->E5_MOTBX != "PCC" .And. !SE5->E5_TIPO $ MVPAGANT  
						aDadosImp[1] -= SE5->E5_VRETPIS * nProp2
					Endif
				EndIf 								
				If Empty( SE5->E5_PRETCOF ) .Or. SE5->E5_PRETCOF == '4'
					aDadosRef[1] += SE5->E5_VRETCOF * nProp2
					nImpostos += SE5->E5_VRETCOF * nProp2
					//Armazeno os valores calculados por titulo, retirando os valores retidos
					If SE5->(E5_VRETPIS + E5_VRETCOF + E5_VRETCSL)+ If(lIrfMP232,SE5->E5_VRETIRF,0) > 0 .And.;
						SE5->E5_MOTBX != "PCC" .And. !SE5->E5_TIPO $ MVPAGANT  					
						aDadosImp[2] -= SE5->E5_VRETCOF * nProp2
					Endif					
				EndIf 								
	
				If Empty( SE5->E5_PRETCSL ) .Or. SE5->E5_PRETCSL == '4'
					aDadosRef[1] += SE5->E5_VRETCSL * nProp2
					nImpostos += SE5->E5_VRETCSL * nProp2
					//Armazeno os valores calculados por titulo, retirando os valores retidos
					If SE5->(E5_VRETPIS + E5_VRETCOF + E5_VRETCSL)+ If(lIrfMP232,SE5->E5_VRETIRF,0) > 0 .And.;
						SE5->E5_MOTBX != "PCC" .And. !SE5->E5_TIPO $ MVPAGANT  
						aDadosImp[3] -= SE5->E5_VRETCSL * nProp2
					Endif					
				EndIf 								
	
				If lIrfMP232
					If Empty( SE5->E5_PRETIRF )
						aDadosRef[1] += SE5->E5_VRETIRF
						nImpostos += SE5->E5_VRETIRF
					Endif
				EndIf 								

				If lCalcIssBx
					aDadosRef[1] += SE5->E5_VRETISS
				Endif
	
				//Guardo o valor dos impostos descontados para que seja recomposta a base de calculo
				If SE5->(E5_PREFIXO+E5_NUMERO+E5_PARCELA+E5_TIPO+E5_CLIFOR+E5_LOJA) == cChaveTit
					//Caso o sistema gravar como valor de pagamento na baixa parcial, o valor da baixa menos os impostos
					//calculados, não ha a necessidade de recompor a base de calculo
					If  !lValPgto
						aDadosRef[7] += nImpostos
					EndIf
				Endif
	
				//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿	
				//³ Adiciona ao array apenas os titulos que calcularam retencao         ³  
				//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
						
				If	SE5->E5_PRETPIS == "1" .Or. SE5->E5_PRETCOF == "1" .Or. SE5->E5_PRETCSL == "1" 
					      
					If SE5->E5_PRETPIS == "1"
						aDadosRef[2] += SE5->E5_VRETPIS * nProp2
					EndIf	
	
					If SE5->E5_PRETCOF == "1"
						aDadosRef[3] += SE5->E5_VRETCOF * nProp2
					EndIf	
						
					If SE5->E5_PRETCSL == "1"
						aDadosRef[4] += SE5->E5_VRETCSL * nProp2       
					EndIf 	
					
					If lIrfMP232 .and. SE5->E5_PRETIRF == "1"
						aDadosRef[5] += SE5->E5_VRETIRF       
					EndIf 	
                     
					// Caso exista titulo de PA com pendencia de 
					// retencao, marco o flag para ser usado na baixa.					
					If SE5->E5_TIPO $ MVPAGANT
						lPendPA := .T.
					Endif					

					AAdd( aRecnos, SE5->( RECNO() ) )			

				// Acumula os valores das baixas realizadas parcialmente
				// para ser utilizada na analise de possiveis problemas 
				// de arredondamento que ocorrem na baixa total.
				ElseIf  Empty(SE5->E5_PRETPIS) .Or. Empty(SE5->E5_PRETCOF) .Or. Empty(SE5->E5_PRETCSL)

					If Empty(SE5->E5_PRETPIS)
						aValorBx[1] += SE5->E5_VRETPIS
					EndIf	
		
					If Empty(SE5->E5_PRETCOF)
						aValorBx[2] += SE5->E5_VRETCOF
					EndIf	
							
					If Empty(SE5->E5_PRETCSL)
						aValorBx[3] += SE5->E5_VRETCSL
					EndIf 	

				EndIf	

				// Caso exista uma CMP envolvendo um PA, marco flag para uso
				//	no momento da baixa para compor o valor a ser baixado.
				If SE5->E5_MOTBX = "CMP"
					lPaComp := .T.               
				Endif

				SE5->( dbSkip() ) 								
						 
			EndDo          
			NEWSE5->(dbCloseArea())			
			dbSelectArea("SE5")
			dbClearFil()
			RetIndex( "SE5" )
			If !Empty(cIndexSE5)
				FErase (cIndexSE5+OrdBagExt())
			Endif
			dbSetOrder(1)
				
		#ENDIF    

	Next	

	aDadosRef[ 6 ] := AClone( aRecnos )            

	// Caso exista algum PA com pendencia de retenção mesmo 
	// apos uma compensação (que ainda nao gerou os impostos), 
	// marcar flag para q seja verificado a diferenca baixada.
	If lPendPA .And. lPaComp
		lAbatPA := .T.
	Endif
Endif

cFilAnt := cFilAtu
RestArea(aArea)
aDadosRet := aClone(aDadosRef)

//Calculo do Pis, Cofins e Csll
If !lCalcPA //Se nao for inclusao de PA
	SE2->(dbGoto(nSE2Reg))
	SED->(dbSetOrder(1))
	SED->(MsSeek(xFilial("SED")+SE2->E2_NATUREZ))
	SA2->(dbSetOrder(1))
	SA2->(MsSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))
	
	//Se considera valores de multa juros desconto ou se a validação partiu do campo de valor
	If lJurMulDes .or. lAltValor 
		nBaseImp := nValPgto
	Else	
		nBaseImp := nValPgto+nDescont+nTotAbat-nJuros-nMulta-nAcresc+nDecresc
	Endif
	
	If lIrfMP232
		nValOutImp := SE2->(E2_INSS+E2_ISS)
	Else
		nValOutImp := SE2->(E2_IRRF+E2_INSS+E2_ISS)
	Endif
	
	If lSest
		nValOutImp += SE2->E2_SEST
	Endif
	
	If lCalcIssBx
		nValOutImp -= SE2->E2_ISS 
	Endif			

	//Verificação para diferenciar se for baixa parcial
	lAltBxVal := STR(SE2->E2_VALOR,17,2) != STR(SE2->E2_SALDO,17,2)

	If !lAltValor
		nBaseImp += nValOutImp + aDadosRet[7] + aDadosImp[4] - aDadosImp[5] + nValComp
	Endif
	
	//Caso o titulo possua o valor de base dos impostos preenchidos, considero
	//esse valor com base para calculo, desprezando o valor da nota fiscal
	If SE2->E2_BASEPIS > 0
		nValTit := SE2->E2_BASEPIS
		If !lAltValor
			nBaseImp := SE2->E2_BASEPIS
		EndIf
		//Procura pelas baixas deste titulo caso seja baixa parcial e esteja baixando em mes diferente
		If lAltBxVal .And. !lAltValor
			aBaixa := Sel080Baixa("VL /BA /CP /",SE2->E2_PREFIXO,SE2->E2_NUM,SE2->E2_PARCELA,SE2->E2_TIPO,@nTotAdto,@lBaixaAbat,SE2->E2_FORNECE,SE2->E2_LOJA,@lBxCec,.F.,@lNotBax,@nTotImpost,@lAglImp,.T.)	
			For nY := 1 to Len(aBaixaSE5)
				If !aBaixaSE5[nY][4] $ MVPAGANT
					nBaseImp -= (aBaixaSE5[nY][8] + If(lValPgto,aBaixaSE5[nY][15]+aBaixaSE5[nY][16]+aBaixaSE5[nY][17],0))
				EndIf
			Next
		EndIf
	Else
		nValTit := SE2->E2_VALOR + nValOutImp
	Endif 
		
	//Base diferenciada para calculo dos impostos
	nBaseRet := nBaseImp
	If lBaseSe2
		If SE2->E2_BASEPIS > 0
			nBaseRet := (SE2->E2_BASEPIS * nBaseImp) / nValTit
		Endif 
	Endif			

	//IRRF
	If lIrfMP232 .and. SE2->E2_IRRF > 0
		nIrrf := NoRound(( nBaseImp * SE2->E2_IRRF ) / nValTit ,2)
	EndIf

	//PIS
	If SE2->E2_PIS > 0 
		nPis := NoRound(( nBaseImp * SE2->E2_PIS ) / nValTit ,2)
		If !lAltBxVal .And. cNCCRet == "2" .And. aDadosImp[1] <> aDadosRet[2] .And. SE2->E2_SALDO > 0  
			nPis += aDadosImp[1]
			If nPis < 0
				nPis := 0
			EndIf
		EndIf
	EndIf

   // COFINS
	If SE2->E2_COFINS > 0  
		nCofins := NoRound(( nBaseImp * SE2->E2_COFINS ) / nValTit ,2)
		If !lAltBxVal .And. cNCCRet == "2" .And. aDadosImp[2] <> aDadosRet[3] .And. SE2->E2_SALDO > 0  
			nCofins += aDadosImp[2]
			If nCofins < 0
				nCofins := 0
			EndIf
		EndIf
	EndIf

	// CSLL
	If SE2->E2_CSLL > 0  
		nCsll := NoRound(( nBaseImp * SE2->E2_CSLL ) / nValTit ,2) 
		If !lAltBxVal .And. cNCCRet == "2" .And. aDadosImp[3] <> aDadosRet[4] .And. SE2->E2_SALDO > 0  
			nCsll += aDadosImp[3]
			If nCsll < 0
				nCsll := 0
			EndIf
		EndIf
	EndIf
Else
	SED->(dbSetOrder(1))
	SED->(MsSeek(xFilial("SED")+M->E2_NATUREZ))
	SA2->(dbSetOrder(1))
	SA2->(MsSeek(xFilial("SA2")+M->E2_FORNECE+M->E2_LOJA))

	//Se considera valores de multa juros desconto ou se a validação partiu do campo de valor
	If lJurMulDes .or. lAltValor 
		nBaseImp := nValPgto
	Else	
		nBaseImp := nValPgto+nDescont+nTotAbat-nJuros-nMulta-nAcresc+nDecresc
	Endif

	If lIrfMP232
		nValOutImp := M->(E2_INSS+E2_ISS)
	Else
		nValOutImp := M->(E2_IRRF+E2_INSS+E2_ISS)
	Endif
	
	If lSest
		nValOutImp += M->E2_SEST
	Endif

	If lCalcIssBx
		nValOutImp -= SE2->E2_ISS
	Endif			

	If !lCalcPA
		nValTit := M->E2_VALOR + nValOutImp
	Else
	   If M->E2_BASEPIS > 0
			nValTit := M->E2_BASEPIS + nValOutImp
		Else
			nValTit := M->E2_VALOR + nValOutImp			
		Endif
		If !M->E2_TIPO $ MVPAGANT		
			nBaseImp := nBaseImp - nValOutImp
		Endif
	Endif

	If !lAltValor
		nBaseImp += nValOutImp + aDadosRef[7]
	Endif
	
	//Verificação para diferenciar se for baixa parcial
	lAltBxVal := STR(SE2->E2_VALOR,17,2) != STR(SE2->E2_SALDO,17,2) 
	
	//Base diferenciada para calculo dos impostos
	nBaseRet := nBaseImp
	If lBaseSe2
		If M->E2_BASEPIS > 0
			nBaseRet := (M->E2_BASEPIS * nBaseImp) / nValTit
		Endif 
	Endif			

	//IRRF
	If lIrfMP232 .and. M->E2_IRRF > 0
		nIrrf := ( nBaseImp * M->E2_IRRF ) / nValTit
	EndIf

	//PIS
	If M->E2_PIS > 0
		nPis := ( nBaseImp * M->E2_PIS ) / nValTit
		If !lAltBxVal .And. cNCCRet == "2" .And. aDadosImp[1] <> aDadosRet[2] .And.	SE2->E2_SALDO > 0
			nPis += aDadosImp[1]
			If nPis < 0
				nPis := 0
			EndIf
		EndIf
	EndIf

   // COFINS
	If M->E2_COFINS > 0
		nCofins := ( nBaseImp * M->E2_COFINS ) / nValTit
		If !lAltBxVal .And. cNCCRet == "2" .And. aDadosImp[2] <> aDadosRet[3] .And. SE2->E2_SALDO > 0 
			nCofins += aDadosImp[2]                                                              
			If nCofins < 0
				nCofins := 0
			EndIf
		EndIf
	EndIf

	// CSLL
	If M->E2_CSLL > 0
		nCsll := ( nBaseImp * M->E2_CSLL ) / nValTit
		If !lAltBxVal .And. cNCCRet == "2" .And. aDadosImp[3] <> aDadosRet[4] .And. SE2->E2_SALDO > 0 
			nCsll += aDadosImp[3]
			If nCsll < 0
				nCsll := 0
			EndIf
		EndIf
	EndIf

Endif	

If lFa080PCC
	ExecBlock("FA080PCC",.F.,.F.,{nPis, nCofins, nCsll, nIrrf, nValTit})
Endif

//Verifico o valor a reter
If lContrRet
   //Nao retem Pis,Cofins,CSLL
	If cModRetPis == "3"  //Nao retem PIS
		nVlRetPis := nPis
		nVlRetCof := nCofins
		nVlRetCsl := nCsll
		nPis := 0
		nCofins := 0
		nCsll := 0
		If lIrfMP232
			nVlRetIrf := nIrrf
			nIrrf := 0
		Endif			
	Else
		//Calculo do Sistema
		IF cModRetPis == "1"
			If aDadosRet[1]+ (nBaseRet) <= nVlMinImp .and. lAplVlMin
				nVlRetPis := nPis
				nVlRetCof := nCofins
				nVlRetCsl := nCsll
				nPis := 0
				nCofins := 0
				nCsll := 0
			Endif			
			If lIrfMP232
				//Verifico o valor de retencao variando entre pessoa fisica
				// e juridica
				If SA2->A2_TIPO == "F"
					nVlMinIrf := MaTbIrfPF(nIrrf)[4]
				Else
					nVlMinIrf := nVlMinImp
				Endif
				
				If aDadosRet[1]+ (nBaseRet) <= nVlMinIrf
					nVlRetIrf := nIrrf
					nIrrf := 0
				Endif			
			Endif
		Endif

		If nPis+nCofins+nCsll+nIrrf > 0
			If nPis+nCofins+nCsll > 0
				nVlRetPis := nPis
				nVlRetCof := nCofins
				nVlRetCsl := nCsll
				nPis    := nVlRetPis + aDadosRet[2]
				nCofins := nVlRetCof + aDadosRet[3]
				nCsll   := nVlRetCsl + aDadosRet[4]
				// Caso não seja inclusão de PA
				If !lCalcPa                 
					// Se o valor a ser baixado for igual ao saldo, e se
					// existiu uma compensacao, cuido para que nao ocorra
					// problemas de arredondamento na baixa.
					If nValPgto == SE2->E2_SALDO .And. (aValorBx[1]+aValorBx[2]+aValorBx[3] > 0)
						If nPis <> SE2->E2_PIS .And. lAbatPA
							nPis := nPis + (SE2->E2_PIS - (nPis + aValorBx[1]))
						Endif								
						If nCofins <> SE2->E2_COFINS .And. lAbatPA
							nCofins := nCofins + (E2_COFINS - (nCofins + aValorBx[2]))
						Endif
						If nCsll <> SE2->E2_CSLL .And. lAbatPA
							nCsll := nCsll + (SE2->E2_CSLL - (nCsll + aValorBx[3]))
						Endif						                      
					Endif
				Endif
			Endif
			If lIrfMP232 .and. nIrrf > 0
				nVlRetIrf := nIrrf
				nIrrf := nVlRetIrf+ aDadosRet[5]
			Endif			
			nValorPg := nValPgto - nPis - nCofins - nCsll - nIrrf - nIss

			If nValorPg < 0
				nValorPg += nPis + nCofins + nCsll + nIrrf + nIss
			
				nTotARet := nPis + nCofins + nCsll + nIrrf + nIss
						
				nDiferImp := nValorPg - nTotARet
					
				If nDiferImp < 0                                                           
					nFatorRed := 1 - ( Abs( nDiferImp ) / nTotARet ) 
					nPis  := NoRound( nPis * nFatorRed, 2 ) 
					nCofins := NoRound( nCofins * nFatorRed, 2 )  						
					nIrrf	:= NoRound( nIrrf * nFatorRed, 2 )
					nCsll := nValorPg - ( nPis + nCofins + nIrrf )
				Endif		
			EndIf 
		Else
			//Natureza nao calculou Pis/Cofins/Csll
			aDadosRet[1] := 0
		Endif
	Endif
Endif	

SE2->( RestArea( aAreaSE2 ) ) 

//Ponto de entrada para manipular os valores de impostos(nPis, nCofins, nCsll)
If lImp10925
	ExecBlock("FA080IMP",.F.,.F.)
EndIf

If !lAltValor
	nValPgto -= nPis+nCofins+nCsll+nIrrf+nIss
Endif

nOldValPgto := nValPgto

Return .T.


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o	 ³FGerCredRt³Autor  ³ Mauricio Pequim Jr    ³ Data ³20.10.04  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Gera titulo de Credito para fornecedor no caso de retencao  ³±±
±±³			 ³seja menor do que zero         							        ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³FGerCredRt()                                                ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ ExpN1 = Valor do Titulo                                    ³±±
±±³			 ³ ExpN2 = Moeda do Titulo                                    ³±±
±±³			 ³ ExpC1 = Sequencia de baixa                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ Generico                                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FGerCredRt(nValtot,nMoeda,cSeq)
Local aArea      := GetArea()
Local cParcela   := ""
Local nTamParc   := 0
Local cPrefOri   := ""
Local cNumOri    := ""
Local cParcOri   := ""
Local cTipoOri   := ""
Local cCfOri     := ""
Local cLojaOri   := ""
Local cNatOri    := ""

DEFAULT nMoeda   := 1                     

If FindFunction("ALIASINDIC")
	If AliasIndic("SFQ") 

		cArqSA := "SA2"
		cArqSE := "SE2"
		
		cPrefOri   := SE2->E2_PREFIXO
		cNumOri    := SE2->E2_NUM
		cParcOri   := SE2->E2_PARCELA
		cTipoOri   := SE2->E2_TIPO
		cCfOri     := SE2->E2_FORNECE
		cLojaOri   := SE2->E2_LOJA
		cNatOri    := SE2->E2_NATUREZ
		
		DbSelectArea("SA2") 	 // Posiciona o arquivo de cliente/fornecedor
		dbSetOrder(1)
		DbSeek(cFilial+cCfOri+cLojaOri)
		
		dbSelectArea("SE2")
		dbSetOrder(1)
	
		cParcela := SE2->E2_PARCELA
		nTamParc := Len(SE2->E2_PARCELA)
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Busca a parcela de acordo com o titulo                                      ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
		While MSSeek(xFilial("SE2")+cPrefOri+cNumOri+cParcela+left(MV_CPNEG,3)+cCfOri+cLojaOri)
			cParcela := Soma1(cParcela,nTamParc)
		EndDo             
	
		RecLock(cArqSE,.T.)
		SE2->E2_NOMFOR  := SA2->A2_NREDUZ
		SE2->E2_EMIS1   := dDataBase
		SE2->E2_BAIXA   := CtoD("  /  /  ")
		SE2->E2_SALDO   := nValTot
		SE2->E2_FILIAL  := cFilial
		SE2->E2_PREFIXO := cPrefOri
		SE2->E2_NUM     := cNumOri
		SE2->E2_PARCELA := cParcela
		SE2->E2_NATUREZ := cNatOri
		SE2->E2_TIPO    := left(MV_CPNEG,3)
		SE2->E2_VALOR   := nValTot
		SE2->E2_EMISSAO := dDataBase
		SE2->E2_VALOR   := nValTot
		SE2->E2_VENCTO  := dDataBase
		SE2->E2_VENCREA := dDatabase
		SE2->E2_VENCORI := dDatabase
		SE2->E2_FORNECE := cCfOri
		SE2->E2_LOJA    := cLojaOri
		SE2->E2_NOMFOR  := SA2->A2_NREDUZ
		SE2->E2_MOEDA   := nMoeda
		SE2->E2_VLCRUZ  := Round(NoRound(xMoeda(SE2->E2_VALOR,nMoeda,1,SE2->E2_EMISSAO,3),3),2)
		SE2->E2_ORIGEM  := "MATA460"
		SE2->E2_LA      := "S"
		SE2->E2_SEQBX	 := cSeq		

		DbSelectArea( "SA2" )
		RecLock("SA2")
		SA2->A2_SALDUP  := A2_SALDUP - Round(NoRound(xMoeda(SE2->E2_VALOR,SE2->E2_MOEDA,1,SE2->E2_EMISSAO,3),3),2)
		SA2->A2_SALDUPM := A2_SALDUPM - Round(NoRound(xMoeda(SE2->E2_VALOR,SE2->E2_MOEDA,Val(GetMv("MV_MCUSTO")),SE2->E2_EMISSAO,3),3),2)
		
		If SA2->A2_SALDUPM > SA2->A2_MSALDO
			SA2->A2_MSALDO := SA2->A2_SALDUPM
		EndIf
	
		//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
		//³ Grava no arquivo de amarracao o titulo x NCC ou NDF                         ³
		//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
	
		dbSelectArea("SFQ")
		RecLock("SFQ",.T.)
		SFQ->FQ_FILIAL  := xFilial("SFQ")
		SFQ->FQ_ENTORI  := "SE5"
		SFQ->FQ_PREFORI := cPrefOri
		SFQ->FQ_NUMORI  := cNumOri
		SFQ->FQ_PARCORI := cParcOri
		SFQ->FQ_TIPOORI := cTipoOri										
		SFQ->FQ_CFORI   := cCfOri
		SFQ->FQ_LOJAORI := cLojaOri
		SFQ->FQ_SEQORI  := cSeq
			
		SFQ->FQ_ENTDES  := cArqSE
		SFQ->FQ_PREFDES := SE2->E2_PREFIXO
		SFQ->FQ_NUMDES  := SE2->E2_NUM
		SFQ->FQ_PARCDES := SE2->E2_PARCELA                             
		SFQ->FQ_TIPODES := SE2->E2_TIPO
		SFQ->FQ_CFDES   := SE2->E2_FORNECE
		SFQ->FQ_LOJADES := SE2->E2_LOJA
		SFQ->FQ_SEQDES  := ""

		//Grava a filial de destino caso o campo exista
		If !Empty( SFQ->( FieldPos( "FQ_FILDES" ) ) ) 
			SFQ->FQ_FILDES := SE2->E2_FILIAL 
		EndIf 											
		MsUnlock()
	Endif
Endif					
RestArea(aArea)
Return


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FImpDelTit³ Autor ³ Eduardo Riera         ³ Data ³11.08.2003 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³Funcao que traz os registros do titulo aglutinador           ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias do registro  do titulo principal                ³±±
±±³          ³       SE1                                                   ³±±
±±³          ³       SE2                                                   ³±±
±±³Parametros³ExpC2: Prefixo                                               ³±±
±±³Parametros³ExpC3: Numero                                                ³±±
±±³Parametros³ExpC4: Parcela                                               ³±±
±±³Parametros³ExpC5: Tipo                                                  ³±±
±±³Parametros³ExpC6: Cliente                                               ³±±
±±³Parametros³ExpC7: Loja                                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo trazer os registros relacionau-³±±
±±³          ³dos ao titulo aglutinador                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Geral                                                       ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FImpDelTit(cAlias,cPrefixo,cNumero,cParcela,cTipo,cCliFor,cLoja,cSeq)

Local aRecnos  := {}                              
Local aArea    := GetArea()
Local aAreaSE5 := SE5->(GetArea())
Local lMultFil:= .F. 


#IFDEF TOP
	Local lQuery    := .F.
	Local cQuery    := ""     
	Local cAliasSFQ := ""
	Local lAddRec := .T.
#ENDIF	

If FindFunction("ALIASINDIC") 

	If AliasIndic("SFQ")

		lMultFil:= !Empty(SFQ->(FieldPos("FQ_FILDES")))	

		#IFDEF TOP
	
			cAliasSFQ := "SFQQUERY"
			
			lQuery := .T.
	
			cQuery := "SELECT SE5.R_E_C_N_O_ RECTIT,E5_FILIAL " 

			If lMultFil
				cQuery += ",FQ_FILDES"
			Endif

			cQuery += " FROM " 
			cQuery += RetSqlName("SE5") + " SE5, "
			cQuery += RetSqlName("SFQ") + " SFQ "
			cQuery += " WHERE "                      
			
			If !lMultFil
				cQuery += "E5_FILIAL  = '"+xFilial("SE5")+"' AND "
			Endif

			cQuery += "E5_PREFIXO = FQ_PREFDES AND "
			cQuery += "E5_NUMERO  = FQ_NUMDES  AND "
			cQuery += "E5_PARCELA = FQ_PARCDES AND "
			cQuery += "E5_TIPO    = FQ_TIPODES AND "	
			cQuery += "E5_CLIFOR  = FQ_CFDES   AND "						
			cQuery += "E5_LOJA    = FQ_LOJADES AND "						
			cQuery += "E5_SEQ 	 = FQ_SEQDES  AND "			
			cQuery += "SE5.D_E_L_E_T_ = ' '    AND "
			
			cQuery += "FQ_FILIAL  = '"+xFilial("SFQ")+"' AND "
			cQuery += "FQ_ENTORI  = '"+ cAlias+   "' AND "			
			cQuery += "FQ_PREFORI = '"+ cPrefixo+ "' AND "
			cQuery += "FQ_NUMORI  = '"+ cNumero+  "' AND "
			cQuery += "FQ_PARCORI = '"+ cParcela+ "' AND "
			cQuery += "FQ_TIPOORI = '"+ cTipo+ "'    AND "	
			cQuery += "FQ_CFORI   = '"+ cCliFor+ "'  AND "						
			cQuery += "FQ_LOJAORI = '"+ cLoja+ "'    AND "						
			cQuery += "FQ_SEQORI  = '"+ cSeq + "' AND "
			cQuery += "SFQ.D_E_L_E_T_ = ' ' "
			
			cQuery := ChangeQuery(cQuery)
	    	
			dbUseArea(.T.,"TOPCONN",TcGenQry(,,cQuery),cAliasSFQ,.T.,.T.)
		

			While (cAliasSFQ)->(!Eof())
				lAddRec := .T.
			
				If lMultFil 
					If !Empty(xFilial("SE5")) 
						If Empty((cAliasSFQ)->FQ_FILDES)
							lAddRec := (xFilial("SE5") == (cAliasSFQ)->E5_FILIAL)
						Else	
							lAddRec := ((cAliasSFQ)->E5_FILIAL == (cAliasSFQ)->FQ_FILDES)
						Endif                                 
					Else
						lAddRec := (xFilial("SE5") == (cAliasSFQ)->E5_FILIAL)
					Endif
				Endif
			
				If lAddRec			
					Aadd(aRecnos,(cAliasSFQ)->RECTIT)			
				Endif	
				
				(cAliasSFQ)->(dbSkip())

			EndDo
	
			If lQuery
				dbSelectArea(cAliasSFQ)
				dbCloseArea()
				dbSelectArea("SFQ")
			EndIf					
	
			
		#ELSE
			SFQ->(dbSetOrder(1))
			If SFQ->(MsSeek(xFilial("SFQ")+cAlias+cPrefixo+cNumero+cParcela+cTipo+cClifor+cLoja))
			    While SFQ->(!Eof()) .And. SFQ->FQ_FILIAL == xFilial("SFQ") .And.;
			    							SFQ->FQ_ENTORI == cAlias    .And. ;
			    							SFQ->FQ_PREFORI == cPrefixo .And.;
			    							SFQ->FQ_NUMORI  == cNumero  .And.;
			    							SFQ->FQ_PARCORI == cParcela .And. ;
			    							SFQ->FQ_TIPOORI == cTipo    .And. ;
			    							SFQ->FQ_CFORI   == cCliFor  .And.;
											SFQ->FQ_LOJAORI == cloja
		
					If lMultFil
						If !Empty(xFilial("SE5")) 
							If Empty(SFQ->FQ_FILDES)					
								cFilPesq := xFilial("SE5")
							Else 
								cFilPesq := SFQ->FQ_FILDES
							Endif	                       
						Else
							cFilPesq := xFilial("SE5")
						Endif		
									
					Else
						cFilPesq := xFilial(cAlias)					
					Endif		

					If SFQ->FQ_SEQORI == cSeq
						(cAlias)->(dbSetOrder(7))
						If (cAlias)->(MsSeek(cFilPesq+SFQ->FQ_PREFDES+SFQ->FQ_NUMDES+SFQ->FQ_PARCDES+SFQ->FQ_TIPODES+SFQ->FQ_CFDES+SFQ->FQ_LOJADES+SFQ->FQ_SEQDES))
							Aadd(aRecnos,(cAlias)->(Recno()))
						Endif	
					Endif			
					SFQ->(dbSkip())        	
				EndDo		
			Endif		
		#ENDIF	
	Endif	
Endif

RestArea(aAreaSE5)
RestArea(aArea)

Return(aRecnos)


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FImpDelSFQ³ Autor ³ Eduardo Riera         ³ Data ³11.08.2003 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³Funcao que exclui os registro s de relacionamento de titulos ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³ExpC1: Alias do registro  do titulo principal                ³±±
±±³          ³       SE5                                                   ³±±
±±³Parametros³ExpC2: Prefixo                                               ³±±
±±³Parametros³ExpC3: Numero                                                ³±±
±±³Parametros³ExpC4: Parcela                                               ³±±
±±³Parametros³ExpC5: Tipo                                                  ³±±
±±³Parametros³ExpC6: Cliente                                               ³±±
±±³Parametros³ExpC7: Loja                                                  ³±±
±±³Parametros³ExpC8: Sequencia da Baixa                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Nenhum                                                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Esta rotina tem como objetivo trazer os registros relacionau-³±±
±±³          ³dos ao titulo aglutinador                                    ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Uso       ³ Geral                                                       ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FImpDelSFQ(cAlias,cPrefixo,cNumero,cParcela,cTipo,cCliFor,cLoja,cSeq)

Local aArea := GetArea()

If AliasIndic("SFQ")
	SFQ->(dbSetOrder(1))
	If SFQ->(MsSeek(xFilial("SFQ")+cAlias+cPrefixo+cNumero+cParcela+cTipo+cClifor+cLoja))
    	While SFQ->(!Eof()) .And. SFQ->FQ_FILIAL == xFilial("SFQ") .And.;
    							SFQ->FQ_ENTORI == cAlias    .And. ;
    							SFQ->FQ_PREFORI == cPrefixo .And.;
    							SFQ->FQ_NUMORI  == cNumero  .And.;
    							SFQ->FQ_PARCORI == cParcela .And. ;
    							SFQ->FQ_TIPOORI == cTipo    .And. ;
    							SFQ->FQ_CFORI   == cCliFor  .And.;
								SFQ->FQ_LOJAORI == cLoja

			If	SFQ->FQ_SEQORI == cSeq
				RecLock("SFQ",.F.)
				SFQ->(dbDelete())
				MsUnlock()
			Endif							
			SFQ->(dbSkip())        	
		EndDo		
	Endif	
Endif		

RestArea(aArea)

Return


/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o    ³FDelTxBx  ³ Autor ³ Mauricio Pequim Jr    ³ Data ³ 20/10/04 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Deleta titulos de imposto Pis Cofins Csll gerados na baixa. ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function FDelTxBx(cPrefixo,cNumero,cParcela,cTipo,cCliFor,cLoja,cSeq,cParcPis,cParcCof,cParcCsl)

Local aArea	:= SE2->(GetArea())
Local cForUniao := ""
Local cLojUniao := ""
Local cChaveImp := ""
Local cNatPis 	:= GetMv("MV_PISNAT",.F.,"PIS")
Local cNatCof	:= GetMv("MV_COFINS",.F.,"COF")
Local cNatCsl	:= GetMv("MV_CSLL",.F.,"CSL")
Local nRegSe2	:= SE2->(RECNO())
Local lF241Nat := ExistBlock("F241NAT")
Local nX

Local cNaturs := ""
Local cNatIrf	:= &(GetMv("MV_IRF"))
Local lIrfMp232 := !Empty( SA2->( FieldPos( "A2_CALCIRF" ) ) ) .and. SA2->A2_CALCIRF == "2" .and. ;
				 !Empty( SE2->( FieldPos( "E2_VRETIRF" ) ) ) .And. !Empty( SE2->( FieldPos( "E2_PRETIRF" ) ) ) .And. ;
				 !Empty( SE5->( FieldPos( "E5_VRETIRF" ) ) ) .And. !Empty( SE5->( FieldPos( "E5_PRETIRF" ) ) )

If ( cPaisLoc == "BRA" )
	// Nao permitir a exclusao do titulo caso a baixa 
	// cancelada seja a do Tx (imposto).
	If !(cTipo $ MVTXA+"/"+MVTAXA)
		DbSelectArea("SA2")
		DbSetOrder(1)
		MsSeek(xFilial("SA2")+GetMv("MV_UNIAO")+Space(Len(A2_COD)-Len(GetMv("MV_UNIAO")))+"00")
		cForUniao	:= SA2->A2_COD
		cLojUniao	:= SA2->A2_LOJA
		
		dbSelectArea("SE2")
		dbSetOrder(1)	
		
		//Abro o SE2 com outro alias pois pode estar filtrado pela 
		//Baixa por lote
		If Select("__SE2") == 0
		   ChkFile("SE2",.F.,"__SE2")
		Else
		   DbSelectArea("__SE2")
		EndIf
		dbSetOrder(6)
		dbGoto(nRegSE2)
		
		//Apago os titulos de impostos	
		cChaveImp	:= cForUniao+cLojUniao+cPrefixo+cNumero
		If lIrfMP232
			cNaturs := cNatPis+"/"+cNatCof+"/"+cNatCsl+"/"+cNatIrf+"/"
		Else
			cNaturs := cNatPis+"/"+cNatCof+"/"+cNatCsl+"/"
		Endif
		//Ponto de entrada onde serao retornados os codigos de natureza utilizados
		//alternativamente pára os titulos de Pis, Cofins e Csll
		If lF241Nat
			cNaturs += ExecBlock("F241NAT",.F.,.F.)
		Endif

		//Apaga registros de Pis, Cofins e Csll gerados por essa baixa
		If MsSeek(xFilial("SE2")+cChaveImp)
			While __SE2->(E2_FORNECE+E2_LOJA+E2_PREFIXO+E2_NUM)== cChaveImp .and. ;
				__SE2->E2_TIPO $ MVTAXA

				If	Alltrim(__SE2->E2_NATUREZ) $ cNaturs .and. ;
					STR(__SE2->E2_SALDO,17,2) == STR(__SE2->E2_VALOR,17,2) .and. ;
					__SE2->E2_SEQBX == cSeq 

					RecLock("__SE2")
					dbDelete()
					MsUnlock()
				Endif
				__SE2->(dbSkip())
			Enddo
		Endif

		//Apaga registros de NCC gerados por essa baixa (Pis, Cofins, Csll)
		dbSetOrder(1)
		cChaveImp	:= cPrefixo+cNumero+cParcela+MV_CPNEG+cCliFor+cLoja
		If MsSeek(xFilial("SE2")+cChaveImp)
			While !Eof() .and. E2_FILIAL == xFilial("SE2") .and. ;
				cChaveImp == __SE2->(E2_PREFIXO+E2_NUM+E2_PARCELA+E2_TIPO+E2_FORNECE+E2_LOJA)
				If __SE2->E2_SEQBX == cSeq .and. STR(__SE2->E2_SALDO,17,2) == STR(__SE2->E2_VALOR,17,2)
					RecLock("__SE2")
					dbDelete()
					MsUnlock()
				Endif
				dbSkip()
			Enddo
		Endif	
	
		RestArea(aArea)
		dbGoto(nRegSE2)
	Endif
Endif
Return .T.

/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³Fa080MovBc³ Autor ³Nilton Pereira         ³ Data ³31/05/05  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao para verificar o nao se o motivo de baixa gerou     ³±±
±±³          ³ movimento bancario                                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ Tratamento da lei 10925                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Static Function Fa080MovBc(cMotInfo)

// Considera baixas que geram ou nao movimento bancario.
// 1 = Somente os motivos que geram movimento bancario
// 2 = Considera todos os motivos de baixa.
Local lMotBxMBco  := (SuperGetMv("MV_MB10925",.t.,"2") == "1")
Local lMovBco  := .F.     

Default cMotInfo := ""

// Consiste se o motivo gera ou nao movimento bancario.
If lMotBxMBco              
	If Empty(cMotInfo) 
		//Se movimenta banco (motivo completo)
		If MovBcoBx(cMotBx,.T.) 
			lMovBco := .T. 
		Endif
	Else
		//Se movimenta banco (motivo resumido)      
		If MovBcoBx(cMotInfo,.F.) 
			lMovBco := .T. 
		Endif
	Endif
Endif

Return lMovBco


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡…o    ³Fa080ValCh³ Autor ³Paulo Augusto          ³ Data ³21/07/05  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Funcao para verificar a existencia de cheque sobre titulo  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso      ³ FINA080                                                    ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
                       
Function Fa080ValCh(lValida)	
Local lRet:=.T.
DEFAULT lValida := .T.

If  lValida .And. (!(MovBcoBx(cMotBx,.T.)) .Or. !(ChqMotBx(cMotBx))) .And. SE2->E2_IMPCHEQ=="S"
	Help(" ",1,"CH_BAIXA",	OemToAnsi(STR0029),OemToAnsi(STR0148),1,0)
	lRet:=.F.
EndIf

Return(lRet)


/*
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Funcao    ³F080IssBx ³ Autor ³Mauricio Pequim Jr     ³ Data ³19/10/2004³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³Calculo do ISS pela baixa                                   ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
*/
Function F080IssBx() 

Local aAreaSE2  := SE2->( GetArea() ) 
Local nValTit := 0
Local lSest := SE2->(FieldPos("E2_SEST"))	> 0  //Verifica campo de SEST
Local lAltValor := STR(nValPgto,17,2) != STR(nOldValPgto,17,2)
Local nValOutImp := 0
Local nSE2Reg := SE2->(RECNO())
Local nBaseImp   := 0
Local lCalcIssBx := !Empty( SE5->( FieldPos( "E5_VRETISS" ) ) ) .and. !Empty( SE2->( FieldPos( "E2_SEQBX"   ) ) ) .and. ;
							!Empty( SE2->( FieldPos( "E2_TRETISS" ) ) ) .and. GetNewPar("MV_MRETISS","1") == "2"  //Retencao do ISS pela emissao (1) ou baixa (2)

//Se a validação nao partiu do campo de valor
If !lAltValor .and. ( Type('lF080Auto') =='U' .or. ! lF080Auto)
	nValPgto += nPis+nCofins+nCsll+nIrrf+nIss
Endif

If lCalcIssBx .and. SE2->E2_TRETISS == "2"

	SE2->(dbGoto(nSE2Reg))
	SED->(dbSetOrder(1))
	SED->(MsSeek(xFilial("SED")+SE2->E2_NATUREZ))
	SA2->(dbSetOrder(1))
	SA2->(MsSeek(xFilial("SA2")+SE2->E2_FORNECE+SE2->E2_LOJA))
	
	nBaseImp := nValPgto
		
	nValOutImp := SE2->(E2_IRRF+E2_INSS)
		
	If lSest
		nValOutImp += SE2->E2_SEST
	Endif
	
	nValTit := SE2->E2_VALOR + nValOutImp
				
	If !lAltValor
		nBaseImp += nValOutImp
	Endif
		
	If nValPgto <> SE2->E2_SALDO .and. SE2->E2_ISS > 0
		nIss := NoRound(( nBaseImp * SE2->E2_ISS ) / nValTit ,2)
	Else
		nIss		 := SE2->E2_ISS
	Endif
Endif	

SE2->( RestArea( aAreaSE2 ) ) 

If !lAltValor
	nValPgto -= nPis+nCofins+nCsll+nIrrf+nIss
	nOldValPgto := nValPgto	
Endif

Return .T.


/*/
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Fun‡„o	 ³F080VldRec³ Autor ³ Paulo Augusto         ³ Data ³ 04/04/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡„o ³Verifica se o valor pago eh menor que o valor da soma       ³±±
±±³          ³de Juros, Multa,acrescimo  e Desconto                       ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Sintaxe	 ³F080VldRec(oValRec)					                      ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³ Uso		 ³ FINA080 								  					  ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/
Function F080VldRec()

Local lRet   := .T.
Local cBxPag:= GetNewPar("MV_VLBXPAG","3")

If cBxPag == "1"
	lRet := .T.
Else

	If nValPgto < (nMulta+nJuros+nAcresc)
		If cBxPag == "2"
			If MsgYesNo(OemToAnsi(STR0156 )+CHR(10)+CHR(13)+OemToAnsi(STR0157 ) )    // "Atencao ! O valor pago e menor que a soma dos valores de juros, multa, acrescimo e desconto."  ## "Deseja confirmar a baixa?" 
				lRet := .T.
			Else
				lRet := .F.
			EndIf
		ElseIf cBxPag == "3"
			MsgAlert(OemToAnsi(STR0156 )+CHR(10)+CHR(13)+OemToAnsi(STR0158 ))  // "Atencao ! O valor pago e menor que a soma dos valores de juros, multa, acrescimo e desconto." ## "Favor modificar os valores."
			lRet := .F.	
		EndIf
	Else
		lRet := .T.
	EndIf
Endif	

Return lRet

/*/
ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±
±±³Programa  ³MenuDef   ³ Autor ³ Ana Paula N. Silva     ³ Data ³21/11/06 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±
±±³Descri‡…o ³ Utilizacao de menu Funcional                               ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Retorno   ³Array com opcoes da rotina.                                 ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³Parametros³Parametros do array a Rotina:                               ³±±
±±³          ³1. Nome a aparecer no cabecalho                             ³±±
±±³          ³2. Nome da Rotina associada                                 ³±±
±±³          ³3. Reservado                                                ³±±
±±³          ³4. Tipo de Transa‡„o a ser efetuada:                        ³±±
±±³          ³		1 - Pesquisa e Posiciona em um Banco de Dados     ³±±
±±³          ³    2 - Simplesmente Mostra os Campos                       ³±±
±±³          ³    3 - Inclui registros no Bancos de Dados                 ³±±
±±³          ³    4 - Altera o registro corrente                          ³±±
±±³          ³    5 - Remove o registro corrente do Banco de Dados        ³±±
±±³          ³5. Nivel de acesso                                          ³±±
±±³          ³6. Habilita Menu Funcional                                  ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±
±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±
±±³          ³               ³                                            ³±±
±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±
±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
ßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß
/*/     
Static Function MenuDef()
Local aRotina := { { OemToAnsi(STR0001), "AxPesqui" , 0 , 1,,.F.},; //"Pesquisar"
	{ OemToAnsi(STR0002), "AxVisual" , 0 , 2},; //"Visualizar"
	{ OemToAnsi(STR0003), "FA080Tit" , 0 , 4},; //"Baixar"
	{ OemToAnsi(STR0004), "FA080Lot" , 0 , 4},; //"Lote"
	{ OemToAnsi(STR0005), "FA080Can" , 0 , 5},; //"Canc Baixa"
	{ OemToAnsi(STR0115), "FA080Can" , 0 , 5,53},;	//"Excluir Baixa"
	{ OemToAnsi(STR0127),"FA040Legenda", 0 , 6, ,.F.} } //"Le&genda"
Return(aRotina)
